// ==UserScript==
// @name           Rycochet's Castle Age Golem
// @namespace      golem
// @description    Auto player for castle age game
// @version        12
// @include        http*://apps.*facebook.com/castle_age/*
// @require        http://cloutman.com/jquery-latest.min.js
// @require        http://cloutman.com/jquery-ui-latest.min.js
// ==/UserScript==
// -- @include        http://www.facebook.com/common/error.html
// -- @include        http://www.facebook.com/reqs.php#confirm_46755028429_0
// -- @include        http://www.facebook.com/home.php
// -- @include        http://www.facebook.com/home.php*filter=app_46755028429*
$("head").append('<style type="text/css">.golem-config { float: none; margin-right: 0; }.golem-config > div { position: static; width: 196px; margin: 0; padding: 0; overflow: hidden; overflow-y: auto;  }.golem-config-fixed { float: right; margin-right: 200px; }.golem-config-fixed > div { position: fixed; }#golem-dashboard { position: absolute; top: 218px; width: 600px; height: 181px; margin: 0; border-left: 1px solid black; border-right:1px solid black; padding: 2px; overflow: hidden; overflow-y: auto; background: white; z-index: 1; }.golem-title { padding: 4px; overflow: hidden; border-bottom: 1px solid #aaaaaa; background: #cccccc url(http://cloutman.com/css/base/images/ui-bg_highlight-soft_75_cccccc_1x100.png) 50% 50% repeat-x; color: #222222; font-weight: bold; }.golem-panel .golem-panel-header { border: 1px solid #d3d3d3; cursor: pointer; margin-top: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-panel .golem-icon { float: left; background-position: -32px -16px; }.golem-panel .golem-locked { float: right; background-position: -192px -96px; }.golem-panel .golem-panel-content { border: 1px solid #aaaaaa; border-top: 0 !important; padding: 2px 6px; background: #ffffff url(http://cloutman.com/css/base/images/ui-bg_glass_65_ffffff_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #212121; display: none; -moz-border-radius-bottomleft: 3px; -webkit-border-bottom-left-radius: 3px; border-bottom-left-radius: 3px; -moz-border-radius-bottomright: 3px; -webkit-border-bottom-right-radius: 3px; border-bottom-right-radius: 3px; }.golem-panel-show  .golem-panel-header { border: 1px solid #aaaaaa; border-bottom: 0 !important; -moz-border-radius-bottomleft: 0 !important; -webkit-border-bottom-left-radius: 0 !important; border-bottom-left-radius: 0 !important; -moz-border-radius-bottomright: 0 !important; -webkit-border-bottom-right-radius: 0 !important; border-bottom-right-radius: 0 !important; }.golem-panel-show  .golem-panel-header .golem-icon { background-position: -64px -16px; }.golem-panel-show  .golem-panel-content { display: block; }.golem-panel-sortable .golem-locked { display: none; }</style>');
var debug=true,VERSION=12,APP="46755028429",PREFIX="golem"+APP+"_",userID=unsafeWindow.Env.user,script_started=Date.now();
function main(){if(!Page.loading()&&!$("#secret_golem_check").length){if(!$("#app"+APP+"_nvbar_div_end").length){Page.reload();return}$("#app"+APP+"_nvbar_div_end").append('<br id="secret_golem_check" style="display:none"/>');Page.identify();var b;for(b in Workers)Workers[b].priv_parse=Workers[b].pages&&(Workers[b].pages==="*"||Page.page&&Workers[b].pages.indexOf(Page.page)>=0)&&Workers[b].parse?Workers[b].parse(false):false;Settings.Save("data");for(b in Workers)Workers[b].priv_parse&&Workers[b].parse(true)}Queue.run()}
$(document).ready(function(){Page.identify();Settings.Load("data");Settings.Load("option");if(window.location.href.indexOf("castle_age")>=0){for(var b in Workers)Workers[b].onload&&Workers[b].onload();main();window.setInterval(function(){main()},1E3)}});
var Settings={userID:unsafeWindow.Env.user,SetValue:function(b,a){switch(typeof a){case "boolean":case "number":return GM_setValue(Settings.userID+"."+b,a);case "string":return GM_setValue(Settings.userID+"."+b,'"'+a+'"');case "array":case "object":return GM_setValue(Settings.userID+"."+b,a.toSource());default:GM_debug("Unknown variable type: "+b)}return null},GetValue:function(b,a){v=GM_getValue(Settings.userID+"."+b,a);if(typeof v==="string")if(v.charAt(0)==='"')v=v.replace(/^"|"$/g,"");else if(v.charAt(0)===
"("||v.charAt(0)==="[")v=typeof a==="array"||typeof a==="object"?$.extend(true,{},a,eval(v)):eval(v);return v},Save:function(){var b,a="data",c=null;for(b=0;b<arguments.length;b++)if(typeof arguments[b]==="object")c=arguments[b];else if(arguments[b]==="data"||arguments[b]==="option")a=arguments[b];if(c&&c[a])Settings.SetValue(a+"."+c.name,c[a]);else for(b=0;b<Workers.length;b++)Workers[b][a]&&Settings.SetValue(a+"."+Workers[b].name,Workers[b][a])},Load:function(){var b,a="data",c=null;for(b=0;b<arguments.length;b++)if(typeof arguments[b]===
"object")c=arguments[b];else if(arguments[b]==="data"||arguments[b]==="option")a=arguments[b];if(c&&c[a])c[a]=Settings.GetValue(a+"."+c.name,c[a]);else for(b=0;b<Workers.length;b++)if(Workers[b][a])Workers[b][a]=Settings.GetValue(a+"."+Workers[b].name,Workers[b][a])}};String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.filepart=function(){var b=this.lastIndexOf("/");if(b>=0)return this.substr(b+1);return this};
String.prototype.pathpart=function(){var b=this.lastIndexOf("/");if(b>=0)return this.substr(0,b+1);return this};String.prototype.regex=function(b){b=this.match(b);var a;if(b){b.shift();for(a=0;a<b.length;a++)if(b[a]&&b[a].search(/^[-+]?[0-9]+\.?[0-9]*$/)>=0)b[a]=parseFloat(b[a]);if(b.length===1)return b[0]}return b};String.prototype.toNumber=function(){return parseFloat(this)};
String.prototype.parseTimer=function(){var b=this.split(":"),a=0,c;for(c=0;c<b.length;c++)a=a*60+parseInt(b[c],10);if(isNaN(a))a=9999;return a};if(typeof GM_debug==="undefined")GM_debug=function(b){debug&&GM_log(b)};
var makeTimer=function(b){var a=Math.floor(b/3600),c=Math.floor(b/60)%60;b=Math.floor(b%60);return(a?a+":"+(c>9?c:"0"+c):c)+":"+(b>9?b:"0"+b)},WorkerByName=function(b){for(var a in Workers)if(Workers[a].name===b)return Workers[a];return null},WorkerById=function(b){for(var a in Workers)if(Workers[a].priv_id===b)return Workers[a];return null},Divisor=function(b){var a=b,c=1;if(a<20)return 1;for(;a>100;){a/=10;c*=10}if(b/c>40)c*=5;else if(b/c>20)c*=2.5;return c},length=function(b){var a=0,c;if(typeof b===
"object")for(c in b)a++;else if(typeof b==="array")a=b.length;return a},unique=function(b){var a={},c,d=b.length,e=[];for(c=0;c<d;c++)a[b[c]]=b[c];for(c in a)e.push(a[c]);return e},addCommas=function(b){b=b.toString();for(var a=/(-?[0-9]+)([0-9]{3})/;a.test(b);)b=b.replace(a,"$1,$2");return b},findInArray=function(b,a){if(typeof b==="array"||typeof b==="object")for(var c in b)if(b[c]===a)return true;return false},getAttDef=function(b,a,c,d,e){var f=[],g=0,j=0,i=c==="att"?"def":"att",h;for(h in b)a(f,
h,b);f.sort(function(k,n){return b[n][c]+0.7*b[n][i]-(b[k][c]+0.7*b[k][i])});for(h=0;h<f.length;h++){a=typeof b[f[h]].own==="number"?b[f[h]].own:1;if(e)if(Math.min(d,a)>0){if(!b[f[h]].use)b[f[h]].use={};b[f[h]].use[e+"_"+c]=Math.min(d,a)}else if(b[f[h]].use){delete b[f[h]].use[e+"_"+c];length(b[f[h]].use)||delete b[f[h]].use}if(d<=0)break;a=Math.min(d,a);g+=a*b[f[h]].att;j+=a*b[f[h]].def;d-=a}return(c==="att"?g:0.7*g)+(c==="def"?j:0.7*j)},Workers=[];
function Worker(b,a){this.id=Workers.push(this);this.name=b;this.pages=a;this.unsortable=false;this.data={};this.option={};this.work=this.parse=this.display=this.onload=null;this.priv_parse=false;this.priv_since=0;this.priv_id=null}var Config=new Worker("Config");Config.data=null;Config.option={display:"block",fixed:true};Config.panel=null;
Config.onload=function(){$("head").append('<link rel="stylesheet" href="http://cloutman.com/css/base/jquery-ui.css" type="text/css" />');var b,a;Config.panel=$('<div class="golem-config'+(Config.option.fixed?" golem-config-fixed":"")+'"><div class="ui-widget-content" style="display:'+Config.option.display+';"><div class="golem-title">Castle Age Golem v'+VERSION+'<span id="golem_fixed" class="ui-icon ui-icon-pin-'+(Config.option.fixed?"s":"w")+'" style="float:right;margin-top:-2px;"></span></div><div id="golem_buttons" style="margin:4px;"></div><div id="golem_config" style="margin:4px;overflow:hidden;overflow-y:auto;"></div></div></div>');
$("div.UIStandardFrame_Content").after(Config.panel);$("#golem_fixed").click(function(){Config.option.fixed^=true;$(this).toggleClass("ui-icon-pin-w ui-icon-pin-s");$(this).parent().parent().parent().toggleClass("golem-config-fixed");Config.option.active=[];Settings.Save("option",Config)});b=$("#golem_config");for(a in Workers)b.append(Config.makePanel(Workers[a]));b.sortable({axis:"y"});$(".golem-panel > h3").click(function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",
function(){$(this).parent().toggleClass("golem-panel-show")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind")}Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Settings.Save("option",Config)});b.children(".golem-panel-sortable").draggable({connectToSortable:"#golem_config",axis:"y",distance:5,scroll:false,handle:"h3",helper:"clone",opacity:0.75,zIndex:100,refreshPositions:true,stop:function(){Config.updateOptions()}}).droppable({tolerance:"pointer",
over:function(c,d){Config.getPlace($(this).attr("id"))<Config.getPlace($(d.draggable).attr("id"))?$(this).before(d.draggable):$(this).after(d.draggable)}});for(a in Workers)Workers[a].select&&Workers[a].select();$("input.golem_addselect").click(function(){$("select.golem_multiple",$(this).parent()).append("<option>"+$("select.golem_select",$(this).parent()).val()+"</option>");Config.updateOptions()});$("input.golem_delselect").click(function(){$("select.golem_multiple option[selected=true]",$(this).parent()).each(function(c,
d){$(d).remove()});Config.updateOptions()});$("input ,textarea, select",b).change(function(){Config.updateOptions()})};
Config.makePanel=function(b){var a,c,d,e,f,g=b.display,j=[],i=[],h=[],k={before:"",after:"",suffix:"",className:"",between:"to",size:7,min:0,max:100};if(!g)return false;b.priv_id="golem_panel_"+b.name.toLowerCase().replace(/[^0-9a-z]/,"_");c=findInArray(Config.option.active,b.priv_id);f=$('<div id="'+b.priv_id+'" class="golem-panel'+(b.unsortable?"":" golem-panel-sortable")+(c?" golem-panel-show":"")+'" name="'+b.name+'"><h3 class="golem-panel-header "><span class="ui-icon golem-icon"></span>'+b.name+
'<span class="ui-icon golem-locked"></span></h3></div>');switch(typeof g){case "array":case "object":for(a in g){i=[];h=[];c=$.extend(true,{},k,g[a]);c.real_id=PREFIX+b.name+"_"+c.id;c.value=b.option[c.id]||null;c.alt=c.alt?' alt="'+c.alt+'"':"";if(c.label){i.push('<span style="float:left;margin-top:2px;">'+c.label.replace(" ","&nbsp;")+"</span>");if(c.text||c.checkbox||c.select||c.multiple)i.push('<span style="float:right;">')}c.before&&i.push(c.before+" ");if(c.info)c.id?i.push('<span style="float:right" id="'+
c.real_id+'">'+c.info+"</span>"):i.push(c.info);else if(c.text)i.push('<input type="text" id="'+c.real_id+'" size="'+c.size+'" value="'+(c.value||"")+'">');else if(c.checkbox)i.push('<input type="checkbox" id="'+c.real_id+'"'+(c.value?" checked":"")+">");else if(c.select){switch(typeof c.select){case "string":c.className=' class="golem_'+c.select+'"';break;case "number":e=Divisor(c.select);for(d=0;d<=c.select;d+=e)h.push("<option"+(c.value==d?" selected":"")+">"+d+"</option>");break;case "array":case "object":for(d in c.select)h.push('<option value="'+
c.select[d]+'"'+(c.value==c.select[d]?" selected":"")+">"+c.select[d]+(c.suffix?" "+c.suffix:"")+"</option>");break}i.push('<select id="'+c.real_id+'"'+c.className+c.alt+">"+h.join("")+"</select>")}else if(c.multiple){if(typeof c.value==="array"||typeof c.value==="object")for(a in c.value)h.push('<option value="'+c.value[a]+'">'+c.value[a]+"</option>");i.push('<select style="width:100%" class="golem_multiple" multiple id="'+c.real_id+'">'+h.join("")+"</select><br>");h=[];switch(typeof c.multiple){case "string":c.className=
' class="golem_'+c.select+'"';break;case "number":e=Divisor(c.select);for(d=0;d<=c.multiple;d+=e)h.push("<option>"+d+"</option>");break;case "array":for(d=0;d<c.multiple.length;d++)h.push('<option value="'+c.multiple[d]+'">'+c.multiple[d]+(c.suffix?" "+c.suffix:"")+"</option>");break;case "object":for(d in c.multiple)h.push('<option value="'+d+'">'+c.multiple[d]+(c.suffix?" "+c.suffix:"")+"</option>");break}i.push('<select class="golem_select">'+h.join("")+'</select><input type="button" class="golem_addselect" value="Add" /><input type="button" class="golem_delselect" value="Del" />')}c.after&&
i.push(" "+c.after);if(c.label&&(c.text||c.checkbox||c.select||c.multiple))i.push("</span>");j.push('<div style="clear:both">'+i.join("")+"</div>")}f.append('<div class="golem-panel-content" style="font-size:smaller;">'+j.join("")+'<div style="clear:both"></div></div>');return f;default:return null}};
Config.updateOptions=function(){GM_debug("Options changed");var b={};Queue.option.queue=[];$("#golem_config > div").each(function(a,c){a=WorkerById($(c).attr("id")).name;b[a]||Queue.option.queue.push(a);b[a]=true});$("#golem_config :input").each(function(a,c){if($(c).attr("id")){var d;if(a=$(c).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))if($(c).attr("type")==="checkbox")WorkerByName(a[0]).option[a[1]]=$(c).attr("checked");else{if($(c).attr("multiple")){d=[];$("option",c).each(function(e,
f){d.push($(f).text())})}else if((d=$(c).attr("value")||$(c).val()||null)&&d.search(/[^0-9.]/)===-1)d=parseFloat(d);WorkerByName(a[0]).option[a[1]]=d}}});Settings.Save("option")};Config.getPlace=function(b){var a=-1;$("#golem_config > div").each(function(c,d){if($(d).attr("id")===b&&a===-1)a=c});return a};var Alchemy=new Worker("Alchemy","keep_alchemy");Alchemy.data={ingredients:{},recipe:{}};
Alchemy.display=[{id:"perform",label:"Automatically Perform",checkbox:true},{id:"hearts",label:"Use Battle Hearts",checkbox:true}];
Alchemy.parse=function(){var b=Alchemy.data.ingredients={},a=Alchemy.data.recipe={};$("div.ingredientUnit").each(function(c,d){c=$("img",d).attr("src").filepart();b[c]=$(d).text().regex(/x([0-9]+)/)});$("div.alchemyQuestBack,div.alchemyRecipeBack,div.alchemyRecipeBackMonster").each(function(c,d){var e={};c=$("div.recipeTitle",d).text().trim().replace("RECIPES: ","");if(c.indexOf(" (")>0)c=c.substr(0,c.indexOf(" ("));e.type=$(d).hasClass("alchemyQuestBack")?"Quest":$(d).hasClass("alchemyRecipeBack")?
"Recipe":$(d).hasClass("alchemyRecipeBackMonster")?"Summons":"wtf";e.ingredients={};$("div.recipeImgContainer",d).parent().each(function(f,g){f=$("img",g).attr("src").filepart();e.ingredients[f]=$(g).text().regex(/x([0-9]+)/)||1});a[c]=e})};
Alchemy.work=function(b){if(!Alchemy.option.perform)return false;var a=null,c=Alchemy.data.recipe,d,e;for(d in c)if(c[d].type==="Recipe"){a=d;for(e in c[d].ingredients)if(!Alchemy.option.hearts&&e==="raid_hearts.gif"||c[d].ingredients[e]>(Alchemy.data.ingredients[e]||0)){a=null;break}if(a)break}if(!a)return false;if(!b)return true;if(!Page.to("keep_alchemy"))return true;GM_debug("Alchemy: Perform - "+a);$("div.alchemyRecipeBack").each(function(f,g){if($("div.recipeTitle",g).text().indexOf(a)>=0){Page.click($('input[type="image"]',
g));return true}});return true};var Bank=new Worker("Bank");Bank.data=null;Bank.option={general:true,above:1E4,hand:0,keep:1E4};Bank.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"above",label:"Bank Above",text:true},{id:"hand",label:"Keep in Cash",text:true},{id:"keep",label:"Keep in Bank",text:true}];
Bank.work=function(b){if(Player.data.cash<Bank.option.above)return false;if(!b)return true;if(!Bank.stash(Player.data.cash-Math.min(Bank.option.above,Bank.option.hand)))return true;return false};Bank.stash=function(b){if(!b||!Player.data.cash)return true;if(Bank.option.general&&!Generals.to("Aeris"))return false;if(!Page.to("keep_stats"))return false;$('input[name="stash_gold"]').val(Math.min(Player.data.cash,b));Page.click('input[value="Stash"]');return true};
Bank.retrieve=function(b){b-=Player.data.gold;if(b<=0)return true;if(Player.data.bank-Bank.option.keep<b)return true;if(!Page.to("keep_stats"))return false;$('input[name="get_gold"]').val(b);Page.click('input[value="Retrieve"]');return true};Bank.worth=function(){return Player.data.cash+Math.max(0,Player.data.bank-Bank.option.keep)};var Battle=new Worker("Battle","battle_rank battle_battle");Battle.data={user:{},rank:{},points:{}};
Battle.option={general:true,points:true,monster:true,losses:5,type:"Invade",bp:"Always"};
Battle.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel"]},{id:"losses",label:"Attack Until",select:[1,2,3,4,5,6,7,8,9,10],after:"Losses"},{id:"points",label:"Always Get Demi-Points",checkbox:true},{id:"monster",label:"Fight Monsters First",checkbox:true},{id:"bp",label:"Get Battle Points<br>(Clears Cache)",select:["Always","Never","Don't Care"]},{id:"cache",label:"Limit Cache Length",select:[100,200,300,400,500]}];
Battle.parse=function(){var b,a,c,d,e=0,f=[];if(Page.page==="battle_rank"){a=Battle.data.rank={0:{name:"Squire",points:0}};$('tr[height="23"]').each(function(g,j){d=$(j).text().regex(/Rank ([0-9]+) - (.*)\s*([0-9]+)/i);a[d[0]]={name:d[1],points:d[2]}})}else if(Page.page==="battle_battle"){a=Battle.data.user;if(Battle.data.attacking){c=Battle.data.attacking;if($("div.results").text().match(/You cannot battle someone in your army/i))delete a[c];else if($("div.results").text().match(/Your opponent is dead or too weak/i))a[c].dead=
Date.now();else if($('img[src*="battle_victory"]').length)a[c].win=(a[c].win||0)+1;else if($('img[src*="battle_defeat"]').length)a[c].loss=(a[c].loss||0)+1;Battle.data.attacking=null}Battle.data.points=$("#app"+APP+"_app_body table.layout table table").prev().text().replace(/[^0-9\/]/g,"").regex(/([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10/);$("#app"+APP+"_app_body table.layout table table tr:even").each(function(g,j){g=$('img[uid!==""]',j).attr("uid");var i=$("td.bluelink",j).text().trim().regex(/Level ([0-9]+) (.*)/i),
h;if(g&&i){h=Battle.rank(i[1]);if(!(Battle.option.bp==="Always"&&Player.data.rank-h>5||!Battle.option.bp==="Never"&&Player.data.rank-h<=5)){a[g]||(a[g]={});a[g].name=$("a",j).text().trim();a[g].level=i[0];a[g].rank=h;a[g].army=$("td.bluelink",j).next().text().regex(/([0-9]+)/);a[g].align=$('img[src*="graphics/symbol_"]',j).attr("src").regex(/symbol_([0-9])/i)}}});for(b in a)if(Battle.option.bp==="Always"&&Player.data.rank-a[b].rank>5||!Battle.option.bp==="Never"&&Player.data.rank-a[b].rank<=5)delete a[b];
else e++;if(e>Battle.option.cache){GM_debug("Battle: Pruning target cache");for(b in a)f.push(b);f.sort(function(g,j){return a[g].win-a[g].loss-(a[j].win-a[j].loss)})}}return false};
Battle.work=function(b){if(Player.data.health<=10||Queue.burn.stamina<1)return false;var a,c=[],d=[],e=Battle.data.user;if(Battle.option.points)for(a=0;a<Battle.data.points.length;a++)if(Battle.data.points[a]<10)c[a+1]=true;if((!Battle.option.points||!c.length)&&Battle.option.monster&&Monster.count)return false;for(a in e)e[a].dead&&e[a].dead+18E5<Date.now()||(e[a].loss||0)-(e[a].win||0)>=Battle.option.losses||(!Battle.option.points||!c.length||typeof c[e[a].align]!=="undefined"?d.push(a):GM_debug("Battle: Not adding target "+
a));if(!d.length)return false;if(!b)return true;if(Battle.option.general&&!Generals.to(Generals.best(Battle.option.type))||!Page.to("battle_battle"))return true;b=d[Math.floor(Math.random()*d.length)];GM_debug("Battle: Wanting to attack "+e[b].name+" ("+b+")");e=$('form input[alt="'+Battle.option.type+'"]').first().parents("form");if(!e.length){GM_log("Battle: Unable to find attack buttons, forcing reload");Page.to("index");return false}Battle.data.attacking=b;$('input[name="target_id"]',e).attr("value",
b);Page.click($('input[type="image"]',e));return true};Battle.rank=function(b){for(var a in Battle.data.rank)if(Battle.data.rank[a].name===b)return parseInt(a,10);return 0};var Blessing=new Worker("Blessing","oracle_demipower");Blessing.option={which:"Stamina"};Blessing.which=["None","Energy","Attack","Defense","Health","Stamina"];Blessing.display=[{id:"which",label:"Which",select:Blessing.which}];
Blessing.parse=function(){var b=$("div.results"),a;if(b.length)if((a=b.text().regex(/Please come back in: ([0-9]+) hours and ([0-9]+) minutes/i))&&a.length)Blessing.data.when=Date.now()+(a[0]*60+a[1]+1)*6E4;else if(b.text().match(/You have paid tribute to/i))Blessing.data.when=Date.now()+8646E4;return false};
Blessing.work=function(b){if(!Blessing.option.which||Blessing.option.which==="None"||Date.now()<=Blessing.data.when)return false;if(!b)return true;if(!Page.to("oracle_demipower"))return true;Page.click("#app"+APP+"_symbols_form_"+Blessing.which.indexOf(Blessing.option.which)+" input.imgButton");return false};var Dashboard=new Worker("Dashboard","*");Dashboard.option={display:"none"};Dashboard.div=null;
Dashboard.onload=function(){Dashboard.div=$('<div id="golem-dashboard" style="display:'+Dashboard.option.display+';"><span>Monsters</span><div id="golem-dashboard-monster"></div></div>').prependTo(".UIStandardFrame_Content");window.setInterval(function(){$(".golem-timer").each(function(b,a){$(a).text(makeTimer($(a).text().parseTimer()-1))})},1E3)};
Dashboard.parse=function(){$("#app"+APP+"_nvbar_nvl").css({width:"760px","padding-left":0,margin:"auto"});$('<div><div class="nvbar_start"></div><div class="nvbar_middle"><a id="golem_toggle_dash"><span class="hover_header">Dashboard</span></a></div><div class="nvbar_end"></div></div><div><div class="nvbar_start"></div><div class="nvbar_middle"><a id="golem_toggle_config"><span class="hover_header">Config</span></a></div><div class="nvbar_end"></div></div>').prependTo("#app"+APP+"_nvbar_nvl > div:last-child");
$("#golem_toggle_dash").click(function(){Dashboard.option.display=Dashboard.option.display==="block"?"none":"block";$("#golem-dashboard").toggle("drop");Settings.Save("option",Dashboard)});$("#golem_toggle_config").click(function(){Config.option.display=Config.option.display==="block"?"none":"block";$(".golem-config > div").toggle(Config.option.fixed?null:"blind");Settings.Save("option",Config)});return false};var Debug=new Worker("Debug");Debug.data=null;Debug.option=null;
Debug.onload=function(){if(!debug)return null;var b=$("<button>Debug</button>").button().click(function(){debug^=true;GM_log("Debug "+(debug?"on":"off"));$("span",this).css("text-decoration",debug?"none":"line-through")});$("#golem_buttons").append(b);return null};var Generals=new Worker("General","heroes_generals");Generals.data={};Generals.best_id=null;
Generals.parse=function(b){var a,c,d,e,f,g,j=0,i=0,h=0,k=0,n=function(m,l){m.push(l)};if(b){if(length(Town.data.invade)){a=Generals.data;for(c in a){b=Player.data.attack+(a[c].skills.regex(/([-+]?[0-9]+) Player Attack/i)||0)+(a[c].skills.regex(/Increase Player Attack by ([0-9]+)/i)||0);d=Player.data.defense+(a[c].skills.regex(/([-+]?[0-9]+) Player Defense/i)||0)+(a[c].skills.regex(/Increase Player Defense by ([0-9]+)/i)||0);e=a[c].skills.regex(/Increases? Army Limit to ([0-9]+)/i)||501;f=getAttDef(Generals.data,
n,"att",Math.floor(e/5));g=getAttDef(a,n,"def",Math.floor(e/5));a[c].invade={att:Math.floor(Town.data.invade.attack+a[c].att+a[c].def*0.7+(b+d*0.7)*e+f),def:Math.floor(Town.data.invade.defend+a[c].def+a[c].att*0.7+(d+(a[c].skills.regex(/([-+]?[0-9]+) Defense when attacked/i)||0)+b*0.7)*e+g)};a[c].duel={att:Math.floor(Town.data.duel.attack+a[c].att+a[c].def*0.7+b+d*0.7),def:Math.floor(Town.data.duel.defend+a[c].def+a[c].att*0.7+d+b*0.7)}}for(c in Generals.data){j=Math.max(j,Generals.data[c].invade.att);
i=Math.max(i,Generals.data[c].invade.def);h=Math.max(h,Generals.data[c].duel.att);k=Math.max(k,Generals.data[c].duel.def)}$("#app"+APP+"_generalContainerBox2 > div > div.generalSmallContainer2").each(function(m,l){m=$(l).children();l=m.eq(0).text().trim();m.eq(1).prepend('<div style="position:absolute;margin-left:8px;margin-top:2px;font-size:smaller;text-align:left;z-index:100;color:#ffd200;text-shadow:black 1px 1px 2px;"><strong>Invade</strong><br>&nbsp;&nbsp;&nbsp;Atk: '+(a[l].invade.att===j?'<span style="font-weight:bold;color:#00ff00;">':
"")+addCommas(a[l].invade.att)+(a[l].invade.att===j?"</span>":"")+"<br>&nbsp;&nbsp;&nbsp;Def: "+(a[l].invade.def===i?'<span style="font-weight:bold;color:#00ff00;">':"")+addCommas(a[l].invade.def)+(a[l].invade.def===i?"</span>":"")+"<br><strong>Duel</strong><br>&nbsp;&nbsp;&nbsp;Atk: "+(a[l].duel.att===h?'<span style="font-weight:bold;color:#00ff00;">':"")+addCommas(a[l].duel.att)+(a[l].duel.att===h?"</span>":"")+"<br>&nbsp;&nbsp;&nbsp;Def: "+(a[l].duel.def===k?'<span style="font-weight:bold;color:#00ff00;">':
"")+addCommas(a[l].duel.def)+(a[l].duel.def===k?"</span>":"")+"<br></div>")})}}else{a={};$("#app"+APP+"_generalContainerBox2 > div > div.generalSmallContainer2").each(function(m,l){m=$(l).children();if(l=m.eq(0).text().trim()){a[l]={};a[l].img=m.eq(1).find("input.imgButton").attr("src").filepart();a[l].att=m.eq(2).children().eq(0).text().regex(/([0-9]+)/);a[l].def=m.eq(2).children().eq(1).text().regex(/([0-9]+)/);a[l].level=m.eq(3).text().regex(/Level ([0-9]+)/i);a[l].skills=$(m.eq(4).html().replace(/\<br\>|\s+|\n/g,
" ")).text().trim()}});if(length(a)>=length(Generals.data)){Generals.data=a;Generals.select()}else Page.to("heroes_generals","")}return true};Generals.to=function(b){if(!b||Player.data.general===b||b==="any")return true;if(!Generals.data[b]){GM_log('General "'+b+'" requested but not found!');return true}if(!Page.to("heroes_generals"))return false;GM_debug("Changing to General "+b);Page.click('input[src$="'+Generals.data[b].img+'"]');return false};
Generals.best=function(b){if(!Generals.data)return"any";var a="",c=null,d=0,e;switch(b.toLowerCase()){case "cost":a=/Decrease Soldier Cost by ([0-9]+)/i;break;case "stamina":a=/Increase Max Stamina by ([0-9]+)|\+([0-9]+) Max Stamina/i;break;case "energy":a=/Increase Max Energy by ([0-9]+)|\+([0-9]+) Max Energy/i;break;case "income":a=/Increase Income by ([0-9]+)/i;break;case "influence":a=/Bonus Influence ([0-9]+)/i;break;case "attack":a=/([-+]?[0-9]+) Player Attack/i;break;case "defense":a=/([-+]?[0-9]+) Player Defense/i;
break;case "invade":for(e in Generals.data)if(!c||Generals.data[e].invade&&Generals.data[e].invade.att>Generals.data[c].invade.att||Generals.data[e].invade.att===Generals.data[c].invade.att&&c!==Player.data.general)c=e;return c||"any";case "duel":for(e in Generals.data)if(!c||Generals.data[e].duel&&Generals.data[e].duel.att>Generals.data[c].duel.att||Generals.data[e].duel.att===Generals.data[c].duel.att&&c!==Player.data.general)c=e;return c||"any";case "defend":for(e in Generals.data)if(!c||Generals.data[e].duel&&
Generals.data[e].duel.def>Generals.data[c].duel.def||Generals.data[e].duel.def===Generals.data[c].duel.def&&c!==Player.data.general)c=e;return c||"any";case "under level 4":if(Generals.data[Player.data.general]&&Generals.data[Player.data.general].level<4)return Player.data.general;return Generals.random(false);default:return"any"}for(e in Generals.data)if(b=Generals.data[e].skills.regex(a))if(!c||b>d){c=e;d=b}c&&GM_debug("Best general found: "+c);return c};
Generals.random=function(b){var a,c=[];for(a in Generals.data)if(b)c.push(a);else Generals.data[a].level<4&&c.push(a);return c.length?c[Math.floor(Math.random()*c.length)]:"any"};
Generals.list=function(b){var a,c,d=[];if(b)if(b.find)for(a in Generals.data)Generals.data[a].skills.indexOf(b.find)>=0&&d.push(a);else{if(b.regex){for(a in Generals.data)(c=Generals.data[a].skills.regex(b.regex))&&d.push([a,c]);d.sort(function(e,f){return f[1]-e[1]})}}else{for(a in Generals.data)d.push(a);d.sort()}d.unshift("any");return d};
Generals.select=function(){$("select.golem_generals").each(function(b,a){$(a).empty();var c;b=(b=$(a).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(b[0]).option[b[1]]:null;var d=Generals.list();for(c in d)$(a).append('<option value="'+d[c]+'"'+(d[c]===b?" selected":"")+">"+d[c]+"</value>")})};var Gift=new Worker("Gift","index army_invite army_gifts");Gift.data={uid:[],todo:{},gifts:{}};
Gift.display=[{label:"Work in progress..."},{id:"type",label:"Return Gifts",select:["None","Random","Same as Received"]}];
Gift.lookup={"eq_gift_mystic_mystery.jpg":"Mystic Armor","eq_drakehelm_mystery.jpg":"Drake Helm","gift_angel_mystery2.jpg":"Battle Of Dark Legion","alchemy_serpent_mystery.jpg":"Serpentine Shield","alchemy_horn_mystery.jpg":"Poseidons Horn","gift_sea_egg_mystery.jpg":"Sea Serpent","gift_egg_mystery.jpg":"Dragon","gift_druid_mystery.jpg":"Whisper Bow","gift_armor_mystery.jpg":"Golden Hand","mystery_frost_weapon.jpg":"Frost Tear Dagger","eq_mace_mystery.jpg":"Morning Star"};
Gift.parse=function(b){if(b)return false;var a,c;if(Page.page==="index")!Gift.data.uid.length&&$("div.result").text().indexOf("has sent you a gift")>=0&&Gift.data.uid.push(1);else if(Page.page==="army_invite"){GM_debug("Gift: Checking for accepted");if(Gift.data.lastgift)if($("div.result").text().indexOf("accepted the gift")>=0){a=Gift.data.lastgift;if(!Gift.data.todo[a].gifts)Gift.data.todo[a].gifts=[];Gift.data.todo[a].gifts.push($("div.result img").attr("src").filepart());Gift.data.lastgift=null}GM_debug("Gift: Checking for new gift to accept");
a=Gift.data.uid=[];if($("div.messages").text().indexOf("gift")>=0){GM_debug("Gift: Found gift div");$("div.messages img").each(function(d,e){a.push($(e).attr("uid"));GM_debug("Gift: Adding gift from "+$(e).attr("uid"))})}}else if(Page.page==="army_gifts"){c=Gift.data.gifts={};$("#app"+APP+'_giftContainer div[id^="app'+APP+'_gift"]').each(function(d,e){d=$("img",e).attr("src").filepart();e=$(e).text().trim().replace("!","");c[d]||(c[d]={});c[d].name=e;if(Gift.lookup[e])c[d].create=Gift.lookup[e]})}return false};
Gift.work=function(b){if(!b){if(!Gift.data.uid.length)return false;return true}if(Gift.data.uid.length){if(!Page.to("army_invite"))return true;b=Gift.data.uid.shift();Gift.data.todo[b]||(Gift.data.todo[b]={});Gift.data.todo[b].time=Date.now();Gift.data.lastgift=b;GM_debug("Gift: Accepting gift from "+b);if(!Page.to("army_invite","?act=acpt&rqtp=gift&uid="+b)||Gift.data.uid.length>0)return true}Page.to("keep_alchemy");return false};var Heal=new Worker("Heal");Heal.data=null;
Heal.option={stamina:0,health:0};Heal.display=[{id:"stamina",label:"Heal Above",after:"stamina",select:"stamina"},{id:"health",label:"...And Below",after:"health",select:"health"}];
Heal.work=function(b){if(Player.data.health>=Player.data.maxhealth||Player.data.stamina<Heal.option.stamina||Player.data.health>=Heal.option.health)return false;if(!b)return true;if(!Page.to("keep_stats"))return true;GM_debug("Heal: Healing...");$('input[value="Heal Wounds"]').length?Page.click('input[value="Heal Wounds"]'):GM_log("Danger Danger Will Robinson... Unable to heal!");return false};var Idle=new Worker("Idle");Idle.data=null;
Idle.option={general:"any",index:"Daily",alchemy:"Daily",quests:"Never",town:"Never",battle:"Daily"};Idle.when=["Never","Hourly","2 Hours","6 Hours","12 Hours","Daily","Weekly"];
Idle.display=[{label:"<strong>NOTE:</strong> Any workers below this will <strong>not</strong> run!<br>Use this for disabling workers you do not use."},{id:"general",label:"Idle General",select:"generals"},{label:"Check Pages:"},{id:"index",label:"Home Page",select:Idle.when},{id:"alchemy",label:"Alchemy",select:Idle.when},{id:"quests",label:"Quests",select:Idle.when},{id:"town",label:"Town",select:Idle.when},{id:"battle",label:"Battle",select:Idle.when}];
Idle.work=function(b){var a,c,d={index:["index"],alchemy:["keep_alchemy"],quests:["quests_quest1","quests_quest2","quests_quest3","quests_quest4","quests_quest5","quests_quest6","quests_demiquests","quests_atlantis"],town:["town_soldiers","town_blacksmith","town_magic","town_land"],battle:["battle_battle"]},e={Never:0,Hourly:36E5,"2 Hours":72E5,"6 Hours":216E5,"12 Hours":432E5,Daily:864E5,Weekly:6048E5};if(!b)return true;if(!Generals.to(Idle.option.general))return true;for(a in d)if(e[Idle.option[a]]){c=
Date.now()-e[Idle.option[a]];for(b=0;b<d[a].length;b++)if(!Page.data[d[a][b]]||Page.data[d[a][b]]<c)if(!Page.to(d[a][b]))return true}return true};var Income=new Worker("Income");Income.data=null;Income.option={general:true,bank:true,margin:30};Income.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true},{id:"margin",label:"Safety Margin",select:[15,30,45,60],suffix:"seconds"}];
Income.work=function(b){if(!Income.option.margin)return false;var a=new Date;a=Player.data.cash_time-(a.getSeconds()+a.getMinutes()*60);if(a<0)a+=3600;if(a>Income.option.margin){if(b&&Income.option.bank)return Bank.work(true);return false}if(!b)return true;if(Income.option.general&&!Generals.to(Generals.best("income")))return true;GM_debug("Income: Waiting for Income... ("+a+" seconds)");return true};var Monster=new Worker("Monster","keep_monster keep_monster_active");Monster.option={fortify:50,choice:"All"};
Monster.display=[{label:"Work in progress..."},{id:"fortify",label:"Fortify Below",select:[10,20,30,40,50,60,70,80,90,100],after:"%"},{label:'"All" is currently Random...'},{id:"choice",label:"Attack",select:["All","Strongest","Weakest","Shortest"]}];
Monster.types={colossus:{list:"stone_giant_list",image:"stone_giant",timer:259200,mpool:1},legion:{list:"castle_siege_list",image:"castle_siege",timer:604800,mpool:3},raid:{list:"deathrune_list2",image:"deathrune",mpool:1},serpent:{list:"seamonster_list_red",image:"seamonster_red",timer:259200,mpool:2}};Monster.count=0;Monster.onload=function(){var b,a;for(b in Monster.data)for(a in Monster.data[b])Monster.data[b][a].state==="engage"&&Monster.count++;Monster.Dashboard()};
Monster.parse=function(){var b,a,c,d;if(Page.page==="keep_monster_active"){a=$('img[linked="true"][size="square"]').attr("uid");for(b in Monster.types)if($('img[src*="'+Monster.types[b].image+'"]').length){c=b;break}if(!a||!c){GM_debug("Monster: Unknown monster");return false}b=$('img[src$="monster_health_background.jpg"]').parent();Monster.data[a][c].health=b.width()/b.parent().width()*100;b=$('img[src$="seamonster_ship_health.jpg"]').parent();if(b.length)Monster.data[a][c].defense=b.width()/(b.next().length?
b.width()+b.next().width():b.parent().width())*100;Monster.data[a][c].timer=$("#app"+APP+"_monsterTicker").text().parseTimer();d={};$('td.dragonContainer table table a[href^="http://apps.facebook.com/castle_age/keep.php?user="]').each(function(e,f){e=$(f).attr("href").regex(/user=([0-9]+)/i);var g=$(f).parent().next().text().replace(/[^0-9\/]/g,"");f=g.regex(/([0-9]+)/);g=g.regex(/\/([0-9]+)/);d[e]=g?[f,g]:f});Monster.data[a][c].damage=d}else if(Page.page==="keep_monster"){for(b in Monster.data)for(a in Monster.data[b])Monster.data[b][a].state=
null;$('img[src*="dragon_list_btn_"]').each(function(e,f){var g=$(f).parent().attr("href").regex(/user=([0-9]+)/i),j=$(f).parent().parent().parent().prev().prev().html().regex(/graphics\/(.*)\./i),i="unknown";for(e in Monster.types)if(j===Monster.types[e].list){i=e;break}if(!(!g||i==="unknown")){Monster.data[g]=Monster.data[g]||{};Monster.data[g][i]=Monster.data[g][i]||{};switch($(f).attr("src").regex(/dragon_list_btn_([0-9])/)){case 2:Monster.data[g][i].state="reward";break;case 3:Monster.data[g][i].state=
"engage";break;case 4:Monster.data[g][i].state="complete";break;default:Monster.data[g][i].state="unknown";break}}});Monster.count=0;for(b in Monster.data){for(a in Monster.data[b])if(Monster.data[b][a].state)Monster.data[b][a].state==="engage"&&Monster.count++;else delete Monster.data[b][a];length(Monster.data[b])||delete Monster.data[b]}}Monster.Dashboard();return false};
Monster.work=function(b){var a=[],c=Monster.option.uid,d=Monster.option.type,e=null;if(!b){Monster.option.uid=null;Monster.option.type=null}if(!length(Monster.data)||Player.data.health<=10)return false;if(!c||!d||!Monster.data[c]||Monster.data[c][d].state!=="engage"){for(c in Monster.data)for(d in Monster.data[c])if(Monster.data[c][d].state==="engage")if(Monster.option.choice==="All")a.push([c,d]);else if(!e||Monster.option.choice==="Strongest"&&Monster.data[c][d].health>Monster.data[e[0]][e[1]].health||
Monster.option.choice==="Weakest"&&Monster.data[c][d].health<Monster.data[e[0]][e[1]].health||Monster.option.choice==="Shortest"&&Monster.data[c][d].timer<Monster.data[e[0]][e[1]].timer)e=[c,d];if(Monster.option.choice==="All"&&a.length)e=a[Math.floor(Math.random()*a.length)];if(!e)return false;c=Monster.option.uid=e[0];d=Monster.option.type=e[1]}if(Queue.burn.stamina<5&&(Queue.burn.energy<10||typeof Monster.data[c][d].defense==="undefined"||Monster.data[c][d].defense>=Monster.option.fortify))return false;
if(!b)return true;if(Monster.data[c][d].defense&&Monster.data[c][d].defense<=Monster.option.fortify&&Queue.burn.energy>=10){if(!Generals.to(Generals.best("defend")))return true;GM_debug("Monster: Fortify "+c);b=$('input[src$="attack_monster_button3.jpg"],input[src$="seamonster_fortify.gif"]').eq(0)}else{if(!Generals.to(Generals.best("duel")))return true;GM_debug("Monster: Attack "+c);b=$('input[src$="attack_monster_button2.jpg"],input[src$="seamonster_power.gif"],input[src$="attack_monster_button.jpg"]').eq(0)}if(!b.length&&
!Page.to("keep_monster","?user="+c+"&mpool="+Monster.types[d].mpool))return true;Page.click(b);return true};
Monster.Dashboard=function(){var b,a,c,d,e=[],f,g;e.push('<table><thead><tr><th>UserID</th><th>State</th><th>Type</th><th title="(estimated)">Health</th><th>Fortify</th><th>Time Left...</th><th title="(estimated)">Kill In...</th></tr></thead><tbody>');for(b in Monster.data){d=0;for(a in Monster.data[b]){for(c in Monster.data[b][a].damage)d+=typeof Monster.data[b][a].damage[c]==="number"?Monster.data[b][a].damage[c]:Monster.data[b][a].damage[c][0];if(Monster.data[b][a].state==="engage"){f=d/(Monster.types[a].timer-
Monster.data[b][a].timer);g=Math.floor(d/(100-Monster.data[b][a].health)*100);f=Math.floor(g/f);e.push("<tr><td>"+b+"</td><td>"+Monster.data[b][a].state+"</td><td>"+a+'</td><td title="Damage: '+d+" ("+Math.floor(100-Monster.data[b][a].health)+'%)">'+(g-d)+" ("+Math.floor(Monster.data[b][a].health)+"%)</td><td>"+(Monster.data[b][a].defense?Math.floor(Monster.data[b][a].defense)+"%":"")+'</td><td><span class="golem-timer">'+makeTimer(Monster.data[b][a].timer)+'</span></td><td><span class="golem-timer">'+
makeTimer(f)+"</span></td></tr>")}else e.push("<tr><td>"+b+"</td><td>"+Monster.data[b][a].state+"</td><td>"+a+"</td></tr>")}}e.push("</tbody></table>");$("#golem-dashboard-monster").html(e.join(""))};var Page=new Worker("Page");Page.unsortable=true;Page.option={timeout:15,retry:5};Page.page="";Page.last=null;Page.lastclick=null;Page.when=null;Page.retry=0;Page.checking=true;
Page.display=[{id:"timeout",label:"Retry after",select:[10,15,30,60],after:"seconds"},{id:"retry",label:"Reload after",select:[2,3,5,10],after:"tries"}];
Page.work=function(b){if(!Page.checking)return false;var a,c,d,e=null;for(a=0;a<Workers.length&&!e;a++)if(!(!Workers[a].pages||Workers[a].pages==="*")){d=Workers[a].pages.split(" ");for(c=0;c<d.length;c++)if(Page.pageNames[d[c]]&&!Page.data[d[c]]&&d[c].indexOf("_active")===-1){e=d[c];break}}if(!b){if(e)return true;return Page.checking=false}if(e&&!Page.to(e))return true;return false};
Page.pageNames={index:{url:"index.php",image:null},quests_quest:{url:"quests.php",image:"tab_quest_on.gif"},quests_quest1:{url:"quests.php?land=1",image:"land_fire_sel.gif"},quests_quest2:{url:"quests.php?land=2",image:"land_earth_sel.gif"},quests_quest3:{url:"quests.php?land=3",image:"land_mist_sel.gif"},quests_quest4:{url:"quests.php?land=4",image:"land_water_sel.gif"},quests_quest5:{url:"quests.php?land=5",image:"land_demon_realm_sel.gif"},quests_quest6:{url:"quests.php?land=6",image:"land_undead_realm_sel.gif"},
quests_demiquests:{url:"symbolquests.php",image:"demi_quest_on.gif"},quests_atlantis:{url:"monster_quests.php",image:"tab_atlantis_on.gif"},battle_battle:{url:"battle.php",image:"battle_on.gif"},battle_training:{url:"battle_train.php",image:"training_grounds_on_new.gif"},battle_rank:{url:"battlerank.php",image:"tab_battle_rank_on.gif"},battle_raid:{url:"raid.php",image:"tab_raid_on.gif"},heroes_heroes:{url:"mercenary.php",image:"tab_heroes_on.gif"},heroes_generals:{url:"generals.php",image:"tab_generals_on.gif"},
town_soldiers:{url:"soldiers.php",image:"tab_soldiers_on.gif"},town_blacksmith:{url:"item.php",image:"tab_black_smith_on.gif"},town_magic:{url:"magic.php",image:"tab_magic_on.gif"},town_land:{url:"land.php",image:"tab_land_on.gif"},oracle_oracle:{url:"oracle.php",image:"oracle_on.gif"},oracle_demipower:{url:"symbols.php",image:"demi_on.gif"},oracle_treasurealpha:{url:"treasure_chest.php",image:"tab_treasure_alpha_on.gif"},oracle_treasurevanguard:{url:"treasure_chest.php?treasure_set=alpha",image:"tab_treasure_vanguard_on.gif"},
keep_stats:{url:"keep.php?user="+userID,image:"tab_stats_on.gif"},keep_eliteguard:{url:"party.php?user="+userID,image:"tab_elite_guard_on.gif"},keep_achievements:{url:"achievements.php",image:"tab_achievements_on.gif"},keep_alchemy:{url:"alchemy.php",image:"tab_alchemy_on.gif"},keep_monster:{url:"battle_monster.php",image:"tab_monster_on.jpg"},keep_monster_active:{url:"battle_monster.php",image:"dragon_view_more.gif"},army_invite:{url:"army.php",image:"invite_on.gif"},army_gifts:{url:"gift.php",image:null},
army_viewarmy:{url:"army_member.php",image:"view_army_on.gif"},army_sentinvites:{url:"army_reqs.php",image:"sent_invites_on.gif"}};
Page.identify=function(){Page.page="";$("#app"+APP+"_app_body img").each(function(b,a){var c;b=$(a).attr("src").filepart();for(c in Page.pageNames)if(b===Page.pageNames[c].image){Page.page=c;return}});if($("#app"+APP+"_indexNewFeaturesBox").length)Page.page="index";else if($('div[style*="giftpage_title.jpg"]').length)Page.page="army_gifts";if(Page.page!=="")Page.data[Page.page]=Date.now();return Page.page};
Page.to=function(b,a){if(b===Page.page&&typeof a==="undefined")return true;a||(a="");if(b&&Page.pageNames[b]&&Page.pageNames[b].url){Page.clear();Page.last=Page.pageNames[b].url+a;Page.when=Date.now();GM_debug("Navigating to "+Page.last+" ("+Page.pageNames[b].url+")");if(unsafeWindow["a"+APP+"_get_cached_ajax"])unsafeWindow["a"+APP+"_get_cached_ajax"](Page.last,"get_body");else window.location.href="http://apps.facebook.com/castle_age/index.php?bm=1"}return false};
Page.click=function(b){if(!$(b).length){GM_debug("Page.click: Unable to find element - "+b);return false}var a=document.createEvent("MouseEvents");a.initEvent("click",true,true);$(b).get(0).wrappedJSObject.dispatchEvent(a);Page.clear();Page.lastclick=b;Page.when=Date.now();return true};Page.clear=function(){Page.last=Page.lastclick=Page.when=null;Page.retry=0};
Page.loading=function(){if(!unsafeWindow["a"+APP+"_get_cached_ajax"]){if(!Page.when||Date.now()-Page.when>=Page.option.timeout*Page.option.retry*1E3){Page.when=Date.now();window.location.href="http://apps.facebook.com/castle_age/index.php"}GM_debug("Page not loaded correctly, reloading.");return true}if($("#app"+APP+"_AjaxLoadIcon").css("display")==="none"){Page.when&&Date.now()-Page.when>Page.option.timeout*1E3&&Page.clear();return false}if(Page.when&&Date.now()-Page.when>=Page.option.timeout*1E3){GM_debug("Page.loading for 15+ seconds - retrying...");
Page.when=Date.now();if(Page.retry++>=Page.option.retry){GM_debug("Page.loading for 1+ minutes - reloading...");window.location.href="http://apps.facebook.com/castle_age/index.php"}else if(Page.last)unsafeWindow["a"+APP+"_get_cached_ajax"](Page.last,"get_body");else Page.lastclick&&Page.click(Page.lastclick)}return true};Page.reload=function(){if(!Page.when||Date.now()-Page.when>=Page.option.timeout*Page.option.retry*1E3)Page.to(Page.page||"index","")};var Player=new Worker("Player","*");
Player.option=null;Player.panel=null;Player.onload=function(){var b=new Date(script_started+$("*").html().regex(/gold_increase_ticker\(([0-9]+),/)*1E3);Player.data.cash_time=b.getSeconds()+b.getMinutes()*60};
Player.parse=function(){if(!$("#app"+APP+"_app_body_container").length){Page.reload();return false}var b=Player.data,a;b.FBID=unsafeWindow.Env.user;b.cash=parseInt($("strong#app"+APP+"_gold_current_value").text().replace(/[^0-9]/g,""),10);b.energy=$("#app"+APP+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);b.maxenergy=$("#app"+APP+"_energy_current_value").parent().text().regex(/[0-9]+\s*\/\s*([0-9]+)/);b.health=$("#app"+APP+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);
b.maxhealth=$("#app"+APP+"_health_current_value").parent().text().regex(/[0-9]+\s*\/\s*([0-9]+)/);b.stamina=$("#app"+APP+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);b.maxstamina=$("#app"+APP+"_stamina_current_value").parent().text().regex(/[0-9]+\s*\/\s*([0-9]+)/);b.exp=$("#app"+APP+"_st_2_5").text().regex(/([0-9]+)\s*\/\s*[0-9]+/);b.maxexp=$("#app"+APP+"_st_2_5").text().regex(/[0-9]+\s*\/\s*([0-9]+)/);b.level=$("#app"+APP+"_st_5").text().regex(/Level: ([0-9]+)!/i);b.armymax=
$("a[href*=army.php]","#app"+APP+"_main_bntp").text().regex(/([0-9]+)/);b.army=Math.min(b.armymax,501);b.upgrade=$("a[href*=keep.php]","#app"+APP+"_main_bntp").text().regex(/([0-9]+)/)||0;b.general=$("div.general_name_div3").first().text().trim();b.imagepath=$("div.general_pic_div3 img").attr("src").pathpart();if(Page.page==="keep_stats"){a=$("div.keep_attribute_section").first();if(a.length){b.myname=$("div.keep_stat_title > span",a).text().regex(/"(.*)"/);b.rank=$("td.statsTMainback img[src*=rank_medals]").attr("src").filepart().regex(/([0-9]+)/);
a=$("div.attribute_stat_container",a);b.attack=$(a).eq(2).text().regex(/([0-9]+)/);b.defense=$(a).eq(3).text().regex(/([0-9]+)/);b.bank=parseInt($("td.statsTMainback b.money").text().replace(/[^0-9]/g,""),10)}}return false};
Player.work=function(){Player.data.cash=parseInt($("strong#app"+APP+"_gold_current_value").text().replace(/[^0-9]/g,""),10);var b=new Date;b=Player.data.cash_time-(b.getSeconds()+b.getMinutes()*60);if(b<0)b+=3600;Player.data.cash_timer=b;Player.data.energy=$("#app"+APP+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);Player.data.energy_timer=$("#app"+APP+"_energy_time_value").text().parseTimer();Player.data.health=$("#app"+APP+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);
Player.data.health_timer=$("#app"+APP+"_health_time_value").text().parseTimer();Player.data.stamina=$("#app"+APP+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);Player.data.stamina_timer=$("#app"+APP+"_stamina_time_value").text().parseTimer()};
Player.select=function(){var b=Divisor(Player.data.maxstamina);$("select.golem_stamina").each(function(a,c){$(c).empty();var d=(a=$(c).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(a[0]).option[a[1]]:null;for(a=0;a<=Player.data.maxstamina;a+=b)$(c).append('<option value="'+a+'"'+(d==a?" selected":"")+">"+a+"</option>")});b=Divisor(Player.data.maxenergy);$("select.golem_energy").each(function(a,c){$(c).empty();var d=(a=$(c).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?
WorkerByName(a[0]).option[a[1]]:null;for(a=0;a<=Player.data.maxenergy;a+=b)$(c).append('<option value="'+a+'"'+(d==a?" selected":"")+">"+a+"</option>")});b=Divisor(Player.data.maxhealth);$("select.golem_health").each(function(a,c){$(c).empty();var d=(a=$(c).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(a[0]).option[a[1]]:null;for(a=0;a<=Player.data.maxhealth;a+=b)$(c).append('<option value="'+a+'"'+(d==a?" selected":"")+">"+a+"</option>")})};var Quest=new Worker("Quest","quests_quest1 quests_quest2 quests_quest3 quests_quest4 quests_quest5 quests_quest6 quests_demiquests quests_atlantis");
Quest.option={general:"Under Level 4",what:"Influence",monster:true};Quest.land=["fire","earth","mist","water","demon","undead"];Quest.current=null;Quest.display=[{id:"general",label:"General",select:["any","Under Level 4","Influence"]},{id:"what",label:"Quest for",select:"quest_reward"},{id:"monster",label:"Fortify Monsters First",checkbox:true},{id:"current",label:"Current",info:"None"}];
Quest.parse=function(b){var a=Quest.data,c,d=null;switch(Page.page){case "quests_quest":case "quests_quest1":case "quests_quest2":case "quests_quest3":case "quests_quest4":case "quests_quest5":case "quests_quest6":c="quest";d=$('div.title_tab_selected img[id^="app'+APP+'_land_image"]').attr("id").regex(/_image([0-9]+)$/,"");break;case "quests_demiquests":c="demiquest";break;case "quests_atlantis":c="atlantis";break;default:return false}if(!b){$("div.quests_background,div.quests_background_sub").each(function(e,
f){var g,j,i,h;if($(f).hasClass("quests_background")){e=$("div.qd_1 b",f).text().trim();g=$("div.quest_progress",f).text().regex(/LEVEL ([0-9]+) INFLUENCE: ([0-9]+)%/i);j=$("div.qd_2",f).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);h=$("div.quest_req b",f).text().regex(/([0-9]+)/)}else{e=$("div.quest_sub_title",f).text().trim();g=$("div.quest_sub_progress",f).text().regex(/LEVEL ([0-9]+) INFLUENCE: ([0-9]+)%/i);j=$("div.qd_2_sub",f).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);
h=$("div.qd_3_sub",f).text().regex(/([0-9]+)/)}if(e){a[e]={};a[e].area=c;if(d)a[e].land=d;if(g){a[e].level=g[0];a[e].influence=g[1]}else a[e].level=a[e].influence=0;a[e].exp=j.shift();a[e].reward=(j[0]+j[1])/2;a[e].energy=h;if($(f).hasClass("quests_background")){if($("div.qd_1 img",f).attr("title"))a[e].item=$("div.qd_1 img",f).attr("title").trim();if($("div.quest_act_gen img",f).attr("title"))a[e].general=$("div.quest_act_gen img",f).attr("title");i={};$("div.quest_req > div > div > div",f).each(function(k,
n){k=$("img",n).attr("title");i[k]=$(n).text().regex(/([0-9]+)/)});if(i.length)a[e].units=i}}});Quest.select()}return false};
Quest.select=function(){var b,a=["Nothing","Influence","Experience","Cash"];for(b in Quest.data)Quest.data[b].item&&a.push(Quest.data[b].item);$("select.golem_quest_reward").each(function(c,d){$(d).empty();var e=(c=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(c[0]).option[c[1]]:null;for(c=0;c<a.length;c++)$(d).append('<option value="'+a[c]+'"'+(a[c]===e?" selected":"")+">"+a[c]+"</value>")})};
Quest.work=function(b){var a,c=null;if(Quest.option.what==="Nothing")return false;for(a in Quest.data){switch(Quest.option.what){case "Influence":if(Quest.data[a].influence>=100||c&&Quest.data[a].energy>=Quest.data[c].energy)continue;break;case "Experience":if(c&&Quest.data[a].energy/Quest.data[a].exp>=Quest.data[c].energy/Quest.data[c].exp)continue;break;case "Cash":if(c&&Quest.data[a].energy/Quest.data[a].reward>=Quest.data[c].energy/Quest.data[c].reward)continue;break;default:if(!Quest.data[a].item||
Quest.data[a].item!==Quest.option.what||c&&Quest.data[a].energy>Quest.data[c].energy)continue;break}c=a}if(c!==Quest.current)if(Quest.current=c){GM_debug("Quest: Wanting to perform - "+c+" (energy: "+Quest.data[c].energy+")");$("#"+PREFIX+"Quest_current").html(""+c+" (energy: "+Quest.data[c].energy+")")}if(Quest.option.monster&&Monster.count&&Queue.burn.energy<=10)return false;if(!c||Quest.data[c].energy>Queue.burn.energy)return false;if(!b)return true;if(Quest.data[c].general){if(!Generals.to(Quest.data[c].general))return true}else if(!Generals.to(Generals.best(Quest.option.general)))return true;
switch(Quest.data[c].area){case "quest":if(!Page.to("quests_quest"+Quest.data[c].land))return true;break;case "demiquest":if(!Page.to("quests_demiquests"))return true;break;case "atlantis":if(!Page.to("quests_atlantis"))return true;break;default:GM_debug("Quest: Can't get to quest area!");return false}GM_debug("Quest: Performing - "+c+" (energy: "+Quest.data[c].energy+")");Page.click('div.action[title^="'+c+'"] input[type="image"]')||Page.reload();return true};var Queue=new Worker("Queue","*");
Queue.data={current:null};Queue.option={delay:5,clickdelay:5,queue:["Page","Queue","Income","Quest","Monster","Battle","Heal","Bank","Alchemy","Town","Blessing","Gift","Upgrade","Idle","Raid"],stamina:0,energy:0};
Queue.display=[{label:"Drag the other panels into the order you wish them run."},{id:"delay",label:"Delay Between Events",text:true,after:"secs",size:3},{id:"clickdelay",label:"Delay After Mouse Click",text:true,after:"secs",size:3},{id:"stamina",label:"Keep Stamina",select:"stamina"},{id:"energy",label:"Keep Energy",select:"energy"}];Queue.runfirst=[];Queue.unsortable=true;Queue.lastclick=Date.now();Queue.lastrun=Date.now();Queue.burn={stamina:false,energy:false};
Queue.onload=function(){var b,a,c={};for(b=0;b<Queue.option.queue.length;b++)if(a=WorkerByName(Queue.option.queue[b]))c[a.name]=true;for(b in Workers)if(!(c[Workers[b].name]||!Workers[b].work||!Workers[b].display)){GM_log("Adding "+Workers[b].name+" to Queue");Workers[b].unsortable?Queue.option.queue.unshift(Workers[b].name):Queue.option.queue.push(Workers[b].name)}for(b=0;b<Queue.option.queue.length;b++)if((a=WorkerByName(Queue.option.queue[b]))&&a.priv_id){if(Queue.data.current&&a.name===Queue.data.current){GM_debug("Queue: Trigger "+
a.name+" (continue after load)");$("#"+a.priv_id+" > h3").css("font-weight","bold")}$("#golem_config").append($("#"+a.priv_id))}$(document).click(function(){Queue.lastclick=Date.now()});$btn=$('<button id="golem_pause">pause</button>').button({text:false,icons:{primary:Queue.option.pause?"ui-icon-play":"ui-icon-pause"}}).click(function(){Queue.option.pause^=true;GM_debug("State: "+(Queue.option.pause?"paused":"running"));$(this).button("option",{icons:{primary:Queue.option.pause?"ui-icon-play":"ui-icon-pause"}});
Page.clear();Config.updateOptions()});$("#golem_buttons").prepend($btn)};
Queue.run=function(){var b,a,c=false,d=Date.now();if(!(Queue.option.pause||d-Queue.lastclick<Queue.option.clickdelay*1E3||d-Queue.lastrun<Queue.option.delay*1E3)){Queue.lastrun=d;if(!Page.loading()){Queue.burn.stamina=Math.max(0,Player.data.stamina-Queue.option.stamina);Queue.burn.energy=Math.max(0,Player.data.energy-Queue.option.energy);for(b in Workers)Workers[b].work&&!Workers[b].display&&Workers[b].work(false);for(b=0;b<Queue.option.queue.length;b++){a=WorkerByName(Queue.option.queue[b]);if(!(!a||
!a.work||!a.display))if(a.work(Queue.data.current===a.name)){Settings.Save(a);if(!c){c=true;if(Queue.data.current!==a.name){a.priv_since=d;if(Queue.data.current){GM_debug("Queue: Interrupt "+Queue.data.current);WorkerByName(Queue.data.current).priv_id&&$("#"+WorkerByName(Queue.data.current).priv_id+" > h3").css("font-weight","normal")}Queue.data.current=a.name;a.priv_id&&$("#"+a.priv_id+" > h3").css("font-weight","bold");GM_debug("Queue: Trigger "+a.name)}}}else{Settings.Save(a);if(Queue.data.current===
a.name){Queue.data.current=null;a.priv_id&&$("#"+a.priv_id+" > h3").css("font-weight","normal");GM_debug("Queue: End "+a.name)}}}Settings.Save(Queue)}}};Raid=new Worker("Raid","battle_raid",{stamina:true});Raid.onload=function(){if(!Raid.option.type)Raid.option.type="Invade"};Raid.display=[{label:"Work in progress... Will be merged with main Monster section later"},{id:"general",label:"General",select:"generals"},{id:"type",label:"Attack Type",select:["Invade","Duel"]}];
Raid.parse=function(){if($('input[name="help with raid"]').length){var b=$('img[linked="true"][size="square"]').attr("uid"),a=$('img[src$="monster_health_background.jpg"]').parent();Raid.data[b].health=Math.ceil(a.width()/a.parent().width()*100);Raid.data[b].timer=$("#app"+APP+"_monsterTicker").text().parseTimer();var c={};$('td.dragonContainer table table a[href^="http://apps.facebook.com/castle_age/keep.php?user="]').each(function(e,f){e=$(f).attr("href").regex(/user=([0-9]+)/i);c[e]=parseInt($(f).parent().next().text().replace(/[^0-9]/g,
""))});Raid.data[b].damage=c}else{var d={};$('img[src$="dragon_list_btn_3.jpg"]').each(function(e,f){e=$(f).parent().attr("href").regex(/user=([0-9]+)/i);d[e]={}});for(b in d)Raid.data[b]||(Raid.data[b]={});for(b in Raid.data)d[b]||delete Raid.data[b]}return false};
Raid.work=function(b){if(!length(Raid.data))return false;if(Player.data.health<=10)return false;var a=null;for(var c in Raid.data)a=c;if(!a)return false;if(!b)return true;if(!Generals.to(Raid.option.general))return true;b=Raid.option.type=="Invade"?$('input[src$="raid_attack_button.gif"]:first'):$('input[src$="raid_attack_button2.gif"]:first');if(!b.length&&!Page.to("battle_raid","?user="+a))return true;b=Raid.option.type=="Invade"?$('input[src$="raid_attack_button.gif"]:first'):$('input[src$="raid_attack_button2.gif"]:first');
Page.click(b);return true};var Town=new Worker("Town","town_soldiers town_blacksmith town_magic town_land");Town.data={soldiers:{},blacksmith:{},magic:{},land:{}};Town.display=[{label:"Work in progress..."},{id:"general",label:"Buy Number:",select:["None","Maximum","Match Army"]},{id:"units",label:"Buy Type:",select:["All","Best Offense","Best Defense","Best of Both"]}];Town.units={};Town.cache={};Town.table=null;Town.header={};
Town.blacksmith={Weapon:/avenger|axe|blade|bow|dagger|halberd|mace|morningstar|rod|spear|staff|stave|sword|talon|trident|wand|Dragonbane|Ironhart's Might|Judgement|Oathkeeper/i,Shield:/buckler|shield|dreadnought|Defender|Sword of Redemption/i,Helmet:/cowl|crown|helm|horns|mask|veil/i,Gloves:/gauntlet|glove|hand/i,Armor:/armor|chainmail|cloak|pauldrons|plate|robe/i,Amulet:/amulet|bauble|charm|jewel|memento|orb|shard|trinket|Paladin's Oath|Poseidons Horn/i};
Town.parse=function(b){var a,c;if(b){if(Page.page==="town_blacksmith"){c=Town.data.blacksmith;$("tr.eq_buy_row,tr.eq_buy_row2").each(function(d,e){d=$("div.eq_buy_txt strong:first-child",e).text().trim();c[d].type&&$("div.eq_buy_txt strong:first-child",e).parent().append("<br>"+c[d].type)})}if(Page.page!=="town_land"){b=$('<tr><td><div style="padding:9px 0px 0px 15px; width:725px; height:28px;">Sort by <a id="sort_none">Normal</a> / <a id="sort_attack">Attack</a> / <a id="sort_defense">Defense</a></div></td></tr>');
$("div",b).css({backgroundImage:$('div[style*="hero_divider.gif"]').first().css("background-image"),color:"#fff",fontSize:"16px",fontWeight:"bold"});$("#sort_none",b).click(function(){Town.sortBy()});$("#sort_attack",b).click(function(){Town.sortBy("att")});$("#sort_defense",b).click(function(){Town.sortBy("def")});$(this.table).prepend(b)}}else{if(Page.page==="town_land"){a=Town.data.land={};b=$("tr.land_buy_row,tr.land_buy_row_unique");b.each(function(d,e){d=$("img",e).attr("alt");a[d]={};a[d].income=
$(".land_buy_info .gold",e).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);a[d].max=$(".land_buy_info",e).text().regex(/Max Allowed For your level: ([0-9]+)/i);a[d].cost=$(".land_buy_costs .gold",e).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);a[d].own=$(".land_buy_costs span",e).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)});GM_debug("Land: "+Town.data.land.toSource())}else{switch(Page.page){case "town_soldiers":c=Town.data.soldiers={};break;case "town_blacksmith":c=Town.data.blacksmith={};break;
case "town_magic":c=Town.data.magic={};break;default:return false}b=$("tr.eq_buy_row,tr.eq_buy_row2");b.each(function(d,e){var f,g=$("div.eq_buy_txt strong:first-child",e).text().trim();d=$("div.eq_buy_costs strong:first-child",e).text().replace(/[^0-9]/g,"");Town.cache[g]=e;c[g]={};if(d){c[g].cost=parseInt(d,10);c[g].buy=[];$('div.eq_buy_costs select[name="amount"]:first option',e).each(function(j,i){c[g].buy.push(parseInt($(i).val(),10))})}c[g].own=$("div.eq_buy_costs span:first-child",e).text().regex(/([0-9]+)/);
c[g].att=$("div.eq_buy_stats div:first-child",e).text().regex(/([0-9]+)/);c[g].def=$("div.eq_buy_stats div:last-child",e).text().regex(/([0-9]+)/);if(Page.page==="town_blacksmith")for(f in Town.blacksmith)if(g.match(Town.blacksmith[f]))c[g].type=f});Town.table=$(b).first().parent();this.header={};$(this.table).children().each(function(d,e){$(e).attr("class")||(Town.header[d]=[e,$(e).next()])});Town.units=c}Page.page!=="town_land"&&length(Town.data.soldiers)&&length(Town.data.blacksmith)&&length(Town.data.magic)&&
Town.getValues()}return true};
Town.work=function(b){if(!Town.option.number)return false;var a,c,d=Math.min(Town.option.number==="Maximum"?501:Player.data.army,501),e=null,f=0,g=Town.data.soldiers;for(a in g){f=0;if(!(!g[a].cost||g[a].own>=d||e&&Town.option.units==="Best Offense"&&g[a].att<=e.att||e&&Town.option.units==="Best Defense"&&g[a].def<=e.def||e&&Town.option.units==="Best of Both"&&(g[a].att<=e.att||g[a].def<=e.def))){for(c in g[a].buy)if(d-g[a].own>=g[a].buy[c])f=g[a].buy[c];GM_debug("Thinking about buying: "+f+" of "+
a+" at $"+f*g[a].cost);if(f){e=a;break}}}if(!e)return false;if(!b){GM_debug("Want to buy "+f+" x "+e+" at $"+f*g[e].cost);return true}return false};
Town.sortBy=function(b){var a,c=[],d=b==="att"?"def":"att";if(b){for(a in Town.units)c.push(a);c.sort(function(e,f){return Town.units[f][b]+0.7*Town.units[f][d]-(Town.units[e][b]+0.7*Town.units[e][d])});for(a=0;a<c.length;a++)$(Town.table).append($(Town.cache[c[a]]));for(a in Town.header)$(Town.header[a]).css("display","none")}else{for(a in Town.units)$(Town.table).append($(Town.cache[a]));for(a in Town.header){$($(Town.header[a][1])).before($(Town.header[a][0]));$(Town.header[a][0]).css("display",
"table-row")}}};
Town.getValues=function(){var b=function(i,h){i.push(h)},a=function(i,h,k){k[h].type==="Weapon"&&i.push(h)},c=function(i,h,k){k[h].type!=="Weapon"&&i.push(h)},d=function(i,h,k){k[h].type==="Shield"&&i.push(h)},e=function(i,h,k){k[h].type==="Helmet"&&i.push(h)},f=function(i,h,k){k[h].type==="Gloves"&&i.push(h)},g=function(i,h,k){k[h].type==="Armor"&&i.push(h)},j=function(i,h,k){k[h].type==="Amulet"&&i.push(h)};Town.data.invade={attack:getAttDef(Town.data.soldiers,b,"att",Player.data.army,"invade")+
getAttDef(Town.data.blacksmith,a,"att",Player.data.army,"invade")+getAttDef(Town.data.blacksmith,c,"att",Player.data.army,"invade")+getAttDef(Town.data.magic,b,"att",Player.data.army,"invade"),defend:getAttDef(Town.data.soldiers,b,"def",Player.data.army,"invade")+getAttDef(Town.data.blacksmith,a,"def",Player.data.army,"invade")+getAttDef(Town.data.blacksmith,c,"def",Player.data.army,"invade")+getAttDef(Town.data.magic,b,"def",Player.data.army,"invade")};Town.data.duel={attack:getAttDef(Town.data.blacksmith,
a,"att",1,"duel")+getAttDef(Town.data.blacksmith,d,"att",1,"duel")+getAttDef(Town.data.blacksmith,e,"att",1,"duel")+getAttDef(Town.data.blacksmith,f,"att",1,"duel")+getAttDef(Town.data.blacksmith,g,"att",1,"duel")+getAttDef(Town.data.blacksmith,j,"att",1,"duel")+getAttDef(Town.data.magic,b,"att",1,"duel"),defend:getAttDef(Town.data.blacksmith,a,"def",1,"duel")+getAttDef(Town.data.blacksmith,d,"def",1,"duel")+getAttDef(Town.data.blacksmith,e,"def",1,"duel")+getAttDef(Town.data.blacksmith,f,"def",1,
"duel")+getAttDef(Town.data.blacksmith,g,"def",1,"duel")+getAttDef(Town.data.blacksmith,j,"def",1,"duel")+getAttDef(Town.data.magic,b,"def",1,"duel")}};var Update=new Worker("Update");Update.data=null;Update.option=null;Update.found=false;Update.onload=function(){var b=$('<button name="Script Update" id="golem_update">Check</button>').button().click(function(){Update.now(true)});$("#golem_buttons").append(b)};
Update.now=function(b){if(Update.found)window.location.href="http://userscripts.org/scripts/source/67412.user.js";else{var a=Settings.GetValue("lastUpdateCheck",0);if(b||Date.now()-a>864E5){Settings.SetValue("lastUpdateCheck",Date.now().toString());GM_xmlhttpRequest({method:"GET",url:"http://userscripts.org/scripts/show/67412",onload:function(c){if(c.readyState===4&&c.status===200){c=$(c.responseText);c=$("#summary",c).text().regex(/Version:[^0-9.]+([0-9.]+)/i);b&&$("#golem_request").remove();if(c>
VERSION){Update.found=true;$("#golem_update span").text("Install");if(b){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There is a new version of Castle Age Golem available.</p><p>Current&nbsp;version:&nbsp;'+VERSION+", New&nbsp;version:&nbsp;"+c+"</p></div>");$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close");window.location.href="http://userscripts.org/scripts/source/67412.user.js"},Skip:function(){$(this).dialog("close")}}})}GM_log("New version available: "+
c)}else if(b){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There are no new versions available.</p></div>');$("#golem_request").dialog({modal:true,buttons:{Ok:function(){$(this).dialog("close")}}})}}}})}}};var Upgrade=new Worker("Upgrade","keep_stats");Upgrade.data={run:0};
Upgrade.display=[{label:"Points will be allocated in this order, add multiple entries if wanted (ie, 3x Attack and 1x Defense would put &frac34; on Attack and &frac14; on Defense)"},{id:"order",multiple:["Energy","Stamina","Attack","Defense","Health"]}];Upgrade.parse=function(){var b=$("div.results");if(Upgrade.data.working&&b.length&&b.text().match(/You just upgraded your/i)){Upgrade.data.working=false;Upgrade.data.run++;if(Upgrade.data.run>=Upgrade.option.order.length)Upgrade.data.run=0}return false};
Upgrade.work=function(b){if(!Upgrade.option.order||!Upgrade.option.order.length||!Player.data.upgrade||Upgrade.option.order[Upgrade.data.run]==="Stamina"&&Player.data.upgrade<2)return false;if(!b||!Page.to("keep_stats"))return true;Upgrade.data.working=true;if(Upgrade.data.run>=Upgrade.option.order.length)Upgrade.data.run=0;switch(Upgrade.option.order[Upgrade.data.run]){case "Energy":if(Page.click('a[href$="?upgrade=energy_max"]'))return true;break;case "Stamina":if(Page.click('a[href$="?upgrade=stamina_max"]'))return true;
break;case "Attack":if(Page.click('a[href$="?upgrade=attack"]'))return true;break;case "Defense":if(Page.click('a[href$="?upgrade=defense"]'))return true;break;case "Health":if(Page.click('a[href$="?upgrade=health_max"]'))return true;break}Page.reload();return true};
