// ==UserScript==
// @name		Rycochet's Castle Age Golem
// @namespace	golem
// @description	Auto player for castle age game
// @license		GNU Lesser General Public License; http://www.gnu.org/licenses/lgpl.html
// @version		30.7
// @include		http*://apps.*facebook.com/castle_age/*
// @require		http://cloutman.com/jquery-latest.min.js
// @require		http://cloutman.com/jquery-ui-latest.min.js
// ==/UserScript==
// 
// For the source code please check the sourse repository
// - http://code.google.com/p/game-golem/
// 
// For the unshrunk Work In Progress version (which may introduce new bugs)
// - http://game-golem.googlecode.com/svn/trunk/_normal.user.js
var show_debug=true,VERSION=30.7,script_started=Date.now(),userID=0,imagepath="",applications={castle_age:["46755028429","Castle Age"]};if(window.location.hostname==="apps.facebook.com"||window.location.hostname==="apps.new.facebook.com")for(var i in applications)if(window.location.pathname.indexOf(i)===1){var APP=i,APPID=applications[i][0],APPNAME=applications[i][1],PREFIX="golem"+APPID+"_";break}var log=console.log,debug=show_debug?console.log:function(){};
if(typeof unsafeWindow==="undefined")unsafeWindow=window;typeof APP!=="undefined"&&$(document).ready(function(){var a;userID=$("head").html().regex(/user:([0-9]+),/i);imagepath=$("#app"+APPID+"_globalContainer img:eq(0)").attr("src").pathpart();do_css();Page.identify();for(a=0;a<Workers.length;a++)Workers[a]._load();for(a=0;a<Workers.length;a++)Workers[a]._init();for(a=0;a<Workers.length;a++){Workers[a]._update();Workers[a]._flush()}Page.parse_all()});
function do_css(){$("head").append("<style type=\"text/css\">.red { background: red !important; }.golem-config { float: none; margin-right: 0; }.golem-config > div { position: static; width: 196px; margin: 0; padding: 0; overflow: hidden; overflow-y: auto; }.golem-config #golem_fixed { float:right; margin:-2px; width:16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00.IDATx%DAb%60A%03%0Cd%0B03%81%18LH%02%10%80%2C%C0%84%24%00%96d%C2%A7%02%AB%19L%8C%A8%B6P%C3%E9%08%00%10%60%00%00z%03%C7%24%170%91%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-config-fixed { float: right; margin-right: 200px; }.golem-config-fixed > div { position: fixed; }.golem-config-fixed #golem_fixed { background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%005IDATx%DAb%60A%03%0C%C4%0901%83%00%13%92%0A%B0%00%0B)%02%8C%CCLLL%CC%0Cx%0CefF%E8%81%B9%83%19%DDa%84%05H%F0%1C%40%80%01%00%FE9%03%C7%D4%8CU%A3%00%00%00%00IEND%AEB%60%82') no-repeat; }#golem-dashboard { position: absolute; width: 600px; height: 185px; margin: 0; border-left: 1px solid black; border-right:1px solid black; overflow: hidden; background: white; z-index: 1; }#golem-dashboard thead th { cursor: pointer }#golem-dashboard thead th.golem-sort:after { content: '&darr;'; }#golem-dashboard thead th.golem-sort-reverse:after { content: '&uarr;'; }#golem-dashboard tbody tr:nth-child(odd) { background: #eeeeee; }#golem-dashboard tbody th { text-align: left; font-weight: normal; }#golem-dashboard td, #golem-dashboard th { margin: 2px; text-align: center; padding: 0 8px; }#golem-dashboard > div { height: 163px; overflow-y: scroll; border-top: 1px solid #d3d3d3; }#golem-dashboard > div > div { padding: 2px; }#golem-dashboard .golem-status { width: 100%; }#golem-dashboard .golem-status tbody th { text-align: right; padding: 2px; font-weight: bold; }#golem-dashboard .golem-status tbody td { text-align: left; }#golem-dashboard .overlay { position: absolute; margin: 6px; color: #1fc23a; text-shadow: black 1px 1px 2px; }table.golem-graph { height: 100px }table.golem-graph tbody th { text-align: right; max-width: 75px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; border-right: 1px solid #cccccc; }table.golem-graph tbody th div { line-height: 60px; height: 60px; }table.golem-graph tbody th div:first-child, table.golem-graph tbody th div:last-child { line-height: 20px; height: 20px; }table.golem-graph tbody td { margin: 0; padding: 0 !important; vertical-align: bottom; width: 5px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; border-right: 1px solid #dddddd; }table.golem-graph tbody td:nth-child(12n+1) { border-right: 1px solid #cccccc; }table.golem-graph tbody td div { margin: 0; padding: 0; width: 5px; }table.golem-graph tbody th.goal { vertical-align: bottom; text-align: left; max-width: 75px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; border-right: 1px solid #dddddd; }.golem-button, .golem-button-active { border: 1px solid #d3d3d3; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; font-weight: normal; font-size: 13px; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-button:hover, .golem-button-active { border: 1px solid #aaaaaa; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }img.golem-button, img.golem-button-active { margin-bottom: -2px }.golem-tab-header { position: relative; top: 1px; border: 1px solid #d3d3d3; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 1px 2px; -moz-border-radius-topleft: 3px; -webkit-border-top-left-radius: 3px; border-top-left-radius: 3px; -moz-border-radius-topright: 3px; -webkit-border-top-right-radius: 3px; border-top-right-radius: 3px; }.golem-tab-header-active { border: 1px solid #aaaaaa; border-bottom: 0 !important; padding: 2px; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }.golem-title { padding: 4px; overflow: hidden; border-bottom: 1px solid #aaaaaa; background: #cccccc url(http://cloutman.com/css/base/images/ui-bg_highlight-soft_75_cccccc_1x100.png) 50% 50% repeat-x; color: #222222; font-weight: bold; }.golem-panel > .golem-panel-header, .golem-panel > * > .golem-panel-header { border: 1px solid #d3d3d3; cursor: pointer; margin-top: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-panel > .golem-panel-content, .golem-panel > * > .golem-panel-content { border: 1px solid #aaaaaa; border-top: 0 !important; padding: 2px 6px; background: #ffffff url(http://cloutman.com/css/base/images/ui-bg_glass_65_ffffff_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #212121; display: none; -moz-border-radius-bottomleft: 3px; -webkit-border-bottom-left-radius: 3px; border-bottom-left-radius: 3px; -moz-border-radius-bottomright: 3px; -webkit-border-bottom-right-radius: 3px; border-bottom-right-radius: 3px; }.golem-panel-show > .golem-panel-header, .golem-panel-show > * > .golem-panel-header { border: 1px solid #aaaaaa; border-bottom: 0 !important; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; -moz-border-radius-bottomleft: 0 !important; -webkit-border-bottom-left-radius: 0 !important; border-bottom-left-radius: 0 !important; -moz-border-radius-bottomright: 0 !important; -webkit-border-bottom-right-radius: 0 !important; border-bottom-right-radius: 0 !important; }.golem-panel-show > .golem-panel-content, .golem-panel-show > * > .golem-panel-content { display: block; }.golem-panel-sortable .golem-lock { display: none; }.golem-panel .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C%D4%13%60%C0%10%60%C0%10%60%C0%10%60%20%A4%82%90-%149%1D%20%C0%00%81%0E%00%F1%DE%25%95%BE%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-panel .golem-panel-header .golem-lock { float: right; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%001IDATx%DAb%60D%03%0CD%0B000%A0%0800%C0D%E0%02%8C(%02%0C%0Cp%25%B8%05%18%09%0A%A0j%C1%B4%96%1C%BF%C0%01%40%80%01%00n%11%00%CF%7D%2Bk%9B%00%00%00%00IEND%AEB%60%82') no-repeat;}.golem-panel-show .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C4%13%60%80%00%24%15%08%3EL%0B%9C%CF%88N%D3%D0a%C8%00%20%C0%00%7F%DE%00%F1%CCc%A6b%00%00%00%00IEND%AEB%60%82') no-repeat; }</style>")}
String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.filepart=function(){var a=this.lastIndexOf("/");if(a>=0)return this.substr(a+1);return this};String.prototype.pathpart=function(){var a=this.lastIndexOf("/");if(a>=0)return this.substr(0,a+1);return this};String.prototype.regex=function(a){a=this.match(a);var c;if(a){a.shift();for(c=0;c<a.length;c++)if(a[c]&&a[c].search(/^[-+]?[0-9]+\.?[0-9]*$/)>=0)a[c]=parseFloat(a[c]);if(a.length===1)return a[0]}return a};
String.prototype.toNumber=function(){return parseFloat(this)};String.prototype.parseTimer=function(){var a=this.split(":"),c=0,b;for(b=0;b<a.length;b++)c=c*60+parseInt(a[b],10);if(isNaN(c))c=9999;return c};Number.prototype.round=function(a){return result=Math.round(this*Math.pow(10,a||0))/Math.pow(10,a||0)};Math.range=function(a,c,b){return Math.max(a,Math.min(c,b))};
var makeTimer=function(a){var c=Math.floor(a/3600),b=Math.floor(a/60)%60;a=Math.floor(a%60);return(c?c+":"+(b>9?b:"0"+b):b)+":"+(a>9?a:"0"+a)},WorkerByName=function(a){for(var c=0;c<Workers.length;c++)if(Workers[c].name===a)return Workers[c];return null},WorkerById=function(a){for(var c=0;c<Workers.length;c++)if(Workers[c].id===a)return Workers[c];return null},Divisor=function(a){var c=a,b=1;if(c<20)return 1;for(;c>100;){c/=10;b*=10}if(a/b>40)b*=5;else if(a/b>20)b*=2.5;return b},length=function(a){var c=
0,b;if(typeof a==="object")for(b in a)c++;else if(typeof a==="array")c=a.length;return c},unique=function(a){var c={},b,d=a.length,e=[];for(b=0;b<d;b++)c[a[b]]=a[b];for(b in c)e.push(c[b]);return e},addCommas=function(a){a=a?a.toString():"0";for(var c=/(-?[0-9]+)([0-9]{3})/;c.test(a);)a=a.replace(c,"$1,$2");return a},findInArray=function(a,c){if(typeof a==="array"||typeof a==="object")for(var b in a)if(a[b]===c)return true;return false},sortObject=function(a,c){var b=[];for(i in a)b.push(i);b.sort(c);
return b},getAttDefList=[],getAttDef=function(a,c,b,d,e){var f=[],g=0,h=0,k=b==="att"?"def":"att",j;if(c)for(j in a)c(f,j,a);else f=getAttDefList;f.sort(function(m,l){return a[l][b]+0.7*a[l][k]-(a[m][b]+0.7*a[m][k])});for(j=0;j<f.length;j++){c=typeof a[f[j]].own==="number"?a[f[j]].own:1;if(e)if(Math.min(d,c)>0){if(!a[f[j]].use)a[f[j]].use={};a[f[j]].use[e+"_"+b]=Math.min(d,c)}else if(a[f[j]].use){delete a[f[j]].use[e+"_"+b];length(a[f[j]].use)||delete a[f[j]].use}if(d<=0)break;c=Math.min(d,c);g+=
c*a[f[j]].att;h+=c*a[f[j]].def;d-=c}getAttDefList=f;return(b==="att"?g:0.7*g)+(b==="def"?h:0.7*h)},tr=function(a,c,b){a.push("<tr"+(b?" "+b:"")+">"+c+"</tr>")},th=function(a,c,b){a.push("<th"+(b?" "+b:"")+">"+c+"</th>")},td=function(a,c,b){a.push("<td"+(b?" "+b:"")+">"+c+"</td>")},isArray=function(a){return a&&typeof a==="object"&&!a.propertyIsEnumerable("length")&&typeof a.length==="number"},isNumber=function(a){return a&&typeof a==="number"};
if(typeof GM_getValue!=="undefined")var setItem=function(a,c){GM_setValue(a,c)},getItem=function(a){return GM_getValue(a)};else if(typeof localStorage!=="undefined"){setItem=function(a,c){localStorage.setItem("golem."+APP+a,c)};getItem=function(a){return localStorage.getItem("golem."+APP+a)}}else if(typeof window.localStorage!=="undefined"){setItem=function(a,c){window.localStorage.setItem("golem."+APP+a,c)};getItem=function(a){return window.localStorage.getItem("golem."+APP+a)}}else if(typeof globalStorage!==
"undefined"){setItem=function(a,c){globalStorage[location.hostname].setItem("golem."+APP+a,c)};getItem=function(a){return globalStorage[location.hostname].getItem("golem."+APP+a)}}var Workers=[];
function Worker(a,c,b){Workers.push(this);this.id=null;this.name=a;this.pages=c;this.settings=b||{};this.data={};this.option={};this.update=this.work=this.parse=this.init=this.display=null;this.get=function(d){return this._get(d)};this.set=function(d,e){return this._set(d,e)};this._loaded=false;this._working={data:false,option:false,update:false};this._changed=Date.now();this._watching=[];this._watch=function(d){for(var e=0;e<d._watching.length;e++)if(d._watching[e]===this)return;d._watching.push(this)};
this._update=function(d){if(this._loaded&&(this.update||this._watching.length)){var e=false;this._working.update=true;if(!this.data){e=true;this._unflush()}if(this.update)try{this.update(d)}catch(f){debug(f.name+" in "+this.name+".update("+(d?typeof d==="string"?d:d.name:"")+"): "+f.message)}for(d=0;d<this._watching.length;d++)if(this._watching[d]===this){if(this.update)try{this.update(this)}catch(g){debug(g.name+" in "+this.name+".update(this): "+g.message)}}else this._watching[d]._update(this);
e&&this._flush();this._working.update=false}};this._get=function(d){d=typeof d==="string"?d.split("."):typeof d==="object"?d:[];this._loaded||this._init();this._unflush();try{switch(d.length){case 0:return this.data;case 1:return this.data[d[0]];case 2:return this.data[d[0]][d[1]];case 3:return this.data[d[0]][d[1]][d[2]];case 4:return this.data[d[0]][d[1]][d[2]][d[3]];case 5:return this.data[d[0]][d[1]][d[2]][d[3]][d[4]];case 6:return this.data[d[0]][d[1]][d[2]][d[3]][d[4]][d[5]];case 7:return this.data[d[0]][d[1]][d[2]][d[3]][d[4]][d[5]][d[6]]}}catch(e){return null}};
this._set=function(d,e){this._loaded||this._init();this._unflush();d=typeof d==="string"?d.split("."):typeof d==="object"?d:[];try{switch(d.length){case 0:this.data=e;break;case 1:this.data[d[0]]=e;break;case 2:this.data[d[0]][d[1]]=e;break;case 3:this.data[d[0]][d[1]][d[2]]=e;break;case 4:this.data[d[0]][d[1]][d[2]][d[3]]=e;break;case 5:this.data[d[0]][d[1]][d[2]][d[3]][d[4]]=e;break;case 6:this.data[d[0]][d[1]][d[2]][d[3]][d[4]][d[5]]=e;break;case 7:this.data[d[0]][d[1]][d[2]][d[3]][d[4]][d[5]][d[6]]=
e;break}this._save()}catch(f){return null}};this._flush=function(){this._save();this.settings.keep||delete this.data};this._unflush=function(){!this.settings.keep&&!this.data&&this._load("data")};this._init=function(){if(!this._loaded){this._loaded=true;if(this.init)try{this.init()}catch(d){debug(d.name+" in "+this.name+".init(): "+d.message)}}};this._load=function(d){if(d!=="data"&&d!=="option"){this._load("data");this._load("option")}else{var e=getItem(userID+"."+d+"."+this.name)||this[d];if(typeof e!==
"string")this[d]=e;else switch(e.charAt(0)){case '"':this[d]=e.replace(/^"|"$/g,"");return;case "(":case "[":if(!this[d]||typeof this[d]!=="array"&&typeof this[d]!=="object"){this[d]=eval(e);return}this[d]=$.extend(true,{},this[d],eval(e));return}}};this._save=function(d){if(d!=="data"&&d!=="option")return this._save("data")+this._save("option");if(typeof this[d]==="undefined"||!this[d]||this._working[d])return false;var e=userID+"."+d+"."+this.name,f;switch(typeof this[d]){case "string":f='"'+this[d]+
'"';break;case "array":case "object":f=this[d].toSource();break;default:f=this[d];break}if(getItem(e)==="undefined"||getItem(e)!==f){this._working[d]=true;this._changed=Date.now();this._update(d);setItem(e,f);this._working[d]=false;return true}return false}}var Config=new Worker("Config",null,{keep:true});Config.option={display:"block",fixed:true,advanced:false};
Config.init=function(){$("head").append('<link rel="stylesheet" href="http://cloutman.com/css/base/jquery-ui.css" type="text/css" />');var a,c;$("div.UIStandardFrame_Content").after('<div class="golem-config'+(Config.option.fixed?" golem-config-fixed":"")+'"><div class="ui-widget-content"><div class="golem-title">Castle Age Golem v'+VERSION+'<img id="golem_fixed"></div><div id="golem_buttons" style="margin:4px;"><img class="golem-button'+(Config.option.display==="block"?"-active":"")+'" id="golem_options" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%E2%E2%E2%8A%8A%8A%AC%AC%AC%FF%FF%FFUUU%1C%CB%CE%D3%00%00%00%04tRNS%FF%FF%FF%00%40*%A9%F4%00%00%00%3DIDATx%DA%A4%8FA%0E%00%40%04%03%A9%FE%FF%CDK%D2%B0%BBW%BD%CD%94%08%8B%2F%B6%10N%BE%A2%18%97%00%09pDr%A5%85%B8W%8A%911%09%A8%EC%2B%8CaM%60%F5%CB%11%60%00%9C%F0%03%07%F6%BC%1D%2C%00%00%00%00IEND%AEB%60%82"></div><div style="display:'+
Config.option.display+';"><div id="golem_config" style="margin:0 4px;overflow:hidden;overflow-y:auto;"></div><div style="text-align:right;"><label>Advanced <input type="checkbox" id="golem-config-advanced"'+(Config.option.advanced?" checked":"")+"></label></div></div></div></div>");$("#golem_options").click(function(){$(this).toggleClass("golem-button golem-button-active");Config.option.display=Config.option.display==="block"?"none":"block";$("#golem_config").parent().toggle("blind");Config._save("option")});
$("#golem_fixed").click(function(){Config.option.fixed^=true;$(this).closest(".golem-config").toggleClass("golem-config-fixed");Config._save("option")});a=$("#golem_config");for(c in Workers)a.append(Config.makePanel(Workers[c]));a.sortable({axis:"y"});$(".golem-config .golem-panel > h3").click(function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});
Config._save("option")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Config._save("option")}});a.children(".golem-panel-sortable").draggable({connectToSortable:"#golem_config",axis:"y",distance:5,scroll:false,handle:"h3",helper:"clone",opacity:0.75,zIndex:100,refreshPositions:true,stop:function(){Config.updateOptions()}}).droppable({tolerance:"pointer",
over:function(b,d){Config.getPlace($(this).attr("id"))<Config.getPlace($(d.draggable).attr("id"))?$(this).before(d.draggable):$(this).after(d.draggable)}});for(c in Workers)Workers[c].select&&Workers[c].select();$("input.golem_addselect").live("click",function(){$("select.golem_multiple",$(this).parent()).append("<option>"+$(".golem_select",$(this).parent()).val()+"</option>");Config.updateOptions()});$("input.golem_delselect").live("click",function(){$("select.golem_multiple option[selected=true]",
$(this).parent()).each(function(b,d){$(d).remove()});Config.updateOptions()});$("input,textarea,select",a).change(function(){Config.updateOptions()});$("#golem-config-advanced").click(function(){Config.updateOptions();$(".golem-advanced").css("display",Config.option.advanced?"block":"none")})};
Config.makePanel=function(a){var c,b,d,e,f,g=a.display,h=[],k=[],j=[],m={before:"",after:"",suffix:"",className:"",between:"to",size:7,min:0,max:100};if(!g)return false;a.id="golem_panel_"+a.name.toLowerCase().replace(/[^0-9a-z]/,"_");b=findInArray(Config.option.active,a.id);f=$('<div id="'+a.id+'" class="golem-panel'+(a.settings.unsortable?"":" golem-panel-sortable")+(b?" golem-panel-show":"")+'" name="'+a.name+'"><h3 class="golem-panel-header "><img class="golem-icon">'+a.name+'<img class="golem-lock"></h3></div>');
switch(typeof g){case "array":case "object":for(c in g){k=[];j=[];b=$.extend(true,{},m,g[c]);b.real_id=PREFIX+a.name+"_"+b.id;b.value=a.option[b.id]||null;b.alt=b.alt?' alt="'+b.alt+'"':"";if(b.label){k.push('<span style="float:left;margin-top:2px;">'+b.label.replace(" ","&nbsp;")+"</span>");if(b.text||b.checkbox||b.select)k.push('<span style="float:right;">');else b.multiple&&k.push("<br>")}b.before&&k.push(b.before+" ");if(b.info)b.id?k.push('<span style="float:right" id="'+b.real_id+'">'+(b.value||
b.info)+"</span>"):k.push(b.info);else if(b.text)k.push('<input type="text" id="'+b.real_id+'" size="'+b.size+'" value="'+(b.value||"")+'">');else if(b.checkbox)k.push('<input type="checkbox" id="'+b.real_id+'"'+(b.value?" checked":"")+">");else if(b.select){switch(typeof b.select){case "number":e=Divisor(b.select);for(d=0;d<=b.select;d+=e)j.push("<option"+(b.value==d?" selected":"")+">"+d+"</option>");break;case "string":b.className=' class="golem_'+b.select+'"';if(this.data&&this.data[b.select]&&
(typeof this.data[b.select]==="array"||typeof this.data[b.select]==="object"))b.select=this.data[b.select];else break;case "array":case "object":if(isArray(b.select))for(d=0;d<b.select.length;d++)j.push('<option value="'+b.select[d]+'"'+(b.value==b.select[d]?" selected":"")+">"+b.select[d]+(b.suffix?" "+b.suffix:"")+"</option>");else for(d in b.select)j.push('<option value="'+d+'"'+(b.value==d?" selected":"")+">"+b.select[d]+(b.suffix?" "+b.suffix:"")+"</option>");break}k.push('<select id="'+b.real_id+
'"'+b.className+b.alt+">"+j.join("")+"</select>")}else if(b.multiple){if(typeof b.value==="array"||typeof b.value==="object")for(c in b.value)j.push('<option value="'+b.value[c]+'">'+b.value[c]+"</option>");k.push('<select style="width:100%;clear:both;" class="golem_multiple" multiple id="'+b.real_id+'">'+j.join("")+"</select><br>");if(typeof b.multiple==="string")k.push('<input class="golem_select" type="text" size="'+b.size+'">');else{j=[];switch(typeof b.multiple){case "number":e=Divisor(b.select);
for(d=0;d<=b.multiple;d+=e)j.push("<option>"+d+"</option>");break;case "array":case "object":if(isArray(b.multiple))for(d=0;d<b.multiple.length;d++)j.push('<option value="'+b.multiple[d]+'">'+b.multiple[d]+(b.suffix?" "+b.suffix:"")+"</option>");else for(d in b.multiple)j.push('<option value="'+d+'">'+b.multiple[d]+(b.suffix?" "+b.suffix:"")+"</option>");break}k.push('<select class="golem_select">'+j.join("")+"</select>")}k.push('<input type="button" class="golem_addselect" value="Add" /><input type="button" class="golem_delselect" value="Del" />')}b.after&&
k.push(" "+b.after);if(b.label&&(b.text||b.checkbox||b.select||b.multiple))k.push("</span>");h.push('<div style="clear:both;'+(b.advanced?(Config.option.advanced?'"':'display:none;"')+' class="golem-advanced"':'"')+(b.help?' title="'+b.help+'"':"")+">"+k.join("")+"</div>")}f.append('<div class="golem-panel-content" style="font-size:smaller;">'+h.join("")+'<div style="clear:both"></div></div>');return f;default:return null}};
Config.set=function(a,c){if(this._loaded){if(!this.data)this.data={}}else this._init();if(!this.data[a]||this.data[a].toSource()!==c.toSource()){this.data[a]=c;$("select.golem_"+a).each(function(b,d){var e=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i);e=e?WorkerByName(e[0]).option[e[1]]:null;var f=Config.data[a],g=[];if(isArray(f))for(b=0;b<f.length;b++)g.push('<option value="'+f[b]+'"'+(e==b?" selected":"")+">"+f[b]+"</option>");else for(b in f)g.push('<option value="'+b+'"'+(e==b?
" selected":"")+">"+f[b]+"</option>");$(d).html(g.join(""))});this._save();return true}return false};
Config.updateOptions=function(){var a={},c;Queue.option.queue=[];$("#golem_config > div").each(function(b,d){b=WorkerById($(d).attr("id")).name;a[b]||Queue.option.queue.push(b);a[b]=true});this.option.advanced=$("#golem-config-advanced").attr("checked");$("#golem_config :input").each(function(b,d){if($(d).attr("id")){var e;if(b=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))if($(d).attr("type")==="checkbox")WorkerByName(b[0]).option[b[1]]=$(d).attr("checked");else{if($(d).attr("multiple")){e=
[];$("option",d).each(function(f,g){e.push($(g).text())})}else if((e=$(d).attr("value")||$(d).val()||null)&&e.search(/[^0-9.]/)===-1)e=parseFloat(e);WorkerByName(b[0]).option[b[1]]=e}}});for(c=0;c<Workers.length;c++)Workers[c]._save("option")};Config.getPlace=function(a){var c=-1;$("#golem_config > div").each(function(b,d){if($(d).attr("id")===a&&c===-1)c=b});return c};var Dashboard=new Worker("Dashboard","*",{keep:true});Dashboard.option={display:"block",active:null};
Dashboard.init=function(){var a,c=[],b=[],d=this.option.active;for(i=0;i<Workers.length;i++)if(Workers[i].dashboard){a="golem-dashboard-"+Workers[i].name;if(!d)this.option.active=d=a;c.push('<h3 name="'+a+'" class="golem-tab-header'+(d===a?" golem-tab-header-active":"")+'">'+(Workers[i]===this?"&nbsp;*&nbsp;":Workers[i].name)+"</h3>");b.push('<div id="'+a+'"'+(d===a?"":' style="display:none;"')+"></div>");this._watch(Workers[i])}$('<div id="golem-dashboard" style="top:'+$("#app"+APPID+"_main_bn").offset().top+
"px;display:"+this.option.display+';">'+c.join("")+"<div>"+b.join("")+"</div></div>").prependTo(".UIStandardFrame_Content");$(".golem-tab-header").click(function(){if(!$(this).hasClass("golem-tab-header-active")){if(Dashboard.option.active){$('h3[name="'+Dashboard.option.active+'"]').removeClass("golem-tab-header-active");$("#"+Dashboard.option.active).hide()}Dashboard.option.active=$(this).attr("name");$(this).addClass("golem-tab-header-active");Dashboard.update();$("#"+Dashboard.option.active).show();
Dashboard._save("option")}});$("#golem-dashboard .golem-panel > h3").live("click",function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind")}});$("#golem-dashboard thead th").live("click",function(){var e=WorkerByName(Dashboard.option.active.substr(16));e._unflush();e.dashboard($(this).prevAll().length,$(this).attr("name")===
"sort")});$("#golem_buttons").append('<img class="golem-button'+(Dashboard.option.display==="block"?"-active":"")+'" id="golem_toggle_dash" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%1EPLTE%BA%BA%BA%EF%EF%EF%E5%E5%E5%D4%D4%D4%D9%D9%D9%E3%E3%E3%F8%F8%F8%40%40%40%FF%FF%FF%00%00%00%83%AA%DF%CF%00%00%00%0AtRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%00%B2%CC%2C%CF%00%00%00EIDATx%DA%9C%8FA%0A%00%20%08%04%B5%CC%AD%FF%7F%B8%0D%CC%20%E8%D20%A7AX%94q!%7FA%10H%04%F4%00%19*j%07Np%9E%3B%C9%A0%0C%BA%DC%A1%91B3%98%85%AF%D9%E1%5C%A1%FE%F9%CB%14%60%00D%1D%07%E7%0AN(%89%00%00%00%00IEND%AEB%60%82">');
$("#golem_toggle_dash").click(function(){$(this).toggleClass("golem-button golem-button-active");Dashboard.option.display=Dashboard.option.display==="block"?"none":"block";Dashboard.option.display==="block"&&!$("#"+Dashboard.option.active).children().length&&WorkerByName(Dashboard.option.active.substr(16)).dashboard();$("#golem-dashboard").toggle("drop");Dashboard._save("option")});window.setInterval(function(){$(".golem-timer").each(function(e,f){(e=$(f).text().parseTimer())&&e>0?$(f).text(makeTimer($(f).text().parseTimer()-
1)):$(f).removeClass("golem-timer").text("now?")})},1E3)};Dashboard.parse=function(){$("#golem-dashboard").css("top",$("#app"+APPID+"_main_bn").offset().top+"px")};
Dashboard.update=function(a){if(!(!this._loaded||a&&typeof a!=="object")){worker=a||WorkerByName(Dashboard.option.active.substr(16));a="golem-dashboard-"+worker.name;if(this.option.active===a&&this.option.display==="block")try{worker._unflush();worker.dashboard()}catch(c){debug(c.name+" in "+worker.name+".dashboard(): "+c.message)}else $("#"+a).empty()}};
Dashboard.dashboard=function(){var a,c=[];for(a=0;a<Workers.length;a++)this.data[Workers[a].name]&&c.push("<tr><th>"+Workers[a].name+':</th><td id="golem-status-'+Workers[a].name+'">'+this.data[Workers[a].name]+"</td></tr>");c.sort();$("#golem-dashboard-Dashboard").html('<table cellspacing="0" cellpadding="0" class="golem-status">'+c.join("")+"</table>")};Dashboard.status=function(a,c){if(c)this.data[a.name]=c;else delete this.data[a.name];this._save()};
var Page=new Worker("Page",null,{unsortable:true,keep:true});Page.option={timeout:15,retry:5};Page.page="";Page.last=null;Page.lastclick=null;Page.when=null;Page.retry=0;Page.checking=true;Page.node_trigger=null;Page.display=[{id:"timeout",label:"Retry after",select:[10,15,30,60],after:"seconds"}];
Page.init=function(){$("body").bind("DOMNodeInserted",function(a){if(!Page.node_trigger&&($(a.target).attr("id")==="app"+APPID+"_app_body_container"||$(a.target).attr("id")==="app"+APPID+"_globalContainer"))Page.node_trigger=window.setTimeout(function(){Page.node_trigger=null;Page.parse_all()},100)})};
Page.parse_all=function(){Page.identify();var a,c=[];for(a=0;a<Workers.length;a++)if(Workers[a].pages&&(Workers[a].pages==="*"||Page.page&&Workers[a].pages.indexOf(Page.page)>=0)&&Workers[a].parse){Workers[a]._unflush();try{Workers[a].parse(false)&&c.push(Workers[a])}catch(b){debug(b.name+" in "+Workers[a].name+".parse(false): "+b.message)}}for(a in c)try{c[a].parse(true)}catch(d){debug(d.name+" in "+c[a].name+".parse(true): "+d.message)}for(a=0;a<Workers.length;a++)Workers[a]._flush()};
Page.work=function(a){if(!this.checking)return false;var c,b,d,e=null;for(c=0;c<Workers.length&&!e;c++)if(!(!Workers[c].pages||Workers[c].pages==="*")){d=Workers[c].pages.split(" ");for(b=0;b<d.length;b++)if(this.pageNames[d[b]]&&!this.data[d[b]]&&d[b].indexOf("_active")===-1){e=d[b];break}}if(!a){if(e)return true;return this.checking=false}if(e&&!this.to(e)){this.data[e]=Date.now();return true}return false};
Page.pageNames={index:{url:"index.php",selector:"#app"+APPID+"_indexNewFeaturesBox"},quests_quest:{url:"quests.php",image:"tab_quest_on.gif"},quests_quest1:{url:"quests.php?land=1",image:"land_fire_sel.gif"},quests_quest2:{url:"quests.php?land=2",image:"land_earth_sel.gif"},quests_quest3:{url:"quests.php?land=3",image:"land_mist_sel.gif"},quests_quest4:{url:"quests.php?land=4",image:"land_water_sel.gif"},quests_quest5:{url:"quests.php?land=5",image:"land_demon_realm_sel.gif"},quests_quest6:{url:"quests.php?land=6",
image:"land_undead_realm_sel.gif"},quests_quest7:{url:"quests.php?land=7",image:"tab_underworld_big.gif"},quests_demiquests:{url:"symbolquests.php",image:"demi_quest_on.gif"},quests_atlantis:{url:"monster_quests.php",image:"tab_atlantis_on.gif"},battle_battle:{url:"battle.php",image:"battle_on.gif"},battle_training:{url:"battle_train.php",image:"training_grounds_on_new.gif"},battle_rank:{url:"battlerank.php",image:"tab_battle_rank_on.gif"},battle_raid:{url:"raid.php",image:"tab_raid_on.gif"},battle_arena:{url:"arena.php",
image:"tab_arena_on.gif"},heroes_heroes:{url:"mercenary.php",image:"tab_heroes_on.gif"},heroes_generals:{url:"generals.php",image:"tab_generals_on.gif"},town_soldiers:{url:"soldiers.php",image:"tab_soldiers_on.gif"},town_blacksmith:{url:"item.php",image:"tab_black_smith_on.gif"},town_magic:{url:"magic.php",image:"tab_magic_on.gif"},town_land:{url:"land.php",image:"tab_land_on.gif"},oracle_oracle:{url:"oracle.php",image:"oracle_on.gif"},oracle_demipower:{url:"symbols.php",image:"demi_on.gif"},oracle_treasurealpha:{url:"treasure_chest.php",
image:"tab_treasure_alpha_on.gif"},oracle_treasurevanguard:{url:"treasure_chest.php?treasure_set=alpha",image:"tab_treasure_vanguard_on.gif"},keep_stats:{url:"keep.php?user="+userID,image:"tab_stats_on.gif"},keep_eliteguard:{url:"party.php?user="+userID,image:"tab_elite_guard_on.gif"},keep_achievements:{url:"achievements.php",image:"tab_achievements_on.gif"},keep_alchemy:{url:"alchemy.php",image:"tab_alchemy_on.gif"},keep_monster:{url:"battle_monster.php",image:"tab_monster_on.jpg"},keep_monster_active:{url:"battle_monster.php",
image:"dragon_view_more.gif"},army_invite:{url:"army.php",image:"invite_on.gif"},army_gifts:{url:"gift.php",selector:'div[style*="giftpage_title.jpg"]'},army_viewarmy:{url:"army_member.php",image:"view_army_on.gif"},army_sentinvites:{url:"army_reqs.php",image:"sent_invites_on.gif"},army_newsfeed:{url:"army_news_feed.php",selector:"#app"+APPID+"_army_feed_header"}};
Page.identify=function(){this.page="";if(!$("#app"+APPID+"_globalContainer").length){this.reload();return null}var a=$("#app"+APPID+"_app_body"),c;$("img",a).each(function(b,d){b=$(d).attr("src").filepart();for(c in Page.pageNames)if(Page.pageNames[c].image&&b===Page.pageNames[c].image){Page.page=c;return}});if(!this.page)for(c in Page.pageNames)if(Page.pageNames[c].selector&&$(Page.pageNames[c].selector,a).length)Page.page=c;if(this.page!=="")this.data[this.page]=Date.now();return this.page};
Page.loading=false;Page.to=function(a,c){if(Queue.option.pause){debug("Trying to load page when paused...");return true}if(a===this.page&&typeof c==="undefined")return true;c||(c="");if(a&&this.pageNames[a]&&this.pageNames[a].url){this.clear();this.last=this.pageNames[a].url;this.when=Date.now();if(c.indexOf("?")===0&&this.last.indexOf("?")>0)this.last=this.last.substr(0,this.last.indexOf("?"))+c;else this.last+=c;debug("Navigating to "+this.last+" ("+this.pageNames[a].url+")");this.ajaxload()}return false};
Page.ajaxload=function(){$.ajax({cache:false,dataType:"text",timeout:this.option.timeout*1E3,url:"http://apps.facebook.com/castle_age/"+this.last,error:function(){debug("Page not loaded correctly, reloading.");Page.ajaxload()},success:function(a){if(a.lastIndexOf("</html>")!==-1&&a.lastIndexOf("single_popup")!==-1){Page.loading=false;a=a.substring(a.indexOf('<div id="app'+APPID+'_globalContainer"'),a.indexOf('<div class="UIStandardFrame_SidebarAds"'));$("#app"+APPID+"_AjaxLoadIcon").css("display",
"none");$("#app"+APPID+"_globalContainer").empty().append(a)}else{debug("Page not loaded correctly, reloading.");Page.ajaxload()}}});this.loading=true;setTimeout(function(){Page.loading&&$("#app"+APPID+"_AjaxLoadIcon").css("display","block")},1500)};Page.reload=function(){window.location.href="http://apps.facebook.com/castle_age/index.php?bm=1"};
Page.click=function(a){if(!$(a).length){debug("Page.click: Unable to find element - "+a);return false}var c=document.createEvent("MouseEvents");c.initEvent("click",true,true);$(a).get(0).wrappedJSObject.dispatchEvent(c);this.clear();this.lastclick=a;this.when=Date.now();return true};Page.clear=function(){this.last=this.lastclick=this.when=null;this.retry=0};var Queue=new Worker("Queue","*",{unsortable:true,keep:true});Queue.data={current:null};
Queue.option={delay:5,clickdelay:5,queue:["Page","Queue","Income","Elite","Quest","Monster","Arena","Battle","Heal","Land","Town","Bank","Alchemy","Blessing","Gift","Upgrade","Potions","Idle"],start_stamina:0,stamina:0,start_energy:0,energy:0};
Queue.display=[{label:"Drag the unlocked panels into the order you wish them run."},{id:"delay",label:"Delay Between Events",text:true,after:"secs",size:3},{id:"clickdelay",label:"Delay After Mouse Click",text:true,after:"secs",size:3,help:"This should be a multiple of Event Delay"},{id:"start_stamina",before:"Save",select:"stamina",after:"Stamina Before Using"},{id:"stamina",before:"Always Keep",select:"stamina",after:"Stamina"},{id:"start_energy",before:"Save",select:"energy",after:"Energy Before Using"},
{id:"energy",before:"Always Keep",select:"energy",after:"Energy"}];Queue.runfirst=[];Queue.lastclick=Date.now();Queue.lastrun=Date.now();Queue.burn={stamina:false,energy:false};Queue.timer=null;Queue.lasttimer=0;Queue.lastpause=false;
Queue.init=function(){var a,c,b={};for(a=0;a<this.option.queue.length;a++)if(c=WorkerByName(this.option.queue[a]))b[c.name]=true;for(a in Workers)if(!(b[Workers[a].name]||!Workers[a].work||!Workers[a].display)){log("Adding "+Workers[a].name+" to Queue");Workers[a].settings.unsortable?this.option.queue.unshift(Workers[a].name):this.option.queue.push(Workers[a].name)}for(a=0;a<this.option.queue.length;a++)if((c=WorkerByName(this.option.queue[a]))&&c.id){if(this.data.current&&c.name===this.data.current){debug("Queue: Trigger "+
c.name+" (continue after load)");$("#"+c.id+" > h3").css("font-weight","bold")}$("#golem_config").append($("#"+c.id))}$(document).click(function(){Queue.lastclick=Date.now()});Queue.lastpause=this.option.pause;$btn=$('<img class="golem-button'+(this.option.pause?" red":"")+'" id="golem_pause" src="'+(this.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82")+'">').click(function(){Queue.option.pause^=true;debug("State: "+(Queue.option.pause?"paused":"running"));$(this).toggleClass("red").attr("src",Queue.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82");Page.clear();Config.updateOptions()});$("#golem_buttons").prepend($btn)};
Queue.update=function(){if(!this.option.pause&&this.option.delay!==this.lasttimer){window.clearInterval(this.timer);this.timer=window.setInterval(function(){Queue.run()},this.option.delay*1E3);this.lasttimer=this.option.delay}else if(this.option.pause&&this.option.pause!==this.lastpause){window.clearInterval(this.timer);this.lasttimer=-1}this.lastpause=this.option.pause};
Queue.run=function(){var a,c,b=false,d;if(!(this.option.pause||Date.now()-this.lastclick<this.option.clickdelay*1E3))if(!Page.loading){this.burn.stamina=this.burn.energy=0;if(this.option.burn_stamina||Player.get("stamina")>=this.option.start_stamina){this.burn.stamina=Math.max(0,Player.get("stamina")-this.option.stamina);this.option.burn_stamina=this.burn.stamina>0}if(this.option.burn_energy||Player.get("energy")>=this.option.start_energy){this.burn.energy=Math.max(0,Player.get("energy")-this.option.energy);
this.option.burn_energy=this.burn.energy>0}for(a=0;a<Workers.length;a++)if(Workers[a].work&&!Workers[a].display)try{Workers[a]._unflush();Workers[a].work(false)}catch(e){debug(e.name+" in "+Workers[a].name+".work(false): "+e.message)}for(a=0;a<this.option.queue.length;a++){c=WorkerByName(this.option.queue[a]);if(!(!c||!c.work||!c.display)){if(this.data.current===c.name){try{c._unflush();d=c.work(true)}catch(f){debug(f.name+" in "+workers.name+".work(false): "+f.message);d=false}c._save()}else try{d=
c.work(false)}catch(g){debug(g.name+" in "+workers.name+".work(false): "+g.message);d=false}if(!d&&this.data.current===c.name){this.data.current=null;c.id&&$("#"+c.id+" > h3").css("font-weight","normal");debug("Queue: End "+c.name)}if(!(!d||b)){b=true;if(this.data.current!==c.name){if(this.data.current){debug("Queue: Interrupt "+this.data.current);WorkerByName(this.data.current).id&&$("#"+WorkerByName(this.data.current).id+" > h3").css("font-weight","normal")}this.data.current=c.name;c.id&&$("#"+
c.id+" > h3").css("font-weight","bold");debug("Queue: Trigger "+c.name)}}}}for(a=0;a<Workers.length;a++)Workers[a]._flush()}};var Update=new Worker("Update");Update.data=null;Update.option=null;Update.found=false;
Update.init=function(){var a=$('<img class="golem-button" name="Script Update" id="golem_update" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C7%C7%C7UUU%7B%7B%7B%BF%BF%BF%A6%A6%A6%FF%FF%FF%40%40%40%FF%FF%FFk5%D0%FB%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00UIDATx%DAt%8F%5B%12%800%08%03%23%8Fx%FF%1B%5B%C0%96%EA%E8~%95%9D%C0%A48_%E0S%A8p%20%3A%85%F1%C6Jh%3C%DD%FD%205E%E4%3D%18%5B)*%9E%82-%24W6Q%F3Cp%09%E1%A2%8E%A2%13%E8b)lVGU%C7%FF%E7v.%01%06%005%D6%06%07%F9%3B(%D0%00%00%00%00IEND%AEB%60%82">').click(function(){Update.now(true)});$("#golem_buttons").append(a)};
Update.now=function(a){if(Update.found)window.location.href="http://userscripts.org/scripts/source/67412.user.js";else{var c=Settings.GetValue("lastUpdateCheck",0);if(a||Date.now()-c>216E5){Settings.SetValue("lastUpdateCheck",Date.now().toString());GM_xmlhttpRequest({method:"GET",url:"http://userscripts.org/scripts/show/67412",onload:function(b){if(b.readyState===4&&b.status===200){b=$(b.responseText);b=$("#summary",b).text().regex(/Version:[^0-9.]+([0-9.]+)/i);a&&$("#golem_request").remove();if(b>
VERSION){Update.found=true;$("#golem_update").attr("src","data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C8%C8%C8%C1%C1%C1%BA%BA%BA%F1%F1%F1ggg%FF%FF%FF%40%40%40%FF%FF%FF%7D%5C%EC%14%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00OIDATx%DA%8C%8FA%0A%C0%20%0C%04W%8D%EB%FF%7F%AC1%5BQi%A1s%0A%C3%24%10%B4%0B%7C%89%9COa%A4%ED%22q%906a%2CE%09%14%D4%AA%04%BA0%8AH%5C%80%02%12%3E%FB%0A%19b%06%BE2%13D%F0%F0.~%3E%B7%E8%02%0C%00Z%03%06Q9dE%25%00%00%00%00IEND%AEB%60%82").toggleClass("golem-button golem-button-active");
if(a){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There is a new version of Castle Age Golem available.</p><p>Current&nbsp;version:&nbsp;'+VERSION+", New&nbsp;version:&nbsp;"+b+"</p></div>");$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close");window.location.href="http://userscripts.org/scripts/source/67412.user.js"},Skip:function(){$(this).dialog("close")}}})}log("New version available: "+b)}else if(a){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There are no new versions available.</p></div>');
$("#golem_request").dialog({modal:true,buttons:{Ok:function(){$(this).dialog("close")}}})}}}})}}};var Alchemy=new Worker("Alchemy","keep_alchemy");Alchemy.data={ingredients:{},recipe:{}};Alchemy.option={perform:true,hearts:false,found:true};Alchemy.display=[{id:"perform",label:"Automatically Perform",checkbox:true},{id:"hearts",label:"Use Battle Hearts",checkbox:true}];
Alchemy.parse=function(){var a=Alchemy.data.ingredients={},c=Alchemy.data.recipe={};$("div.ingredientUnit").each(function(b,d){b=$("img",d).attr("src").filepart();a[b]=$(d).text().regex(/x([0-9]+)/)});$("div.alchemyQuestBack,div.alchemyRecipeBack,div.alchemyRecipeBackMonster").each(function(b,d){var e={};b=$("div.recipeTitle",d).text().trim().replace("RECIPES: ","");if(b.indexOf(" (")>0)b=b.substr(0,b.indexOf(" ("));e.type=$(d).hasClass("alchemyQuestBack")?"Quest":$(d).hasClass("alchemyRecipeBack")?
"Recipe":$(d).hasClass("alchemyRecipeBackMonster")?"Summons":"wtf";e.ingredients={};$("div.recipeImgContainer",d).parent().each(function(f,g){f=$("img",g).attr("src").filepart();e.ingredients[f]=$(g).text().regex(/x([0-9]+)/)||1});c[b]=e})};
Alchemy.update=function(){var a=null,c=this.data.recipe,b,d;for(b in c)if(c[b].type==="Recipe"){a=b;for(d in c[b].ingredients)if(!Alchemy.option.hearts&&d==="raid_hearts.gif"||c[b].ingredients[d]>(Alchemy.data.ingredients[d]||0)){a=null;break}if(a)break}this.option.found=a};
Alchemy.work=function(a){if(!Alchemy.option.perform||!Alchemy.option.found)return false;if(!a||!Page.to("keep_alchemy"))return true;debug("Alchemy: Perform - "+Alchemy.option.found);$("div.alchemyRecipeBack").each(function(c,b){if($("div.recipeTitle",b).text().indexOf(Alchemy.option.found)>=0){Page.click($('input[type="image"]',b));return true}});return true};var Arena=new Worker("Arena","battle_arena");Arena.data={user:{}};
Arena.option={enabled:false,general:true,losses:5,cache:50,type:"Invade",army:1.1,level:1.1};Arena.rank={Brawler:1,Swordsman:2,Warrior:3,Gladiator:4,Hero:5,Legend:6};Arena.knar={1:"Brawler",2:"Swordsman",3:"Warrior",4:"Gladiator",5:"Hero",6:"Legend"};
Arena.display=[{label:"NOTE: Make sure this is disabled if you are not fighting and drag into order relative to the Monster panel!"},{id:"enabled",label:"Arena Enabled",checkbox:true},{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel"]},{id:"bp",label:"Higher Relative Rank<br>(Clears Cache)",select:["Always","Never","Don't Care"]},{advanced:true,id:"losses",label:"Attack Until",select:["Ignore",1,2,3,4,5,6,7,8,9,10],after:"Losses"},{advanced:true,
id:"cache",label:"Limit Cache Length",select:[50,100,150,200,250]},{id:"army",label:"Target Army Ratio<br>(Only needed for Invade)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for smaller target army. Reduce this number if you're losing in Invade"},{id:"level",label:"Target Level Ratio<br>(Mainly used for Dual)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for lower target level. Reduce this number if you're losing a lot"}];
Arena.parse=function(){var a=this.data.user;if(this.option.attacking){uid=this.option.attacking;this.option.attacking=null;if($("div.results").text().match(/You cannot battle someone in your army/i))delete a[uid];else if($("div.results").text().match(/Your opponent is dead or too weak/i)){a[uid].hide=(a[uid].hide||0)+1;a[uid].dead=Date.now()}else if($('img[src*="battle_victory"]').length)a[uid].win=(a[uid].win||0)+1;else if($('img[src*="battle_defeat"]').length)a[uid].loss=(a[uid].loss||0)+1;else this.option.attacking=
uid}this.data.rank=$("#app"+APPID+'_arena_body img[src*="arena_rank"]').attr("src").regex(/arena_rank([0-9]+).gif/i);$("#app"+APPID+"_arena_body table tr:odd").each(function(c,b){c=$('img[uid!==""]',b).attr("uid");var d=$("td.bluelink",b).text().trim().regex(/Level ([0-9]+) (.*)/i),e;if(c&&d){e=Arena.rank[d[1]];if(!(Arena.option.bp==="Always"&&Arena.data.rank-e>0||!Arena.option.bp==="Never"&&Arena.data.rank-e<0)){a[c]=a[c]||{};a[c].name=$("a",b).text().trim();a[c].level=d[0];a[c].rank=e;a[c].army=
$("td.bluelink",b).next().text().regex(/([0-9]+)/)}}});return false};
Arena.update=function(){var a,c=[],b=this.data.user,d=Player.get("army"),e=Player.get("level");for(a in b)if(this.option.bp==="Always"&&this.data.rank-b[a].rank>0||!this.option.bp==="Never"&&this.data.rank-b[a].rank<0)delete b[a];if(length(b)>this.option.cache){for(a in b)c.push(a);for(c.sort(function(f,g){var h=0;if((b[f].win||0)-(b[f].loss||0)<(b[g].win||0)-(b[g].loss||0))h+=10;else if((b[f].win||0)-(b[f].loss||0)>(b[g].win||0)-(b[g].loss||0))h-=10;if(Arena.option.bp==="Always")h+=b[g].rank-b[f].rank;
if(Arena.option.bp==="Never")h+=b[f].rank-b[g].rank;h+=Math.range(-1,(b[g].hide||0)-(b[f].hide||0),1);h+=Math.range(-10,(b[f].army-b[g].army)/10,10);h+=Math.range(-10,(b[f].level-b[g].level)/10,10);return h});c.length>this.option.cache;)delete b[c.pop()]}if(this.option.enabled){if(!this.option.attacking||!b[this.option.attacking]||this.option.army!=="Any"&&b[this.option.attacking].army/d>this.option.army||this.option.level!=="Any"&&b[this.option.attacking].level/e>this.option.level){c=[];for(a in b)b[a].dead&&
b[a].dead+18E5>=Date.now()||typeof this.option.losses==="number"&&(b[a].loss||0)-(b[a].win||0)>=this.option.losses||this.option.army!=="Any"&&b[a].army/d>this.option.army||this.option.level!=="Any"&&b[a].level/e>this.option.level||c.push(a);if(c.length){a=this.option.attacking=c[Math.floor(Math.random()*c.length)];Dashboard.status(this,"Next Target: "+b[a].name+" (Level "+b[a].level+" "+this.knar[b[a].rank]+" with "+b[a].army+" army), "+c.length+" / "+length(b)+" targets")}else{this.option.attacking=
null;Dashboard.status(this,"No valid targets found ("+length(b)+" total)")}}}else{this.option.attacking=null;Dashboard.status(this)}};
Arena.work=function(a){if(!this.option.enabled||!this.option.attacking||Player.get("health")<=10||Queue.burn.stamina<5)return false;if(!a||this.option.general&&!Generals.to(Generals.best(this.option.type))||!Page.to("battle_arena"))return true;a=this.option.attacking;var c=$('form input[alt="'+this.option.type+'"]').first().parents("form");debug("Arena: Wanting to attack "+this.data.user[a].name+" ("+a+")");if(c.length){$('input[name="target_id"]',c).attr("value",a);Page.click($('input[type="image"]',
c))}else{log("Arena: Unable to find attack buttons, forcing reload");Page.to("index")}return true};Arena.order=[];
Arena.dashboard=function(a,c){var b,d,e=[],f=[],g=["rank","name","level","army","win","loss","hide"],h=this.data.user,k=Player.get("army"),j=Player.get("level");if(typeof a==="undefined"){this.order=[];for(b in h)this.order.push(b);a=1}typeof g[a]==="string"&&this.order.sort(function(m,l){m=h[m][g[a]]||0;l=h[l][g[a]]||0;if(typeof m==="string"||typeof l==="string")return c?l>m:l<m;return c?m-l:l-m});e.push('<div style="text-align:center;"><strong>Rank:</strong> '+this.knar[this.data.rank]+" ("+this.data.rank+
"), <strong>Targets:</strong> "+length(h)+" / "+this.option.cache+"</div><hr>");th(f,"Rank");th(f,"Name");th(f,"Level");th(f,"Army");th(f,"Wins");th(f,"Losses");th(f,"Hides");e.push('<table cellspacing="0" style="width:100%"><thead><tr>'+f.join("")+"</tr></thead><tbody>");for(d=0;d<this.order.length;d++){h=this.data.user[this.order[d]];f=[];td(f,'<img style="width:22px;height:22px;" src="'+imagepath+"arena_rank"+h.rank+'.gif">','title="'+this.knar[h.rank]+" (Rank "+h.rank+')"');th(f,h.name,'title="'+
b+'"');td(f,this.option.level!=="Any"&&h.level/j>this.option.level?"<i>"+h.level+"</i>":h.level);td(f,this.option.army!=="Any"&&h.army/k>this.option.army?"<i>"+h.army+"</i>":h.army);td(f,h.win||"");td(f,h.loss||"");td(f,h.hide||"");tr(e,f.join(""))}e.push("</tbody></table>");$("#golem-dashboard-Arena").html(e.join(""));if(typeof a!=="undefined")$("#golem-dashboard-Arena thead th:eq("+a+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Bank=new Worker("Bank",null);
Bank.data=null;Bank.option={general:true,above:1E4,hand:0,keep:1E4};Bank.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"above",label:"Bank Above",text:true},{id:"hand",label:"Keep in Cash",text:true},{id:"keep",label:"Keep in Bank",text:true}];Bank.work=function(a){if(Player.get("cash")<this.option.above)return false;if(!a)return true;if(!Bank.stash(Player.get("cash")-Math.min(this.option.above,this.option.hand)))return true;return false};
Bank.stash=function(a){if(!a||!Player.get("cash")||Math.min(Player.get("cash"),a)<=10)return true;if(Bank.option.general&&!Generals.to("Aeris"))return false;if(!Page.to("keep_stats"))return false;$('input[name="stash_gold"]').val(Math.min(Player.get("cash"),a));Page.click('input[value="Stash"]');return true};
Bank.retrieve=function(a){a-=Player.get("cash");if(a<=0)return true;if(Player.get("bank")-this.option.keep<a)return true;if(!Page.to("keep_stats"))return false;$('input[name="get_gold"]').val(a.toString());Page.click('input[value="Retrieve"]');return true};Bank.worth=function(a){var c=Player.get("cash")+Math.max(0,Player.get("bank")-Bank.option.keep);if(typeof a==="number")return a<=c;return c};var Battle=new Worker("Battle","battle_rank battle_battle");Battle.data={user:{},rank:{},points:{}};
Battle.option={general:true,points:true,monster:true,arena:true,losses:5,type:"Invade",bp:"Always",army:1.1,level:1.1,preferonly:false,prefer:[]};
Battle.symbol={1:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%17%90%B3%1AIn%99%AD%B0%3F%5Erj%7F%8A4%40J%22*1%FF%FF%FFm%0F%82%CD%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%ABIDATx%DAl%91%0B%0E%04!%08CAh%E7%FE7%DE%02%BA3%FBib%A2O%A8%02vm%91%00xN%B6%A1%10%EB%86O%0C%22r%AD%0Cmn%0C%8A%8Drxa%60-%B3p%AF%8C%05%0C%06%15d%E6-%5D%90%8D%E5%90~%B0x%A20e%117%0E%D9P%18%A1%60w%F3%B0%1D%1E%18%1C%85m'D%B9%08%E7%C6%FE%0F%B7%CF%13%C77%1Eo%F4%93%05%AA%24%3D%D9%3F%E1%DB%25%8E%07%BB%CA%D8%9C%8E%FE6%A6J%B9%1F%FB%DAa%8A%BFNW3%B5%9ANc%D5%FEn%9El%F7%20%F6tt%8C%12%F01%B4%CE%F8%9D%E5%B7%5E%02%0C%00n%97%07%B1AU%81%B7%00%00%00%00IEND%AEB%60%82",2:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%E0%0D%0CZ%5B%5Bv%13%0F%2F%1A%16%7Byx%8941DB%3F%FF%FF%FFOmpc%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B4IDATx%DAT%D1%5B%12%C5%20%08%03P%08%C2%DD%FF%8Eo%12%EB%D8%F2%D1%C7%C1%01%C5%F8%3DQ%05T%9D%BFxP%C6%07%EA%CDF%07p%998%B9%14%C3%C4aj%AE%9CI%A5%B6%875zFL%0F%C8%CD%19vrG%AC%CD%5C%BC%C6nM%D57'%EB%CA%AD%EC%C2%E5b%B5%93%5B%E9%97%99%40D%CC%97sw%DB%FByqwF%83u%FA%F2%C8%A3%93u%A0%FD%8C%B8%BA%96NAn%90%17%C1%C7%E1'%D7%F2%85%01%D4%DC%A7d%16%EDM2%1A%C3%C5%1E%15%7DX%C7%23%19%EB%1El%F5h%B2lV%5B%CF%ED%A0w%89~%AE'%CE%ED%01%F7%CA%5E%FC%8D%BF%00%03%00%AA%CE%08%23%FB4h%C4%00%00%00%00IEND%AEB%60%82",
3:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%B1%98g%DE%BCyqpq%8CnF%12%11%0EME7y8%0B%FF%FF%FF6%A1%E73%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B7IDATx%DA%5C%91Y%16C!%0CB%C9%40%BA%FF%1D%17%7Cz%9Em%BE%F4%8A%19%08%3E%3BX%40%F1%DC%B0%A1%99_xcT%EF(%BC8%D8%CC%9A%A9%D4!%0E%0E%8Bf%863%FE%16%0F%06%5BR%22%02%1C%A0%89%07w%E6T%AC%A8A%F6%C2%251_%9CPG%C2%A1r7N%CB%E1%1CtN%E7%06%86%7F%B85%8B%1A%22%2F%AC%3E%D4%B2_.%9C%C6%EA%B3%E2%C6%BB%24%CA%25uY%98%D5H%0D%EE%922%40b%19%09%CFNs%99%C8Y%E2XS%D2%F3*%0F7%B5%B9%B6%AA%16_%0E%9A%D61V%DCu-%E5%A2g%3BnO%C1%B3%1E%9C%EDiax%94%3F%F87%BE%02%0C%00%98%F2%07%E0%CE%8C%E4%B1%00%00%00%00IEND%AEB%60%82",
4:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%90%CA%3CSTRq%9B5On*%10%13%0Dx%7Ct6B'%FF%FF%FFx%0A%94%CE%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B2IDATx%DAT%D1A%16%C4%20%08%03P%20%92%B9%FF%8D'%80%B5%96%85%AF~%95*%D8o%07%09%90%CF%CC6%96%F5%CA%CD%E0%DAA%BC%0CM%B3C%CBxX%9A%E9%15Z%18%B7QW%E2%DB%9B%3D%E0%CD%99%11%18V%3AM%02%CD%FA%08.%8A%B5%D95%B1%A0%A7%E9Ci%D0%9Cb3%034D%F8%CB(%EE%F8%F0%F1%FA%C5ae9%BB%FD%B0%A7%CF%F9%1Au%9FfR%DB%A3%A19%179%CFa%B1%8E%EB*%91%BE_%B9*M%A9S%B7%97%AE)%15%B5%3F%BAX%A9%0Aw%C9m%9A%A0%CA%AA%20%5Eu%E5%D5%1DL%23%D4%9Eu7%AD%DBvZv%F17%FE%02%0C%00%D3%0A%07%E1%0961%CF%00%00%00%00IEND%AEB%60%82",
5:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%F2%F2%EF!!%20%A5%A5%A3vvv%5BZZ%3D%3D%3B%00%00%00%FF%FF%FF.%C4%F9%B3%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%BEIDATx%DA%5C%91Q%92%C30%08C%11B%DE%FB%DFx%25%C7n3%E5%23%E3%3Cd%01%A6%FEN%00%12p%FF%EA%40%A3%05%A7%F0%C6%C2%0A%CCW_%AC%B5%C4%1D9%5D%EC39%09'%B0y%A5%D8%E2H%5D%D53%DDH%E1%E05%A6%9A2'%9Bkcw%40%E9%C5e%5Ev%B6g%E4%B1)%DA%DF%EEQ%D3%A0%25Vw%EC%B9%D5)%C8%5Cob%9C%1E%E2%E2%D8%16%F1%94%F8%E0-%AF%B9%F8x%CB%F2%FE%C8g%1Eo%A03w%CA%86%13%DB%C4%1D%CA%7C%B7%E8w%E4d%FAL%E9%CE%9B%F3%F0%D0g%F8%F0%AD%CFSyD%DC%875%87%3B%B0%D1%5D%C4%D9N%5C%13%3A%EB%A9%F7.%F5%BB%CB%DF%F8%17%60%00%EF%2F%081%0F%2BNZ%00%00%00%00IEND%AEB%60%82"};
Battle.demi={1:"Ambrosia",2:"Malekus",3:"Corvintheus",4:"Aurora",5:"Azeron"};
Battle.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel"]},{id:"losses",label:"Attack Until",select:["Ignore",1,2,3,4,5,6,7,8,9,10],after:"Losses"},{id:"points",label:"Always Get Demi-Points",checkbox:true},{advanced:true,id:"arena",label:"Fight in Arena First",checkbox:true,help:"Only if the Arena is enabled!"},{advanced:true,id:"monster",label:"Fight Monsters First",checkbox:true},{id:"bp",label:"Get Battle Points<br>(Clears Cache)",
select:["Always","Never","Don't Care"]},{advanced:true,id:"cache",label:"Limit Cache Length",select:[100,200,300,400,500]},{id:"army",label:"Target Army Ratio<br>(Only needed for Invade)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for smaller target army. Reduce this number if you're losing in Invade"},{id:"level",label:"Target Level Ratio<br>(Mainly used for Duel)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for lower target level. Reduce this number if you're losing a lot"},
{advanced:true,id:"preferonly",label:"Fight Preferred Targets Only",checkbox:true},{advanced:true,id:"prefer",label:"Preferred Targets",multiple:"userid"}];Battle.init=function(){this._watch(Arena);this._watch(Monster)};
Battle.parse=function(){var a,c;if(Page.page==="battle_rank"){a={0:{name:"Squire",points:0}};$('tr[height="23"]').each(function(b,d){b=$(d).text().regex(/Rank ([0-9]+) - (.*)\s*([0-9]+)/i);a[b[0]]={name:b[1],points:b[2]}});if(length(a)>length(this.data.rank))this.data.rank=a}else if(Page.page==="battle_battle"){a=this.data.user;if(this.option.attacking){c=this.option.attacking;this.option.attacking=null;if($("div.results").text().match(/You cannot battle someone in your army/i))delete a[c];else if($("div.results").text().match(/Your opponent is dead or too weak/i)){a[c].hide=
(a[c].hide||0)+1;a[c].dead=Date.now()}else if($('img[src*="battle_victory"]').length)a[c].win=(a[c].win||0)+1;else if($('img[src*="battle_defeat"]').length)a[c].loss=(a[c].loss||0)+1;else this.option.attacking=c}this.data.points=$("#app"+APPID+"_app_body table.layout table table").prev().text().replace(/[^0-9\/]/g,"").regex(/([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10/);$("#app"+APPID+"_app_body table.layout table table tr:even").each(function(b,d){b=$('img[uid!==""]',d).attr("uid");
var e=$("td.bluelink",d).text().trim().regex(/Level ([0-9]+) (.*)/i),f;if(b&&e){f=Battle.rank(e[1]);if(!(Battle.option.bp==="Always"&&Player.get("rank")-f>5||!Battle.option.bp==="Never"&&Player.get("rank")-f<=5)){a[b]||(a[b]={});a[b].name=$("a",d).text().trim();a[b].level=e[0];a[b].rank=f;a[b].army=$("td.bluelink",d).next().text().regex(/([0-9]+)/);a[b].align=$('img[src*="graphics/symbol_"]',d).attr("src").regex(/symbol_([0-9])/i)}}})}return false};
Battle.update=function(){var a,c,b=this.data.user,d=[],e=[],f=Player.get("army"),g=Player.get("level"),h=Player.get("rank");for(a in b)if(this.option.bp==="Always"&&h-(b[a].rank||0)>=4||!this.option.bp==="Never"&&h-(b[a].rank||6)<=5)delete b[a];if(length(this.data.user)>this.option.cache){for(a in b)d.push(a);for(d.sort(function(k,j){var m=0;if((b[k].win||0)-(b[k].loss||0)<(b[j].win||0)-(b[j].loss||0))m+=10;else if((b[k].win||0)-(b[k].loss||0)>(b[j].win||0)-(b[j].loss||0))m-=10;if(Battle.option.bp===
"Always")m+=((b[j].rank||0)-(b[k].rank||0))/2;if(Battle.option.bp==="Never")m+=((b[k].rank||0)-(b[j].rank||0))/2;m+=Math.range(-1,(b[j].hide||0)-(b[k].hide||0),1);m+=Math.range(-10,((b[k].army||0)-(b[j].army||0))/10,10);m+=Math.range(-10,((b[k].level||0)-(b[j].level||0))/10,10);return m});d.length>Battle.option.cache;)delete b[d.pop()];d=[]}if(this.option.arena&&Arena.option.enabled&&Arena.option.attacking){this.option.attacking=null;Dashboard.status(this,"Battling in the Arena")}else if(this.option.monster&&
Monster.count){this.option.attacking=null;Dashboard.status(this,"Attacking Monsters")}else{if((!this.option.attacking||!b[this.option.attacking])&&this.option.prefer.length)for(c=0;c<this.option.prefer.length;c++){a=this.option.prefer[c];if(!/[^0-9]/g.test(a)){b[a]=b[a]||{};b[a].dead&&b[a].dead+18E5>=Date.now()||typeof this.option.losses==="number"&&(b[a].loss||0)-(b[a].win||0)>=this.option.losses||d.push(a,a,a,a,a,a,a,a,a,a)}}if(!this.option.preferonly&&(!this.option.attacking||!b[this.option.attacking]||
this.option.army!=="Any"&&b[this.option.attacking].army/f>this.option.army||this.option.level!=="Any"&&b[this.option.attacking].level/g>this.option.level)){if(this.option.points)for(a=0;a<this.data.points.length;a++)if(this.data.points[a]<10)e[a+1]=true;for(a in b)if(!(b[a].dead&&b[a].dead+18E5>=Date.now()||typeof this.option.losses==="number"&&(b[a].loss||0)-(b[a].win||0)>=this.option.losses||this.option.army!=="Any"&&(b[a].army||0)/f>this.option.army||this.option.level!=="Any"&&(b[a].level||0)/
g>this.option.level||this.option.points&&e.length&&b[a].align&&typeof e[b[a].align]==="undefined"))for(c=Math.range(1,(b[a].rank||0)-h+1,5);c>0;c--)d.push(a)}if(d.length){a=this.option.attacking=d[Math.floor(Math.random()*d.length)];Dashboard.status(this,"Next Target: "+b[a].name+" (Level "+b[a].level+" "+this.data.rank[b[a].rank].name+" with "+b[a].army+" army), "+d.length+" / "+length(b)+" targets")}else if(!this.option.attacking||!b[this.option.attacking]){this.option.attacking=null;Dashboard.status(this,
"No valid targets found ("+length(b)+" total)")}}};
Battle.work=function(a){if(!this.option.attacking||Player.get("health")<=10||Queue.burn.stamina<1||this.option.monster&&Monster.count||this.option.arena&&Arena.option.enabled&&Arena.option.attacking)return false;if(!a||this.option.general&&!Generals.to(Generals.best(this.option.type))||!Page.to("battle_battle"))return true;a=this.option.attacking;var c=$('form input[alt="'+this.option.type+'"]').first().parents("form");debug("Battle: Wanting to attack "+this.data.user[a].name+" ("+a+")");if(c.length){$('input[name="target_id"]',
c).attr("value",a);Page.click($('input[type="image"]',c))}else{log("Battle: Unable to find attack buttons, forcing reload");Page.to("index")}return true};Battle.rank=function(a){for(var c in Battle.data.rank)if(Battle.data.rank[c].name===a)return parseInt(c,10);return 0};Battle.order=[];
Battle.dashboard=function(a,c){var b,d;d=[0,0,0,0,0,0];var e=[],f=[],g=["align","name","level","rank","army","win","loss","hide"],h=this.data.user,k=Player.get("army"),j=Player.get("level");for(b in h)d[h[b].align]++;if(typeof a==="undefined"){this.order=[];for(b in h)this.order.push(b);a=1}typeof g[a]==="string"&&this.order.sort(function(m,l){m=h[m][g[a]]||0;l=h[l][g[a]]||0;if(typeof m==="string"||typeof l==="string")return c?l>m:l<m;return c?m-l:l-m});e.push('<div style="text-align:center;"><strong>Rank:</strong> '+
this.data.rank[Player.get("rank")].name+" ("+Player.get("rank")+"), <strong>Targets:</strong> "+length(h)+" / "+this.option.cache+", <strong>By Alignment:</strong>");for(b=1;b<6;b++)e.push(' <img src="'+this.symbol[b]+'" alt="'+this.demi[b]+'" title="'+this.demi[b]+'"> '+d[b]);e.push("</div><hr>");th(f,"Align");th(f,"Name");th(f,"Level");th(f,"Rank");th(f,"Army");th(f,"Wins");th(f,"Losses");th(f,"Hides");e.push('<table cellspacing="0" style="width:100%"><thead><tr>'+f.join("")+"</tr></thead><tbody>");
for(d=0;d<this.order.length;d++){h=this.data.user[this.order[d]];f=[];td(f,'<img src="'+this.symbol[h.align]+'" alt="'+this.demi[h.align]+'">','title="'+this.demi[h.align]+'"');th(f,h.name,'title="'+b+'"');td(f,this.option.level!=="Any"&&h.level/j>this.option.level?"<i>"+h.level+"</i>":h.level);td(f,this.data.rank[h.rank]?this.data.rank[h.rank].name:"");td(f,this.option.army!=="Any"&&h.army/k>this.option.army?"<i>"+h.army+"</i>":h.army);td(f,h.win||"");td(f,h.loss||"");td(f,h.hide||"");tr(e,f.join(""))}e.push("</tbody></table>");
$("#golem-dashboard-Battle").html(e.join(""));$("#golem-dashboard-Battle tbody tr td:nth-child(2)").css("text-align","left");if(typeof a!=="undefined")$("#golem-dashboard-Battle thead th:eq("+a+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Blessing=new Worker("Blessing","oracle_demipower");Blessing.data=null;Blessing.option={which:"Stamina",when:null};Blessing.which=["None","Energy","Attack","Defense","Health","Stamina"];
Blessing.display=[{id:"which",label:"Which",select:Blessing.which}];Blessing.parse=function(){var a=$("div.results"),c;if(a.length)if((c=a.text().regex(/Please come back in: ([0-9]+) hours and ([0-9]+) minutes/i))&&c.length)this.option.when=Date.now()+(c[0]*60+c[1]+1)*6E4;else if(a.text().match(/You have paid tribute to/i))this.option.when=Date.now()+8646E4;return false};
Blessing.work=function(a){if(!this.option.which||this.option.which==="None"||Date.now()<=this.option.when)return false;if(!a||!Page.to("oracle_demipower"))return true;Page.click("#app"+APPID+"_symbols_form_"+this.which.indexOf(this.option.which)+" input.imgButton");return true};var Elite=new Worker("Elite","keep_eliteguard army_viewarmy battle_arena");Elite.data={};
Elite.option={fill:true,arena:false,every:24,prefer:[],waitfill:0,waitarena:0,nextfill:null,nextarena:null,armyperpage:25,armylastpage:1,armyextra:0};Elite.display=[{id:"fill",label:"Fill Elite Guard",checkbox:true},{id:"arena",label:"Fill Arena Guard",checkbox:true},{id:"every",label:"Every",select:[1,2,3,6,12,24],after:"hours"},{advanced:true,label:"Add UserIDs to prefer them over random army members. These <b>must</b> be in your army to be checked.",id:"prefer",multiple:"userid"}];
Elite.init=function(){for(i in this.data)if(typeof this.data[i]==="number")this.data[i]={elite:this.data[i]}};
Elite.parse=function(){$("span.result_body").each(function(c,b){if(Elite.option.nextarena)if($(b).text().match(/has not joined in the Arena!/i))Elite.data[Elite.option.nextarena].arena=-1;else if($(b).text().match(/Arena Guard, and they have joined/i))Elite.data[Elite.option.nextarena].arena=Date.now()+864E5;else if($(b).text().match(/'s Arena Guard is FULL/i))Elite.data[Elite.option.nextarena].arena=Date.now()+36E5;else if($(b).text().match(/YOUR Arena Guard is FULL/i)){Elite.option.waitarena=Date.now();
debug("Arena guard full, wait "+Elite.option.every+" hours")}if($(b).text().match(/Elite Guard, and they have joined/i))Elite.data[$("img",b).attr("uid")].elite=Date.now()+864E5;else if($(b).text().match(/'s Elite Guard is FULL!/i))Elite.data[$("img",b).attr("uid")].elite=Date.now()+36E5;else if($(b).text().match(/YOUR Elite Guard is FULL!/i)){Elite.option.waitfill=Date.now();debug("Elite guard full, wait "+Elite.option.every+" hours")}});if(Page.page==="army_viewarmy"){var a=0;$('img[linked="true"][size="square"]').each(function(c,
b){c=$(b).attr("uid");b=$(b).parent().parent().next();a++;Elite.data[c]=Elite.data[c]||{};Elite.data[c].name=$("a",b).text();Elite.data[c].level=$(b).text().regex(/([0-9]+) Commander/i)});if(a<25)this.option.armyextra=Player.get("armymax")-length(this.data)-1}return false};
Elite.update=function(){var a,c;for(c=this.option.nextfill=this.option.nextarena=0;c<this.option.prefer.length;c++){a=this.option.prefer[c];if(!/[^0-9]/g.test(a)&&this.data[a]){if(!this.option.nextfill&&(typeof this.data[a].elite!=="number"||this.data[a].elite<Date.now()))this.option.nextfill=a;if(!this.option.nextarena&&(typeof this.data[a].arena!=="number"||this.data[a].arena!==-1&&this.data[a].arena<Date.now()))this.option.nextarena=a}}for(a in this.data){if(!this.option.nextfill&&(typeof this.data[a].elite!==
"number"||this.data[a].elite<Date.now()))this.option.nextfill=a;if(!this.option.nextarena&&(typeof this.data[a].arena!=="number"||this.data[a].arena!==-1&&this.data[a].arena<Date.now()))this.option.nextarena=a}};
Elite.work=function(a){if(Math.ceil((Player.get("armymax")-this.option.armyextra-1)/this.option.armyperpage)>this.option.armylastpage){if(a){debug("Elite: Filling army list");this.option.armylastpage=Math.max(this.option.armylastpage+1,Math.ceil((length(this.data)+1)/this.option.armyperpage));Page.to("army_viewarmy","?page="+this.option.armylastpage)}return true}if((!this.option.fill||this.option.waitfill+this.option.every*36E5>Date.now())&&(!this.option.arena||this.option.waitarena+this.option.every*
36E5>Date.now()))return false;if(!a)return true;if(!this.option.nextfill&&!this.option.nextarena&&!length(this.data)&&!Page.to("army_viewarmy"))return true;if(this.option.waitfill+this.option.every*36E5<=Date.now()){debug("Elite: Add Elite Guard member "+this.option.nextfill);if(!Page.to("keep_eliteguard","?twt=jneg&jneg=true&user="+this.option.nextfill))return true}if(this.option.waitarena+this.option.every*36E5<=Date.now()){debug("Elite: Add Arena Guard member "+this.option.nextarena);if(!Page.to("battle_arena",
"?user="+this.option.nextarena+"&lka="+this.option.nextarena+"&agtw=1&ref=nf"))return true}return false};var Generals=new Worker("Generals","heroes_generals");Generals.init=function(){for(var a in this.data)a.indexOf("\t")!==-1&&delete this.data[a];this._watch(Town)};
Generals.parse=function(){var a=$(".generalSmallContainer2"),c=this.data;if(a.length<length(c)){debug("Generals: Different number of generals, have "+a.length+", want "+length(c));return false}a.each(function(b,d){b=$(".general_name_div3_padding",d).text().trim();var e=$(d).text().regex(/Level ([0-9]+)/i);if(b&&b.indexOf("\t")===-1&&b.length<30)if(!c[b]||c[b].level!==e){c[b]=c[b]||{};c[b].img=$(".imgButton",d).attr("src").filepart();c[b].att=$(".generals_indv_stats_padding div:eq(0)",d).text().regex(/([0-9]+)/);
c[b].def=$(".generals_indv_stats_padding div:eq(1)",d).text().regex(/([0-9]+)/);c[b].level=e;c[b].skills=$("table div",d).html().replace(/\<[^>]*\>|\s+|\n/g," ").trim()}});return false};
Generals.update=function(){var a=this.data,c,b=[],d=Town.option.invade,e=Town.option.duel,f,g,h,k,j=function(m,l){m.push(l)};for(c in Generals.data)b.push(c);Config.set("generals",["any"].concat(b.sort()));if(d&&e)for(c in a){b=Player.get("attack")+(a[c].skills.regex(/([-+]?[0-9]+) Player Attack/i)||0)+(a[c].skills.regex(/Increase Player Attack by ([0-9]+)/i)||0);f=Player.get("defense")+(a[c].skills.regex(/([-+]?[0-9]+) Player Defense/i)||0)+(a[c].skills.regex(/Increase Player Defense by ([0-9]+)/i)||
0);g=a[c].skills.regex(/Increases? Army Limit to ([0-9]+)/i)||501;h=getAttDef(a,j,"att",Math.floor(g/5));k=getAttDef(a,j,"def",Math.floor(g/5));a[c].invade={att:Math.floor(d.attack+a[c].att+a[c].def*0.7+(b+f*0.7)*g+h),def:Math.floor(d.defend+a[c].def+a[c].att*0.7+(f+(a[c].skills.regex(/([-+]?[0-9]+) Defense when attacked/i)||0)+b*0.7)*g+k)};a[c].duel={att:Math.floor(e.attack+a[c].att+a[c].def*0.7+b+f*0.7),def:Math.floor(e.defend+a[c].def+a[c].att*0.7+f+(a[c].skills.regex(/([-+]?[0-9]+) Defense when attacked/i)||
0)+b*0.7)}}};Generals.to=function(a){this._unflush();if(a&&!this.data[a])a=this.best(a);if(!a||Player.get("general")===a||a==="any")return true;if(!a||!this.data[a]){log('General "'+a+'" requested but not found!');return true}if(!Page.to("heroes_generals"))return false;debug("Changing to General "+a);Page.click('input[src$="'+this.data[a].img+'"]');return false};
Generals.best=function(a){this._unflush();var c="",b=null,d=0,e;c=[];switch(a.toLowerCase()){case "cost":c=/Decrease Soldier Cost by ([0-9]+)/i;break;case "stamina":c=/Increase Max Stamina by ([0-9]+)|\+([0-9]+) Max Stamina/i;break;case "energy":c=/Increase Max Energy by ([0-9]+)|\+([0-9]+) Max Energy/i;break;case "income":c=/Increase Income by ([0-9]+)/i;break;case "item":c=/Chance +([0-9]+)% Drops for Quest/i;break;case "influence":c=/Bonus Influence ([0-9]+)/i;break;case "attack":c=/([-+]?[0-9]+) Player Attack/i;
break;case "defense":c=/([-+]?[0-9]+) Player Defense/i;break;case "cash":c=/Bonus ([0-9]+) Gold/i;break;case "invade":for(e in Generals.data)if(!b||Generals.data[e].invade&&Generals.data[e].invade.att>Generals.data[b].invade.att||Generals.data[e].invade&&Generals.data[e].invade.att===Generals.data[b].invade.att&&b!==Player.get("general"))b=e;return b||"any";case "duel":for(e in Generals.data)if(!b||Generals.data[e].duel&&Generals.data[e].duel.att>Generals.data[b].duel.att||Generals.data[e].duel&&
Generals.data[e].duel.att===Generals.data[b].duel.att&&b!==Player.get("general"))b=e;return b||"any";case "defend":for(e in Generals.data)if(!b||Generals.data[e].duel&&Generals.data[e].duel.def>Generals.data[b].duel.def||Generals.data[e].duel&&Generals.data[e].duel.def===Generals.data[b].duel.def&&b!==Player.get("general"))b=e;return b||"any";case "under level 4":if(Generals.data[Player.get("general")]&&Generals.data[Player.get("general")].level<4)return Player.get("general");for(e in Generals.data)Generals.data[e].level<
4&&c.push(e);return c.length?c[Math.floor(Math.random()*c.length)]:"any";default:return"any"}for(e in Generals.data)if(a=Generals.data[e].skills.regex(c))if(!b||a>d){b=e;d=a}return b||"any"};Generals.order=[];
Generals.dashboard=function(a,c){var b,d,e=[],f=[],g=0,h=0,k=0,j=0;if(typeof a==="undefined"){Generals.order=[];for(b in Generals.data)Generals.order.push(b);a=1}typeof a!=="undefined"&&Generals.order.sort(function(m,l){var n,o;if(a==1){m=m;l=l}else if(a==2){m=Generals.data[m].level||0;l=Generals.data[l].level||0}else{n=a<5?"invade":"duel";o=a%2?"att":"def";m=Generals.data[m][n][o]||0;l=Generals.data[l][n][o]||0}if(typeof m==="string"||typeof l==="string")return c?l>m:l<m;return c?m-l:l-m});for(b in Generals.data){g=
Math.max(g,Generals.data[b].invade?Generals.data[b].invade.att:1);h=Math.max(h,Generals.data[b].invade?Generals.data[b].invade.def:1);k=Math.max(k,Generals.data[b].duel?Generals.data[b].duel.att:1);j=Math.max(j,Generals.data[b].duel?Generals.data[b].duel.def:1)}f.push('<table cellspacing="0" style="width:100%"><thead><tr><th></th><th>General</th><th>Level</th><th>Invade<br>Attack</th><th>Invade<br>Defend</th><th>Duel<br>Attack</th><th>Duel<br>Defend</th></tr></thead><tbody>');for(d=0;d<Generals.order.length;d++){b=
Generals.order[d];e=[];e.push('<img src="'+imagepath+Generals.data[b].img+'" style="width:25px;height:25px;" title="'+Generals.data[b].skills+'">');e.push(b);e.push(Generals.data[b].level);e.push(Generals.data[b].invade?(g==Generals.data[b].invade.att?"<strong>":"")+addCommas(Generals.data[b].invade.att)+(g==Generals.data[b].invade.att?"</strong>":""):"?");e.push(Generals.data[b].invade?(h==Generals.data[b].invade.def?"<strong>":"")+addCommas(Generals.data[b].invade.def)+(h==Generals.data[b].invade.def?
"</strong>":""):"?");e.push(Generals.data[b].duel?(k==Generals.data[b].duel.att?"<strong>":"")+addCommas(Generals.data[b].duel.att)+(k==Generals.data[b].duel.att?"</strong>":""):"?");e.push(Generals.data[b].duel?(j==Generals.data[b].duel.def?"<strong>":"")+addCommas(Generals.data[b].duel.def)+(j==Generals.data[b].duel.def?"</strong>":""):"?");f.push("<tr><td>"+e.join("</td><td>")+"</td></tr>")}f.push("</tbody></table>");$("#golem-dashboard-Generals").html(f.join(""));$("#golem-dashboard-Generals tbody tr td:nth-child(2)").css("text-align",
"left");if(typeof a!=="undefined")$("#golem-dashboard-Generals thead th:eq("+a+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Gift=new Worker("Gift","index army_invite army_gifts",{keep:true});Gift.data={uid:[],todo:{},gifts:{}};Gift.option={type:"None",work:false};Gift.display=[{label:"Work in progress..."},{id:"type",label:"Return Gifts",select:["None","Random","Same as Received"]}];
Gift.lookup={"eq_gift_mystic_mystery.jpg":"Mystic Armor","eq_drakehelm_mystery.jpg":"Drake Helm","gift_angel_mystery2.jpg":"Battle Of Dark Legion","alchemy_serpent_mystery.jpg":"Serpentine Shield","alchemy_horn_mystery.jpg":"Poseidons Horn","gift_sea_egg_mystery.jpg":"Sea Serpent","gift_egg_mystery.jpg":"Dragon","gift_druid_mystery.jpg":"Whisper Bow","gift_armor_mystery.jpg":"Golden Hand","mystery_frost_weapon.jpg":"Frost Tear Dagger","eq_mace_mystery.jpg":"Morning Star"};
Gift.parse=function(a){if(a)return false;var c,b;if(Page.page==="index")!this.data.uid.length&&$("span.result_body").text().indexOf("has sent you a gift")>=0&&this.data.uid.push(1);else if(Page.page==="army_invite"){debug("Gift: Checking for accepted");if(this.data.lastgift)if($("div.result").text().indexOf("accepted the gift")>=0){c=this.data.lastgift;if(!this.data.todo[c].gifts)this.data.todo[c].gifts=[];this.data.todo[c].gifts.push($("div.result img").attr("src").filepart());this.data.lastgift=
null}debug("Gift: Checking for new gift to accept");c=this.data.uid=[];if($("div.messages").text().indexOf("gift")>=0){debug("Gift: Found gift div");$("div.messages img").each(function(d,e){c.push($(e).attr("uid"));debug("Gift: Adding gift from "+$(e).attr("uid"))})}}else if(Page.page==="army_gifts"){b=this.data.gifts={};$("#app"+APPID+'_giftContainer div[id^="app'+APPID+'_gift"]').each(function(d,e){d=$("img",e).attr("src").filepart();e=$(e).text().trim().replace("!","");b[d]||(b[d]={});b[d].name=
e;if(this.lookup[e])b[d].create=this.lookup[e]})}return false};Gift.work=function(a){if(!a){if(!this.data.uid.length)return false;return true}if(this.data.uid.length){if(!Page.to("army_invite"))return true;a=this.data.uid.shift();this.data.todo[a]||(this.data.todo[a]={});this.data.todo[a].time=Date.now();this.data.lastgift=a;debug("Gift: Accepting gift from "+a);if(!Page.to("army_invite","?act=acpt&rqtp=gift&uid="+a)||this.data.uid.length>0)return true}Page.to("keep_alchemy");return false};
var Heal=new Worker("Heal");Heal.data=null;Heal.option={stamina:0,health:0};Heal.display=[{id:"stamina",label:"Heal Above",after:"stamina",select:"stamina"},{id:"health",label:"...And Below",after:"health",select:"health"}];
Heal.work=function(a){if(Player.get("health")>=Player.get("maxhealth")||Player.get("stamina")<Heal.option.stamina||Player.get("health")>=Heal.option.health)return false;if(!a)return true;if(!Page.to("keep_stats"))return true;debug("Heal: Healing...");$('input[value="Heal Wounds"]').length?Page.click('input[value="Heal Wounds"]'):log("Danger Danger Will Robinson... Unable to heal!");return false};var Idle=new Worker("Idle");Idle.data=null;
Idle.option={general:"any",index:"Daily",alchemy:"Daily",quests:"Never",town:"Never",battle:"Daily"};Idle.when=["Never","Hourly","2 Hours","6 Hours","12 Hours","Daily","Weekly"];
Idle.display=[{label:"<strong>NOTE:</strong> Any workers below this will <strong>not</strong> run!<br>Use this for disabling workers you do not use."},{id:"general",label:"Idle General",select:"generals"},{label:"Check Pages:"},{id:"index",label:"Home Page",select:Idle.when},{id:"alchemy",label:"Alchemy",select:Idle.when},{id:"quests",label:"Quests",select:Idle.when},{id:"town",label:"Town",select:Idle.when},{id:"battle",label:"Battle",select:Idle.when}];
Idle.work=function(a){if(!a)return true;var c,b,d={index:["index"],alchemy:["keep_alchemy"],quests:["quests_quest1","quests_quest2","quests_quest3","quests_quest4","quests_quest5","quests_quest6","quests_demiquests","quests_atlantis"],town:["town_soldiers","town_blacksmith","town_magic","town_land"],battle:["battle_battle"]},e={Never:0,Hourly:36E5,"2 Hours":72E5,"6 Hours":216E5,"12 Hours":432E5,Daily:864E5,Weekly:6048E5};if(!Generals.to(this.option.general))return true;for(c in d)if(e[this.option[c]]){b=
Date.now()-e[this.option[c]];for(a=0;a<d[c].length;a++)if(!Page.data[d[c][a]]||Page.data[d[c][a]]<b)if(!Page.to(d[c][a]))return true}return true};var Income=new Worker("Income");Income.data=null;Income.option={general:true,bank:true,margin:30};Income.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true},{advanced:true,id:"margin",label:"Safety Margin",select:[15,30,45,60],suffix:"seconds"}];
Income.work=function(a){if(!Income.option.margin)return false;if(Player.get("cash_timer")>this.option.margin){if(a&&this.option.bank)return Bank.work(true);return false}if(!a)return true;if(this.option.general&&!Generals.to(Generals.best("income")))return true;debug("Income: Waiting for Income... ("+Player.get("cash_timer")+" seconds)");return true};var Land=new Worker("Land","town_land");Land.option={buy:true,wait:48,best:null,onlyten:false,lastlevel:0,bestbuy:0,bestcost:0};
Land.display=[{id:"buy",label:"Auto-Buy Land",checkbox:true},{id:"wait",label:"Maximum Wait Time",select:[0,24,36,48],suffix:"hours",help:"There has been a lot of testing in this code, it is the fastest way to increase your income despite appearances!"},{advanced:true,id:"onlyten",label:"Only buy 10x<br>NOTE: This is slower!!!",checkbox:true}];
Land.parse=function(){$("tr.land_buy_row,tr.land_buy_row_unique").each(function(a,c){a=$("img",c).attr("alt");var b;Land.data[a]={};Land.data[a].income=$(".land_buy_info .gold",c).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);Land.data[a].max=$(".land_buy_info",c).text().regex(/Max Allowed For your level: ([0-9]+)/i);Land.data[a].cost=$(".land_buy_costs .gold",c).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);if(b=$("option",$(".land_buy_costs .gold",c).parent().next()).last().attr("value"))Land.data[a].buy=
b;Land.data[a].own=$(".land_buy_costs span",c).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)});return false};
Land.update=function(){var a,c=Bank.worth(),b=Player.get("income")+Player.get("average_income"),d,e=0;for(a in this.data)if(this.data[a].buy)if(!d||this.data[d].cost/b+this.data[a].cost/(b+this.data[d].income)>this.data[a].cost/b+this.data[d].cost/(b+this.data[a].income))d=a;if(d){e=this.option.onlyten||this.data[d].cost*10<=c||this.data[d].own>=10&&this.data[d].cost*10/b<this.option.wait?Math.min(this.data[d].max-this.data[d].own,10):this.data[d].cost*5<=c||this.data[d].own>=10&&this.data[d].cost*
5/b<this.option.wait?Math.min(this.data[d].max-this.data[d].own,5):1;this.option.bestbuy=e;this.option.bestcost=e*this.data[d].cost;Dashboard.status(this,e+"x "+d+" for $"+addCommas(e*this.data[d].cost))}else Dashboard.status(this);this.option.best=d};
Land.work=function(a){if(!this.option.buy||!this.option.best||!Bank.worth(this.option.bestcost)){if(!this.option.best&&this.option.lastlevel<Player.get("level")){if(!a||!Page.to("town_land"))return true;this.option.lastlevel=Player.get("level")}return false}if(!a||!Bank.retrieve(this.option.bestcost)||!Page.to("town_land"))return true;$("tr.land_buy_row,tr.land_buy_row_unique").each(function(c,b){if($("img",b).attr("alt")===Land.option.best){debug("Land: Buying "+Land.option.bestbuy+" x "+Land.option.best+
" for $"+addCommas(Land.option.bestcost));$("select",$(".land_buy_costs .gold",b).parent().next()).val(Land.option.bestbuy>5?10:Land.option.bestbuy>1?5:1);Page.click($('.land_buy_costs input[name="Buy"]',b));$("#"+PREFIX+"Land_current").text("None")}});return true};var Monster=new Worker("Monster","keep_monster keep_monster_active battle_raid",{keep:true});Monster.option={fortify:50,dispel:50,choice:"All",raid:"Invade x5"};
Monster.display=[{label:"Work in progress..."},{id:"fortify",label:"Fortify Below",select:[10,20,30,40,50,60,70,80,90,100],after:"%"},{id:"dispel",label:"Dispel Above",select:[10,20,30,40,50,60,70,80,90,100],after:"%"},{label:'"All" is currently Random...'},{id:"choice",label:"Attack",select:["All","Strongest","Weakest","Shortest","Spread"]},{id:"raid",label:"Raid",select:["Invade","Invade x5","Duel","Duel x5"]},{id:"assist",label:"Use Assist Links in Dashboard",checkbox:true}];
Monster.types={kull:{name:"Kull, the Orc Captain",timer:259200},raid:{name:"The Deathrune Siege",list:"deathrune_list2.jpg",image:"raid_map_1.jpg",image2:"raid_map_2.jpg",dead:"raid_1_large_victory.jpg",timer:319920,timer2:519960,raid:true},colossus:{name:"Colossus of Terra",list:"stone_giant_list.jpg",image:"stone_giant_large.jpg",dead:"stone_giant_dead.jpg",timer:259200,mpool:1},gildamesh:{name:"Gildamesh, the Orc King",list:"orc_boss_list.jpg",image:"orc_boss.jpg",dead:"orc_boss_dead.jpg",timer:259200,
mpool:1},keira:{name:"Keira, the Dread Knight",list:"boss_keira_list.jpg",image:"boss_keira.jpg",dead:"boss_keira_dead.jpg",timer:172800,mpool:1},lotus:{name:"Lotus Ravenmoore",list:"boss_lotus_list.jpg",image:"boss_lotus.jpg",dead:"boss_lotus_big_dead.jpg",timer:172800,mpool:1},mephistopheles:{name:"Mephistopheles",list:"boss_mephistopheles_list.jpg",image:"boss_mephistopheles_large.jpg",dead:"boss_mephistopheles_dead.jpg",timer:172800,mpool:1},skaar:{name:"Skaar Deathrune",list:"death_list.jpg",
image:"death_large.jpg",dead:"death_dead.jpg",timer:345E3,mpool:1},sylvanus:{name:"Sylvanas the Sorceress Queen",list:"boss_sylvanus_list.jpg",image:"boss_sylvanus_large.jpg",dead:"boss_sylvanus_dead.jpg",timer:172800,mpool:1},dragon_emerald:{name:"Emerald Dragon",list:"dragon_list_green.jpg",image:"dragon_monster_green.jpg",dead:"dead_dragon_image_green.jpg",timer:259200,mpool:2},dragon_frost:{name:"Frost Dragon",list:"dragon_list_blue.jpg",image:"dragon_monster_blue.jpg",dead:"dead_dragon_image_blue.jpg",
timer:259200,mpool:2},dragon_gold:{name:"Gold Dragon",list:"dragon_list_gold.jpg",image:"dragon_monster_gold.jpg",dead:"dead_dragon_image_gold.jpg",timer:259200,mpool:2},dragon_red:{name:"Ancient Red Dragon",list:"dragon_list_red.jpg",image:"dragon_monster_red.jpg",dead:"dead_dragon_image_red.jpg",timer:259200,mpool:2},serpent_amethyst:{name:"Amethyst Sea Serpent",list:"seamonster_list_purple.jpg",image:"seamonster_purple.jpg",timer:259200,mpool:2},serpent_ancient:{name:"Ancient Sea Serpent",list:"seamonster_list_red.jpg",
image:"seamonster_red.jpg",timer:259200,mpool:2},serpent_emerald:{name:"Emerald Sea Serpent",list:"seamonster_list_green.jpg",image:"seamonster_green.jpg",timer:259200,mpool:2},serpent_sapphire:{name:"Sapphire Sea Serpent",list:"seamonster_list_blue.jpg",image:"seamonster_blue.jpg",timer:259200,mpool:2},cronus:{name:"Cronus, The World Hydra",list:"hydra_head.jpg",image:"hydra_large.jpg",dead:"hydra_dead.jpg",timer:604800,mpool:3},legion:{name:"Battle of the Dark Legion",list:"castle_siege_list.jpg",
image:"castle_siege_large.jpg",dead:"castle_siege_dead.jpg",timer:604800,mpool:3},genesis:{name:"Genesis, The Earth Elemental",list:"earth_element_list.jpg",image:"earth_element_large.jpg",dead:"earth_element_dead.jpg",timer:604800,mpool:3},ragnarok:{name:"Ragnarok, The Ice Elemental",list:"water_list.jpg",image:"water_large.jpg",dead:"water_dead.jpg",timer:604800,mpool:3}};Monster.dispel=['input[src=$"button_dispel.gif"]'];Monster.fortify=['input[src$="attack_monster_button3.jpg"]','input[src$="seamonster_fortify.gif"]'];
Monster.attack=['input[src$="attack_monster_button2.jpg"]','input[src$="seamonster_power.gif"]','input[src$="attack_monster_button.jpg"]','input[src$="event_attack2.gif"]','input[src$="event_attack1.gif"]'];Monster.count=0;Monster.uid=null;
Monster.init=function(){var a,c;for(a in Monster.data)for(c in Monster.data[a])Monster.data[a][c].state==="engage"&&Monster.count++;$("#golem-dashboard-Monster tbody td a").live("click",function(){var b=$(this).attr("href");Page.to(b.indexOf("raid")>0?"battle_raid":"keep_monster",b.substr(b.indexOf("?")));return false})};
Monster.parse=function(){var a,c,b,d,e=false,f,g;if(Page.page==="keep_monster_active"){Monster.uid=b=$('img[linked="true"][size="square"]').attr("uid");for(a in Monster.types)if(Monster.types[a].dead&&$('img[src$="'+Monster.types[a].dead+'"]').length){d=a;g=Monster.types[a].timer;e=true}else if(Monster.types[a].image&&$('img[src$="'+Monster.types[a].image+'"]').length){d=a;g=Monster.types[a].timer}else if(Monster.types[a].image2&&$('img[src$="'+Monster.types[a].image2+'"]').length){d=a;g=Monster.types[a].timer2||
Monster.types[a].timer}if(!b||!d){debug("Monster: Unknown monster (probably dead)");return false}Monster.data[b]=Monster.data[b]||{};Monster.data[b][d]=Monster.data[b][d]||{};f=Monster.data[b][d];if($('input[src*="collect_reward_button.jpg"]').length){f.state="reward";return false}if(e&&f.state==="assist")f.state=null;else if(e&&f.state==="engage")f.state="reward";else{if(!f.state&&$("span.result_body").text().match(/for your help in summoning|You have already assisted on this objective|You don't have enough stamina assist in summoning/i)){if($("span.result_body").text().match(/for your help in summoning/i))f.assist=
Date.now();f.state="assist"}if($('img[src$="icon_weapon.gif"],img[src$="battle_victory.gif"]').length)f.battle_count=(f.battle_count||0)+1;if(!f.name){b=$('img[linked="true"][size="square"]').parent().parent().next().text().trim().replace(/[\s\n\r]{2,}/g," ");f.name=b.substr(0,b.length-Monster.types[d].name.length-3)}b=$('img[src$="monster_health_background.jpg"]').parent();f.health=b.length?b.width()/b.parent().width()*100:0;b=$('img[src$="seamonster_ship_health.jpg"]').parent();if(b.length)f.defense=
b.width()/(b.next().length?b.width()+b.next().width():b.parent().width())*100;b=$('img[src$="bar_dispel.gif"]').parent();if(b.length)f.dispel=b.width()/(b.next().length?b.width()+b.next().width():b.parent().width())*100;f.timer=$("#app"+APPID+"_monsterTicker").text().parseTimer();f.finish=Date.now()+f.timer*1E3;f.damage_total=0;f.damage={};$('td.dragonContainer table table a[href^="http://apps.facebook.com/castle_age/keep.php?user="]').each(function(h,k){h=$(k).attr("href").regex(/user=([0-9]+)/i);
var j=$(k).parent().next().text().replace(/[^0-9\/]/g,"");k=j.regex(/([0-9]+)/);j=j.regex(/\/([0-9]+)/);f.damage[h]=j?[k,j]:[k];f.damage_total+=k});f.dps=f.damage_total/(g-f.timer);f.total=Monster.types[d].raid?f.damage_total+$('img[src$="monster_health_background.jpg"]').parent().parent().next().text().regex(/([0-9]+)/):Math.floor(f.damage_total/(100-f.health)*100);f.eta=Date.now()+Math.floor((f.total-f.damage_total)/f.dps)*1E3}}else if(Page.page==="keep_monster"||Page.page==="battle_raid"){if(!$("#app"+
APPID+"_app_body div.imgButton").length)return false;if(Page.page==="battle_raid")raid=true;for(b in Monster.data)for(d in Monster.data[b])if((Page.page==="battle_raid"&&Monster.types[d].raid||Page.page==="keep_monster"&&!Monster.types[d].raid)&&(Monster.data[b][d].state==="complete"||Monster.data[b][d].state==="assist"&&Monster.data[b][d].finish<Date.now()))Monster.data[b][d].state=null;$("#app"+APPID+"_app_body div.imgButton").each(function(h,k){var j=$("a",k).attr("href").regex(/user=([0-9]+)/i),
m=$(k).parent().parent().children().eq(1).html().regex(/graphics\/([^.]*\....)/i),l="unknown";for(h in Monster.types)if(m===Monster.types[h].list||m===Monster.types[h].lis2){l=h;break}if(!(!j||l==="unknown")){Monster.data[j]=Monster.data[j]||{};Monster.data[j][l]=Monster.data[j][l]||{};if(j===userID)Monster.data[j][l].name="You";else{m=$(k).parent().parent().children().eq(2).text().trim();Monster.data[j][l].name=m.substr(0,m.length-Monster.types[l].name.length-3)}switch($("img",k).attr("src").regex(/dragon_list_btn_([0-9])/)){case 2:Monster.data[j][l].state=
"reward";break;case 3:Monster.data[j][l].state="engage";break;case 4:Monster.data[j][l].state="complete";break;default:Monster.data[j][l].state="unknown";break}}})}Monster.count=0;for(a in Monster.data){for(c in Monster.data[a])if(Monster.data[a][c].state)Monster.data[a][c].state==="engage"&&Monster.count++;else delete Monster.data[a][c];length(Monster.data[a])||delete Monster.data[a]}return false};
Monster.work=function(a){var c,b,d=[],e=Monster.option.uid,f=Monster.option.type,g=null,h=null;if(!a||e&&f&&Monster.data[e][f].state!=="engage"&&Monster.data[e][f].state!=="assist"){Monster.option.uid=e=null;Monster.option.type=f=null}if(!length(Monster.data)||Player.get("health")<=10)return false;for(c in Monster.data)for(b in Monster.data[c])if(!Monster.data[c][b].health&&Monster.data[c][b].state==="engage"){if(a)Page.to(Monster.types[b].raid?"battle_raid":"keep_monster","?user="+c+(Monster.types[b].mpool?
"&mpool="+Monster.types[b].mpool:""));return true}if(!e||!f||!Monster.data[e]||!Monster.data[e][f]){for(e in Monster.data)for(f in Monster.data[e])if(Monster.data[e][f].state==="engage"&&Monster.data[e][f].finish>Date.now())if(Monster.option.choice==="All")d.push([e,f]);else if(!h||Monster.option.choice==="Strongest"&&Monster.data[e][f].health>Monster.data[h[0]][h[1]].health||Monster.option.choice==="Weakest"&&Monster.data[e][f].health<Monster.data[h[0]][h[1]].health||Monster.option.choice==="Shortest"&&
Monster.data[e][f].timer<Monster.data[h[0]][h[1]].timer||Monster.option.choice==="Spread"&&Monster.data[e][f].battle_count<Monster.data[h[0]][h[1]].battle_count)h=[e,f];if(Monster.option.choice==="All"&&d.length)h=d[Math.floor(Math.random()*d.length)];if(!h)return false;e=Monster.option.uid=h[0];f=Monster.option.type=h[1]}if(Queue.burn.stamina<5&&(Queue.burn.energy<10||(typeof Monster.data[e][f].defense==="undefined"||Monster.data[e][f].defense>Monster.option.fortify)&&(typeof Monster.data[e][f].dispel===
"undefined"||Monster.data[e][f].dispel<Monster.option.dispel)))return false;if(!a)return true;if(Monster.types[f].raid){if(!Generals.to(Generals.best(Monster.option.raid.indexOf("Invade")?"invade":"duel")))return true;debug("Raid: "+Monster.option.raid+" "+e);switch(Monster.option.raid){case "Invade":g=$('input[src$="raid_attack_button.gif"]:first');break;case "Invade x5":g=$('input[src$="raid_attack_button3.gif"]:first');break;case "Duel":g=$('input[src$="raid_attack_button2.gif"]:first');break;
case "Duel x5":g=$('input[src$="raid_attack_button4.gif"]:first');break}}else if(Monster.data[e][f].defense&&Monster.data[e][f].defense<=Monster.option.fortify&&Queue.burn.energy>=10){if(!Generals.to(Generals.best("defend")))return true;debug("Monster: Fortify "+e);for(c=0;c<Monster.fortify.length;c++)if($(Monster.fortify[c]).length){g=$(Monster.fortify[c]);break}}else if(Monster.data[e][f].dispel&&Monster.data[e][f].dispel>=Monster.option.dispel&&Queue.burn.energy>=10){if(!Generals.to(Generals.best("defend")))return true;
debug("Monster: Dispel "+e);for(c=0;c<Monster.dispel.length;c++)if($(Monster.dispel[c]).length){g=$(Monster.dispel[c]);break}}else{if(!Generals.to(Generals.best("duel")))return true;debug("Monster: Attack "+e);for(c=0;c<Monster.attack.length;c++)if($(Monster.attack[c]).length){g=$(Monster.attack[c]);break}}if((!g||!g.length||e!==Monster.uid)&&!Page.to(Monster.types[f].raid?"battle_raid":"keep_monster","?user="+e+(Monster.types[f].mpool?"&mpool="+Monster.types[f].mpool:"")))return true;Page.click(g);
return true};Monster.order=null;
Monster.dashboard=function(a,c){var b,d,e,f,g,h=[],k=[],j=[null,"name","health","defense","dispel",null,"timer","eta"],m={engage:0,assist:1,reward:2,complete:3},l;if(typeof a==="undefined"){a=1;Monster.order=[];for(b in Monster.data)for(d in Monster.data[b])Monster.order.push([b,d])}Monster.order.sort(function(n,o){var p,q;if(m[Monster.data[n[0]][n[1]].state]>m[Monster.data[o[0]][o[1]].state])return 1;if(m[Monster.data[n[0]][n[1]].state]<m[Monster.data[o[0]][o[1]].state])return-1;if(typeof j[a]===
"string"){p=Monster.data[n[0]][n[1]][j[a]];q=Monster.data[o[0]][o[1]][j[a]]}else if(a==4){p=Monster.data[n[0]][n[1]].damage?Monster.data[n[0]][n[1]].damage[userID]:0;q=Monster.data[o[0]][o[1]].damage?Monster.data[o[0]][o[1]].damage[userID]:0}if(typeof p==="string"||typeof q==="string")return c?(q||"")>(p||""):(q||"")<(p||"");return c?(p||0)-(q||0):(q||0)-(p||0)});th(k,"");th(k,"User");th(k,"Health",'title="(estimated)"');th(k,"Fortify");th(k,"Shield");th(k,"Damage");th(k,"Time Left");th(k,"Kill In",
'title="(estimated)"');h.push('<table cellspacing="0" style="width:100%"><thead><tr>'+k.join("")+"</tr></thead><tbody>");for(e=0;e<Monster.order.length;e++){b=Monster.order[e][0];d=Monster.order[e][1];if(Monster.types[d]){k=[];f=Monster.data[b][d];l=!((f.state==="engage"||f.state==="assist")&&f.total);g=Monster.option.assist&&(f.state==="engage"||f.state==="assist")?"?user="+b+"&action=doObjective"+(Monster.types[d].mpool?"&mpool="+Monster.types[d].mpool:"")+"&lka="+b+"&ref=nf":"?user="+b+(Monster.types[d].mpool?
"&mpool="+Monster.types[d].mpool:"");td(k,'<a href="http://apps.facebook.com/castle_age/'+(Monster.types[d].raid?"raid.php":"battle_monster.php")+g+'"><strong class="overlay">'+f.state+'</strong><img src="'+imagepath+Monster.types[d].list+'" style="width:90px;height:25px" alt="'+d+'"></a>','title="'+Monster.types[d].name+'"');th(k,Monster.data[b][d].name);td(k,l?"":f.health===100?"100%":addCommas(f.total-f.damage_total)+" ("+Math.floor(f.health)+"%)");td(k,l?"":isNumber(f.defense)?Math.floor(f.defense)+
"%":"");td(k,l?"":isNumber(f.dispel)?Math.floor(f.dispel)+"%":"");td(k,l?"":f.state==="engage"?addCommas(f.damage[userID][0]||0)+" ("+((f.damage[userID][0]||0)/f.total*100).round(1)+"%)":"",l?"":'title="In '+(f.battle_count||"an unknown number of")+' attacks"');td(k,l?"":f.timer?'<span class="golem-timer">'+makeTimer((f.finish-Date.now())/1E3)+"</span>":"?");td(k,l?"":'<span class="golem-timer">'+(f.health===100?makeTimer((f.finish-Date.now())/1E3):makeTimer((f.eta-Date.now())/1E3))+"</span>");tr(h,
k.join(""))}}h.push("</tbody></table>");$("#golem-dashboard-Monster").html(h.join(""));if(typeof a!=="undefined")$("#golem-dashboard-Monster thead th:eq("+a+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var News=new Worker("News","index");News.data=null;News.option=null;
News.parse=function(a){if(a){var c=0,b=0,d=0,e=0,f=0,g=0,h,k=[],j={},m;$("#app"+APPID+"_battleUpdateBox .alertsContainer .alert_content").each(function(l,n){l=$(n).text().replace(/,/g,"");var o=$("a:eq(0)",n).attr("href").regex(/user=([0-9]+)/i);j[o]=j[o]||{name:$("a:eq(0)",n).text(),win:0,lose:0};if(l.regex(/Victory!/i)){d++;j[o].lose++;c+=l.regex(/([0-9]+) experience/i);b+=l.regex(/([0-9]+) Battle Points!/i);g+=l.regex(/\$([0-9]+)/i)}else{e++;j[o].win++;c-=l.regex(/([0-9]+) experience/i);b-=l.regex(/([0-9]+) Battle Points!/i);
g-=l.regex(/\$([0-9]+)/i);l.regex(/You were killed/i)&&f++}});if(d||e){k.push("You were challenged <strong>"+(d+e)+"</strong> times, winning <strong>"+d+"</strong> and losing <strong>"+e+"</strong>.");k.push("You "+(c>=0?'gained <span class="positive">':'lost <span class="negative">')+addCommas(Math.abs(c))+"</span> experience points.");k.push("You "+(g>=0?'gained <span class="positive">':'lost <span class="negative">')+'<b class="gold">$'+addCommas(Math.abs(g))+"</b></span>.");k.push("You "+(b>=
0?'gained <span class="positive">':'lost <span class="negative">')+addCommas(Math.abs(b))+"</span> Battle Points.");k.push("");m=sortObject(j,function(l,n){return j[n].win+j[n].lose/100-(j[l].win+j[l].lose/100)});for(h=0;h<m.length;h++){a=m[h];k.push('<strong title="'+a+'">'+j[a].name+"</strong> "+(j[a].win?'beat you <span class="negative">'+j[a].win+"</span> time"+(j[a].win>1?"s":""):"")+(j[a].lose?(j[a].win?" and ":"")+'was beaten <span class="positive">'+j[a].lose+"</span> time"+(j[a].lose>1?"s":
""):"")+".")}if(f)k.push("You died "+(f>1?f+" times":"once")+"!");$("#app"+APPID+"_battleUpdateBox  .alertsContainer").prepend('<div style="padding: 0pt 0pt 10px;"><div class="alert_title">Summary:</div><div class="alert_content">'+k.join("<br>")+"</div></div>")}}return true};var Player=new Worker("Player","*",{keep:true});Player.data={history:{}};Player.option=null;Player.panel=null;
Player.init=function(){var a=new Date(script_started+$("*").html().regex(/gold_increase_ticker\(([0-9]+),/)*1E3);Player.data.cash_time=a.getSeconds()+a.getMinutes()*60};
Player.parse=function(a){var c=this.data,b=Math.floor(Date.now()/36E5);if(a){$("#app"+APPID+"_st_2_5 strong").attr("title",c.exp+"/"+c.maxexp).html(addCommas(c.maxexp-c.exp)+'<span style="font-weight:normal;"> in <span class="golem-timer" style="color:rgb(25,123,48);">'+makeTimer(this.get("level_timer"))+"</span></span>");return true}c.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);a=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);
c.energy=a[0]||0;c.maxenergy=a[1]||0;a=$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);c.health=a[0]||0;c.maxhealth=a[1]||0;a=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);c.stamina=a[0]||0;c.maxstamina=a[1]||0;a=$("#app"+APPID+"_st_2_5").text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);c.exp=a[0]||0;c.maxexp=a[1]||0;c.level=$("#app"+APPID+"_st_5").text().regex(/Level: ([0-9]+)!/i);c.armymax=$("a[href*=army.php]","#app"+
APPID+"_main_bntp").text().regex(/([0-9]+)/);c.army=Math.min(c.armymax,501);c.upgrade=$("a[href*=keep.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/)||0;c.general=$("div.general_name_div3").first().text().trim();c.imagepath=$("#app"+APPID+"_globalContainer img:eq(0)").attr("src").pathpart();if(Page.page==="keep_stats"){a=$("div.keep_attribute_section").first();if(a.length){c.myname=$("div.keep_stat_title > span",a).text().regex(/"(.*)"/);c.rank=$("td.statsTMainback img[src*=rank_medals]").attr("src").filepart().regex(/([0-9]+)/);
a=$("div.attribute_stat_container",a);c.attack=$(a).eq(2).text().regex(/([0-9]+)/);c.defense=$(a).eq(3).text().regex(/([0-9]+)/);c.bank=parseInt($("td.statsTMainback b.money").text().replace(/[^0-9]/g,""),10);a=$("td.statsTMainback tr tr").text().replace(/[^0-9$]/g,"").regex(/([0-9]+)\$([0-9]+)\$([0-9]+)/);c.maxincome=a[0];c.upkeep=a[1];c.income=a[2]}}if(Page.page==="town_land"){a=$(".mContTMainback div:last-child");c.income=a.eq(a.length-4).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)}c.history[b]=
typeof c.history[b]==="number"?{income:c.history[b]}:c.history[b]||{};c.history[b].bank=c.bank;c.history[b].exp=c.exp;$("span.result_body").each(function(e,f){e=$(f).text().replace(/,|\s+|\n/g,"");c.history[b].income=(c.history[b].income||0)+(e.regex(/Gain.*\$([0-9]+).*Cost/i)||0)+(e.regex(/stealsGold:\+\$([0-9]+)/i)||0)+(e.regex(/Youreceived\$([0-9]+)/i)||0)+(e.regex(/Yougained\$([0-9]+)/i)||0);if(e.regex(/incomepaymentof\$([0-9]+)gold/i))c.history[b].land=(e.regex(/incomepaymentof\$([0-9]+)gold/i)||
0)+(e.regex(/backinthemine:Extra([0-9]+)Gold/i)||0)});b-=168;for(var d in c.history)d<b&&delete c.history[d];return true};
Player.update=function(a){if(a!=="option"){var c,b=["stamina","energy","health"],d,e;for(c=0;c<b.length;c++){d=[];e=Divisor(Player.data["max"+b[c]]);for(a=0;a<=Player.data["max"+b[c]];a+=e)d.push(a);Config.set(b[c],d)}}Dashboard.status(this,"Exp: "+addCommas(this.get("average_exp"))+' per hour (<span class="golem-timer">'+makeTimer(this.get("level_timer"))+"</span> to next level), Income: $"+addCommas(this.get("average_income"))+" per hour (plus $"+addCommas(this.data.income)+" from land)")};
Player.get=function(a){var c,b=0,d=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,f=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,h=this.data;switch(a){case "cash":return parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);case "cash_timer":a=new Date;return(3600+h.cash_time-(a.getSeconds()+a.getMinutes()*60))%3600;case "energy":return $("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "energy_timer":return $("#app"+
APPID+"_energy_time_value").text().parseTimer();case "health":return $("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "health_timer":return $("#app"+APPID+"_health_time_value").text().parseTimer();case "stamina":return $("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "stamina_timer":return $("#app"+APPID+"_stamina_time_value").text().parseTimer();case "level_timer":return 3600*(h.maxexp-h.exp)/(this.get("average_exp")||
1);case "average_income":for(c in h.history)b+=h.history[c].income||0;return Math.floor(b/length(h.history));case "average_total_income":for(c in h.history)b+=(h.history[c].income||0)+(h.history[c].land||0);return Math.floor(b/length(h.history));case "average_cash":for(c in h.history)if(h.history[c].bank){b+=h.history[c].bank;f=Math.min(f,c);g=Math.max(g,c)}return Math.floor(b/length(h.history));case "average_exp":for(c in h.history)if(h.history[c].exp){d=Math.min(d,h.history[c].exp);e=Math.max(e,
h.history[c].exp);f=Math.min(f,c);g=Math.max(g,c)}return Math.floor((e-d)/(g-f));default:return this._get(a)}};
Player.dashboard=function(){var a=[];a.push('<table cellspacing="0" cellpadding="0" class="golem-graph"><thead><tr><th></th><th colspan="73"><span style="float:left;">&lArr; Older</span>72 Hour History<span style="float:right;">Newer &rArr;</span><th></th></th></tr></thead><tbody>');a.push(Player.makeGraph(["income","land"],"Income",true,this.get("average_total_income")));a.push(Player.makeGraph("bank","Bank",true,this.get("average_cash")));a.push(Player.makeGraph("exp","Experience",false,this.data.maxexp));
a.push("</tbody></table>");$("#golem-dashboard-Player").html(a.join(""))};
Player.makeGraph=function(a,c,b,d){var e,f,g=0,h,k,j=[];h=[];var m={},l=Math.floor(Date.now()/36E5);if(typeof d==="undefined")d=0;for(e=l-72;e<=l;e++)if(typeof a==="string"){m[e]=0;if(typeof Player.data.history[e]!=="undefined"&&typeof Player.data.history[e][a]!=="undefined"){f=Math.min(typeof f==="number"?f:Number.POSITIVE_INFINITY,Player.data.history[e][a]);g=Math.max(g,Player.data.history[e][a]);m[e]=Player.data.history[e][a]}}else if(typeof a==="object"){m[e]=[0,0];if(typeof Player.data.history[e]!==
"undefined"){if(typeof Player.data.history[e][a[0]]!=="undefined"){f=Math.min(typeof f==="number"?f:Number.POSITIVE_INFINITY,Player.data.history[e][a[0]]);g=Math.max(g,Player.data.history[e][a[0]]);m[e][0]=Player.data.history[e][a[0]]}if(typeof Player.data.history[e][a[1]]!=="undefined"){f=Math.min(typeof f==="number"?f:Number.POSITIVE_INFINITY,Player.data.history[e][a[1]]);g=Math.max(g,Player.data.history[e][a[1]]);m[e][1]=Player.data.history[e][a[1]]}if(typeof Player.data.history[e][a[1]]!=="undefined"&&
typeof Player.data.history[e][a[0]]!=="undefined")g=Math.max(g,Player.data.history[e][a[0]]+Player.data.history[e][a[1]])}}if(d)g=Math.max(g,d);if(g>=1E9){g=Math.ceil(g/1E9)*1E9;e=addCommas(g/1E9)+"b";k=addCommas(Math.round(d/1E8)/10)+"b";f=Math.floor(f/1E9)*1E9;h=addCommas(f/1E9)+"b"}else if(g>=1E6){g=Math.ceil(g/1E6)*1E6;e=g/1E6+"m";k=Math.round(d/1E5)/10+"m";f=Math.floor(f/1E6)*1E6;h=f/1E6+"m"}else if(g>=1E3){g=Math.ceil(g/1E3)*1E3;e=g/1E3+"k";k=Math.round(d/100)/10+"k";f=Math.floor(f/1E3)*1E3;
h=f/1E3+"k"}else{e=g||0;k=Math.round(d)||0;h=f||0}j.push('<th style="border-left:1px solid #dddddd;"><div>'+(b?"$":"")+e+"</div><div>"+c+"</div><div>"+(b?"$":"")+h+"</div></th>");for(e=l-72;e<=l;e++){h=[];if(typeof a==="string"&&m[e]){h.push('<div style="background:#00ff00;height:'+Math.ceil((m[e]-f)/(g-f)*100)+'px;"></div>');c=l-e+" hour"+(l-e==1?"":"s")+" ago, "+(b?"$":"")+addCommas(m[e])}else if(typeof a==="object"&&(m[e][0]||m[e][1])){h.push('<div style="background:#00aa00;height:'+Math.max(Math.ceil((m[e][0]-
f)/(g-f)*100),0)+'px;"></div>');h.push('<div style="background:#00ff00;height:'+Math.max(Math.ceil((m[e][1]-f)/(g-f)*100),0)+'px;"></div>');c=l-e+" hour"+(l-e==1?"":"s")+" ago, "+(b?"$":"")+addCommas(m[e][1])+" + "+(b?"$":"")+addCommas(m[e][0])+" = "+(b?"$":"")+addCommas(m[e][0]+m[e][1])}else c=l-e+" hour"+(l-e==1?"":"s")+" ago";d&&h.push('<div style="position:relative;background:#ff0000;height:1px;margin-top:-1px;bottom:'+Math.max(Math.ceil((d-f)/(g-f)*100),0)+'px;"></div>');td(j,h.join(""),'title="'+
c+'"')}d?th(j,'<div style="position:relative;height:10px;color:#ff0000;bottom:'+Math.max(Math.ceil((d-f)/(g-f)*100)+2,0)+'px;">'+(b?"$":"")+k+"</div>",'class="goal"'):th(j,"",'class="goal"');return"<tr>"+j.join("")+"</tr>"};var Potions=new Worker("Potions","keep_stats");Potions.option={energy:35,stamina:35,drink:false};
Potions.display=[{id:"energy",label:"Maximum Energy Potions",select:{0:0,5:5,10:10,15:15,20:20,25:25,30:30,35:35,40:40,infinite:"&infin;"},help:"Will use them when you have to many, if you collect more than 40 they will be lost anyway"},{id:"stamina",label:"Maximum Stamina Potions",select:{0:0,5:5,10:10,15:15,20:20,25:25,30:30,35:35,40:40,infinite:"&infin;"},help:"Will use them when you have to many, if you collect more than 40 they will be lost anyway"}];
Potions.parse=function(){this.data={};$(".statsT2:eq(2) .statUnit").each(function(a,c){if((a=$(c).text().replace(/\s+/g," ").trim().regex(/(.*) Potion x ([0-9]+)/i))&&a[0]&&a[1])Potions.data[a[0]]=a[1]});return false};
Potions.update=function(){var a=[];this.option.drink=false;for(var c in this.data){this.data[c]&&a.push(c+": "+this.data[c]);if(typeof this.option[c.toLowerCase()]==="number"&&this.data[c]>this.option[c.toLowerCase()]&&(Player.get(c.toLowerCase())||0)<(Player.get("max"+c.toLowerCase())||0))this.option.drink=true}Dashboard.status(this,a.join(", "))};
Potions.work=function(a){if(!this.option.drink)return false;if(!a||!Page.to("keep_stats"))return true;for(var c in this.data)if(typeof this.option[c.toLowerCase()]==="number"&&this.data[c]>this.option[c.toLowerCase()]){debug("Potions: Wanting to drink a "+c+" potion");Page.click('.statUnit:contains("'+c+'") form .imgButton input');break}return true};
var Quest=new Worker("Quest","quests_quest1 quests_quest2 quests_quest3 quests_quest4 quests_quest5 quests_quest6 quests_quest7 quests_demiquests quests_atlantis",{data:true,option:true});Quest.option={general:true,what:"Influence",unique:true,monster:true,best:null,bank:true,energy:0};Quest.land=["Land of Fire","Land of Earth","Land of Mist","Land of Water","Demon Realm","Undead Realm","Underworld"];Quest.area={quest:"Quests",demiquest:"Demi Quests",atlantis:"Atlantis"};Quest.current=null;
Quest.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"what",label:"Quest for",select:"quest_reward"},{id:"unique",label:"Get Unique Items First",checkbox:true},{id:"monster",label:"Fortify Monsters First",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true}];Quest.init=function(){for(var a in this.data)a.indexOf("\t")!==-1&&delete this.data[a]};
Quest.parse=function(){var a=this.data,c,b=null;if(Page.page==="quests_quest")return false;else if(Page.page==="quests_demiquests")c="demiquest";else if(Page.page==="quests_atlantis")c="atlantis";else{c="quest";b=Page.page.regex(/quests_quest([0-9]+)/i)-1}$("div.quests_background,div.quests_background_sub,div.quests_background_special").each(function(d,e){var f,g,h,k,j,m=0;if($(e).hasClass("quests_background_sub")){d=$(".quest_sub_title",e).text().trim();h=$(".qd_2_sub",e).text().replace(/[^0-9$]/g,
"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);j=$(".qd_3_sub",e).text().regex(/([0-9]+)/);f=$(".quest_sub_progress",e).text().regex(/LEVEL ([0-9]+)/i);g=$(".quest_sub_progress",e).text().regex(/INFLUENCE: ([0-9]+)%/i);m=2}else{d=$(".qd_1 b",e).text().trim();h=$(".qd_2",e).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);j=$(".quest_req b",e).text().regex(/([0-9]+)/);if($(e).hasClass("quests_background")){f=$(".quest_progress",e).text().regex(/LEVEL ([0-9]+)/i);g=$(".quest_progress",
e).text().regex(/INFLUENCE: ([0-9]+)%/i);m=1}else m=3}if(!(!d||d.indexOf("\t")!==-1)){a[d]={};a[d].area=c;if(typeof b==="number")a[d].land=b;if(typeof g==="number"){a[d].level=f||0;a[d].influence=g}a[d].exp=h.shift();a[d].reward=(h[0]+h[1])/2;a[d].energy=j;if(m!==2){if(m===3)a[d].unique=true;f=$(".qd_1 img",e).last();if(f.length&&f.attr("title")){a[d].item=f.attr("title").trim();a[d].itemimg=f.attr("src").filepart()}k={};$(".quest_req >div >div >div",e).each(function(l,n){l=$("img",n).attr("title");
k[l]=$(n).text().regex(/([0-9]+)/)});if(length(k))a[d].units=k;f=$(".quest_act_gen img",e);if(f.length&&f.attr("title"))a[d].general=f.attr("title")}}});return false};
Quest.update=function(){var a,c,b=null,d=[];for(a in this.data)this.data[a].item&&!this.data[a].unique&&d.push(this.data[a].item);Config.set("quest_reward",["Nothing","Influence","Experience","Cash"].concat(unique(d).sort()));if(this.option.unique&&Alchemy._changed>this.lastunique){for(a in this.data)if(this.data[a].unique&&!Alchemy.get(["ingredients",this.data[a].itemimg])&&(!b||this.data[a].energy<this.data[b].energy))b=a;this.lastunique=Date.now()}if(!b&&this.option.what!=="Nothing")for(a in this.data)if(this.option.what===
"Influence"&&typeof this.data[a].influence!=="undefined"&&this.data[a].influence<100&&(!b||this.data[a].energy<this.data[b].energy)||this.option.what==="Experience"&&(!b||this.data[a].energy/this.data[a].exp<this.data[b].energy/this.data[b].exp)||this.option.what==="Cash"&&(!b||this.data[a].energy/this.data[a].reward<this.data[b].energy/this.data[b].reward)||this.option.what!=="Influence"&&this.option.what!=="Experience"&&this.option.what!=="Cash"&&this.data[a].item===this.option.what&&(!b||this.data[a].energy<
this.data[b].energy))b=a;if(b!==this.option.best)if(this.option.best=b){this.option.energy=this.data[b].energy;debug("Quest: Wanting to perform - "+b+" (energy: "+this.option.energy+")");Dashboard.status(this,b+" (energy: "+this.option.energy+")")}else Dashboard.status(this);if(this.option.monster&&Monster.data)for(a in Monster.data)for(c in Monster.data[a])if(Monster.data[a][c].state==="engage"&&typeof Monster.data[a][c].defense==="number"&&Monster.data[a][c].defense<=Monster.option.fortify)return false};
Quest.work=function(a){if(!this.option.best||this.option.energy>Queue.burn.energy){if(a&&this.option.bank)return Bank.work(true);return false}if(!a)return true;a=null;var c=this.option.best;if(this.option.general)if(this.data[c].general){if(!Generals.to(this.data[c].general))return true}else{switch(this.option.what){case "Influence":case "Experience":a=Generals.best("under level 4");if(a==="any"&&this.data[c].influence<100)a=Generals.best("influence");break;case "Cash":a=Generals.best("cash");break;
default:a=Generals.best("item");break}if(!Generals.to(a))return true}switch(this.data[c].area){case "quest":if(!Page.to("quests_quest"+(this.data[c].land+1)))return true;break;case "demiquest":if(!Page.to("quests_demiquests"))return true;break;case "atlantis":if(!Page.to("quests_atlantis"))return true;break;default:debug("Quest: Can't get to quest area!");return false}debug("Quest: Performing - "+c+" (energy: "+this.data[c].energy+")");Page.click('div.action[title^="'+c+'"] input[type="image"]')||
Page.reload();this.option.unique&&this.data[c].unique&&Page.to("keep_alchemy");return true};Quest.order=[];
Quest.dashboard=function(a,c){function b(h){switch(a){case 0:return Quest.data[h].general||"zzz";case 1:return h;case 2:return typeof Quest.data[h].land==="number"&&typeof Quest.land[Quest.data[h].land]!=="undefined"?Quest.land[Quest.data[h].land]:Quest.area[Quest.data[h].area];case 3:return(typeof Quest.data[h].level!=="undefined"?Quest.data[h].level:-1)*100+(Quest.data[h].influence||0);case 4:return Quest.data[h].energy;case 5:return Quest.data[h].exp/Quest.data[h].energy;case 6:return Quest.data[h].reward/
Quest.data[h].energy;case 7:return Quest.data[h].item||"zzz"}return 0}var d,e,f=[],g=[];if(typeof a==="undefined"){this.order=[];for(d in this.data)this.order.push(d);a=1}this.order.sort(function(h,k){h=b(h);k=b(k);if(typeof h==="string"||typeof k==="string")return c?(k||"")>(h||""):(k||"")<(h||"");return c?(h||0)-(k||0):(k||0)-(h||0)});th(g,"General");th(g,"Name");th(g,"Area");th(g,"Level");th(g,"Energy");th(g,"@&nbsp;Exp");th(g,"@&nbsp;Reward");th(g,"Item");f.push('<table cellspacing="0" style="width:100%"><thead><tr>'+
g.join("")+"</tr></thead><tbody>");for(e=0;e<this.order.length;e++){d=this.order[e];g=[];td(g,Generals.data[this.data[d].general]?'<img style="width:25px;height:25px;" src="'+imagepath+Generals.data[this.data[d].general].img+'" alt="'+this.data[d].general+'" title="'+this.data[d].general+'">':"");th(g,d);td(g,typeof this.data[d].land==="number"?this.land[this.data[d].land].replace(" ","&nbsp;"):this.area[this.data[d].area].replace(" ","&nbsp;"));td(g,typeof this.data[d].level!=="undefined"?this.data[d].level+
"&nbsp;("+this.data[d].influence+"%)":"");td(g,this.data[d].energy);td(g,(this.data[d].exp/this.data[d].energy).round(2),'title="'+this.data[d].exp+" total, "+(this.data[d].exp/this.data[d].energy*12).round(2)+' per hour"');td(g,"$"+addCommas((this.data[d].reward/this.data[d].energy).round()),'title="$'+addCommas(this.data[d].reward)+" total, $"+addCommas((this.data[d].reward/this.data[d].energy*12).round())+' per hour"');td(g,this.data[d].itemimg?'<img style="width:25px;height:25px;" src="'+imagepath+
this.data[d].itemimg+'" alt="'+this.data[d].item+'" title="'+this.data[d].item+'">':"");tr(f,g.join(""),'style="height:25px;"')}f.push("</tbody></table>");$("#golem-dashboard-Quest").html(f.join(""));$("#golem-dashboard-Quest tbody tr td:nth-child(2)").css("text-align","left");if(typeof a!=="undefined")$("#golem-dashboard-Quest thead th:eq("+a+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Town=new Worker("Town","town_soldiers town_blacksmith town_magic");
Town.data={};Town.option={number:"Minimum",maxcost:"$100k",units:"All",sell:false};
Town.display=[{label:"Work in progress..."},{id:"number",label:"Buy Number",select:["None","Minimum","Match Army","Maximum"],help:"Minimum will buy before any quests (otherwise only bought when needed), Maximum will buy 501 (depending on generals)"},{advanced:true,id:"maxcost",label:"Maximum Buy Cost",select:["$10k","$100k","$1m","$10m","$100m","$1b","$10b","$100b"]},{advanced:true,id:"units",label:"Buy Type",select:["All","Best Offense","Best Defense","Best of Both"]},{advanced:true,id:"sell",label:"Auto-Sell<br>(Not enabled)",
checkbox:true}];
Town.blacksmith={Weapon:/avenger|axe|blade|bow|cudgel|dagger|halberd|mace|morningstar|rod|saber|spear|staff|stave|sword|talon|trident|wand|Daedalus|Dragonbane|Dreadnought Greatsword|Excalibur|Incarnation|Ironhart's Might|Judgement|Justice|Lightbringer|Oathkeeper|Onslaught/i,Shield:/buckler|shield|tome|Defender|Dragon Scale|Frost Dagger|Frost Tear Dagger|Harmony|Sword of Redemption|The Dreadnought/i,Helmet:/cowl|crown|helm|horns|mask|veil/i,Gloves:/gauntlet|glove|hand|bracer|Slayer's Embrace/i,Armor:/armor|chainmail|cloak|pauldrons|plate|robe|Blood Vestment|Faerie Wings|Ogre Raiments/i,
Amulet:/amulet|bauble|charm|eye|heart|jewel|lantern|memento|orb|shard|soul|talisman|trinket|Paladin's Oath|Poseidons Horn/i};Town.init=function(){if(this.data.soldiers||this.data.blacksmith||this.data.magic){this.data={};delete Page.data.town_soldiers;delete Page.data.town_blacksmith;delete Page.data.town_magic}};
Town.parse=function(a){if(a)Page.page==="town_blacksmith"&&$(".eq_buy_row,.eq_buy_row2").each(function(d,e){d=$("div.eq_buy_txt strong:first-child",e);e=d.text().trim();Town.data[e].type&&d.parent().append("<br>"+Town.data[e].type)});else{var c=Town.data,b=Page.page.substr(5);$(".eq_buy_row,.eq_buy_row2").each(function(d,e){var f;d=$("div.eq_buy_stats",e);var g=$(".eq_buy_txt strong:first",e).text().trim(),h=$("div.eq_buy_costs",e),k=$("strong:first-child",h).text().replace(/[^0-9]/g,"");c[g]=c[g]||
{};c[g].page=b;c[g].img=$("div.eq_buy_image img",e).attr("src").filepart();c[g].own=$("span:first-child",h).text().regex(/Owned: ([0-9]+)/i);c[g].att=$(".eq_buy_stats_int div:eq(0)",d).text().regex(/([0-9]+)\s*Attack/);c[g].def=$(".eq_buy_stats_int div:eq(1)",d).text().regex(/([0-9]+)\s*Defense/);if(k){c[g].cost=parseInt(k,10);c[g].buy=[];$('select[name="amount"]:first option',h).each(function(j,m){c[g].buy.push(parseInt($(m).val(),10))})}if(b==="blacksmith")for(f in Town.blacksmith)if(g.match(Town.blacksmith[f]))c[g].type=
f})}return true};
Town.getInvade=function(a){var c=0,b=0,d=this.data;c+=getAttDef(d,function(e,f,g){g[f].page==="soldiers"&&e.push(f)},"att",a,"invade");b+=getAttDef(d,null,"def",a,"invade");c+=getAttDef(d,function(e,f,g){g[f].type&&g[f].type!=="Weapon"&&e.push(f)},"att",a,"invade");b+=getAttDef(d,null,"def",a,"invade");c+=getAttDef(d,function(e,f,g){g[f].type==="Weapon"&&e.push(f)},"att",a,"invade");b+=getAttDef(d,null,"def",a,"invade");c+=getAttDef(d,function(e,f,g){g[f].page==="magic"&&e.push(f)},"att",a,"invade");
b+=getAttDef(d,null,"def",a,"invade");return{attack:c,defend:b}};
Town.getDuel=function(){var a=0,c=0,b=this.data;a+=getAttDef(b,function(d,e,f){f[e].type==="Weapon"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",1,"duel");a+=getAttDef(b,function(d,e,f){f[e].page==="magic"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",1,"duel");a+=getAttDef(b,function(d,e,f){f[e].type==="Shield"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",1,"duel");a+=getAttDef(b,function(d,e,f){f[e].type==="Helmet"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",
1,"duel");a+=getAttDef(b,function(d,e,f){f[e].type==="Gloves"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",1,"duel");a+=getAttDef(b,function(d,e,f){f[e].type==="Armor"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",1,"duel");a+=getAttDef(b,function(d,e,f){f[e].type==="Amulet"&&d.push(e)},"att",1,"duel");c+=getAttDef(b,null,"def",1,"duel");return{attack:a,defend:c}};
Town.update=function(){var a,c,b=null,d=0,e=this.data,f;this.option.invade=this.getInvade(Player.get("army"));this.option.duel=this.getDuel();if(this.option.number!=="None"){f=Quest.get();for(a in f)if(f[a].units)for(c in f[a].units)if(e[c]&&e[c].cost&&e[c].own<f[a].units[c]){b=c;d=f[a].units[c]-e[c].own}}if(this.option.best=b){this.option.bestbuy=d;this.option.bestcost=d*e[b].cost;Dashboard.status(this,"Want to buy "+d+" x "+b+" for $"+addCommas(this.option.bestcost))}else Dashboard.status(this)};
Town.work=function(a){if(!this.option.best||!this.option.bestbuy||!Bank.worth(this.option.bestcost))return false;if(!a||!Bank.retrieve(this.option.bestcost)||this.data[this.option.best].page==="soldiers"&&!Generals.to("cost")||!Page.to("town_"+this.data[this.option.best].page))return true;$(".eq_buy_row,.eq_buy_row2").each(function(c,b){if($(".eq_buy_txt strong:first",b).text().trim()===Town.option.best){debug("Town: Buying "+Town.option.bestbuy+" x "+Town.option.best+" for $"+addCommas(Town.option.bestcost));
$('.eq_buy_costs select[name="Amount"]:eq(0)',b).val(Town.option.bestbuy>5?10:Town.option.bestbuy>1?5:1);Page.click($('.eq_buy_costs input[name="Buy"]',b))}});return true};
var makeTownDash=function(a,c,b,d,e,f){var g=[],h=[],k=b==="att"?"def":"att",j,m={Weapon:1,Shield:2,Helmet:3,Armor:4,Amulet:5,Gloves:6,Magic:7};e&&h.push('<div class="golem-panel"><h3 class="golem-panel-header">'+e+'</h3><div class="golem-panel-content">');for(j in a)c(g,j,a);if(a[g[0]])if(d==="duel"&&a[g[0]].type)g.sort(function(l,n){return m[a[l].type]-m[a[n].type]});else a[g[0]]&&a[g[0]].skills&&a[g[0]][d]?g.sort(function(l,n){return(a[n][d][b]||0)-(a[l][d][b]||0)}):g.sort(function(l,n){return a[n][b]+
0.7*a[n][k]-(a[l][b]+0.7*a[l][k])});for(j=0;j<(f?f:g.length);j++)if(a[g[0]]&&a[g[0]].skills||a[g[j]].use&&a[g[j]].use[d+"_"+b])h.push('<div style="height:25px;margin:1px;"><img src="'+imagepath+a[g[j]].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+(a[g[j]].use?a[g[j]].use[d+"_"+b]+" x ":"")+g[j]+" ("+a[g[j]].att+" / "+a[g[j]].def+")"+(a[g[j]].cost?"<br>$"+addCommas(a[g[j]].cost):"")+"</div>");e&&h.push("</div></div>");return h.join("")};
Town.dashboard=function(){var a,c;c=Generals.get();var b;b=Generals.best("duel");a='<div style="float:left;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(c,function(d,e){d.push(e)},"att","invade","Heroes")+makeTownDash(this.data,function(d,e,f){f[e].page==="soldiers"&&f[e].use&&d.push(e)},"att","invade","Soldiers")+makeTownDash(this.data,function(d,e,f){f[e].use&&f[e].type==="Weapon"&&d.push(e)},
"att","invade","Weapons")+makeTownDash(this.data,function(d,e,f){f[e].use&&f[e].type!=="Weapon"&&d.push(e)},"att","invade","Equipment")+makeTownDash(this.data,function(d,e,f){f[e].page==="magic"&&f[e].use&&d.push(e)},"att","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+(b!=="any"?'<div style="height:25px;margin:1px;"><img src="'+imagepath+c[b].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+
b+" ("+c[b].att+" / "+c[b].def+")</div>":"")+makeTownDash(this.data,function(d,e,f){f[e].page==="blacksmith"&&f[e].use&&d.push(e)},"att","duel")+makeTownDash(this.data,function(d,e,f){f[e].page==="magic"&&f[e].use&&d.push(e)},"att","duel")+"</div></div></div>";b=Generals.best("defend");c='<div style="float:right;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(c,function(d,e){d.push(e)},"def",
"invade","Heroes")+makeTownDash(this.data,function(d,e,f){f[e].page==="soldiers"&&f[e].use&&d.push(e)},"def","invade","Soldiers")+makeTownDash(this.data,function(d,e,f){f[e].use&&f[e].type==="Weapon"&&d.push(e)},"def","invade","Weapons")+makeTownDash(this.data,function(d,e,f){f[e].use&&f[e].type!=="Weapon"&&d.push(e)},"def","invade","Equipment")+makeTownDash(this.data,function(d,e,f){f[e].page==="magic"&&f[e].use&&d.push(e)},"def","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+
(b!=="any"?'<div style="height:25px;margin:1px;"><img src="'+imagepath+c[b].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+b+" ("+c[b].att+" / "+c[b].def+")</div>":"")+makeTownDash(this.data,function(d,e,f){f[e].page==="blacksmith"&&f[e].use&&d.push(e)},"def","duel")+makeTownDash(this.data,function(d,e,f){f[e].page==="magic"&&f[e].use&&d.push(e)},"def","duel")+"</div></div></div>";$("#golem-dashboard-Town").html(a+c)};var Upgrade=new Worker("Upgrade","keep_stats");
Upgrade.data=null;Upgrade.option={order:[],working:false,run:0};Upgrade.display=[{label:"Points will be allocated in this order, add multiple entries if wanted (ie, 3x Attack and 1x Defense would put &frac34; on Attack and &frac14; on Defense)"},{id:"order",multiple:["Energy","Stamina","Attack","Defense","Health"]}];Upgrade.init=function(){this.option.working=this.data.working;this.option.run=this.data.run};
Upgrade.parse=function(){var a=$("div.results");if(this.option.working&&a.length&&a.text().match(/You just upgraded your/i)){this.option.working=false;this.option.run++}return false};
Upgrade.work=function(a){var c=Player.get("upgrade");if(this.option.run>=this.option.order.length)this.option.run=0;if(!this.option.order.length||!c||this.option.order[this.option.run]==="Stamina"&&c<2)return false;if(!a||!Page.to("keep_stats"))return true;switch(this.option.order[this.option.run]){case "Energy":a='a[href$="?upgrade=energy_max"]';break;case "Stamina":a='a[href$="?upgrade=stamina_max"]';break;case "Attack":a='a[href$="?upgrade=attack"]';break;case "Defense":a='a[href$="?upgrade=defense"]';
break;case "Health":a='a[href$="?upgrade=health_max"]';break;default:this.option.run++;return true}if(Page.click(a))return this.option.working=true;Page.reload();return true};
