// ==UserScript==
// @name           Rycochet's Castle Age Golem
// @namespace      golem
// @description    Auto player for castle age game
// @version        29
// @include        http*://apps.*facebook.com/castle_age/*
// @require        http://cloutman.com/jquery-latest.min.js
// @require        http://cloutman.com/jquery-ui-latest.min.js
// ==/UserScript==
// -- @include        http://www.facebook.com/common/error.html
// -- @include        http://www.facebook.com/reqs.php#confirm_46755028429_0
// -- @include        http://www.facebook.com/home.php
// -- @include        http://www.facebook.com/home.php*filter=app_46755028429*
var show_debug=true,VERSION=29,script_started=Date.now(),applications={castle_age:["46755028429","Castle Age"]};if(window.location.hostname==="apps.facebook.com"||window.location.hostname==="apps.new.facebook.com")for(var i in applications)if(window.location.pathname.indexOf(i)===1){var APP=i,APPID=applications[i][0],APPNAME=applications[i][1],PREFIX="golem"+APP+"_";break}var log=function(b){console.log(b)},debug=function(b){show_debug&&console.log(b)};
if(typeof unsafeWindow==="undefined")unsafeWindow=window;var userID=0;function parse_all(){Page.identify();var b,c=[];for(b in Workers)if(Workers[b].pages&&(Workers[b].pages==="*"||Page.page&&Workers[b].pages.indexOf(Page.page)>=0)&&Workers[b].parse)Workers[b].parse(false)?c.push(Workers[b]):Workers[b].save();for(b in c){c[b].parse(true);c[b].save()}}
if(typeof APP!=="undefined"){var node_trigger=null;$(document).ready(function(){var b;userID=$("head").html().regex(/user:([0-9]+),/i);do_css();Page.identify();for(b=0;b<Workers.length;b++)Workers[b].load();for(b=0;b<Workers.length;b++)Workers[b].onload&&Workers[b].onload();for(b=0;b<Workers.length;b++)Workers[b].update&&Workers[b].update("data");parse_all();$("body").bind("DOMNodeInserted",function(c){if(!node_trigger&&($(c.target).attr("id")==="app"+APPID+"_app_body_container"||$(c.target).attr("id")===
"app"+APPID+"_globalContainer"))node_trigger=window.setTimeout(function(){node_trigger=null;parse_all()},100)})})}
function do_css(){$("head").append("<style type=\"text/css\">.red { background: red !important; }.golem-config { float: none; margin-right: 0; }.golem-config > div { position: static; width: 196px; margin: 0; padding: 0; overflow: hidden; overflow-y: auto; }.golem-config #golem_fixed { float:right; margin:-2px; width:16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00.IDATx%DAb%60A%03%0Cd%0B03%81%18LH%02%10%80%2C%C0%84%24%00%96d%C2%A7%02%AB%19L%8C%A8%B6P%C3%E9%08%00%10%60%00%00z%03%C7%24%170%91%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-config-fixed { float: right; margin-right: 200px; }.golem-config-fixed > div { position: fixed; }.golem-config-fixed #golem_fixed { background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%005IDATx%DAb%60A%03%0C%C4%0901%83%00%13%92%0A%B0%00%0B)%02%8C%CCLLL%CC%0Cx%0CefF%E8%81%B9%83%19%DDa%84%05H%F0%1C%40%80%01%00%FE9%03%C7%D4%8CU%A3%00%00%00%00IEND%AEB%60%82') no-repeat; }#golem-dashboard { position: absolute; width: 600px; height: 185px; margin: 0; border-left: 1px solid black; border-right:1px solid black; overflow: hidden; background: white; z-index: 1; }#golem-dashboard tbody tr:nth-child(odd) { background: #eeeeee; }#golem-dashboard td, #golem-dashboard th { margin: 2px; text-align: center; padding: 0 8px; }#golem-dashboard > div { height: 163px; overflow-y: scroll; border-top: 1px solid #d3d3d3; }#golem-dashboard > div > div { padding: 2px; }table.golem-graph { height: 100px }table.golem-graph tbody th { text-align: right; max-width: 75px; border-right: 1px solid #cccccc; }table.golem-graph tbody th div { line-height: 60px; height: 60px; }table.golem-graph tbody th div:first-child, table.golem-graph tbody th div:last-child { line-height: 20px; height: 20px; }table.golem-graph tbody td { margin: 0; padding: 0 !important; vertical-align: bottom; width: 5px; border-right: 1px solid white; }table.golem-graph tbody td:nth-child(12n+1) { border-right: 1px solid #cccccc; }table.golem-graph tbody td div { margin: 0; padding: 0; background: #00aa00; width: 5px; border-top: 1px solid blue; }table.golem-graph tbody td div:last-child { background: #00ff00; }.golem-button, .golem-button-active { border: 1px solid #d3d3d3; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; font-weight: normal; font-size: 13px; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-button:hover, .golem-button-active { border: 1px solid #aaaaaa; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }img.golem-button, img.golem-button-active { margin-bottom: -2px }.golem-tab-header { position: relative; top: 1px; border: 1px solid #d3d3d3; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 1px 2px; -moz-border-radius-topleft: 3px; -webkit-border-top-left-radius: 3px; border-top-left-radius: 3px; -moz-border-radius-topright: 3px; -webkit-border-top-right-radius: 3px; border-top-right-radius: 3px; }.golem-tab-header-active { border: 1px solid #aaaaaa; border-bottom: 0 !important; padding: 2px; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }.golem-title { padding: 4px; overflow: hidden; border-bottom: 1px solid #aaaaaa; background: #cccccc url(http://cloutman.com/css/base/images/ui-bg_highlight-soft_75_cccccc_1x100.png) 50% 50% repeat-x; color: #222222; font-weight: bold; }.golem-panel > .golem-panel-header, .golem-panel > * > .golem-panel-header { border: 1px solid #d3d3d3; cursor: pointer; margin-top: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-panel > .golem-panel-content, .golem-panel > * > .golem-panel-content { border: 1px solid #aaaaaa; border-top: 0 !important; padding: 2px 6px; background: #ffffff url(http://cloutman.com/css/base/images/ui-bg_glass_65_ffffff_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #212121; display: none; -moz-border-radius-bottomleft: 3px; -webkit-border-bottom-left-radius: 3px; border-bottom-left-radius: 3px; -moz-border-radius-bottomright: 3px; -webkit-border-bottom-right-radius: 3px; border-bottom-right-radius: 3px; }.golem-panel-show > .golem-panel-header, .golem-panel-show > * > .golem-panel-header { border: 1px solid #aaaaaa; border-bottom: 0 !important; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; -moz-border-radius-bottomleft: 0 !important; -webkit-border-bottom-left-radius: 0 !important; border-bottom-left-radius: 0 !important; -moz-border-radius-bottomright: 0 !important; -webkit-border-bottom-right-radius: 0 !important; border-bottom-right-radius: 0 !important; }.golem-panel-show > .golem-panel-content, .golem-panel-show > * > .golem-panel-content { display: block; }.golem-panel-sortable .golem-lock { display: none; }.golem-panel .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C%D4%13%60%C0%10%60%C0%10%60%C0%10%60%20%A4%82%90-%149%1D%20%C0%00%81%0E%00%F1%DE%25%95%BE%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-panel .golem-panel-header .golem-lock { float: right; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%001IDATx%DAb%60D%03%0CD%0B000%A0%0800%C0D%E0%02%8C(%02%0C%0Cp%25%B8%05%18%09%0A%A0j%C1%B4%96%1C%BF%C0%01%40%80%01%00n%11%00%CF%7D%2Bk%9B%00%00%00%00IEND%AEB%60%82') no-repeat;}.golem-panel-show .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C4%13%60%80%00%24%15%08%3EL%0B%9C%CF%88N%D3%D0a%C8%00%20%C0%00%7F%DE%00%F1%CCc%A6b%00%00%00%00IEND%AEB%60%82') no-repeat; }</style>")}
String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.filepart=function(){var b=this.lastIndexOf("/");if(b>=0)return this.substr(b+1);return this};String.prototype.pathpart=function(){var b=this.lastIndexOf("/");if(b>=0)return this.substr(0,b+1);return this};String.prototype.regex=function(b){b=this.match(b);var c;if(b){b.shift();for(c=0;c<b.length;c++)if(b[c]&&b[c].search(/^[-+]?[0-9]+\.?[0-9]*$/)>=0)b[c]=parseFloat(b[c]);if(b.length===1)return b[0]}return b};
String.prototype.toNumber=function(){return parseFloat(this)};String.prototype.parseTimer=function(){var b=this.split(":"),c=0,a;for(a=0;a<b.length;a++)c=c*60+parseInt(b[a],10);if(isNaN(c))c=9999;return c};Number.prototype.round=function(b){return result=Math.round(this*Math.pow(10,b||0))/Math.pow(10,b||0)};
var makeTimer=function(b){var c=Math.floor(b/3600),a=Math.floor(b/60)%60;b=Math.floor(b%60);return(c?c+":"+(a>9?a:"0"+a):a)+":"+(b>9?b:"0"+b)},WorkerByName=function(b){for(var c in Workers)if(Workers[c].name===b)return Workers[c];return null},WorkerById=function(b){for(var c in Workers)if(Workers[c].priv_id===b)return Workers[c];return null},Divisor=function(b){var c=b,a=1;if(c<20)return 1;for(;c>100;){c/=10;a*=10}if(b/a>40)a*=5;else if(b/a>20)a*=2.5;return a},length=function(b){var c=0,a;if(typeof b===
"object")for(a in b)c++;else if(typeof b==="array")c=b.length;return c},unique=function(b){var c={},a,d=b.length,e=[];for(a=0;a<d;a++)c[b[a]]=b[a];for(a in c)e.push(c[a]);return e},addCommas=function(b){b=b.toString();for(var c=/(-?[0-9]+)([0-9]{3})/;c.test(b);)b=b.replace(c,"$1,$2");return b},findInArray=function(b,c){if(typeof b==="array"||typeof b==="object")for(var a in b)if(b[a]===c)return true;return false},getAttDefList=[],getAttDef=function(b,c,a,d,e){var f=[],g=0,h=0,j=a==="att"?"def":"att",
k;if(c)for(k in b)c(f,k,b);else f=getAttDefList;f.sort(function(m,l){return b[l][a]+0.7*b[l][j]-(b[m][a]+0.7*b[m][j])});for(k=0;k<f.length;k++){c=typeof b[f[k]].own==="number"?b[f[k]].own:1;if(e)if(Math.min(d,c)>0){if(!b[f[k]].use)b[f[k]].use={};b[f[k]].use[e+"_"+a]=Math.min(d,c)}else if(b[f[k]].use){delete b[f[k]].use[e+"_"+a];length(b[f[k]].use)||delete b[f[k]].use}if(d<=0)break;c=Math.min(d,c);g+=c*b[f[k]].att;h+=c*b[f[k]].def;d-=c}getAttDefList=f;return(a==="att"?g:0.7*g)+(a==="def"?h:0.7*h)};
if(typeof GM_getValue!=="undefined")var setItem=function(b,c){GM_setValue(b,c)},getItem=function(b){return GM_getValue(b)};else if(typeof localStorage!=="undefined"){setItem=function(b,c){localStorage.setItem("golem."+APP+b,c)};getItem=function(b){return localStorage.getItem("golem."+APP+b)}}else if(typeof window.localStorage!=="undefined"){setItem=function(b,c){window.localStorage.setItem("golem."+APP+b,c)};getItem=function(b){return window.localStorage.getItem("golem."+APP+b)}}else if(typeof globalStorage!==
"undefined"){setItem=function(b,c){globalStorage[location.hostname].setItem("golem."+APP+b,c)};getItem=function(b){return globalStorage[location.hostname].getItem("golem."+APP+b)}}var Workers=[];
function Worker(b,c){this.id=Workers.push(this);this.name=b;this.pages=c;this.unsortable=false;this.data={};this.option={};this.update=this.work=this.parse=this.display=this.onload=null;this.priv_since=0;this.priv_id=null;this.load=function(a){if(a!=="data"&&a!=="option"){this.load("data");this.load("option")}else{var d=getItem(userID+"."+a+"."+this.name)||this[a];if(typeof d!=="string")this[a]=d;else switch(d.charAt(0)){case '"':this[a]=d.replace(/^"|"$/g,"");return;case "(":case "[":if(typeof this[a]===
"array"||typeof this[a]==="object"){this[a]=$.extend(true,{},this[a],eval(d));return}this[a]=eval(d);return}}};this.save=function(a){if(a!=="data"&&a!=="option")return this.save("data")+this.save("option");if(typeof this[a]==="undefined"||!this[a])return false;var d=userID+"."+a+"."+this.name,e;switch(typeof this[a]){case "string":e='"'+this[a]+'"';break;case "array":case "object":e=this[a].toSource();break;default:e=this[a];break}if(getItem(d)==="undefined"||getItem(d)!==e){this.update&&this.update(a);
GM_setValue(d,e);return true}return false}}var Config=new Worker("Config");Config.data=null;Config.option={display:"block",fixed:true};Config.panel=null;
Config.onload=function(){$("head").append('<link rel="stylesheet" href="http://cloutman.com/css/base/jquery-ui.css" type="text/css" />');var b,c;Config.panel=$('<div class="golem-config'+(Config.option.fixed?" golem-config-fixed":"")+'"><div class="ui-widget-content"><div class="golem-title">Castle Age Golem v'+VERSION+'<img id="golem_fixed"></div><div id="golem_buttons" style="margin:4px;"><img class="golem-button'+(Config.option.display==="block"?"-active":"")+'" id="golem_options" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%E2%E2%E2%8A%8A%8A%AC%AC%AC%FF%FF%FFUUU%1C%CB%CE%D3%00%00%00%04tRNS%FF%FF%FF%00%40*%A9%F4%00%00%00%3DIDATx%DA%A4%8FA%0E%00%40%04%03%A9%FE%FF%CDK%D2%B0%BBW%BD%CD%94%08%8B%2F%B6%10N%BE%A2%18%97%00%09pDr%A5%85%B8W%8A%911%09%A8%EC%2B%8CaM%60%F5%CB%11%60%00%9C%F0%03%07%F6%BC%1D%2C%00%00%00%00IEND%AEB%60%82"></div><div id="golem_config" style="display:'+
Config.option.display+';margin:0 4px 4px 4px;overflow:hidden;overflow-y:auto;"></div></div></div>');$("div.UIStandardFrame_Content").after(Config.panel);$("#golem_options").click(function(){$(this).toggleClass("golem-button golem-button-active");Config.option.display=Config.option.display==="block"?"none":"block";$("#golem_config").toggle("blind");Config.save("option")});$("#golem_fixed").click(function(){Config.option.fixed^=true;$(this).closest(".golem-config").toggleClass("golem-config-fixed");
Config.save("option")});b=$("#golem_config");for(c in Workers)b.append(Config.makePanel(Workers[c]));b.sortable({axis:"y"});$(".golem-config .golem-panel > h3").click(function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Config.save("option")});else{$(this).parent().toggleClass("golem-panel-show");
$(this).next().show("blind");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Config.save("option")}});b.children(".golem-panel-sortable").draggable({connectToSortable:"#golem_config",axis:"y",distance:5,scroll:false,handle:"h3",helper:"clone",opacity:0.75,zIndex:100,refreshPositions:true,stop:function(){Config.updateOptions()}}).droppable({tolerance:"pointer",over:function(a,d){Config.getPlace($(this).attr("id"))<Config.getPlace($(d.draggable).attr("id"))?
$(this).before(d.draggable):$(this).after(d.draggable)}});for(c in Workers)Workers[c].select&&Workers[c].select();$("input.golem_addselect").click(function(){$("select.golem_multiple",$(this).parent()).append("<option>"+$(".golem_select",$(this).parent()).val()+"</option>");Config.updateOptions()});$("input.golem_delselect").click(function(){$("select.golem_multiple option[selected=true]",$(this).parent()).each(function(a,d){$(d).remove()});Config.updateOptions()});$("input ,textarea, select",b).change(function(){Config.updateOptions()})};
Config.makePanel=function(b){var c,a,d,e,f,g=b.display,h=[],j=[],k=[],m={before:"",after:"",suffix:"",className:"",between:"to",size:7,min:0,max:100};if(!g)return false;b.priv_id="golem_panel_"+b.name.toLowerCase().replace(/[^0-9a-z]/,"_");a=findInArray(Config.option.active,b.priv_id);f=$('<div id="'+b.priv_id+'" class="golem-panel'+(b.unsortable?"":" golem-panel-sortable")+(a?" golem-panel-show":"")+'" name="'+b.name+'"><h3 class="golem-panel-header "><img class="golem-icon">'+b.name+'<img class="golem-lock"></h3></div>');
switch(typeof g){case "array":case "object":for(c in g){j=[];k=[];a=$.extend(true,{},m,g[c]);a.real_id=PREFIX+b.name+"_"+a.id;a.value=b.option[a.id]||null;a.alt=a.alt?' alt="'+a.alt+'"':"";if(a.label){j.push('<span style="float:left;margin-top:2px;">'+a.label.replace(" ","&nbsp;")+"</span>");if(a.text||a.checkbox||a.select||a.multiple)j.push('<span style="float:right;">')}a.before&&j.push(a.before+" ");if(a.info)a.id?j.push('<span style="float:right" id="'+a.real_id+'">'+a.info+"</span>"):j.push(a.info);
else if(a.text)j.push('<input type="text" id="'+a.real_id+'" size="'+a.size+'" value="'+(a.value||"")+'">');else if(a.checkbox)j.push('<input type="checkbox" id="'+a.real_id+'"'+(a.value?" checked":"")+">");else if(a.select){switch(typeof a.select){case "string":a.className=' class="golem_'+a.select+'"';break;case "number":e=Divisor(a.select);for(d=0;d<=a.select;d+=e)k.push("<option"+(a.value==d?" selected":"")+">"+d+"</option>");break;case "array":case "object":for(d in a.select)k.push('<option value="'+
a.select[d]+'"'+(a.value==a.select[d]?" selected":"")+">"+a.select[d]+(a.suffix?" "+a.suffix:"")+"</option>");break}j.push('<select id="'+a.real_id+'"'+a.className+a.alt+">"+k.join("")+"</select>")}else if(a.multiple){if(typeof a.value==="array"||typeof a.value==="object")for(c in a.value)k.push('<option value="'+a.value[c]+'">'+a.value[c]+"</option>");j.push('<select style="width:100%" class="golem_multiple" multiple id="'+a.real_id+'">'+k.join("")+"</select><br>");if(typeof a.multiple==="string")j.push('<input class="golem_select" type="text" size="'+
a.size+'">');else{k=[];switch(typeof a.multiple){case "number":e=Divisor(a.select);for(d=0;d<=a.multiple;d+=e)k.push("<option>"+d+"</option>");break;case "array":for(d=0;d<a.multiple.length;d++)k.push('<option value="'+a.multiple[d]+'">'+a.multiple[d]+(a.suffix?" "+a.suffix:"")+"</option>");break;case "object":for(d in a.multiple)k.push('<option value="'+d+'">'+a.multiple[d]+(a.suffix?" "+a.suffix:"")+"</option>");break}j.push('<select class="golem_select">'+k.join("")+"</select>")}j.push('<input type="button" class="golem_addselect" value="Add" /><input type="button" class="golem_delselect" value="Del" />')}a.after&&
j.push(" "+a.after);if(a.label&&(a.text||a.checkbox||a.select||a.multiple))j.push("</span>");h.push('<div style="clear:both"'+(a.help?' title="'+a.help+'"':"")+">"+j.join("")+"</div>")}f.append('<div class="golem-panel-content" style="font-size:smaller;">'+h.join("")+'<div style="clear:both"></div></div>');return f;default:return null}};
Config.updateOptions=function(){debug("Options changed");var b={},c;Queue.option.queue=[];$("#golem_config > div").each(function(a,d){a=WorkerById($(d).attr("id")).name;b[a]||Queue.option.queue.push(a);b[a]=true});$("#golem_config :input").each(function(a,d){if($(d).attr("id")){var e;if(a=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))if($(d).attr("type")==="checkbox")WorkerByName(a[0]).option[a[1]]=$(d).attr("checked");else{if($(d).attr("multiple")){e=[];$("option",d).each(function(f,
g){e.push($(g).text())})}else if((e=$(d).attr("value")||$(d).val()||null)&&e.search(/[^0-9.]/)===-1)e=parseFloat(e);WorkerByName(a[0]).option[a[1]]=e}}});for(c=0;c<Workers.length;c++)Workers[c].save("option")};Config.getPlace=function(b){var c=-1;$("#golem_config > div").each(function(a,d){if($(d).attr("id")===b&&c===-1)c=a});return c};var Dashboard=new Worker("Dashboard","*");Dashboard.data=null;Dashboard.option={display:"block",active:null};Dashboard.div=null;
Dashboard.onload=function(){var b,c=[],a=[],d=Dashboard.option.active;for(i in Workers)if(Workers[i].dashboard){b="golem-dashboard-"+Workers[i].name;if(!d)Dashboard.option.active=d=b;c.push('<h3 name="'+b+'" class="golem-tab-header'+(d===b?" golem-tab-header-active":"")+'">'+Workers[i].name+"</h3>");a.push('<div id="'+b+'"'+(d===b?"":' style="display:none;"')+"></div>");d===b&&Dashboard.option.display==="block"&&Workers[i].dashboard()}Dashboard.div=$('<div id="golem-dashboard" style="top:'+$("#app"+
APPID+"_main_bn").offset().top+"px;display:"+Dashboard.option.display+';">'+c.join("")+"<div>"+a.join("")+"</div></div>").prependTo(".UIStandardFrame_Content");$(".golem-tab-header").click(function(){if(!$(this).hasClass("golem-tab-header-active")){$("#"+$(this).attr("name")).children().length||WorkerByName($(this).attr("name").substr(16)).dashboard();if(Dashboard.option.active){$('h3[name="'+Dashboard.option.active+'"]').removeClass("golem-tab-header-active");$("#"+Dashboard.option.active).hide()}Dashboard.option.active=
$(this).attr("name");$(this).addClass("golem-tab-header-active");$("#"+Dashboard.option.active).show();Dashboard.save("option")}});$("#golem-dashboard .golem-panel > h3").live("click",function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind")}});$("#golem_buttons").append('<img class="golem-button'+(Dashboard.option.display===
"block"?"-active":"")+'" id="golem_toggle_dash" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%1EPLTE%BA%BA%BA%EF%EF%EF%E5%E5%E5%D4%D4%D4%D9%D9%D9%E3%E3%E3%F8%F8%F8%40%40%40%FF%FF%FF%00%00%00%83%AA%DF%CF%00%00%00%0AtRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%00%B2%CC%2C%CF%00%00%00EIDATx%DA%9C%8FA%0A%00%20%08%04%B5%CC%AD%FF%7F%B8%0D%CC%20%E8%D20%A7AX%94q!%7FA%10H%04%F4%00%19*j%07Np%9E%3B%C9%A0%0C%BA%DC%A1%91B3%98%85%AF%D9%E1%5C%A1%FE%F9%CB%14%60%00D%1D%07%E7%0AN(%89%00%00%00%00IEND%AEB%60%82">');
$("#golem_toggle_dash").click(function(){$(this).toggleClass("golem-button golem-button-active");Dashboard.option.display=Dashboard.option.display==="block"?"none":"block";Dashboard.option.display==="block"&&!$("#"+Dashboard.option.active).children().length&&WorkerByName(Dashboard.option.active.substr(16)).dashboard();$("#golem-dashboard").toggle("drop");Dashboard.save("option")});window.setInterval(function(){$(".golem-timer").each(function(e,f){$(f).text(makeTimer($(f).text().parseTimer()-1))})},
1E3)};Dashboard.parse=function(){$("#golem-dashboard").css("top",$("#app"+APPID+"_main_bn").offset().top+"px")};Dashboard.change=function(b){var c="golem-dashboard-"+b.name;Dashboard.option.active===c&&Dashboard.option.display==="block"?b.dashboard():$("#"+c).empty()};var Page=new Worker("Page");Page.unsortable=true;Page.option={timeout:15,retry:5};Page.page="";Page.last=null;Page.lastclick=null;Page.when=null;Page.retry=0;Page.checking=true;
Page.display=[{id:"timeout",label:"Retry after",select:[10,15,30,60],after:"seconds"}];Page.work=function(b){if(!Page.checking)return false;var c,a,d,e=null;for(c=0;c<Workers.length&&!e;c++)if(!(!Workers[c].pages||Workers[c].pages==="*")){d=Workers[c].pages.split(" ");for(a=0;a<d.length;a++)if(Page.pageNames[d[a]]&&!Page.data[d[a]]&&d[a].indexOf("_active")===-1){e=d[a];break}}if(!b){if(e)return true;return Page.checking=false}if(e&&!Page.to(e)){Page.data[e]=Date.now();return true}return false};
Page.pageNames={index:{url:"index.php",image:null},quests_quest:{url:"quests.php",image:"tab_quest_on.gif"},quests_quest1:{url:"quests.php?land=1",image:"land_fire_sel.gif"},quests_quest2:{url:"quests.php?land=2",image:"land_earth_sel.gif"},quests_quest3:{url:"quests.php?land=3",image:"land_mist_sel.gif"},quests_quest4:{url:"quests.php?land=4",image:"land_water_sel.gif"},quests_quest5:{url:"quests.php?land=5",image:"land_demon_realm_sel.gif"},quests_quest6:{url:"quests.php?land=6",image:"land_undead_realm_sel.gif"},
quests_quest7:{url:"quests.php?land=7",image:"tab_underworld_big.gif"},quests_demiquests:{url:"symbolquests.php",image:"demi_quest_on.gif"},quests_atlantis:{url:"monster_quests.php",image:"tab_atlantis_on.gif"},battle_battle:{url:"battle.php",image:"battle_on.gif"},battle_training:{url:"battle_train.php",image:"training_grounds_on_new.gif"},battle_rank:{url:"battlerank.php",image:"tab_battle_rank_on.gif"},battle_raid:{url:"raid.php",image:"tab_raid_on.gif"},battle_arena:{url:"arena.php",image:"tab_arena_on.gif"},
heroes_heroes:{url:"mercenary.php",image:"tab_heroes_on.gif"},heroes_generals:{url:"generals.php",image:"tab_generals_on.gif"},town_soldiers:{url:"soldiers.php",image:"tab_soldiers_on.gif"},town_blacksmith:{url:"item.php",image:"tab_black_smith_on.gif"},town_magic:{url:"magic.php",image:"tab_magic_on.gif"},town_land:{url:"land.php",image:"tab_land_on.gif"},oracle_oracle:{url:"oracle.php",image:"oracle_on.gif"},oracle_demipower:{url:"symbols.php",image:"demi_on.gif"},oracle_treasurealpha:{url:"treasure_chest.php",
image:"tab_treasure_alpha_on.gif"},oracle_treasurevanguard:{url:"treasure_chest.php?treasure_set=alpha",image:"tab_treasure_vanguard_on.gif"},keep_stats:{url:"keep.php?user="+userID,image:"tab_stats_on.gif"},keep_eliteguard:{url:"party.php?user="+userID,image:"tab_elite_guard_on.gif"},keep_achievements:{url:"achievements.php",image:"tab_achievements_on.gif"},keep_alchemy:{url:"alchemy.php",image:"tab_alchemy_on.gif"},keep_monster:{url:"battle_monster.php",image:"tab_monster_on.jpg"},keep_monster_active:{url:"battle_monster.php",
image:"dragon_view_more.gif"},army_invite:{url:"army.php",image:"invite_on.gif"},army_gifts:{url:"gift.php",image:null},army_viewarmy:{url:"army_member.php",image:"view_army_on.gif"},army_sentinvites:{url:"army_reqs.php",image:"sent_invites_on.gif"}};
Page.identify=function(){Page.page="";if(!$("#app"+APPID+"_globalContainer").length){Page.reload();return null}$("#app"+APPID+"_app_body img").each(function(b,c){var a;b=$(c).attr("src").filepart();for(a in Page.pageNames)if(b===Page.pageNames[a].image){Page.page=a;return}});if($("#app"+APPID+"_indexNewFeaturesBox").length)Page.page="index";else if($('div[style*="giftpage_title.jpg"]').length)Page.page="army_gifts";if(Page.page!=="")Page.data[Page.page]=Date.now();return Page.page};Page.loading=false;
Page.to=function(b,c){if(b===Page.page&&typeof c==="undefined")return true;c||(c="");if(b&&Page.pageNames[b]&&Page.pageNames[b].url){Page.clear();Page.last=Page.pageNames[b].url;Page.when=Date.now();if(c.indexOf("?")===0&&Page.last.indexOf("?")>0)Page.last=Page.last.substr(0,Page.last.indexOf("?"))+c;else Page.last+=c;debug("Navigating to "+Page.last+" ("+Page.pageNames[b].url+")");Page.ajaxload()}return false};
Page.ajaxload=function(){$.ajax({cache:false,dataType:"text",timeout:Page.option.timeout*1E3,url:"http://apps.facebook.com/castle_age/"+Page.last,error:function(){debug("Page not loaded correctly, reloading.");Page.ajaxload()},success:function(b){if(b.lastIndexOf("</html>")!==-1&&b.lastIndexOf("single_popup")!==-1){Page.loading=false;b=b.replace(/<(?:head[\s\S]*?\/head)?>/ig,"").replace(/<(?:script[\s\S]*?\/script)?>/ig,"").replace(/<(?:style[\s\S]*?\/style)?>/ig,"");$("#app"+APPID+"_AjaxLoadIcon").css("display",
"none");$("#app"+APPID+"_globalContainer").empty().append($("#app"+APPID+"_globalContainer",b))}else{debug("Page not loaded correctly, reloading.");Page.ajaxload()}}});Page.loading=true;setTimeout(function(){Page.loading&&$("#app"+APPID+"_AjaxLoadIcon").css("display","block")},1500)};Page.reload=function(){window.location.href="http://apps.facebook.com/castle_age/index.php?bm=1"};
Page.click=function(b){if(!$(b).length){debug("Page.click: Unable to find element - "+b);return false}var c=document.createEvent("MouseEvents");c.initEvent("click",true,true);$(b).get(0).wrappedJSObject.dispatchEvent(c);Page.clear();Page.lastclick=b;Page.when=Date.now();return true};Page.clear=function(){Page.last=Page.lastclick=Page.when=null;Page.retry=0};var Queue=new Worker("Queue","*");Queue.data={current:null};
Queue.option={delay:5,clickdelay:5,queue:["Page","Queue","Income","Quest","Monster","Arena","Battle","Heal","Land","Town","Bank","Alchemy","Blessing","Gift","Upgrade","Elite","Idle"],start_stamina:0,stamina:0,start_energy:0,energy:0};
Queue.display=[{label:"Drag the unlocked panels into the order you wish them run."},{id:"delay",label:"Delay Between Events",text:true,after:"secs",size:3},{id:"clickdelay",label:"Delay After Mouse Click",text:true,after:"secs",size:3,help:"This should be a multiple of Event Delay"},{id:"start_stamina",before:"Save",select:"stamina",after:"Stamina Before Using"},{id:"stamina",before:"Always Keep",select:"stamina",after:"Stamina"},{id:"start_energy",before:"Save",select:"energy",after:"Energy Before Using"},
{id:"energy",before:"Always Keep",select:"energy",after:"Energy"}];Queue.runfirst=[];Queue.unsortable=true;Queue.lastclick=Date.now();Queue.lastrun=Date.now();Queue.burn={stamina:false,energy:false};Queue.timer=null;
Queue.onload=function(){var b,c,a={};for(b=0;b<Queue.option.queue.length;b++)if(c=WorkerByName(Queue.option.queue[b]))a[c.name]=true;for(b in Workers)if(!(a[Workers[b].name]||!Workers[b].work||!Workers[b].display)){log("Adding "+Workers[b].name+" to Queue");Workers[b].unsortable?Queue.option.queue.unshift(Workers[b].name):Queue.option.queue.push(Workers[b].name)}for(b=0;b<Queue.option.queue.length;b++)if((c=WorkerByName(Queue.option.queue[b]))&&c.priv_id){if(Queue.data.current&&c.name===Queue.data.current){debug("Queue: Trigger "+
c.name+" (continue after load)");$("#"+c.priv_id+" > h3").css("font-weight","bold")}$("#golem_config").append($("#"+c.priv_id))}$(document).click(function(){Queue.lastclick=Date.now()});$btn=$('<img class="golem-button'+(Queue.option.pause?" red":"")+'" id="golem_pause" src="'+(Queue.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82")+'">').click(function(){Queue.option.pause^=true;debug("State: "+(Queue.option.pause?"paused":"running"));$(this).toggleClass("red").attr("src",Queue.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82");Page.clear();Config.updateOptions()});$("#golem_buttons").prepend($btn);Queue.update("option")};
Queue.update=function(b){if(b==="option"){Queue.timer&&window.clearInterval(Queue.timer);Queue.timer=window.setInterval(function(){Queue.run()},Queue.option.clickdelay*1E3)}};
Queue.run=function(){var b,c,a=false,d=Date.now(),e;if(!(Queue.option.pause||d-Queue.lastrun<Queue.option.delay*1E3)){Queue.lastrun=d;if(!Page.loading){Queue.burn.stamina=Queue.burn.energy=0;if(Queue.option.burn_stamina||Player.data.stamina>=Queue.option.start_stamina){Queue.burn.stamina=Math.max(0,Player.data.stamina-Queue.option.stamina);Queue.option.burn_stamina=Queue.burn.stamina>0}if(Queue.option.burn_energy||Player.data.energy>=Queue.option.start_energy){Queue.burn.energy=Math.max(0,Player.data.energy-
Queue.option.energy);Queue.option.burn_energy=Queue.burn.energy>0}for(b in Workers)Workers[b].work&&!Workers[b].display&&Workers[b].work(false);for(b=0;b<Queue.option.queue.length;b++){c=WorkerByName(Queue.option.queue[b]);if(!(!c||!c.work||!c.display)){e=c.work(Queue.data.current===c.name);c.save();if(e){if(!a){a=true;if(Queue.data.current!==c.name){c.priv_since=d;if(Queue.data.current){debug("Queue: Interrupt "+Queue.data.current);WorkerByName(Queue.data.current).priv_id&&$("#"+WorkerByName(Queue.data.current).priv_id+
" > h3").css("font-weight","normal")}Queue.data.current=c.name;c.priv_id&&$("#"+c.priv_id+" > h3").css("font-weight","bold");debug("Queue: Trigger "+c.name)}}}else if(Queue.data.current===c.name){Queue.data.current=null;c.priv_id&&$("#"+c.priv_id+" > h3").css("font-weight","normal");debug("Queue: End "+c.name)}}}this.save()}}};var Update=new Worker("Update");Update.data=null;Update.option=null;Update.found=false;
Update.onload=function(){var b=$('<img class="golem-button" name="Script Update" id="golem_update" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C7%C7%C7UUU%7B%7B%7B%BF%BF%BF%A6%A6%A6%FF%FF%FF%40%40%40%FF%FF%FFk5%D0%FB%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00UIDATx%DAt%8F%5B%12%800%08%03%23%8Fx%FF%1B%5B%C0%96%EA%E8~%95%9D%C0%A48_%E0S%A8p%20%3A%85%F1%C6Jh%3C%DD%FD%205E%E4%3D%18%5B)*%9E%82-%24W6Q%F3Cp%09%E1%A2%8E%A2%13%E8b)lVGU%C7%FF%E7v.%01%06%005%D6%06%07%F9%3B(%D0%00%00%00%00IEND%AEB%60%82">').click(function(){Update.now(true)});$("#golem_buttons").append(b)};
Update.now=function(b){if(Update.found)window.location.href="http://userscripts.org/scripts/source/67412.user.js";else{var c=Settings.GetValue("lastUpdateCheck",0);if(b||Date.now()-c>216E5){Settings.SetValue("lastUpdateCheck",Date.now().toString());GM_xmlhttpRequest({method:"GET",url:"http://userscripts.org/scripts/show/67412",onload:function(a){if(a.readyState===4&&a.status===200){a=$(a.responseText);a=$("#summary",a).text().regex(/Version:[^0-9.]+([0-9.]+)/i);b&&$("#golem_request").remove();if(a>
VERSION){Update.found=true;$("#golem_update").attr("src","data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C8%C8%C8%C1%C1%C1%BA%BA%BA%F1%F1%F1ggg%FF%FF%FF%40%40%40%FF%FF%FF%7D%5C%EC%14%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00OIDATx%DA%8C%8FA%0A%C0%20%0C%04W%8D%EB%FF%7F%AC1%5BQi%A1s%0A%C3%24%10%B4%0B%7C%89%9COa%A4%ED%22q%906a%2CE%09%14%D4%AA%04%BA0%8AH%5C%80%02%12%3E%FB%0A%19b%06%BE2%13D%F0%F0.~%3E%B7%E8%02%0C%00Z%03%06Q9dE%25%00%00%00%00IEND%AEB%60%82").toggleClass("golem-button golem-button-active");
if(b){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There is a new version of Castle Age Golem available.</p><p>Current&nbsp;version:&nbsp;'+VERSION+", New&nbsp;version:&nbsp;"+a+"</p></div>");$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close");window.location.href="http://userscripts.org/scripts/source/67412.user.js"},Skip:function(){$(this).dialog("close")}}})}log("New version available: "+a)}else if(b){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There are no new versions available.</p></div>');
$("#golem_request").dialog({modal:true,buttons:{Ok:function(){$(this).dialog("close")}}})}}}})}}};var Alchemy=new Worker("Alchemy","keep_alchemy");Alchemy.data={ingredients:{},recipe:{}};Alchemy.display=[{id:"perform",label:"Automatically Perform",checkbox:true},{id:"hearts",label:"Use Battle Hearts",checkbox:true}];
Alchemy.parse=function(){var b=Alchemy.data.ingredients={},c=Alchemy.data.recipe={};$("div.ingredientUnit").each(function(a,d){a=$("img",d).attr("src").filepart();b[a]=$(d).text().regex(/x([0-9]+)/)});$("div.alchemyQuestBack,div.alchemyRecipeBack,div.alchemyRecipeBackMonster").each(function(a,d){var e={};a=$("div.recipeTitle",d).text().trim().replace("RECIPES: ","");if(a.indexOf(" (")>0)a=a.substr(0,a.indexOf(" ("));e.type=$(d).hasClass("alchemyQuestBack")?"Quest":$(d).hasClass("alchemyRecipeBack")?
"Recipe":$(d).hasClass("alchemyRecipeBackMonster")?"Summons":"wtf";e.ingredients={};$("div.recipeImgContainer",d).parent().each(function(f,g){f=$("img",g).attr("src").filepart();e.ingredients[f]=$(g).text().regex(/x([0-9]+)/)||1});c[a]=e})};
Alchemy.work=function(b){if(!Alchemy.option.perform)return false;var c=null,a=Alchemy.data.recipe,d,e;for(d in a)if(a[d].type==="Recipe"){c=d;for(e in a[d].ingredients)if(!Alchemy.option.hearts&&e==="raid_hearts.gif"||a[d].ingredients[e]>(Alchemy.data.ingredients[e]||0)){c=null;break}if(c)break}if(!c)return false;if(!b)return true;if(!Page.to("keep_alchemy"))return true;debug("Alchemy: Perform - "+c);$("div.alchemyRecipeBack").each(function(f,g){if($("div.recipeTitle",g).text().indexOf(c)>=0){Page.click($('input[type="image"]',
g));return true}});return true};var Arena=new Worker("Arena","army_viewarmy battle_arena");Arena.data={army:{},user:{}};Arena.option={enabled:false,general:true,losses:5,type:"Invade",fill:true,every:24,cache:100,checking:null};Arena.rank={Brawler:1,Swordsman:2,Warrior:3,Gladiator:4,Hero:5,Legend:6};Arena.knar={1:"Brawler",2:"Swordsman",3:"Warrior",4:"Gladiator",5:"Hero",6:"Legend"};
Arena.display=[{label:"NOTE: Make sure this is disabled if you are not fighting and drag into order relative to the Monster panel!"},{id:"enabled",label:"Arena Enabled",checkbox:true},{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel"]},{id:"bp",label:"Higher Relative Rank<br>(Clears Cache)",select:["Always","Never","Don't Care"]},{id:"losses",label:"Attack Until",select:[1,2,3,4,5,6,7,8,9,10],after:"Losses"},{id:"cache",label:"Limit Cache Length",
select:[50,100,150,200,250]},{id:"fill",label:"Fill Arena Guard",checkbox:true},{id:"every",label:"Every",select:[1,2,3,6,12,24],after:"hours"},{label:"Add UserIDs to prefer them over random army members."},{id:"prefer",multiple:"number"}];
Arena.parse=function(){if(Arena.option.checking){$("span.result_body").each(function(d,e){if($(e).text().match(/has not joined in the Arena!/i))Arena.data.army[Arena.option.checking]=-1;else if($(e).text().match(/Arena Guard, and they have joined/i))Arena.data.army[Arena.option.checking]=Date.now()+864E5;else if($(e).text().match(/'s Arena Guard is FULL/i))Arena.data.army[Arena.option.checking]=Date.now()+36E5;else if($(e).text().match(/YOUR Arena Guard is FULL/i)){Arena.option.wait=Date.now();debug("Arena guard full, wait 24 hours")}});
Arena.option.checking=null}if(Page.page==="army_viewarmy")$('img[linked="true"][size="square"]').each(function(d,e){Arena.data.army[$(e).attr("uid")]=Arena.data.army[$(e).attr("uid")]||0});else if(Page.page==="battle_arena"){var b,c=[],a=Arena.data.user;if(Arena.data.attacking){uid=Arena.data.attacking;if($("div.results").text().match(/You cannot battle someone in your army/i))delete a[uid];else if($("div.results").text().match(/Your opponent is dead or too weak/i)){a[uid].hide=(a[uid].hide||0)+1;
a[uid].dead=Date.now()}else if($('img[src*="battle_victory"]').length)a[uid].win=(a[uid].win||0)+1;else if($('img[src*="battle_defeat"]').length)a[uid].loss=(a[uid].loss||0)+1;Arena.data.attacking=null}Arena.data.rank=$("#app"+APPID+'_arena_body img[src*="arena_rank"]').attr("src").regex(/arena_rank([0-9]+).gif/i);$("#app"+APPID+"_arena_body table tr:odd").each(function(d,e){d=$('img[uid!==""]',e).attr("uid");var f=$("td.bluelink",e).text().trim().regex(/Level ([0-9]+) (.*)/i),g;if(d&&f){g=Arena.rank[f[1]];
if(!(Arena.option.bp==="Always"&&Arena.data.rank>g||!Arena.option.bp==="Never"&&Arena.data.rank<g)){a[d]=a[d]||{};a[d].name=$("a",e).text().trim();a[d].level=f[0];a[d].rank=g;a[d].army=$("td.bluelink",e).next().text().regex(/([0-9]+)/)}}});for(b in a)if(Arena.option.bp==="Always"&&Arena.data.rank>a[b].rank||!Arena.option.bp==="Never"&&Arena.data.rank<a[b].rank)delete a[b];if(length(Arena.data.user)>Arena.option.cache){debug("Arena: Pruning target cache");for(b in a)c.push(b);for(c.sort(function(d,
e){var f=0;if((a[d].win||0)-(a[d].loss||0)<(a[e].win||0)-(a[e].loss||0))f+=10;else if((a[d].win||0)-(a[d].loss||0)>(a[e].win||0)-(a[e].loss||0))f-=10;if((a[d].hide||0)>(a[e].hide||0))f+=1;else if((a[d].hide||0)<(a[e].hide||0))f-=1;if(a[d].army>a[e].army)f+=1;else if(a[d].army<a[e].army)f-=1;if(Arena.option.bp==="Always")f+=a[e].rank-a[d].rank;if(Arena.option.bp==="Never")f+=a[d].rank-a[e].rank;f+=(a[d].level-a[e].level)/10;return f});c.length>Arena.option.cache;)delete a[c.pop()]}}return false};
Arena.update=function(b){b==="data"&&Dashboard.change(Arena)};
Arena.work=function(b){var c,a,d=null;if(!Arena.option.enabled)return false;if(Arena.option.fill&&(!Arena.option.wait||Arena.option.wait+Arena.option.every*36E5<Date.now())){for(a=0;a<Arena.option.prefer.length;a++){c=Arena.option.prefer[a];if(!/[^0-9]/g.test(c)){Arena.data.army[c]=Arena.data.army[c]||0;if(typeof Arena.data.army[c]!=="number"||Arena.data.army[c]!==-1&&Arena.data.army[c]<Date.now()){d=c;break}}}if(!d)for(c in Arena.data.army)if(typeof Arena.data.army[c]!=="number"||Arena.data.army[c]!==
-1&&Arena.data.army[c]<Date.now()){d=c;break}if(d||!length(Arena.data.army)){if(!b)return true;if(!d&&!length(Arena.data.army)&&!Page.to("army_viewarmy"))return true;debug("Arena: Add member "+d);Arena.option.checking=d;if(!Page.to("battle_arena","?user="+d+"&lka="+d+"&agtw=1&ref=nf"))return true}}if(Player.data.health<=10||Queue.burn.stamina<5)return false;d=[];a=Arena.data.user;for(c in a)a[c].dead&&a[c].dead+18E5>=Date.now()||(a[c].loss||0)-(a[c].win||0)>=Arena.option.losses||d.push(c);if(!d.length)return false;
if(!b)return true;if(Arena.option.general&&!Generals.to(Generals.best(Arena.option.type))||!Page.to("battle_arena"))return true;b=d[Math.floor(Math.random()*d.length)];debug("Arena: Wanting to attack "+a[b].name+" ("+b+")");c=$('form input[alt="'+Arena.option.type+'"]').first().parents("form");if(!c.length){log("Arena: Unable to find attack buttons, forcing reload");Page.to("index");return false}Arena.data.attacking=b;$('input[name="target_id"]',c).attr("value",b);Page.click($('input[type="image"]',
c));return true};Arena.order=[];
Arena.dashboard=function(b,c){var a,d,e=[],f,g=["rank","name","level","army","win","loss","hide"];if(typeof b==="undefined"){Arena.order=[];for(a in Arena.data.user)Arena.order.push(a);b=1}typeof g[b]==="string"&&Arena.order.sort(function(h,j){h=Arena.data.user[h][g[b]]||0;j=Arena.data.user[j][g[b]]||0;if(typeof h==="string"||typeof j==="string")return c?j>h:j<h;return c?h-j:j-h});e.push('<div style="text-align:center;"><strong>Rank:</strong> '+Arena.knar[Arena.data.rank]+" ("+Arena.data.rank+"), <strong>Targets:</strong> "+
length(Arena.data.user)+" / "+Arena.option.cache+"</div><hr>");e.push('<table cellspacing="0" style="width:100%"><thead><th>Rank</th><th>Name</th><th>Level</th><th>Army</th><th>Wins</th><th>Losses</th><th>Hides</th></tr></thead><tbody>');for(d=0;d<Arena.order.length;d++){a=Arena.order[d];f=[];f.push('<img style="width:16px;height:16px;" src="'+Player.data.imagepath+"arena_rank"+Arena.data.user[a].rank+'.gif"> '+Arena.knar[Arena.data.user[a].rank]+" ("+Arena.data.user[a].rank+") ");f.push('<span title="'+
a+'">'+Arena.data.user[a].name+"</span>");f.push(Arena.data.user[a].level);f.push(Arena.data.user[a].army);f.push(Arena.data.user[a].win);f.push(Arena.data.user[a].loss);f.push(Arena.data.user[a].hide);e.push("<tr><td>"+f.join("</td><td>")+"</td></tr>")}e.push("</tbody></table>");$("#golem-dashboard-Arena").html(e.join(""));$("#golem-dashboard-Arena thead th").css("cursor","pointer").click(function(){Arena.dashboard($(this).prevAll().length,$(this).attr("name")==="sort")});$("#golem-dashboard-Arena tbody tr td:nth-child(1)").css("text-align",
"left");$("#golem-dashboard-Arena tbody tr td:nth-child(2)").css("text-align","left");if(typeof b!=="undefined")$("#golem-dashboard-Arena thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Bank=new Worker("Bank");Bank.data=null;Bank.option={general:true,above:1E4,hand:0,keep:1E4};
Bank.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"above",label:"Bank Above",text:true},{id:"hand",label:"Keep in Cash",text:true},{id:"keep",label:"Keep in Bank",text:true}];Bank.work=function(b){if(Player.data.cash<Bank.option.above)return false;if(!b)return true;if(!Bank.stash(Player.data.cash-Math.min(Bank.option.above,Bank.option.hand)))return true;return false};
Bank.stash=function(b){if(!b||!Player.data.cash||Math.min(Player.data.cash,b)<=10)return true;if(Bank.option.general&&!Generals.to("Aeris"))return false;if(!Page.to("keep_stats"))return false;$('input[name="stash_gold"]').val(Math.min(Player.data.cash,b));Page.click('input[value="Stash"]');return true};
Bank.retrieve=function(b){b-=Player.data.cash;if(b<=0)return true;if(Player.data.bank-Bank.option.keep<b)return true;if(!Page.to("keep_stats"))return false;$('input[name="get_gold"]').val(b.toString());Page.click('input[value="Retrieve"]');return true};Bank.worth=function(b){var c=Player.data.cash+Math.max(0,Player.data.bank-Bank.option.keep);if(typeof b==="number")return b<=c;return c};var Battle=new Worker("Battle","battle_rank battle_battle");Battle.data={user:{},rank:{},points:{}};
Battle.option={general:true,points:true,monster:true,arena:true,losses:5,type:"Invade",bp:"Always"};
Battle.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel"]},{id:"losses",label:"Attack Until",select:[1,2,3,4,5,6,7,8,9,10],after:"Losses"},{id:"points",label:"Always Get Demi-Points",checkbox:true},{id:"arena",label:"Fight in Arena First",checkbox:true,help:"Only if the Arena is enabled!"},{id:"monster",label:"Fight Monsters First",checkbox:true},{id:"bp",label:"Get Battle Points<br>(Clears Cache)",select:["Always","Never","Don't Care"]},
{id:"cache",label:"Limit Cache Length",select:[100,200,300,400,500]}];
Battle.parse=function(){var b,c,a,d,e=[];if(Page.page==="battle_rank"){c={0:{name:"Squire",points:0}};$('tr[height="23"]').each(function(f,g){d=$(g).text().regex(/Rank ([0-9]+) - (.*)\s*([0-9]+)/i);c[d[0]]={name:d[1],points:d[2]}});if(length(c)>length(Battle.data.rank))Battle.data.rank=c}else if(Page.page==="battle_battle"){c=Battle.data.user;if(Battle.data.attacking){a=Battle.data.attacking;if($("div.results").text().match(/You cannot battle someone in your army/i))delete c[a];else if($("div.results").text().match(/Your opponent is dead or too weak/i)){c[a].hide=
(c[a].hide||0)+1;c[a].dead=Date.now()}else if($('img[src*="battle_victory"]').length)c[a].win=(c[a].win||0)+1;else if($('img[src*="battle_defeat"]').length)c[a].loss=(c[a].loss||0)+1;Battle.data.attacking=null}Battle.data.points=$("#app"+APPID+"_app_body table.layout table table").prev().text().replace(/[^0-9\/]/g,"").regex(/([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10/);$("#app"+APPID+"_app_body table.layout table table tr:even").each(function(f,g){f=$('img[uid!==""]',g).attr("uid");
var h=$("td.bluelink",g).text().trim().regex(/Level ([0-9]+) (.*)/i),j;if(f&&h){j=Battle.rank(h[1]);if(!(Battle.option.bp==="Always"&&Player.data.rank-j>5||!Battle.option.bp==="Never"&&Player.data.rank-j<=5)){c[f]||(c[f]={});c[f].name=$("a",g).text().trim();c[f].level=h[0];c[f].rank=j;c[f].army=$("td.bluelink",g).next().text().regex(/([0-9]+)/);c[f].align=$('img[src*="graphics/symbol_"]',g).attr("src").regex(/symbol_([0-9])/i)}}});for(b in c)if(Battle.option.bp==="Always"&&Player.data.rank-c[b].rank>
5||!Battle.option.bp==="Never"&&Player.data.rank-c[b].rank<=5)delete c[b];if(length(Battle.data.user)>Battle.option.cache){debug("Battle: Pruning target cache");for(b in c)e.push(b);for(e.sort(function(f,g){var h=0;if((c[f].win||0)-(c[f].loss||0)<(c[g].win||0)-(c[g].loss||0))h+=10;else if((c[f].win||0)-(c[f].loss||0)>(c[g].win||0)-(c[g].loss||0))h-=10;if((c[f].hide||0)>(c[g].hide||0))h+=1;else if((c[f].hide||0)<(c[g].hide||0))h-=1;if(c[f].army>c[g].army)h+=1;else if(c[f].army<c[g].army)h-=1;if(Battle.option.bp===
"Always")h+=(c[g].rank-c[f].rank)/2;if(Battle.option.bp==="Never")h+=(c[f].rank-c[g].rank)/2;h+=(c[f].level-c[g].level)/10;return h});e.length>Battle.option.cache;)delete c[e.pop()]}}return false};Battle.update=function(b){b==="data"&&Dashboard.change(Battle)};
Battle.work=function(b){if(Player.data.health<=10||Queue.burn.stamina<1)return false;var c,a=[],d=[],e=Battle.data.user;if(Battle.option.points)for(c=0;c<Battle.data.points.length;c++)if(Battle.data.points[c]<10)a[c+1]=true;if((!Battle.option.points||!a.length)&&(Battle.option.monster&&Monster.count||Battle.option.arena&&Arena.option.enabled))return false;for(c in e)if(!(e[c].dead&&e[c].dead+18E5>=Date.now()))if(!((e[c].loss||0)-(e[c].win||0)>=Battle.option.losses))if(!Battle.option.points||!a.length||
typeof a[e[c].align]!=="undefined")d.push(c);if(!d.length)return false;if(!b)return true;if(Battle.option.general&&!Generals.to(Generals.best(Battle.option.type))||!Page.to("battle_battle"))return true;b=d[Math.floor(Math.random()*d.length)];debug("Battle: Wanting to attack "+e[b].name+" ("+b+")");e=$('form input[alt="'+Battle.option.type+'"]').first().parents("form");if(!e.length){log("Battle: Unable to find attack buttons, forcing reload");Page.to("index");return false}Battle.data.attacking=b;$('input[name="target_id"]',
e).attr("value",b);Page.click($('input[type="image"]',e));return true};Battle.rank=function(b){for(var c in Battle.data.rank)if(Battle.data.rank[c].name===b)return parseInt(c,10);return 0};Battle.order=[];
Battle.dashboard=function(b,c){var a,d;d=[0,0,0,0,0,0];var e=["Ambrosia","Malekus","Corvintheus","Aurora","Azeron"],f=[],g=["align","name","level","rank","army","win","loss","hide"];for(a in Battle.data.user)d[Battle.data.user[a].align]++;if(typeof b==="undefined"){Battle.order=[];for(a in Battle.data.user)Battle.order.push(a);b=1}typeof g[b]==="string"&&Battle.order.sort(function(h,j){h=Battle.data.user[h][g[b]]||0;j=Battle.data.user[j][g[b]]||0;if(typeof h==="string"||typeof j==="string")return c?
j>h:j<h;return c?h-j:j-h});f.push('<div style="text-align:center;"><strong>Targets:</strong> '+length(Battle.data.user)+", <strong>By Alignment:</strong>");for(a=1;a<6;a++)f.push(' <img src="'+Player.data.imagepath+"symbol_tiny_"+a+'.jpg" alt="'+e[a-1]+'" title="'+e[a-1]+'"> '+d[a]);f.push("</div><hr>");f.push('<table cellspacing="0" style="width:100%"><thead><th>Align</th><th>Name</th><th>Level</th><th>Rank</th><th>Army</th><th>Wins</th><th>Losses</th><th>Hides</th></tr></thead><tbody>');for(d=0;d<
Battle.order.length;d++){a=Battle.order[d];e=[];e.push('<img src="'+Player.data.imagepath+"symbol_tiny_"+Battle.data.user[a].align+'.jpg" alt="'+Battle.data.user[a]+'">');e.push('<span title="'+a+'">'+Battle.data.user[a].name+"</span>");e.push(Battle.data.user[a].level);e.push(Battle.data.rank[Battle.data.user[a].rank]?Battle.data.rank[Battle.data.user[a].rank].name:"");e.push(Battle.data.user[a].army);e.push(Battle.data.user[a].win);e.push(Battle.data.user[a].loss);e.push(Battle.data.user[a].hide);
f.push("<tr><td>"+e.join("</td><td>")+"</td></tr>")}f.push("</tbody></table>");$("#golem-dashboard-Battle").html(f.join(""));$("#golem-dashboard-Battle thead th").css("cursor","pointer").click(function(){Battle.dashboard($(this).prevAll().length,$(this).attr("name")==="sort")});$("#golem-dashboard-Battle tbody tr td:nth-child(2)").css("text-align","left");if(typeof b!=="undefined")$("#golem-dashboard-Battle thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};
var Blessing=new Worker("Blessing","oracle_demipower");Blessing.option={which:"Stamina"};Blessing.which=["None","Energy","Attack","Defense","Health","Stamina"];Blessing.display=[{id:"which",label:"Which",select:Blessing.which}];
Blessing.parse=function(){var b=$("div.results"),c;if(b.length)if((c=b.text().regex(/Please come back in: ([0-9]+) hours and ([0-9]+) minutes/i))&&c.length)Blessing.data.when=Date.now()+(c[0]*60+c[1]+1)*6E4;else if(b.text().match(/You have paid tribute to/i))Blessing.data.when=Date.now()+8646E4;return false};
Blessing.work=function(b){if(!Blessing.option.which||Blessing.option.which==="None"||Date.now()<=Blessing.data.when)return false;if(!b)return true;if(!Page.to("oracle_demipower"))return true;Page.click("#app"+APPID+"_symbols_form_"+Blessing.which.indexOf(Blessing.option.which)+" input.imgButton");return false};var Elite=new Worker("Elite","keep_eliteguard army_viewarmy");Elite.data={};Elite.option={fill:true,every:24};
Elite.display=[{id:"fill",label:"Fill Elite Guard",checkbox:true},{id:"every",label:"Every",select:[1,2,3,6,12,24],after:"hours"},{label:"Add UserIDs to prefer them over random army members."},{id:"prefer",multiple:"number"}];
Elite.parse=function(){$("span.result_body").each(function(b,c){if($(c).text().match(/Elite Guard, and they have joined/i))Elite.data[$("img",c).attr("uid")]=Date.now()+864E5;else if($(c).text().match(/'s Elite Guard is FULL!/i))Elite.data[$("img",c).attr("uid")]=Date.now()+36E5;else if($(c).text().match(/YOUR Elite Guard is FULL!/i)){Elite.option.wait=Date.now();debug("Elite guard full, wait 24 hours")}});Page.page==="army_viewarmy"&&$('img[linked="true"][size="square"]').each(function(b,c){Elite.data[$(c).attr("uid")]=
Elite.data[$(c).attr("uid")]||0});return false};
Elite.work=function(b){var c,a,d=null;if(!Elite.option.fill||Elite.option.wait&&Elite.option.wait+Elite.option.every*36E5>Date.now())return false;for(a=0;a<Elite.option.prefer.length;a++){c=Elite.option.prefer[a];if(!/[^0-9]/g.test(c)){Elite.data[c]=Elite.data[c]||0;if(typeof Elite.data[c]!=="number"||Elite.data[c]<Date.now()){d=c;break}}}if(!d)for(c in Elite.data)if(typeof Elite.data[c]!=="number"||Elite.data[c]<Date.now()){d=c;break}if(!d&&length(Elite.data))return false;if(!b)return true;if(!d&&
!length(Elite.data)&&!Page.to("army_viewarmy"))return true;debug("Elite: Add member "+d);if(!Page.to("keep_eliteguard","?twt=jneg&jneg=true&user="+d))return true;return false};var Generals=new Worker("Generals","heroes_generals");Generals.data={};Generals.best_id=null;Generals.sort=null;
Generals.parse=function(b){var c,a,d,e,f,g;b=false;var h=function(j,k){j.push(k)};c=$("#app"+APPID+"_generalContainerBox2 > div > div.generalSmallContainer2");if(c.length<length(Generals.data)){Page.to("heroes_generals","");return false}c.each(function(j,k){j=$(k).children();k=j.eq(0).text().trim();var m=j.eq(3).text().regex(/Level ([0-9]+)/i);if(k)if(!Generals.data[k]||Generals.data[k].level!==m){Generals.data[k]=Generals.data[k]||{};Generals.data[k].img=j.eq(1).find("input.imgButton").attr("src").filepart();
Generals.data[k].att=j.eq(2).children().eq(0).text().regex(/([0-9]+)/);Generals.data[k].def=j.eq(2).children().eq(1).text().regex(/([0-9]+)/);Generals.data[k].level=m;Generals.data[k].skills=$(j.eq(4).html().replace(/\<br\>|\s+|\n/g," ")).text().trim();b=true}});if(b&&length(Town.data.invade))for(a in Generals.data){c=Player.data.attack+(Generals.data[a].skills.regex(/([-+]?[0-9]+) Player Attack/i)||0)+(Generals.data[a].skills.regex(/Increase Player Attack by ([0-9]+)/i)||0);d=Player.data.defense+
(Generals.data[a].skills.regex(/([-+]?[0-9]+) Player Defense/i)||0)+(Generals.data[a].skills.regex(/Increase Player Defense by ([0-9]+)/i)||0);e=Generals.data[a].skills.regex(/Increases? Army Limit to ([0-9]+)/i)||501;f=getAttDef(Generals.data,h,"att",Math.floor(e/5));g=getAttDef(Generals.data,h,"def",Math.floor(e/5));Generals.data[a].invade={att:Math.floor(Town.data.invade.attack+Generals.data[a].att+Generals.data[a].def*0.7+(c+d*0.7)*e+f),def:Math.floor(Town.data.invade.defend+Generals.data[a].def+
Generals.data[a].att*0.7+(d+(Generals.data[a].skills.regex(/([-+]?[0-9]+) Defense when attacked/i)||0)+c*0.7)*e+g)};Generals.data[a].duel={att:Math.floor(Town.data.duel.attack+Generals.data[a].att+Generals.data[a].def*0.7+c+d*0.7),def:Math.floor(Town.data.duel.defend+Generals.data[a].def+Generals.data[a].att*0.7+d+(Generals.data[a].skills.regex(/([-+]?[0-9]+) Defense when attacked/i)||0)+c*0.7)}}return false};
Generals.update=function(b){if(b==="data"){$("select.golem_generals").each(function(c,a){$(a).empty();var d;c=(c=$(a).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(c[0]).option[c[1]]:null;var e=Generals.list();for(d in e)$(a).append('<option value="'+e[d]+'"'+(e[d]===c?" selected":"")+">"+e[d]+"</value>")});Dashboard.change(Generals)}};
Generals.to=function(b){if(!b||Player.data.general===b||b==="any")return true;if(!Generals.data[b]){log('General "'+b+'" requested but not found!');return true}if(!Page.to("heroes_generals"))return false;debug("Changing to General "+b);Page.click('input[src$="'+Generals.data[b].img+'"]');return false};
Generals.best=function(b){if(!Generals.data)return"any";var c="",a=null,d=0,e;switch(b.toLowerCase()){case "cost":c=/Decrease Soldier Cost by ([0-9]+)/i;break;case "stamina":c=/Increase Max Stamina by ([0-9]+)|\+([0-9]+) Max Stamina/i;break;case "energy":c=/Increase Max Energy by ([0-9]+)|\+([0-9]+) Max Energy/i;break;case "income":c=/Increase Income by ([0-9]+)/i;break;case "influence":c=/Bonus Influence ([0-9]+)/i;break;case "attack":c=/([-+]?[0-9]+) Player Attack/i;break;case "defense":c=/([-+]?[0-9]+) Player Defense/i;
break;case "invade":for(e in Generals.data)if(!a||Generals.data[e].invade&&Generals.data[e].invade.att>Generals.data[a].invade.att||Generals.data[e].invade&&Generals.data[e].invade.att===Generals.data[a].invade.att&&a!==Player.data.general)a=e;return a||"any";case "duel":for(e in Generals.data)if(!a||Generals.data[e].duel&&Generals.data[e].duel.att>Generals.data[a].duel.att||Generals.data[e].duel&&Generals.data[e].duel.att===Generals.data[a].duel.att&&a!==Player.data.general)a=e;return a||"any";case "defend":for(e in Generals.data)if(!a||
Generals.data[e].duel&&Generals.data[e].duel.def>Generals.data[a].duel.def||Generals.data[e].duel&&Generals.data[e].duel.def===Generals.data[a].duel.def&&a!==Player.data.general)a=e;return a||"any";case "under level 4":if(Generals.data[Player.data.general]&&Generals.data[Player.data.general].level<4)return Player.data.general;return Generals.random(false);default:return"any"}for(e in Generals.data)if(b=Generals.data[e].skills.regex(c))if(!a||b>d){a=e;d=b}a&&debug("Best general found: "+a);return a};
Generals.random=function(b){var c,a=[];for(c in Generals.data)if(b)a.push(c);else Generals.data[c].level<4&&a.push(c);return a.length?a[Math.floor(Math.random()*a.length)]:"any"};
Generals.list=function(b){var c,a,d=[];if(b)if(b.find)for(c in Generals.data)Generals.data[c].skills.indexOf(b.find)>=0&&d.push(c);else{if(b.regex){for(c in Generals.data)(a=Generals.data[c].skills.regex(b.regex))&&d.push([c,a]);d.sort(function(e,f){return f[1]-e[1]})}}else{for(c in Generals.data)d.push(c);d.sort()}d.unshift("any");return d};Generals.order=[];
Generals.dashboard=function(b,c){var a,d,e=[],f=[],g=0,h=0,j=0,k=0;if(typeof b==="undefined"){Generals.order=[];for(a in Generals.data)Generals.order.push(a);b=1}typeof b!=="undefined"&&Generals.order.sort(function(m,l){var n,o;if(b==1){m=m;l=l}else if(b==2){m=Generals.data[m].level||0;l=Generals.data[l].level||0}else{n=b<5?"invade":"duel";o=b%2?"att":"def";m=Generals.data[m][n][o]||0;l=Generals.data[l][n][o]||0}if(typeof m==="string"||typeof l==="string")return c?l>m:l<m;return c?m-l:l-m});for(a in Generals.data){g=
Math.max(g,Generals.data[a].invade?Generals.data[a].invade.att:1);h=Math.max(h,Generals.data[a].invade?Generals.data[a].invade.def:1);j=Math.max(j,Generals.data[a].duel?Generals.data[a].duel.att:1);k=Math.max(k,Generals.data[a].duel?Generals.data[a].duel.def:1)}f.push('<table cellspacing="0" style="width:100%"><thead><tr><th></th><th>General</th><th>Level</th><th>Invade<br>Attack</th><th>Invade<br>Defend</th><th>Duel<br>Attack</th><th>Duel<br>Defend</th></tr></thead><tbody>');for(d=0;d<Generals.order.length;d++){a=
Generals.order[d];e=[];e.push('<img src="'+Player.data.imagepath+Generals.data[a].img+'" style="width:25px;height:25px;" title="'+Generals.data[a].skills+'">');e.push(a);e.push(Generals.data[a].level);e.push(Generals.data[a].invade?(g==Generals.data[a].invade.att?"<strong>":"")+addCommas(Generals.data[a].invade.att)+(g==Generals.data[a].invade.att?"</strong>":""):"?");e.push(Generals.data[a].invade?(h==Generals.data[a].invade.def?"<strong>":"")+addCommas(Generals.data[a].invade.def)+(h==Generals.data[a].invade.def?
"</strong>":""):"?");e.push(Generals.data[a].duel?(j==Generals.data[a].duel.att?"<strong>":"")+addCommas(Generals.data[a].duel.att)+(j==Generals.data[a].duel.att?"</strong>":""):"?");e.push(Generals.data[a].duel?(k==Generals.data[a].duel.def?"<strong>":"")+addCommas(Generals.data[a].duel.def)+(k==Generals.data[a].duel.def?"</strong>":""):"?");f.push("<tr><td>"+e.join("</td><td>")+"</td></tr>")}f.push("</tbody></table>");$("#golem-dashboard-Generals").html(f.join(""));$("#golem-dashboard-Generals thead th").css("cursor",
"pointer").click(function(){Generals.dashboard($(this).prevAll().length,$(this).attr("name")==="sort")});$("#golem-dashboard-Generals tbody tr td:nth-child(2)").css("text-align","left");if(typeof b!=="undefined")$("#golem-dashboard-Generals thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Gift=new Worker("Gift","index army_invite army_gifts");Gift.data={uid:[],todo:{},gifts:{}};
Gift.display=[{label:"Work in progress..."},{id:"type",label:"Return Gifts",select:["None","Random","Same as Received"]}];
Gift.lookup={"eq_gift_mystic_mystery.jpg":"Mystic Armor","eq_drakehelm_mystery.jpg":"Drake Helm","gift_angel_mystery2.jpg":"Battle Of Dark Legion","alchemy_serpent_mystery.jpg":"Serpentine Shield","alchemy_horn_mystery.jpg":"Poseidons Horn","gift_sea_egg_mystery.jpg":"Sea Serpent","gift_egg_mystery.jpg":"Dragon","gift_druid_mystery.jpg":"Whisper Bow","gift_armor_mystery.jpg":"Golden Hand","mystery_frost_weapon.jpg":"Frost Tear Dagger","eq_mace_mystery.jpg":"Morning Star"};
Gift.parse=function(b){if(b)return false;var c,a;if(Page.page==="index")!Gift.data.uid.length&&$("span.result_body").text().indexOf("has sent you a gift")>=0&&Gift.data.uid.push(1);else if(Page.page==="army_invite"){debug("Gift: Checking for accepted");if(Gift.data.lastgift)if($("div.result").text().indexOf("accepted the gift")>=0){c=Gift.data.lastgift;if(!Gift.data.todo[c].gifts)Gift.data.todo[c].gifts=[];Gift.data.todo[c].gifts.push($("div.result img").attr("src").filepart());Gift.data.lastgift=
null}debug("Gift: Checking for new gift to accept");c=Gift.data.uid=[];if($("div.messages").text().indexOf("gift")>=0){debug("Gift: Found gift div");$("div.messages img").each(function(d,e){c.push($(e).attr("uid"));debug("Gift: Adding gift from "+$(e).attr("uid"))})}}else if(Page.page==="army_gifts"){a=Gift.data.gifts={};$("#app"+APPID+'_giftContainer div[id^="app'+APPID+'_gift"]').each(function(d,e){d=$("img",e).attr("src").filepart();e=$(e).text().trim().replace("!","");a[d]||(a[d]={});a[d].name=
e;if(Gift.lookup[e])a[d].create=Gift.lookup[e]})}return false};Gift.work=function(b){if(!b){if(!Gift.data.uid.length)return false;return true}if(Gift.data.uid.length){if(!Page.to("army_invite"))return true;b=Gift.data.uid.shift();Gift.data.todo[b]||(Gift.data.todo[b]={});Gift.data.todo[b].time=Date.now();Gift.data.lastgift=b;debug("Gift: Accepting gift from "+b);if(!Page.to("army_invite","?act=acpt&rqtp=gift&uid="+b)||Gift.data.uid.length>0)return true}Page.to("keep_alchemy");return false};
var Heal=new Worker("Heal");Heal.data=null;Heal.option={stamina:0,health:0};Heal.display=[{id:"stamina",label:"Heal Above",after:"stamina",select:"stamina"},{id:"health",label:"...And Below",after:"health",select:"health"}];
Heal.work=function(b){if(Player.data.health>=Player.data.maxhealth||Player.data.stamina<Heal.option.stamina||Player.data.health>=Heal.option.health)return false;if(!b)return true;if(!Page.to("keep_stats"))return true;debug("Heal: Healing...");$('input[value="Heal Wounds"]').length?Page.click('input[value="Heal Wounds"]'):log("Danger Danger Will Robinson... Unable to heal!");return false};var Idle=new Worker("Idle");Idle.data=null;
Idle.option={general:"any",index:"Daily",alchemy:"Daily",quests:"Never",town:"Never",battle:"Daily"};Idle.when=["Never","Hourly","2 Hours","6 Hours","12 Hours","Daily","Weekly"];
Idle.display=[{label:"<strong>NOTE:</strong> Any workers below this will <strong>not</strong> run!<br>Use this for disabling workers you do not use."},{id:"general",label:"Idle General",select:"generals"},{label:"Check Pages:"},{id:"index",label:"Home Page",select:Idle.when},{id:"alchemy",label:"Alchemy",select:Idle.when},{id:"quests",label:"Quests",select:Idle.when},{id:"town",label:"Town",select:Idle.when},{id:"battle",label:"Battle",select:Idle.when}];
Idle.work=function(b){var c,a,d={index:["index"],alchemy:["keep_alchemy"],quests:["quests_quest1","quests_quest2","quests_quest3","quests_quest4","quests_quest5","quests_quest6","quests_demiquests","quests_atlantis"],town:["town_soldiers","town_blacksmith","town_magic","town_land"],battle:["battle_battle"]},e={Never:0,Hourly:36E5,"2 Hours":72E5,"6 Hours":216E5,"12 Hours":432E5,Daily:864E5,Weekly:6048E5};if(!b)return true;if(!Generals.to(Idle.option.general))return true;for(c in d)if(e[Idle.option[c]]){a=
Date.now()-e[Idle.option[c]];for(b=0;b<d[c].length;b++)if(!Page.data[d[c][b]]||Page.data[d[c][b]]<a)if(!Page.to(d[c][b]))return true}return true};var Income=new Worker("Income");Income.data=null;Income.option={general:true,bank:true,margin:30};Income.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true},{id:"margin",label:"Safety Margin",select:[15,30,45,60],suffix:"seconds"}];
Income.work=function(b){if(!Income.option.margin)return false;var c=new Date;c=(3600+Player.data.cash_time-(c.getSeconds()+c.getMinutes()*60))%3600;if(c>Income.option.margin){if(b&&Income.option.bank)return Bank.work(true);return false}if(!b)return true;if(Income.option.general&&!Generals.to(Generals.best("income")))return true;debug("Income: Waiting for Income... ("+c+" seconds)");return true};var Land=new Worker("Land","town_land");Land.option={buy:true,wait:48,best:null,bestbuy:0};
Land.display=[{id:"buy",label:"Auto-Buy Land",checkbox:true},{id:"wait",label:"Maximum Wait Time",select:[0,24,36,48],suffix:"hours"},{id:"current",label:"Want to buy",info:"None"}];
Land.parse=function(){$("tr.land_buy_row,tr.land_buy_row_unique").each(function(b,c){b=$("img",c).attr("alt");var a;Land.data[b]={};Land.data[b].income=$(".land_buy_info .gold",c).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);Land.data[b].max=$(".land_buy_info",c).text().regex(/Max Allowed For your level: ([0-9]+)/i);Land.data[b].cost=$(".land_buy_costs .gold",c).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);if(a=$("option",$(".land_buy_costs .gold",c).parent().next()).last().attr("value"))Land.data[b].buy=
a;Land.data[b].own=$(".land_buy_costs span",c).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)});Land.option.best=null;Land.option.bestbuy=0;return false};
Land.work=function(b){if(b&&!Land.option.buy)return false;var c,a=Bank.worth(),d=Land.option.best||null,e=Land.option.bestbuy||0;if(!d||!e){for(c in Land.data)if(Land.data[c].buy)if(!d||Land.data[d].cost/Player.data.income+(Land.data[c].cost/Player.data.income+Land.data[d].income)>Land.data[c].cost/Player.data.income+Land.data[d].cost/(Player.data.income+Land.data[c].income))d=c;if(!d)return false;if(Land.data[d].cost*10<=a||Land.data[d].own>=10&&Land.data[d].cost*10/Player.data.income<Land.option.wait&&
Land.data[d].max-Land.data[d].own>=10)e=10;else if(Land.data[d].cost*5<=a||Land.data[d].own>=10&&Land.data[d].cost*5/Player.data.income<Land.option.wait&&Land.data[d].max-Land.data[d].own>=5)e=5;else if(Land.data[d].cost<=a)e=1;$("#"+PREFIX+"Land_current").text(e+"x "+d+" for $"+addCommas(e*Land.data[d].cost));Land.option.best=d;Land.option.bestbuy=e}if(!e||e*Land.data[d].cost>a)return false;if(!b)return true;if(!Bank.retrieve(e*Land.data[d].cost))return true;if(!Page.to("town_land"))return true;
$("tr.land_buy_row,tr.land_buy_row_unique").each(function(f,g){if($("img",g).attr("alt")===d){debug("Land: Buying "+Land.data[d].buy+" x "+d+" for $"+Land.data[d].buy*Land.data[d].cost);$("select",$(".land_buy_costs .gold",g).parent().next()).val(e);Page.click($('.land_buy_costs input[name="Buy"]',g));$("#"+PREFIX+"Land_current").text("None")}});return true};var Monster=new Worker("Monster","keep_monster keep_monster_active battle_raid");Monster.option={fortify:50,dispel:50,choice:"All",raid:"Invade x5"};
Monster.display=[{label:"Work in progress..."},{id:"fortify",label:"Fortify Below",select:[10,20,30,40,50,60,70,80,90,100],after:"%"},{id:"dispel",label:"Dispel Above",select:[10,20,30,40,50,60,70,80,90,100],after:"%"},{label:'"All" is currently Random...'},{id:"choice",label:"Attack",select:["All","Strongest","Weakest","Shortest"]},{id:"raid",label:"Raid",select:["Invade","Invade x5","Duel","Duel x5"]},{id:"assist",label:"Use Assist Links in Dashboard",checkbox:true}];
Monster.types={kull:{name:"Kull, the Orc Captain",timer:259200},raid:{name:"The Deathrune Siege",list:"deathrune_list2.jpg",image:"raid_map_1.jpg",image2:"raid_map_2.jpg",dead:"raid_1_large_victory.jpg",timer:319920,timer2:519960,raid:true},colossus:{name:"Colossus of Terra",list:"stone_giant_list.jpg",image:"stone_giant.jpg",dead:"stone_giant_dead.jpg",timer:259200,mpool:1},gildamesh:{name:"Gildamesh, the Orc King",list:"orc_boss_list.jpg",image:"orc_boss.jpg",dead:"orc_boss_dead.jpg",timer:259200,
mpool:1},keira:{name:"Keira, the Dread Knight",list:"boss_keira_list.jpg",image:"boss_keira.jpg",dead:"boss_keira_dead.jpg",timer:172800,mpool:1},lotus:{name:"Lotus Ravenmoore",list:"boss_lotus_list.jpg",image:"boss_lotus.jpg",dead:"boss_lotus_big_dead.jpg",timer:172800,mpool:1},mephistopheles:{name:"Mephistopheles",list:"boss_mephistopheles_list.jpg",image:"boss_mephistopheles_large.jpg",dead:"boss_mephistopheles_dead.jpg",timer:172800,mpool:1},skaar:{name:"Skaar Deathrune",list:"death_list.jpg",
image:"death_large.jpg",dead:"death_dead.jpg",timer:345E3,mpool:1},sylvanus:{name:"Sylvanas the Sorceress Queen",list:"boss_sylvanus_list.jpg",image:"boss_sylvanus_large.jpg",dead:"boss_sylvanus_dead.jpg",timer:172800,mpool:1},dragon_emerald:{name:"Emerald Dragon",list:"dragon_list_green.jpg",image:"dragon_monster_green.jpg",timer:259200,mpool:2},dragon_frost:{name:"Frost Dragon",list:"dragon_list_blue.jpg",image:"dragon_monster_blue.jpg",timer:259200,mpool:2},dragon_gold:{name:"Gold Dragon",list:"dragon_list_gold.jpg",
image:"dragon_monster_gold.jpg",timer:259200,mpool:2},dragon_red:{name:"Ancient Red Dragon",list:"dragon_list_red.jpg",image:"dragon_monster_red.jpg",timer:259200,mpool:2},serpent_amethyst:{name:"Amethyst Sea Serpent",list:"seamonster_list_purple.jpg",image:"seamonster_purple.jpg",timer:259200,mpool:2},serpent_ancient:{name:"Ancient Sea Serpent",list:"seamonster_list_red.jpg",image:"seamonster_red.jpg",timer:259200,mpool:2},serpent_emerald:{name:"Emerald Sea Serpent",list:"seamonster_list_green.jpg",
image:"seamonster_green.jpg",timer:259200,mpool:2},serpent_sapphire:{name:"Sapphire Sea Serpent",list:"seamonster_list_blue.jpg",image:"seamonster_blue.jpg",timer:259200,mpool:2},cronus:{name:"Cronus, The World Hydra",list:"hydra_head.jpg",image:"hydra_large.jpg",dead:"hydra_dead.jpg",timer:604800,mpool:3},legion:{name:"Battle of the Dark Legion",list:"castle_siege_list.jpg",image:"castle_siege_large.jpg",dead:"castle_siege_dead.jpg",timer:604800,mpool:3},genesis:{name:"Genesis, The Earth Elemental",
list:"earth_element_list.jpg",image:"earth_element_large.jpg",dead:"earth_element_dead.jpg",timer:604800,mpool:3},ragnarok:{name:"Ragnarok, The Ice Elemental",list:"water_list.jpg",image:"water_large.jpg",dead:"water_dead.jpg",timer:604800,mpool:3}};Monster.dispel=['input[src=$"button_dispel.gif"]'];Monster.fortify=['input[src$="attack_monster_button3.jpg"]','input[src$="seamonster_fortify.gif"]'];
Monster.attack=['input[src$="attack_monster_button2.jpg"]','input[src$="seamonster_power.gif"]','input[src$="attack_monster_button.jpg"]','input[src$="event_attack2.gif"]','input[src$="event_attack1.gif"]'];Monster.count=0;Monster.uid=null;Monster.onload=function(){var b,c;for(b in Monster.data)for(c in Monster.data[b])Monster.data[b][c].state==="engage"&&Monster.count++};
Monster.parse=function(){var b,c,a,d,e=false,f,g;if(Page.page==="keep_monster_active"){Monster.uid=a=$('img[linked="true"][size="square"]').attr("uid");for(b in Monster.types)if(Monster.types[b].dead&&$('img[src$="'+Monster.types[b].dead+'"]').length){d=b;g=Monster.types[b].timer;e=true}else if(Monster.types[b].image&&$('img[src$="'+Monster.types[b].image+'"]').length){d=b;g=Monster.types[b].timer}else if(Monster.types[b].image2&&$('img[src$="'+Monster.types[b].image2+'"]').length){d=b;g=Monster.types[b].timer2||
Monster.types[b].timer}if(!a||!d){debug("Monster: Unknown monster (probably dead)");return false}Monster.data[a]=Monster.data[a]||{};Monster.data[a][d]=Monster.data[a][d]||{};f=Monster.data[a][d];if($('input[src*="collect_reward_button.jpg"]').length){f.state="reward";return false}if(e&&f.state==="assist")f.state=null;else if(e&&f.state==="engage")f.state="reward";else{if(!f.state&&$("span.result_body").text().match(/for your help in summoning|You have already assisted on this objective|You don't have enough stamina assist in summoning/i)){if($("span.result_body").text().match(/for your help in summoning/i))f.assist=
Date.now();f.state="assist"}if(!f.name){a=$('img[linked="true"][size="square"]').parent().parent().next().text().trim().replace(/[\s\n\r]{2,}/g," ");f.name=a.substr(0,a.length-Monster.types[d].name.length-3)}a=$('img[src$="monster_health_background.jpg"]').parent();f.health=a.length?a.width()/a.parent().width()*100:0;a=$('img[src$="seamonster_ship_health.jpg"]').parent();if(a.length)f.defense=a.width()/(a.next().length?a.width()+a.next().width():a.parent().width())*100;a=$('img[src$="bar_dispel.gif"]').parent();
if(a.length)f.dispel=a.width()/(a.next().length?a.width()+a.next().width():a.parent().width())*100;f.timer=$("#app"+APPID+"_monsterTicker").text().parseTimer();f.finish=Date.now()+f.timer*1E3;f.damage_total=0;f.damage={};$('td.dragonContainer table table a[href^="http://apps.facebook.com/castle_age/keep.php?user="]').each(function(h,j){h=$(j).attr("href").regex(/user=([0-9]+)/i);var k=$(j).parent().next().text().replace(/[^0-9\/]/g,"");j=k.regex(/([0-9]+)/);k=k.regex(/\/([0-9]+)/);f.damage[h]=k?[j,
k]:[j];f.damage_total+=j});f.dps=f.damage_total/(g-f.timer);f.total=Monster.types[d].raid?f.damage_total+$('img[src$="monster_health_background.jpg"]').parent().parent().next().text().regex(/([0-9]+)/):Math.floor(f.damage_total/(100-f.health)*100);f.eta=Date.now()+Math.floor((f.total-f.damage_total)/f.dps)*1E3}}else if(Page.page==="keep_monster"||Page.page==="battle_raid"){if(!$("#app"+APPID+"_app_body div.imgButton").length)return false;if(Page.page==="battle_raid")raid=true;for(a in Monster.data)for(d in Monster.data[a])if((Page.page===
"battle_raid"&&Monster.types[d].raid||Page.page==="keep_monster"&&!Monster.types[d].raid)&&(Monster.data[a][d].state==="complete"||Monster.data[a][d].state==="assist"&&Monster.data[a][d].finish<Date.now()))Monster.data[a][d].state=null;$("#app"+APPID+"_app_body div.imgButton").each(function(h,j){var k=$("a",j).attr("href").regex(/user=([0-9]+)/i),m=$(j).parent().parent().children().eq(1).html().regex(/graphics\/([^.]*\....)/i),l="unknown";for(h in Monster.types)if(m===Monster.types[h].list||m===Monster.types[h].lis2){l=
h;break}if(!(!k||l==="unknown")){Monster.data[k]=Monster.data[k]||{};Monster.data[k][l]=Monster.data[k][l]||{};if(k===userID)Monster.data[k][l].name="You";else{m=$(j).parent().parent().children().eq(2).text().trim();Monster.data[k][l].name=m.substr(0,m.length-Monster.types[l].name.length-3)}switch($("img",j).attr("src").regex(/dragon_list_btn_([0-9])/)){case 2:Monster.data[k][l].state="reward";break;case 3:Monster.data[k][l].state="engage";break;case 4:Monster.data[k][l].state="complete";break;default:Monster.data[k][l].state=
"unknown";break}}})}Monster.count=0;for(b in Monster.data){for(c in Monster.data[b])if(Monster.data[b][c].state)Monster.data[b][c].state==="engage"&&Monster.count++;else delete Monster.data[b][c];length(Monster.data[b])||delete Monster.data[b]}return false};Monster.update=function(b){b==="data"&&Dashboard.change(Monster)};
Monster.work=function(b){var c,a,d=[],e=Monster.option.uid,f=Monster.option.type,g=null,h=null;if(!b||e&&f&&Monster.data[e][f].state!=="engage"&&Monster.data[e][f].state!=="assist"){Monster.option.uid=e=null;Monster.option.type=f=null}if(!length(Monster.data)||Player.data.health<=10)return false;for(c in Monster.data)for(a in Monster.data[c])if(!Monster.data[c][a].health&&Monster.data[c][a].state==="engage"){if(b)Page.to(Monster.types[a].raid?"battle_raid":"keep_monster","?user="+c+(Monster.types[a].mpool?
"&mpool="+Monster.types[a].mpool:""));return true}if(!e||!f||!Monster.data[e]||!Monster.data[e][f]){for(e in Monster.data)for(f in Monster.data[e])if(Monster.data[e][f].state==="engage"&&Monster.data[e][f].finish>Date.now())if(Monster.option.choice==="All")d.push([e,f]);else if(!h||Monster.option.choice==="Strongest"&&Monster.data[e][f].health>Monster.data[h[0]][h[1]].health||Monster.option.choice==="Weakest"&&Monster.data[e][f].health<Monster.data[h[0]][h[1]].health||Monster.option.choice==="Shortest"&&
Monster.data[e][f].timer<Monster.data[h[0]][h[1]].timer)h=[e,f];if(Monster.option.choice==="All"&&d.length)h=d[Math.floor(Math.random()*d.length)];if(!h)return false;e=Monster.option.uid=h[0];f=Monster.option.type=h[1]}if(Queue.burn.stamina<5&&(Queue.burn.energy<10||(typeof Monster.data[e][f].defense==="undefined"||Monster.data[e][f].defense>Monster.option.fortify)&&(typeof Monster.data[e][f].dispel==="undefined"||Monster.data[e][f].dispel<Monster.option.dispel)))return false;if(!b)return true;if(Monster.types[f].raid){if(!Generals.to(Generals.best(Monster.option.raid.indexOf("Invade")?
"invade":"duel")))return true;debug("Raid: "+Monster.option.raid+" "+e);switch(Monster.option.raid){case "Invade":g=$('input[src$="raid_attack_button.gif"]:first');break;case "Invade x5":g=$('input[src$="raid_attack_button3.gif"]:first');break;case "Duel":g=$('input[src$="raid_attack_button2.gif"]:first');break;case "Duel x5":g=$('input[src$="raid_attack_button4.gif"]:first');break}}else if(Monster.data[e][f].defense&&Monster.data[e][f].defense<=Monster.option.fortify&&Queue.burn.energy>=10){if(!Generals.to(Generals.best("defend")))return true;
debug("Monster: Fortify "+e);for(c=0;c<Monster.fortify.length;c++)if($(Monster.fortify[c]).length){g=$(Monster.fortify[c]);break}}else if(Monster.data[e][f].dispel&&Monster.data[e][f].dispel>=Monster.option.dispel&&Queue.burn.energy>=10){if(!Generals.to(Generals.best("defend")))return true;debug("Monster: Dispel "+e);for(c=0;c<Monster.dispel.length;c++)if($(Monster.dispel[c]).length){g=$(Monster.dispel[c]);break}}else{if(!Generals.to(Generals.best("duel")))return true;debug("Monster: Attack "+e);
for(c=0;c<Monster.attack.length;c++)if($(Monster.attack[c]).length){g=$(Monster.attack[c]);break}}if((!g||!g.length||e!==Monster.uid)&&!Page.to(Monster.types[f].raid?"battle_raid":"keep_monster","?user="+e+(Monster.types[f].mpool?"&mpool="+Monster.types[f].mpool:"")))return true;Page.click(g);return true};Monster.order=null;
Monster.dashboard=function(b,c){var a,d,e,f,g,h=[],j,k=[null,"name","health","defense","dispel",null,"timer","eta"],m={engage:0,assist:1,reward:2,complete:3};h.push('<table cellspacing="0" style="width:100%"><thead><tr><th></th><th>User</th><th title="(estimated)">Health</th><th>Fortify</th><th>Shield</th><th>Damage</th><th>Time Left</th><th title="(estimated)">Kill In</th></tr></thead><tbody>');if(typeof b==="undefined"){b=1;Monster.order=[];for(a in Monster.data)for(d in Monster.data[a])Monster.order.push([a,
d])}Monster.order.sort(function(l,n){var o,p;if(m[Monster.data[l[0]][l[1]].state]>m[Monster.data[n[0]][n[1]].state])return 1;if(m[Monster.data[l[0]][l[1]].state]<m[Monster.data[n[0]][n[1]].state])return-1;if(typeof k[b]==="string"){o=Monster.data[l[0]][l[1]][k[b]];p=Monster.data[n[0]][n[1]][k[b]]}else if(b==4){o=Monster.data[l[0]][l[1]].damage?Monster.data[l[0]][l[1]].damage[userID]:0;p=Monster.data[n[0]][n[1]].damage?Monster.data[n[0]][n[1]].damage[userID]:0}if(typeof o==="string"||typeof p==="string")return c?
(p||"")>(o||""):(p||"")<(o||"");return c?(o||0)-(p||0):(p||0)-(o||0)});for(e=0;e<Monster.order.length;e++){a=Monster.order[e][0];d=Monster.order[e][1];if(Monster.types[d]){j=[];f=Monster.data[a][d];g=Monster.option.assist&&(f.state==="engage"||f.state==="assist")?"?user="+a+"&action=doObjective"+(Monster.types[d].mpool?"&mpool="+Monster.types[d].mpool:"")+"&lka="+a+"&ref=nf":"?user="+a+(Monster.types[d].mpool?"&mpool="+Monster.types[d].mpool:"");j.push('<a href="http://apps.facebook.com/castle_age/'+
(Monster.types[d].raid?"raid.php":"battle_monster.php")+g+'"><strong  style="position:absolute;margin:6px;color:#1fc23a;text-shadow:black 1px 1px 2px;">'+f.state+'</strong><img src="'+Player.data.imagepath+Monster.types[d].list+'" style="width:90px;height:25px" alt="'+d+'" title="'+(Monster.types[d].name?Monster.types[d].name:d)+'"></a>');j.push(Monster.data[a][d].name);if((f.state==="engage"||f.state==="assist")&&f.total){j.push(f.health===100?"?":addCommas(f.total-f.damage_total)+" ("+Math.floor(f.health)+
"%)");j.push(typeof f.defense==="number"?Math.floor(f.defense)+"%":"");j.push(typeof f.dispel==="number"?Math.floor(f.dispel)+"%":"");j.push(f.state==="engage"?addCommas(f.damage[userID][0]||0)+" ("+((f.damage[userID][0]||0)/f.total*100).round(1)+"%)":"");j.push(f.timer?'<span class="golem-timer">'+makeTimer((f.finish-Date.now())/1E3)+"</span>":"?");j.push(f.health===100?"?":'<span class="golem-timer">'+makeTimer((f.eta-Date.now())/1E3)+"</span>")}else j.push("","","","","","");h.push("<tr><td>"+
j.join("</td><td>")+"</td></tr>")}}h.push("</tbody></table>");$("#golem-dashboard-Monster").html(h.join(""));$("#golem-dashboard-Monster thead th").css("cursor","pointer").click(function(){Monster.dashboard($(this).prevAll().length,$(this).attr("name")==="sort")});$("#golem-dashboard-Monster tbody td a").click(function(){var l=$(this).attr("href");Page.to(l.indexOf("raid")>0?"battle_raid":"keep_monster",l.substr(l.indexOf("?")));return false});$("#golem-dashboard-Monster tbody tr td:nth-child(2)").css("text-align",
"left");if(typeof b!=="undefined")$("#golem-dashboard-Monster thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Player=new Worker("Player","*");Player.data={history:{},average:0};Player.option=null;Player.panel=null;Player.onload=function(){var b=new Date(script_started+$("*").html().regex(/gold_increase_ticker\(([0-9]+),/)*1E3);Player.data.cash_time=b.getSeconds()+b.getMinutes()*60};
Player.parse=function(){var b=Player.data,c,a=Math.floor(Date.now()/36E5);b.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);c=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);b.energy=c[0]||0;b.maxenergy=c[1]||0;c=$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);b.health=c[0]||0;b.maxhealth=c[1]||0;c=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);
b.stamina=c[0]||0;b.maxstamina=c[1]||0;c=$("#app"+APPID+"_st_2_5").text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);b.exp=c[0]||0;b.maxexp=c[1]||0;b.level=$("#app"+APPID+"_st_5").text().regex(/Level: ([0-9]+)!/i);b.armymax=$("a[href*=army.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/);b.army=Math.min(b.armymax,501);b.upgrade=$("a[href*=keep.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/)||0;b.general=$("div.general_name_div3").first().text().trim();b.imagepath=$("div.general_pic_div3 img").attr("src").pathpart();
if(Page.page==="keep_stats"){c=$("div.keep_attribute_section").first();if(c.length){b.myname=$("div.keep_stat_title > span",c).text().regex(/"(.*)"/);b.rank=$("td.statsTMainback img[src*=rank_medals]").attr("src").filepart().regex(/([0-9]+)/);c=$("div.attribute_stat_container",c);b.attack=$(c).eq(2).text().regex(/([0-9]+)/);b.defense=$(c).eq(3).text().regex(/([0-9]+)/);b.bank=parseInt($("td.statsTMainback b.money").text().replace(/[^0-9]/g,""),10);c=$("td.statsTMainback tr tr").text().replace(/[^0-9$]/g,
"").regex(/([0-9]+)\$([0-9]+)\$([0-9]+)/);b.maxincome=c[0];b.upkeep=c[1];b.income=c[2]}}if(Page.page==="town_land"){c=$(".mContTMainback div:last-child");Player.data.income=c.eq(c.length-4).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)}b.history[a]=typeof b.history[a]==="number"?{income:b.history[a]}:b.history[a]||{};b.history[a].bank=Player.data.bank;b.history[a].exp=Player.data.exp;$("span.result_body").each(function(e,f){e=$(f).text().replace(/,|\s+|\n/g,"");b.history[a].income=(b.history[a].income||
0)+(e.regex(/Gain.*\$([0-9]+).*Cost/i)||0)+(e.regex(/stealsGold:\+\$([0-9]+)/i)||0)+(e.regex(/Youreceived\$([0-9]+)/i)||0)+(e.regex(/Yougained\$([0-9]+)/i)||0);if(e.regex(/incomepaymentof\$([0-9]+)gold/i))b.history[a].land=(e.regex(/incomepaymentof\$([0-9]+)gold/i)||0)+(e.regex(/backinthemine:Extra([0-9]+)Gold/i)||0)});a-=168;b.average=0;for(var d in b.history)if(d<a)delete b.history[d];else b.average+=b.history[d].income||0;b.average=Math.floor(b.average/length(b.average));return false};
Player.update=function(b){if(b==="data"){var c=Divisor(Player.data.maxstamina);$("select.golem_stamina").each(function(a,d){$(d).empty();var e=(a=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(a[0]).option[a[1]]:null;for(a=0;a<=Player.data.maxstamina;a+=c)$(d).append('<option value="'+a+'"'+(e==a?" selected":"")+">"+a+"</option>")});c=Divisor(Player.data.maxenergy);$("select.golem_energy").each(function(a,d){$(d).empty();var e=(a=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?
WorkerByName(a[0]).option[a[1]]:null;for(a=0;a<=Player.data.maxenergy;a+=c)$(d).append('<option value="'+a+'"'+(e==a?" selected":"")+">"+a+"</option>")});c=Divisor(Player.data.maxhealth);$("select.golem_health").each(function(a,d){$(d).empty();var e=(a=$(d).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(a[0]).option[a[1]]:null;for(a=0;a<=Player.data.maxhealth;a+=c)$(d).append('<option value="'+a+'"'+(e==a?" selected":"")+">"+a+"</option>")});Dashboard.change(Player)}};
Player.work=function(){Player.data.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);var b=new Date;Player.data.cash_timer=(3600+Player.data.cash_time-(b.getSeconds()+b.getMinutes()*60))%3600;Player.data.energy=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);Player.data.energy_timer=$("#app"+APPID+"_energy_time_value").text().parseTimer();Player.data.health=$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);
Player.data.health_timer=$("#app"+APPID+"_health_time_value").text().parseTimer();Player.data.stamina=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);Player.data.stamina_timer=$("#app"+APPID+"_stamina_time_value").text().parseTimer()};
Player.dashboard=function(){var b=[];b.push('<table cellspacing="0" cellpadding="0" class="golem-graph"><thead><tr><th></th><th colspan="73"><span style="float:left;">&lArr; Older</span>72 Hour History<span style="float:right;">Newer &rArr;</span></th></tr></thead><tbody>');b.push(Player.makeGraph(["income","land"],"Income",true));b.push(Player.makeGraph("bank","Bank",true));b.push(Player.makeGraph("exp","Experience",false));b.push("</tbody></table>");$("#golem-dashboard-Player").html(b.join(""))};
Player.makeGraph=function(b,c,a,d){var e,f=0,g,h=[],j={},k=Math.floor(Date.now()/36E5);h.push("<tr>");for(e=k-72;e<=k;e++)if(typeof b==="string"){j[e]=0;if(typeof Player.data.history[e]!=="undefined"&&typeof Player.data.history[e][b]!=="undefined"){d=Math.min(typeof d==="number"?d:Number.POSITIVE_INFINITY,Player.data.history[e][b]);f=Math.max(f,Player.data.history[e][b]);j[e]=Player.data.history[e][b]}}else if(typeof b==="object"){j[e]=[0,0];if(typeof Player.data.history[e]!=="undefined"){if(typeof Player.data.history[e][b[0]]!==
"undefined"){d=Math.min(typeof d==="number"?d:Number.POSITIVE_INFINITY,Player.data.history[e][b[0]]);f=Math.max(f,Player.data.history[e][b[0]]);j[e][0]=Player.data.history[e][b[0]]}if(typeof Player.data.history[e][b[1]]!=="undefined"){d=Math.min(typeof d==="number"?d:Number.POSITIVE_INFINITY,Player.data.history[e][b[1]]);f=Math.max(f,Player.data.history[e][b[1]]);j[e][1]=Player.data.history[e][b[1]]}}}if(f>=1E9){f=Math.ceil(f/1E9)*1E9;e=addCommas(f/1E9)+"b"}else if(f>=1E6){f=Math.ceil(f/1E6)*1E6;
e=f/1E6+"m"}else if(f>=1E3){f=Math.ceil(f/1E3)*1E3;e=f/1E3+"k"}else e=f||0;if(d>=1E9){d=d.round(-9);g=addCommas(d/1E9)+"b"}else if(d>=1E6){d=d.round(-6);g=d/1E6+"m"}else if(d>=1E3){d=d.round(-3);g=d/1E3+"k"}else g=d||0;h.push("<th><div>"+(a?"$":"")+e+"</div><div>"+c+"</div><div>"+(a?"$":"")+g+"</div></th>");for(e=k-72;e<=k;e++)if(typeof b==="string"&&j[e])h.push('<td title="'+(k-e)+" hour"+(k-e==1?"":"s")+" ago, "+(a?"$":"")+addCommas(j[e])+'"><div style="height:'+Math.ceil((j[e]-d)/(f-d)*100)+'px;"></div></td>');
else typeof b==="object"&&(j[e][0]||j[e][1])?h.push('<td title="'+(k-e)+" hour"+(k-e==1?"":"s")+" ago, "+(a?"$":"")+addCommas(j[e][1])+" + "+(a?"$":"")+addCommas(j[e][0])+" = "+(a?"$":"")+addCommas(j[e][0]+j[e][1])+'"><div style="height:'+Math.max(Math.ceil((j[e][0]-d)/(f-d)*100)-1,0)+'px;"></div><div style="height:'+Math.max(Math.ceil((j[e][1]-d)/(f-d)*100)-1,0)+'px;"></div></td>'):h.push('<td style="border-bottom:1px solid blue;" title="'+(k-e)+" hour"+(k-e==1?"":"s")+' ago"></td>');h.push("</tr>");
return h.join("")};var Quest=new Worker("Quest","quests_quest1 quests_quest2 quests_quest3 quests_quest4 quests_quest5 quests_quest6 quests_quest7 quests_demiquests quests_atlantis");Quest.option={general:"Under Level 4",what:"Influence",unique:true,monster:true};Quest.land=["Land of Fire","Land of Earth","Land of Mist","Land of Water","Demon Realm","Undead Realm","Underworld"];Quest.area={quest:"Quests",demiquest:"Demi Quests",atlantis:"Atlantis"};Quest.current=null;
Quest.display=[{id:"general",label:"General",select:["any","Under Level 4","Influence"]},{id:"what",label:"Quest for",select:"quest_reward"},{id:"unique",label:"Get Unique Items First",checkbox:true},{id:"monster",label:"Fortify Monsters First",checkbox:true},{id:"current",label:"Current",info:"None"}];
Quest.parse=function(){var b=Quest.data,c,a=null;if(Page.page==="quests_quest")return false;else if(Page.page==="quests_demiquests")c="demiquest";else if(Page.page==="quests_atlantis")c="atlantis";else{c="quest";a=Page.page.regex(/quests_quest([0-9]+)/i)-1}$("div.quests_background,div.quests_background_sub,div.quests_background_special").each(function(d,e){var f,g,h,j,k,m=0;if($(e).hasClass("quests_background_sub")){d=$(".quest_sub_title",e).text().trim();h=$(".qd_2_sub",e).text().replace(/[^0-9$]/g,
"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);k=$(".qd_3_sub",e).text().regex(/([0-9]+)/);f=$(".quest_sub_progress",e).text().regex(/LEVEL ([0-9]+)/i);g=$(".quest_sub_progress",e).text().regex(/INFLUENCE: ([0-9]+)%/i);m=2}else{d=$(".qd_1 b",e).text().trim();h=$(".qd_2",e).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);k=$(".quest_req b",e).text().regex(/([0-9]+)/);if($(e).hasClass("quests_background")){f=$(".quest_progress",e).text().regex(/LEVEL ([0-9]+)/i);g=$(".quest_progress",
e).text().regex(/INFLUENCE: ([0-9]+)%/i);m=1}else m=3}if(d){b[d]={};b[d].area=c;if(typeof a==="number")b[d].land=a;if(typeof g==="number"){b[d].level=f||0;b[d].influence=g}b[d].exp=h.shift();b[d].reward=(h[0]+h[1])/2;b[d].energy=k;if(m!==2){if(m===3)b[d].unique=true;f=$(".qd_1 img",e).last();if(f.length&&f.attr("title")){b[d].item=f.attr("title").trim();b[d].itemimg=f.attr("src").filepart()}j={};$(".quest_req > div > div > div",e).each(function(l,n){l=$("img",n).attr("title");j[l]=$(n).text().regex(/([0-9]+)/)});
if(j.length)b[d].units=j;f=$(".quest_act_gen img",e);if(f.length&&f.attr("title"))b[d].general=f.attr("title")}}});return false};
Quest.update=function(b){if(b==="data"){var c,a=[];for(c in Quest.data)Quest.data[c].item&&!Quest.data[c].unique&&a.push(Quest.data[c].item);a=["Nothing","Influence","Experience","Cash"].concat(unique(a).sort());$("select.golem_quest_reward").each(function(d,e){$(e).empty();var f=(d=$(e).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i))?WorkerByName(d[0]).option[d[1]]:null;for(d=0;d<a.length;d++)$(e).append('<option value="'+a[d]+'"'+(a[d]===f?" selected":"")+">"+a[d]+"</value>")});Dashboard.change(Quest)}};
Quest.work=function(b){var c,a,d=null;if(Quest.option.what==="Nothing")return false;if(Quest.option.unique)for(c in Quest.data)if(Quest.data[c].unique&&!Alchemy.data.ingredients[Quest.data[c].itemimg]&&(!d||Quest.data[c].energy<Quest.data[d].energy))d=c;if(!d)for(c in Quest.data)if(Quest.option.what==="Influence"&&typeof Quest.data[c].influence!=="undefined"&&Quest.data[c].influence<100&&(!d||Quest.data[c].energy<Quest.data[d].energy)||Quest.option.what==="Experience"&&(!d||Quest.data[c].energy/Quest.data[c].exp<
Quest.data[d].energy/Quest.data[d].exp)||Quest.option.what==="Cash"&&(!d||Quest.data[c].energy/Quest.data[c].reward<Quest.data[d].energy/Quest.data[d].reward)||Quest.option.what!=="Influence"&&Quest.option.what!=="Experience"&&Quest.option.what!=="Cash"&&Quest.data[c].item===Quest.option.what&&(!d||Quest.data[c].energy<Quest.data[d].energy))d=c;if(d!==Quest.current)if(Quest.current=d){debug("Quest: Wanting to perform - "+d+" (energy: "+Quest.data[d].energy+")");$("#"+PREFIX+"Quest_current").html(""+
d+" (energy: "+Quest.data[d].energy+")")}if(Quest.option.monster)for(c in Monster.data)for(a in Monster.data[c])if(Monster.data[c][a].state==="engage"&&typeof Monster.data[c][a].defense==="number"&&Monster.data[c][a].defense<=Monster.option.fortify)return false;if(!d||Quest.data[d].energy>Queue.burn.energy)return false;if(!b)return true;if(Quest.data[d].general){if(!Generals.to(Quest.data[d].general))return true}else if(!Generals.to(Generals.best(Quest.option.general)))return true;switch(Quest.data[d].area){case "quest":if(!Page.to("quests_quest"+
(Quest.data[d].land+1)))return true;break;case "demiquest":if(!Page.to("quests_demiquests"))return true;break;case "atlantis":if(!Page.to("quests_atlantis"))return true;break;default:debug("Quest: Can't get to quest area!");return false}debug("Quest: Performing - "+d+" (energy: "+Quest.data[d].energy+")");Page.click('div.action[title^="'+d+'"] input[type="image"]')||Page.reload();if(Quest.option.unique&&Quest.data[d].unique)if(!Page.to("keep_alchemy"))return true;return true};Quest.order=[];
Quest.dashboard=function(b,c){function a(h){switch(b){case 0:return Quest.data[h].general||"zzz";case 1:return h;case 2:return typeof Quest.data[h].land==="number"&&typeof Quest.land[Quest.data[h].land]!=="undefined"?Quest.land[Quest.data[h].land]:Quest.area[Quest.data[h].area];case 3:return(typeof Quest.data[h].level!=="undefined"?Quest.data[h].level:-1)*100+(Quest.data[h].influence||0);case 4:return Quest.data[h].energy;case 5:return Quest.data[h].exp/Quest.data[h].energy;case 6:return Quest.data[h].reward/
Quest.data[h].energy;case 7:return Quest.data[h].item||"zzz"}return 0}var d,e,f=[],g;if(typeof b==="undefined"){Quest.order=[];for(d in Quest.data)Quest.order.push(d);b=1}Quest.order.sort(function(h,j){h=a(h);j=a(j);if(typeof h==="string"||typeof j==="string")return c?(j||"")>(h||""):(j||"")<(h||"");return c?(h||0)-(j||0):(j||0)-(h||0)});f.push('<table cellspacing="0" style="width:100%"><thead><th>General</th><th>Name</th><th>Area</th><th>Level</th><th>Energy</th><th>@&nbsp;Exp</th><th>@&nbsp;Reward</th><th>Item</th></tr></thead><tbody>');
for(e=0;e<Quest.order.length;e++){d=Quest.order[e];g=[];g.push(Generals.data[Quest.data[d].general]?'<img style="width:25px;height:25px;" src="'+Player.data.imagepath+Generals.data[Quest.data[d].general].img+'" alt="'+Quest.data[d].general+'" title="'+Quest.data[d].general+'">':"");g.push(d);g.push(typeof Quest.data[d].land==="number"?Quest.land[Quest.data[d].land].replace(" ","&nbsp;"):Quest.area[Quest.data[d].area].replace(" ","&nbsp;"));g.push(typeof Quest.data[d].level!=="undefined"?Quest.data[d].level+
"&nbsp;("+Quest.data[d].influence+"%)":"");g.push(Quest.data[d].energy);g.push('<span title="'+Quest.data[d].exp+" total, "+(Quest.data[d].exp/Quest.data[d].energy*12).round(2)+' per hour">'+(Quest.data[d].exp/Quest.data[d].energy).round(2)+"</span>");g.push('<span title="$'+addCommas(Quest.data[d].reward)+" total, $"+addCommas((Quest.data[d].reward/Quest.data[d].energy*12).round())+' per hour">$'+addCommas((Quest.data[d].reward/Quest.data[d].energy).round())+"</span>");g.push(Quest.data[d].itemimg?
'<img style="width:25px;height:25px;" src="'+Player.data.imagepath+Quest.data[d].itemimg+'" alt="'+Quest.data[d].item+'" title="'+Quest.data[d].item+'">':"");f.push('<tr style="height:25px;"><td>'+g.join("</td><td>")+"</td></tr>")}f.push("</tbody></table>");$("#golem-dashboard-Quest").html(f.join(""));$("#golem-dashboard-Quest thead th").css("cursor","pointer").click(function(){Quest.dashboard($(this).prevAll().length,$(this).attr("name")==="sort")});$("#golem-dashboard-Quest tbody tr td:nth-child(2)").css("text-align",
"left");if(typeof b!=="undefined")$("#golem-dashboard-Quest thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Town=new Worker("Town","town_soldiers town_blacksmith town_magic");Town.data={soldiers:{},blacksmith:{},magic:{}};Town.display=[{label:"Work in progress..."},{id:"general",label:"Buy Number:",select:["None","Maximum","Match Army"]},{id:"units",label:"Buy Type:",select:["All","Best Offense","Best Defense","Best of Both"]}];
Town.blacksmith={Weapon:/avenger|axe|blade|bow|cudgel|dagger|halberd|mace|morningstar|rod|saber|spear|staff|stave|sword|talon|trident|wand|Daedalus|Dragonbane|Dreadnought Greatsword|Excalibur|Incarnation|Ironhart's Might|Judgement|Justice|Lightbringer|Oathkeeper|Onslaught/i,Shield:/buckler|shield|tome|Defender|Dragon Scale|Frost Dagger|Frost Tear Dagger|Harmony|Sword of Redemption|The Dreadnought/i,Helmet:/cowl|crown|helm|horns|mask|veil/i,Gloves:/gauntlet|glove|hand|bracer|Slayer's Embrace/i,Armor:/armor|chainmail|cloak|pauldrons|plate|robe|Blood Vestment|Faerie Wings|Ogre Raiments/i,
Amulet:/amulet|bauble|charm|eye|heart|jewel|lantern|memento|orb|shard|soul|talisman|trinket|Paladin's Oath|Poseidons Horn/i};
Town.parse=function(b){if(b)Page.page==="town_blacksmith"&&$(".eq_buy_row,.eq_buy_row2").each(function(a,d){a=$("div.eq_buy_txt strong:first-child",d);d=a.text().trim();Town.data.blacksmith[d].type&&a.parent().append("<br>"+Town.data.blacksmith[d].type)});else{var c={};$(".eq_buy_row,.eq_buy_row2").each(function(a,d){var e;a=$("div.eq_buy_costs",d);var f=$("div.eq_buy_stats",d),g=$("div.eq_buy_txt strong:first-child",d).text().trim(),h=$("strong:first-child",a).text().replace(/[^0-9]/g,"");c[g]={};
if(h){c[g].cost=parseInt(h,10);c[g].buy=[];$('select[name="amount"]:first option',a).each(function(j,k){c[g].buy.push(parseInt($(k).val(),10))})}c[g].img=$("div.eq_buy_image img",d).attr("src").filepart();c[g].own=$("span:first-child",a).text().regex(/Owned: ([0-9]+)/i);c[g].att=$("div:first-child",f).text().regex(/([0-9]+)/);c[g].def=$("div:last-child",f).text().regex(/([0-9]+)/);if(Page.page==="town_blacksmith")for(e in Town.blacksmith)if(g.match(Town.blacksmith[e]))c[g].type=e});Town.data[Page.page.substr(5)]=
c}return true};
Town.update=function(b){if(b==="data"){var c=b=0,a=0,d=0,e=Player.data.army,f=function(g,h){g.push(h)};b+=getAttDef(Town.data.soldiers,f,"att",e,"invade");c+=getAttDef(Town.data.soldiers,null,"def",e,"invade");b+=getAttDef(Town.data.blacksmith,function(g,h,j){j[h].type!=="Weapon"&&g.push(h)},"att",e,"invade");c+=getAttDef(Town.data.blacksmith,null,"def",e,"invade");b+=getAttDef(Town.data.blacksmith,function(g,h,j){j[h].type==="Weapon"&&g.push(h)},"att",e,"invade");c+=getAttDef(Town.data.blacksmith,null,
"def",e,"invade");a+=getAttDef(Town.data.blacksmith,null,"att",1,"duel");d+=getAttDef(Town.data.blacksmith,null,"def",1,"duel");b+=getAttDef(Town.data.magic,f,"att",e,"invade");c+=getAttDef(Town.data.magic,null,"def",e,"invade");a+=getAttDef(Town.data.magic,null,"att",1,"duel");d+=getAttDef(Town.data.magic,null,"def",1,"duel");a+=getAttDef(Town.data.blacksmith,function(g,h,j){j[h].type==="Shield"&&g.push(h)},"att",1,"duel");d+=getAttDef(Town.data.blacksmith,null,"def",1,"duel");a+=getAttDef(Town.data.blacksmith,
function(g,h,j){j[h].type==="Helmet"&&g.push(h)},"att",1,"duel");d+=getAttDef(Town.data.blacksmith,null,"def",1,"duel");a+=getAttDef(Town.data.blacksmith,function(g,h,j){j[h].type==="Gloves"&&g.push(h)},"att",1,"duel");d+=getAttDef(Town.data.blacksmith,null,"def",1,"duel");a+=getAttDef(Town.data.blacksmith,function(g,h,j){j[h].type==="Armor"&&g.push(h)},"att",1,"duel");d+=getAttDef(Town.data.blacksmith,null,"def",1,"duel");a+=getAttDef(Town.data.blacksmith,function(g,h,j){j[h].type==="Amulet"&&g.push(h)},
"att",1,"duel");d+=getAttDef(Town.data.blacksmith,null,"def",1,"duel");Town.data.invade={attack:b,defend:c};Town.data.duel={attack:a,defend:d};Dashboard.change(Town);return true}};
Town.work=function(b){if(!Town.option.number)return false;var c,a,d=Math.min(Town.option.number==="Maximum"?501:Player.data.army,501),e=null,f=0,g=Town.data.soldiers;for(c in g){f=0;if(!(!g[c].cost||g[c].own>=d||e&&Town.option.units==="Best Offense"&&g[c].att<=e.att||e&&Town.option.units==="Best Defense"&&g[c].def<=e.def||e&&Town.option.units==="Best of Both"&&(g[c].att<=e.att||g[c].def<=e.def))){for(a in g[c].buy)if(d-g[c].own>=g[c].buy[a])f=g[c].buy[a];debug("Thinking about buying: "+f+" of "+c+
" at $"+f*g[c].cost);if(f){e=c;break}}}if(!e)return false;if(!b){debug("Want to buy "+f+" x "+e+" at $"+f*g[e].cost);return true}return false};
var makeTownDash=function(b,c,a,d,e,f){var g=[],h=[],j=a==="att"?"def":"att",k,m={Weapon:1,Shield:2,Helmet:3,Armor:4,Amulet:5,Gloves:6,Magic:7};e&&h.push('<div class="golem-panel"><h3 class="golem-panel-header">'+e+'</h3><div class="golem-panel-content">');for(k in b)c(g,k,b);if(b[g[0]])if(d==="duel"&&b[g[0]].type)g.sort(function(l,n){return m[b[l].type]-m[b[n].type]});else b[g[0]]&&b[g[0]].skills&&b[g[0]][d]?g.sort(function(l,n){return(b[n][d][a]||0)-(b[l][d][a]||0)}):g.sort(function(l,n){return b[n][a]+
0.7*b[n][j]-(b[l][a]+0.7*b[l][j])});for(k=0;k<(f?f:g.length);k++)if(b[g[0]]&&b[g[0]].skills||b[g[k]].use&&b[g[k]].use[d+"_"+a])h.push('<div style="height:25px;margin:1px;"><img src="'+Player.data.imagepath+b[g[k]].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+(b[g[k]].use?b[g[k]].use[d+"_"+a]+" x ":"")+g[k]+" ("+b[g[k]].att+" / "+b[g[k]].def+")"+(b[g[k]].cost?"<br>$"+addCommas(b[g[k]].cost):"")+"</div>");e&&h.push("</div></div>");return h.join("")};
Town.dashboard=function(){var b,c,a=function(g,h){g.push(h)},d=function(g,h,j){j[h].use&&g.push(h)},e=function(g,h,j){j[h].use&&j[h].type==="Weapon"&&g.push(h)},f=function(g,h,j){j[h].use&&j[h].type!=="Weapon"&&g.push(h)};c=Generals.best("duel");b='<div style="float:left;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(Generals.data,a,"att","invade","Heroes")+makeTownDash(Town.data.soldiers,
d,"att","invade","Soldiers")+makeTownDash(Town.data.blacksmith,e,"att","invade","Weapons")+makeTownDash(Town.data.blacksmith,f,"att","invade","Equipment")+makeTownDash(Town.data.magic,d,"att","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+(c!=="any"?'<div style="height:25px;margin:1px;"><img src="'+Player.data.imagepath+Generals.data[c].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+
c+" ("+Generals.data[c].att+" / "+Generals.data[c].def+")</div>":"")+makeTownDash(Town.data.blacksmith,d,"att","duel")+makeTownDash(Town.data.magic,d,"att","duel")+"</div></div></div>";c=Generals.best("defend");c='<div style="float:right;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(Generals.data,a,"def","invade","Heroes")+makeTownDash(Town.data.soldiers,d,"def","invade","Soldiers")+makeTownDash(Town.data.blacksmith,
e,"def","invade","Weapons")+makeTownDash(Town.data.blacksmith,f,"def","invade","Equipment")+makeTownDash(Town.data.magic,d,"def","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+(c!=="any"?'<div style="height:25px;margin:1px;"><img src="'+Player.data.imagepath+Generals.data[c].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+c+" ("+Generals.data[c].att+" / "+Generals.data[c].def+
")</div>":"")+makeTownDash(Town.data.blacksmith,d,"def","duel")+makeTownDash(Town.data.magic,d,"def","duel")+"</div></div></div>";$("#golem-dashboard-Town").html(b+c)};var Upgrade=new Worker("Upgrade","keep_stats");Upgrade.data={run:0};Upgrade.display=[{label:"Points will be allocated in this order, add multiple entries if wanted (ie, 3x Attack and 1x Defense would put &frac34; on Attack and &frac14; on Defense)"},{id:"order",multiple:["Energy","Stamina","Attack","Defense","Health"]}];
Upgrade.parse=function(){var b=$("div.results");if(Upgrade.data.working&&b.length&&b.text().match(/You just upgraded your/i)){Upgrade.data.working=false;Upgrade.data.run++;if(Upgrade.data.run>=Upgrade.option.order.length)Upgrade.data.run=0}return false};
Upgrade.work=function(b){if(!Upgrade.option.order||!Upgrade.option.order.length||!Player.data.upgrade||Upgrade.option.order[Upgrade.data.run]==="Stamina"&&Player.data.upgrade<2)return false;if(!b||!Page.to("keep_stats"))return true;Upgrade.data.working=true;if(Upgrade.data.run>=Upgrade.option.order.length)Upgrade.data.run=0;switch(Upgrade.option.order[Upgrade.data.run]){case "Energy":if(Page.click('a[href$="?upgrade=energy_max"]'))return true;break;case "Stamina":if(Page.click('a[href$="?upgrade=stamina_max"]'))return true;
break;case "Attack":if(Page.click('a[href$="?upgrade=attack"]'))return true;break;case "Defense":if(Page.click('a[href$="?upgrade=defense"]'))return true;break;case "Health":if(Page.click('a[href$="?upgrade=health_max"]'))return true;break}Page.reload();return true};
