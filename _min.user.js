// ==UserScript==
// @name		Rycochet's Castle Age Golem
// @namespace	golem
// @description	Auto player for castle age game
// @license		GNU Lesser General Public License; http://www.gnu.org/licenses/lgpl.html
// @version		31.1
// @include		http://apps.facebook.com/castle_age/*
// @include		http://apps.facebook.com/reqs.php
// @require		http://cloutman.com/jquery-latest.min.js
// @require		http://cloutman.com/jquery-ui-latest.min.js
// ==/UserScript==
// 
// For the source code please check the sourse repository
// - http://code.google.com/p/game-golem/
// 
// For the unshrunk Work In Progress version (which may introduce new bugs)
// - http://game-golem.googlecode.com/svn/trunk/_normal.user.js
var a,show_debug=true,VERSION=31.1,script_started=Date.now(),userID=0,imagepath="",applications={"reqs.php":["","Gifts"],castle_age:["46755028429","Castle Age"]};if(window.location.hostname==="apps.facebook.com"||window.location.hostname==="apps.new.facebook.com")for(var i in applications)if(window.location.pathname.indexOf(i)===1){var APP=i,APPID=applications[i][0],APPNAME=applications[i][1],PREFIX="golem"+APPID+"_";break}
var log=console.log,debug=show_debug?function(b){console.log("["+(new Date).format("G:i:s")+"] "+b)}:function(){};if(typeof unsafeWindow==="undefined")unsafeWindow=window;
typeof APP!=="undefined"&&$(document).ready(function(){var b;userID=$("head").html().regex(/user:([0-9]+),/i);if(!userID||typeof userID!=="number"||userID===0){log("ERROR: No Facebook UserID!!!");window.location.href=window.location.href}else if(APP!=="reqs.php"){try{imagepath=$("#app"+APPID+"_globalContainer img:eq(0)").attr("src").pathpart()}catch(c){log("ERROR: Bad Page Load!!!");Page.reload();return}do_css();Page.identify();for(b=0;b<Workers.length;b++)Workers[b]._setup();for(b=0;b<Workers.length;b++)Workers[b]._init();
for(b=0;b<Workers.length;b++){Workers[b]._update();Workers[b]._flush()}Page.parse_all()}});
function do_css(){$("head").append("<style type=\"text/css\">.red { background: red !important; }.golem-config { float: none; margin-right: 0; }.golem-config > div { position: static; width: 196px; margin: 0; padding: 0; overflow: hidden; overflow-y: auto; }.golem-config #golem_fixed { float:right; margin:-2px; width:16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00.IDATx%DAb%60A%03%0Cd%0B03%81%18LH%02%10%80%2C%C0%84%24%00%96d%C2%A7%02%AB%19L%8C%A8%B6P%C3%E9%08%00%10%60%00%00z%03%C7%24%170%91%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-config-fixed { float: right; margin-right: 200px; }.golem-config-fixed > div { position: fixed; }.golem-config-fixed #golem_fixed { background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%DE%DE%DE%DD%DD%DDcccUUU%00%00%00%23%06%7B1%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%005IDATx%DAb%60A%03%0C%C4%0901%83%00%13%92%0A%B0%00%0B)%02%8C%CCLLL%CC%0Cx%0CefF%E8%81%B9%83%19%DDa%84%05H%F0%1C%40%80%01%00%FE9%03%C7%D4%8CU%A3%00%00%00%00IEND%AEB%60%82') no-repeat; }#golem-dashboard { position: absolute; width: 600px; height: 185px; margin: 0; border-left: 1px solid black; border-right:1px solid black; overflow: hidden; background: white; z-index: 1; }#golem-dashboard thead th { cursor: pointer }#golem-dashboard thead th.golem-sort:after { content: '&darr;'; }#golem-dashboard thead th.golem-sort-reverse:after { content: '&uarr;'; }#golem-dashboard tbody tr:nth-child(odd) { background: #eeeeee; }#golem-dashboard tbody th { text-align: left; font-weight: normal; }#golem-dashboard td, #golem-dashboard th { margin: 2px; text-align: center; padding: 0 8px; }#golem-dashboard > div { height: 163px; overflow: hidden; overflow-y: scroll; border-top: 1px solid #d3d3d3; }#golem-dashboard > div > div { padding: 2px; }#golem-dashboard .golem-status { width: 100%; }#golem-dashboard .golem-status tbody th { text-align: right; padding: 2px; font-weight: bold; }#golem-dashboard .golem-status tbody td { text-align: left; }#golem-dashboard .overlay { position: absolute; left:10px; margin: 3px; color: white; text-shadow: black 0px 0px 2px; }table.golem-graph { height: 100px }table.golem-graph tbody th, table.golem-graph tbody td { border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }table.golem-graph tbody th { max-width: 75px; }table.golem-graph tbody th:first-child { text-align: right; border-left: 1px solid #dddddd; border-right: 1px solid #cccccc; }table.golem-graph tbody th:first-child div { line-height: 60px; height: 60px; }table.golem-graph tbody th:first-child div:first-child, table.golem-graph tbody th:first-child div:last-child { line-height: 20px; height: 20px; }table.golem-graph tbody th:last-child { text-align: left; border-right: 1px solid #dddddd; vertical-align: bottom; }table.golem-graph tbody th:last-child div { position: relative; height: 10px; margin: -10px 0 0; }table.golem-graph tbody th:last-child div:nth-last-child(1) { color: #ff0000; }table.golem-graph tbody th:last-child div:nth-last-child(2) { color: #0000ff; }table.golem-graph tbody th:last-child div:nth-last-child(3) { color: #00ffff; }table.golem-graph tbody th:last-child div:nth-last-child(4) { color: #aa00aa; }table.golem-graph tbody td { margin: 0; padding: 0 !important; vertical-align: bottom; width: 5px; border-right: 1px solid #dddddd; }table.golem-graph tbody td:nth-child(12n+1) { border-right: 1px solid #cccccc; }table.golem-graph tbody td div div { margin: 0; padding: 0; width: 5px; }table.golem-graph tbody td div.bars div:nth-last-child(1) { background: #00ff00; }table.golem-graph tbody td div.bars div:nth-last-child(2) { background: #00aa00; }table.golem-graph tbody td div.bars div:nth-last-child(3) { background: #ffff00; }table.golem-graph tbody td div.bars div:nth-last-child(4) { background: #ff00ff; }table.golem-graph tbody td div.goal div { position: relative; height: 1px; margin: -1px 0 0; }table.golem-graph tbody td div.goal div:nth-last-child(1) { background: #ff0000; }table.golem-graph tbody td div.goal div:nth-last-child(2) { background: #0000ff; }table.golem-graph tbody td div.goal div:nth-last-child(3) { background: #00ffff; }table.golem-graph tbody td div.goal div:nth-last-child(4) { background: #aa00aa; }.golem-button, .golem-button-active { border: 1px solid #d3d3d3; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; font-weight: normal; font-size: 13px; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-button:hover, .golem-button-active { border: 1px solid #aaaaaa; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }img.golem-button, img.golem-button-active { margin-bottom: -2px }.golem-tab-header { position: relative; top: 1px; border: 1px solid #d3d3d3; display: inline-block; cursor: pointer; margin-left: 1px; margin-right: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 1px 2px; -moz-border-radius-topleft: 3px; -webkit-border-top-left-radius: 3px; border-top-left-radius: 3px; -moz-border-radius-topright: 3px; -webkit-border-top-right-radius: 3px; border-top-right-radius: 3px; }.golem-tab-header-active { border: 1px solid #aaaaaa; border-bottom: 0 !important; padding: 2px; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; }.golem-title { padding: 4px; overflow: hidden; border-bottom: 1px solid #aaaaaa; background: #cccccc url(http://cloutman.com/css/base/images/ui-bg_highlight-soft_75_cccccc_1x100.png) 50% 50% repeat-x; color: #222222; font-weight: bold; }.golem-panel > .golem-panel-header, .golem-panel > * > .golem-panel-header { border: 1px solid #d3d3d3; cursor: pointer; margin-top: 1px; background: #e6e6e6 url(http://cloutman.com/css/base/images/ui-bg_glass_75_e6e6e6_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #555555; padding: 2px 2px 2px 2px; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }.golem-panel > .golem-panel-content, .golem-panel > * > .golem-panel-content { border: 1px solid #aaaaaa; border-top: 0 !important; padding: 2px 6px; background: #ffffff url(http://cloutman.com/css/base/images/ui-bg_glass_65_ffffff_1x400.png) 50% 50% repeat-x; font-weight: normal; color: #212121; display: none; -moz-border-radius-bottomleft: 3px; -webkit-border-bottom-left-radius: 3px; border-bottom-left-radius: 3px; -moz-border-radius-bottomright: 3px; -webkit-border-bottom-right-radius: 3px; border-bottom-right-radius: 3px; }.golem-panel-show > .golem-panel-header, .golem-panel-show > * > .golem-panel-header { border: 1px solid #aaaaaa; border-bottom: 0 !important; background: #dadada url(http://cloutman.com/css/base/images/ui-bg_glass_75_dadada_1x400.png) 50% 50% repeat-x; -moz-border-radius-bottomleft: 0 !important; -webkit-border-bottom-left-radius: 0 !important; border-bottom-left-radius: 0 !important; -moz-border-radius-bottomright: 0 !important; -webkit-border-bottom-right-radius: 0 !important; border-bottom-right-radius: 0 !important; }.golem-panel-show > .golem-panel-content, .golem-panel-show > * > .golem-panel-content { display: block; }.golem-panel-sortable .golem-lock { display: none; }.golem-panel .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C%D4%13%60%C0%10%60%C0%10%60%C0%10%60%20%A4%82%90-%149%1D%20%C0%00%81%0E%00%F1%DE%25%95%BE%00%00%00%00IEND%AEB%60%82') no-repeat; }.golem-panel .golem-panel-header .golem-lock { float: right; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%001IDATx%DAb%60D%03%0CD%0B000%A0%0800%C0D%E0%02%8C(%02%0C%0Cp%25%B8%05%18%09%0A%A0j%C1%B4%96%1C%BF%C0%01%40%80%01%00n%11%00%CF%7D%2Bk%9B%00%00%00%00IEND%AEB%60%82') no-repeat;}.golem-panel-show .golem-panel-header .golem-icon { float: left; width: 16px; height: 16px; background: url('data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTEUUU%00%00%00%F5%04%9F%A0%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%22IDATx%DAb%60D%03%0C4%13%60%80%00%24%15%08%3EL%0B%9C%CF%88N%D3%D0a%C8%00%20%C0%00%7F%DE%00%F1%CCc%A6b%00%00%00%00IEND%AEB%60%82') no-repeat; }</style>")}
a=String.prototype;a.trim=function(){return this.replace(/^\s+|\s+$/g,"")};a.filepart=function(){var b=this.lastIndexOf("/");if(b>=0)return this.substr(b+1);return this};a.pathpart=function(){var b=this.lastIndexOf("/");if(b>=0)return this.substr(0,b+1);return this};a.regex=function(b){b=this.match(b);var c;if(b){b.shift();for(c=0;c<b.length;c++)if(b[c]&&b[c].search(/^[-+]?[0-9]*\.?[0-9]*$/)>=0)b[c]=parseFloat(b[c]);if(b.length===1)return b[0]}return b};a.toNumber=function(){return parseFloat(this)};
a.parseTimer=function(){var b=this.split(":"),c=0,d;for(d=0;d<b.length;d++)c=c*60+parseInt(b[d],10);if(isNaN(c))c=9999;return c};Number.prototype.round=function(b){return result=Math.round(this*Math.pow(10,b||0))/Math.pow(10,b||0)};Math.range=function(b,c,d){return Math.max(b,Math.min(c,d))};
var makeTimer=function(b){var c=Math.floor(b/3600),d=Math.floor(b/60)%60;b=Math.floor(b%60);return(c?c+":"+(d>9?d:"0"+d):d)+":"+(b>9?b:"0"+b)},WorkerByName=function(b){for(var c=0;c<Workers.length;c++)if(Workers[c].name.toLowerCase()===b.toLowerCase())return Workers[c];return null},WorkerById=function(b){for(var c=0;c<Workers.length;c++)if(Workers[c].id===b)return Workers[c];return null},Divisor=function(b){var c=b,d=1;if(c<20)return 1;for(;c>100;){c/=10;d*=10}if(b/d>40)d*=5;else if(b/d>20)d*=2.5;
return d},length=function(b){var c=0,d;if(typeof b==="object")for(d in b)c++;else if(typeof b==="array")c=b.length;return c},unique=function(b){var c={},d,e=b.length,f=[];for(d=0;d<e;d++)c[b[d]]=b[d];for(d in c)f.push(c[d]);return f},deleteElement=function(b,c){for(;c in b;)b.splice(b.indexOf(c),1)},sum=function(b){var c,d=0;if(isArray(b))for(c=0;c<b.length;c++)d+=sum(b[c]);else if(typeof b==="object")for(c in b)d+=sum(b[c]);else if(typeof b==="number")d=b;else if(typeof b==="string"&&b.search(/^[-+]?[0-9]*\.?[0-9]*$/)>=
0)d=parseFloat(b);return d},addCommas=function(b){b=b?b.toString():"0";for(var c=/(-?[0-9]+)([0-9]{3})/;c.test(b);)b=b.replace(c,"$1,$2");return b},findInArray=function(b,c){if(typeof b==="array"||typeof b==="object")for(var d in b)if(b[d]===c)return true;return false},arrayIndexOf=function(b,c){if(isArray(b))for(var d=0;d<b.length;d++)if(b[d]===c)return d;return-1},arrayLastIndexOf=function(b,c){if(isArray(b))for(var d=b.length-1;d>=0;d--)if(b[d]===c)return d;return-1},sortObject=function(b,c){var d=
[],e={};for(i in b)d.push(i);d.sort(c);for(i=0;i<d.length;i++)e[d[i]]=b[d[i]];return e},getAttDefList=[],getAttDef=function(b,c,d,e,f){var g=[],h=0,k=0,l=d==="att"?"def":"att",n;if(c)for(n in b)c(g,n,b);else g=getAttDefList;g.sort(function(o,p){return b[p][d]+0.7*b[p][l]-(b[o][d]+0.7*b[o][l])});for(n=0;n<g.length;n++){c=typeof b[g[n]].own==="number"?b[g[n]].own:1;if(f)if(Math.min(e,c)>0){if(!b[g[n]].use)b[g[n]].use={};b[g[n]].use[f+"_"+d]=Math.min(e,c)}else if(length(b[g[n]].use)){delete b[g[n]].use[f+
"_"+d];length(b[g[n]].use)||delete b[g[n]].use}c=Math.min(e,c);h+=c*b[g[n]].att;k+=c*b[g[n]].def;e-=c}getAttDefList=g;return(d==="att"?h:0.7*h)+(d==="def"?k:0.7*k)},tr=function(b,c,d){b.push("<tr"+(d?" "+d:"")+">"+(c||"")+"</tr>")},th=function(b,c,d){b.push("<th"+(d?" "+d:"")+">"+(c||"")+"</th>")},td=function(b,c,d){b.push("<td"+(d?" "+d:"")+">"+(c||"")+"</td>")},isArray=function(b){return b&&typeof b==="object"&&!b.propertyIsEnumerable("length")&&typeof b.length==="number"},isNumber=function(b){return b&&
typeof b==="number"};
if(typeof GM_getValue!=="undefined")var setItem=function(b,c){GM_setValue(b,c)},getItem=function(b){return GM_getValue(b)};else if(typeof localStorage!=="undefined"){setItem=function(b,c){localStorage.setItem("golem."+APP+b,c)};getItem=function(b){return localStorage.getItem("golem."+APP+b)}}else if(typeof window.localStorage!=="undefined"){setItem=function(b,c){window.localStorage.setItem("golem."+APP+b,c)};getItem=function(b){return window.localStorage.getItem("golem."+APP+b)}}else if(typeof globalStorage!==
"undefined"){setItem=function(b,c){globalStorage[location.hostname].setItem("golem."+APP+b,c)};getItem=function(b){return globalStorage[location.hostname].getItem("golem."+APP+b)}}var plural=function(b){return b===1?"":"s"};Date.prototype.format=function(b){for(var c="",d=Date.replaceChars,e=0;e<b.length;e++){var f=b.charAt(e);c+=d[f]?d[f].call(this):f}return c};
Date.replaceChars={shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longMonths:["January","February","March","April","May","June","July","August","September","October","November","December"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longDays:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d:function(){return(this.getDate()<10?"0":"")+this.getDate()},D:function(){return Date.replaceChars.shortDays[this.getDay()]},j:function(){return this.getDate()},
l:function(){return Date.replaceChars.longDays[this.getDay()]},N:function(){return this.getDay()+1},S:function(){return this.getDate()%10==1&&this.getDate()!=11?"st":this.getDate()%10==2&&this.getDate()!=12?"nd":this.getDate()%10==3&&this.getDate()!=13?"rd":"th"},w:function(){return this.getDay()},z:function(){return"Not Yet Supported"},W:function(){return"Not Yet Supported"},F:function(){return Date.replaceChars.longMonths[this.getMonth()]},m:function(){return(this.getMonth()<9?"0":"")+(this.getMonth()+
1)},M:function(){return Date.replaceChars.shortMonths[this.getMonth()]},n:function(){return this.getMonth()+1},t:function(){return"Not Yet Supported"},L:function(){return this.getFullYear()%4==0&&this.getFullYear()%100!=0||this.getFullYear()%400==0?"1":"0"},o:function(){return"Not Supported"},Y:function(){return this.getFullYear()},y:function(){return(""+this.getFullYear()).substr(2)},a:function(){return this.getHours()<12?"am":"pm"},A:function(){return this.getHours()<12?"AM":"PM"},B:function(){return"Not Yet Supported"},
g:function(){return this.getHours()%12||12},G:function(){return this.getHours()},h:function(){return((this.getHours()%12||12)<10?"0":"")+(this.getHours()%12||12)},H:function(){return(this.getHours()<10?"0":"")+this.getHours()},i:function(){return(this.getMinutes()<10?"0":"")+this.getMinutes()},s:function(){return(this.getSeconds()<10?"0":"")+this.getSeconds()},e:function(){return"Not Yet Supported"},I:function(){return"Not Supported"},O:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/
60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+"00"},P:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+":"+(Math.abs(this.getTimezoneOffset()%60)<10?"0":"")+Math.abs(this.getTimezoneOffset()%60)},T:function(){var b=this.getMonth();this.setMonth(0);var c=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,"$1");this.setMonth(b);return c},Z:function(){return-this.getTimezoneOffset()*60},c:function(){return this.format("Y-m-d")+
"T"+this.format("H:i:sP")},r:function(){return this.toString()},U:function(){return this.getTime()/1E3}};var Workers=[];
function Worker(b,c,d){Workers.push(this);this.id=null;this.name=b;this.pages=c;this.defaults=null;this.settings=d||{};this.data={};this.option={};this.update=this.work=this.parse=this.init=this.display=this.runtime=null;this.get=function(e){return this._get(e)};this.set=function(e,f){return this._set(e,f)};this._rootpath=true;this._loaded=false;this._working={data:false,option:false,runtime:false,update:false};this._changed=Date.now();this._watching=[]}a=Worker.prototype;
a._flush=function(){this._save();this.settings.keep||delete this.data};
a._get=function(b){var c=typeof b==="string"?b.split("."):typeof b==="object"?b:[],d;if(!c.length||c[0]!=="data"&&c[0]!=="option"&&c[0]!=="runtime")c.unshift("data");if(c[0]==="data"){!this._loaded&&this._init();this._unflush()}d=this[c.shift()];try{switch(c.length){case 0:return d;case 1:return d[c[0]];case 2:return d[c[0]][c[1]];case 3:return d[c[0]][c[1]][c[2]];case 4:return d[c[0]][c[1]][c[2]][c[3]];case 5:return d[c[0]][c[1]][c[2]][c[3]][c[4]];case 6:return d[c[0]][c[1]][c[2]][c[3]][c[4]][c[5]];
case 7:return d[c[0]][c[1]][c[2]][c[3]][c[4]][c[5]][c[6]];default:break}}catch(e){debug(e.name+" in "+this.name+".get("+b+"): "+e.message)}return null};a._init=function(){if(!this._loaded){this._loaded=true;try{this.init&&this.init()}catch(b){debug(b.name+" in "+this.name+".init(): "+b.message)}}};
a._load=function(b){if(b!=="data"&&b!=="option"&&b!=="runtime"){this._load("data");this._load("option");this._load("runtime")}else{var c=getItem((this._rootpath?userID+".":"")+b+"."+this.name)||this[b];if(typeof c!=="string")this[b]=c;else switch(c.charAt(0)){case '"':this[b]=c.replace(/^"|"$/g,"");return;case "(":case "[":c=(new Function("return "+c))();if(!this[b]||typeof this[b]!=="array"&&typeof this[b]!=="object"){this[b]=c;return}this[b]=$.extend(true,{},this[b],c);return;default:this[b]=c;
return}}};a._parse=function(b){try{return this.parse&&this.parse(b)}catch(c){debug(c.name+" in "+this.name+".parse("+b+"): "+c.message)}return false};a._remind=function(b){var c=this;window.setTimeout(function(){c._update("reminder")},b*1E3)};
a._save=function(b){if(b!=="data"&&b!=="option"&&b!=="runtime")return this._save("data")+this._save("option")+this._save("runtime");if(typeof this[b]==="undefined"||!this[b]||this._working[b])return false;var c=(this._rootpath?userID+".":"")+b+"."+this.name,d;switch(typeof this[b]){case "string":d='"'+this[b]+'"';break;case "array":case "object":d=this[b].toSource();break;default:d=this[b];break}if(getItem(c)==="undefined"||getItem(c)!==d){this._working[b]=true;this._changed=Date.now();this._update(b);
setItem(c,d);this._working[b]=false;return true}return false};
a._set=function(b,c){var d=typeof b==="string"?b.split("."):typeof b==="object"?b:[],e;if(!d.length||d[0]!=="data"&&d[0]!=="option"&&d[0]!=="runtime")d.unshift("data");if(d[0]==="data"){!this._loaded&&this._init();this._unflush()}e=this[d.shift()];try{switch(d.length){case 0:break;case 1:e[d[0]]=c;break;case 2:e[d[0]][d[1]]=c;break;case 3:e[d[0]][d[1]][d[2]]=c;break;case 4:e[d[0]][d[1]][d[2]][d[3]]=c;break;case 5:e[d[0]][d[1]][d[2]][d[3]][d[4]]=c;break;case 6:e[d[0]][d[1]][d[2]][d[3]][d[4]][d[5]]=
c;break;case 7:e[d[0]][d[1]][d[2]][d[3]][d[4]][d[5]][d[6]]=c;break;default:break}}catch(f){debug(f.name+" in "+this.name+".set("+b+", "+c+"): "+f.message)}return null};a._setup=function(){if(this.defaults&&this.defaults[APP])for(var b in this.defaults[APP])this[b]=this.defaults[APP][b];this.settings.system||!this.defaults||this.defaults[APP]?this._load():Workers.splice(Workers.indexOf(this),1)};a._unflush=function(){!this._loaded&&this._init();!this.settings.keep&&!this.data&&this._load("data")};
a._update=function(b){if(this._loaded&&(this.update||this._watching.length)){var c=false;this._working.update=true;if(!this.data){c=true;this._unflush()}try{this.update&&this.update(b)}catch(d){debug(d.name+" in "+this.name+".update("+(b?typeof b==="string"?b:b.name:"")+"): "+d.message)}for(b=0;b<this._watching.length;b++)if(this._watching[b]===this)try{this.update&&this.update(this)}catch(e){debug(e.name+" in "+this.name+".update(this): "+e.message)}else this._watching[b]._update(this);c&&this._flush();
this._working.update=false}};a._watch=function(b){!findInArray(b._watching,this)&&b._watching.push(this)};a._work=function(b){try{return this.work&&this.work(b)}catch(c){debug(c.name+" in "+this.name+".work("+b+"): "+c.message)}return false};var Config=new Worker("Config");Config.settings={system:true,keep:true};Config.option={display:"block",fixed:true,advanced:false};
Config.init=function(){$("head").append('<link rel="stylesheet" href="http://cloutman.com/css/base/jquery-ui.css" type="text/css" />');var b,c,d,e;$("div.UIStandardFrame_Content").after('<div class="golem-config'+(Config.option.fixed?" golem-config-fixed":"")+'"><div class="ui-widget-content"><div class="golem-title">Castle Age Golem v'+VERSION+'<img id="golem_fixed"></div><div id="golem_buttons" style="margin:4px;"><img class="golem-button'+(Config.option.display==="block"?"-active":"")+'" id="golem_options" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%E2%E2%E2%8A%8A%8A%AC%AC%AC%FF%FF%FFUUU%1C%CB%CE%D3%00%00%00%04tRNS%FF%FF%FF%00%40*%A9%F4%00%00%00%3DIDATx%DA%A4%8FA%0E%00%40%04%03%A9%FE%FF%CDK%D2%B0%BBW%BD%CD%94%08%8B%2F%B6%10N%BE%A2%18%97%00%09pDr%A5%85%B8W%8A%911%09%A8%EC%2B%8CaM%60%F5%CB%11%60%00%9C%F0%03%07%F6%BC%1D%2C%00%00%00%00IEND%AEB%60%82"></div><div style="display:'+
Config.option.display+';"><div id="golem_config" style="margin:0 4px;overflow:hidden;overflow-y:auto;"></div><div style="text-align:right;"><label>Advanced <input type="checkbox" id="golem-config-advanced"'+(Config.option.advanced?" checked":"")+"></label></div></div></div></div>");$("#golem_options").click(function(){$(this).toggleClass("golem-button golem-button-active");Config.option.display=Config.option.display==="block"?"none":"block";$("#golem_config").parent().toggle("blind");Config._save("option")});
$("#golem_fixed").click(function(){Config.option.fixed^=true;$(this).closest(".golem-config").toggleClass("golem-config-fixed");Config._save("option")});b=$("#golem_config");for(c in Workers)b.append(Config.makePanel(Workers[c]));b.sortable({axis:"y"});$(".golem-config .golem-panel > h3").click(function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});
Config._save("option")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind");Config.option.active=[];$(".golem-panel-show").each(function(){Config.option.active.push($(this).attr("id"))});Config._save("option")}});b.children(".golem-panel-sortable").draggable({connectToSortable:"#golem_config",axis:"y",distance:5,scroll:false,handle:"h3",helper:"clone",opacity:0.75,zIndex:100,refreshPositions:true,stop:function(){Config.updateOptions()}}).droppable({tolerance:"pointer",
over:function(f,g){var h=Config.getOrder(),k=WorkerByName($(g.draggable).attr("name")),l=arrayIndexOf(h,$(this).attr("name"));if(arrayIndexOf(h,"Idle")>=l){if(k.settings.before)for(f=0;f<k.settings.before.length;f++)if(arrayIndexOf(h,k.settings.before[f])<=l)return;if(k.settings.after)for(f=0;f<k.settings.after.length;f++)if(arrayIndexOf(h,k.settings.after[f])>=l)return}l<arrayIndexOf(h,$(g.draggable).attr("name"))?$(this).before(g.draggable):$(this).after(g.draggable)}});for(c in Workers){if(Workers[c].settings.before)for(d=
0;d<Workers[c].settings.before.length;d++)if(e=WorkerByName(Workers[c].settings.before[d])){e.settings.after=e.settings.after||[];e.settings.after.push(Workers[c].name);e.settings.after=unique(e.settings.after)}if(Workers[c].settings.after)for(d=0;d<Workers[c].settings.after.length;d++)if(e=WorkerByName(Workers[c].settings.after[d])){e.settings.before=e.settings.before||[];e.settings.before.push(Workers[c].name);e.settings.before=unique(e.settings.before)}}$.expr[":"].golem=function(f,g,h){g=h[3].toLowerCase().split(",");
if($(f).attr("id")===PREFIX+g[0].trim().replace(/[^0-9a-z]/g,"-")+"_"+g[1].trim())return true;return false};$("input.golem_addselect").live("click",function(){$("select.golem_multiple",$(this).parent()).append("<option>"+$(".golem_select",$(this).parent()).val()+"</option>");Config.updateOptions()});$("input.golem_delselect").live("click",function(){$("select.golem_multiple option[selected=true]",$(this).parent()).each(function(f,g){$(g).remove()});Config.updateOptions()});$("input,textarea,select",
b).change(function(){Config.updateOptions()});$("#golem-config-advanced").click(function(){Config.updateOptions();$(".golem-advanced").css("display",Config.option.advanced?"":"none")})};
Config.makePanel=function(b){var c,d,e,f,g,h=b.display,k=[],l=[],n=[],o={before:"",after:"",suffix:"",className:"",between:"to",size:7,min:0,max:100};if(!h)return false;b.id="golem_panel_"+b.name.toLowerCase().replace(/[^0-9a-z]/g,"-");d=findInArray(Config.option.active,b.id);g=$('<div id="'+b.id+'" class="golem-panel'+(b.settings.unsortable?"":" golem-panel-sortable")+(d?" golem-panel-show":"")+(b.settings.advanced?' golem-advanced"'+(Config.option.advanced?"":' style="display:none;"'):'"')+' name="'+
b.name+'"><h3 class="golem-panel-header "><img class="golem-icon">'+b.name+'<img class="golem-lock"></h3></div>');switch(typeof h){case "array":case "object":for(c in h){l=[];n=[];d=$.extend(true,{},o,h[c]);d.real_id=PREFIX+b.name.toLowerCase().replace(/[^0-9a-z]/g,"-")+"_"+d.id;d.value=b.get("option."+d.id)||null;d.alt=d.alt?' alt="'+d.alt+'"':"";d.hr&&l.push('<br><hr style="clear:both;margin:0;">');d.title&&l.push('<div style="text-align:center;font-size:larger;font-weight:bold;">'+d.title.replace(" ",
"&nbsp;")+"</div>");if(d.label){l.push('<span style="float:left;margin-top:2px;">'+d.label.replace(" ","&nbsp;")+"</span>");if(d.text||d.checkbox||d.select)l.push('<span style="float:right;">');else d.multiple&&l.push("<br>")}d.before&&l.push(d.before+" ");if(d.info)d.id?l.push('<span style="float:right" id="'+d.real_id+'">'+(d.value||d.info)+"</span>"):l.push(d.info);else if(d.text)l.push('<input type="text" id="'+d.real_id+'" size="'+d.size+'" value="'+(d.value||"")+'">');else if(d.checkbox)l.push('<input type="checkbox" id="'+
d.real_id+'"'+(d.value?" checked":"")+">");else if(d.select){switch(typeof d.select){case "number":f=Divisor(d.select);for(e=0;e<=d.select;e+=f)n.push("<option"+(d.value==e?" selected":"")+">"+e+"</option>");break;case "string":d.className=' class="golem_'+d.select+'"';if(this.data&&this.data[d.select]&&(typeof this.data[d.select]==="array"||typeof this.data[d.select]==="object"))d.select=this.data[d.select];else break;case "array":case "object":if(isArray(d.select))for(e=0;e<d.select.length;e++)n.push('<option value="'+
d.select[e]+'"'+(d.value==d.select[e]?" selected":"")+">"+d.select[e]+(d.suffix?" "+d.suffix:"")+"</option>");else for(e in d.select)n.push('<option value="'+e+'"'+(d.value==e?" selected":"")+">"+d.select[e]+(d.suffix?" "+d.suffix:"")+"</option>");break}l.push('<select id="'+d.real_id+'"'+d.className+d.alt+">"+n.join("")+"</select>")}else if(d.multiple){if(typeof d.value==="array"||typeof d.value==="object")for(c in d.value)n.push('<option value="'+d.value[c]+'">'+d.value[c]+"</option>");l.push('<select style="width:100%;clear:both;" class="golem_multiple" multiple id="'+
d.real_id+'">'+n.join("")+"</select><br>");if(typeof d.multiple==="string")l.push('<input class="golem_select" type="text" size="'+d.size+'">');else{n=[];switch(typeof d.multiple){case "number":f=Divisor(d.select);for(e=0;e<=d.multiple;e+=f)n.push("<option>"+e+"</option>");break;case "array":case "object":if(isArray(d.multiple))for(e=0;e<d.multiple.length;e++)n.push('<option value="'+d.multiple[e]+'">'+d.multiple[e]+(d.suffix?" "+d.suffix:"")+"</option>");else for(e in d.multiple)n.push('<option value="'+
e+'">'+d.multiple[e]+(d.suffix?" "+d.suffix:"")+"</option>");break}l.push('<select class="golem_select">'+n.join("")+"</select>")}l.push('<input type="button" class="golem_addselect" value="Add" /><input type="button" class="golem_delselect" value="Del" />')}d.after&&l.push(" "+d.after);if(d.label&&(d.text||d.checkbox||d.select||d.multiple))l.push("</span>");k.push('<div style="clear:both;'+(d.advanced?(Config.option.advanced?'"':'display:none;"')+' class="golem-advanced"':'"')+(d.help?' title="'+
d.help+'"':"")+">"+l.join("")+"</div>")}g.append('<div class="golem-panel-content" style="font-size:smaller;">'+k.join("")+'<div style="clear:both"></div></div>');return g;default:return null}};
Config.set=function(b,c){this._unflush();if(!this.data[b]||this.data[b].toSource()!==c.toSource()){this.data[b]=c;$("select.golem_"+b).each(function(d,e){var f=$(e).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i);f=f?WorkerByName(f[0]).option[f[1]]:null;var g=Config.data[b],h=[];if(isArray(g))for(d=0;d<g.length;d++)h.push('<option value="'+g[d]+'"'+(f==d?" selected":"")+">"+g[d]+"</option>");else for(d in g)h.push('<option value="'+d+'"'+(f==d?" selected":"")+">"+g[d]+"</option>");$(e).html(h.join(""))});
this._save();return true}return false};
Config.updateOptions=function(){Queue.option.queue=this.getOrder();this.option.advanced=$("#golem-config-advanced").attr("checked");$("#golem_config :input").each(function(b,c){if($(c).attr("id")){var d;if(b=$(c).attr("id").slice(PREFIX.length).regex(/([^_]*)_(.*)/i)){if($(c).attr("type")==="checkbox")d=$(c).attr("checked");else if($(c).attr("multiple")){d=[];$("option",c).each(function(f,g){d.push($(g).text())})}else if((d=$(c).attr("value")||$(c).val()||null)&&d.search(/[^0-9.]/)===-1)d=parseFloat(d);
try{WorkerByName(b[0]).set("option."+b[1],d)}catch(e){debug(e.name+" in Config.updateOptions(): "+$(c).attr("id")+"("+b.toSource()+") = "+e.message)}}}});for(i=0;i<Workers.length;i++)Workers[i]._save("option")};Config.getOrder=function(){var b=[];$("#golem_config > div").each(function(c,d){b.push($(d).attr("name"))});return unique(b)};var Dashboard=new Worker("Dashboard");Dashboard.settings={keep:true};Dashboard.defaults={castle_age:{pages:"*"}};Dashboard.option={display:"block",active:null};
Dashboard.init=function(){var b,c=[],d=[],e=this.option.active;for(i=0;i<Workers.length;i++)if(Workers[i].dashboard){b="golem-dashboard-"+Workers[i].name;if(!e)this.option.active=e=b;c.push('<h3 name="'+b+'" class="golem-tab-header'+(e===b?" golem-tab-header-active":"")+'">'+(Workers[i]===this?"&nbsp;*&nbsp;":Workers[i].name)+"</h3>");d.push('<div id="'+b+'"'+(e===b?"":' style="display:none;"')+"></div>");this._watch(Workers[i])}$('<div id="golem-dashboard" style="top:'+$("#app"+APPID+"_main_bn").offset().top+
"px;display:"+this.option.display+';">'+c.join("")+"<div>"+d.join("")+"</div></div>").prependTo(".UIStandardFrame_Content");$(".golem-tab-header").click(function(){if(!$(this).hasClass("golem-tab-header-active")){if(Dashboard.option.active){$('h3[name="'+Dashboard.option.active+'"]').removeClass("golem-tab-header-active");$("#"+Dashboard.option.active).hide()}Dashboard.option.active=$(this).attr("name");$(this).addClass("golem-tab-header-active");Dashboard.update();$("#"+Dashboard.option.active).show();
Dashboard._save("option")}});$("#golem-dashboard .golem-panel > h3").live("click",function(){if($(this).parent().hasClass("golem-panel-show"))$(this).next().hide("blind",function(){$(this).parent().toggleClass("golem-panel-show")});else{$(this).parent().toggleClass("golem-panel-show");$(this).next().show("blind")}});$("#golem-dashboard thead th").live("click",function(){var f=WorkerByName(Dashboard.option.active.substr(16));f._unflush();f.dashboard($(this).prevAll().length,$(this).attr("name")===
"sort")});$("#golem_buttons").append('<img class="golem-button'+(Dashboard.option.display==="block"?"-active":"")+'" id="golem_toggle_dash" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%1EPLTE%BA%BA%BA%EF%EF%EF%E5%E5%E5%D4%D4%D4%D9%D9%D9%E3%E3%E3%F8%F8%F8%40%40%40%FF%FF%FF%00%00%00%83%AA%DF%CF%00%00%00%0AtRNS%FF%FF%FF%FF%FF%FF%FF%FF%FF%00%B2%CC%2C%CF%00%00%00EIDATx%DA%9C%8FA%0A%00%20%08%04%B5%CC%AD%FF%7F%B8%0D%CC%20%E8%D20%A7AX%94q!%7FA%10H%04%F4%00%19*j%07Np%9E%3B%C9%A0%0C%BA%DC%A1%91B3%98%85%AF%D9%E1%5C%A1%FE%F9%CB%14%60%00D%1D%07%E7%0AN(%89%00%00%00%00IEND%AEB%60%82">');
$("#golem_toggle_dash").click(function(){$(this).toggleClass("golem-button golem-button-active");Dashboard.option.display=Dashboard.option.display==="block"?"none":"block";Dashboard.option.display==="block"&&!$("#"+Dashboard.option.active).children().length&&WorkerByName(Dashboard.option.active.substr(16)).dashboard();$("#golem-dashboard").toggle("drop");Dashboard._save("option")});window.setInterval(function(){$(".golem-timer").each(function(f,g){(f=$(g).text().parseTimer())&&f>0?$(g).text(makeTimer($(g).text().parseTimer()-
1)):$(g).removeClass("golem-timer").text("now?")});$(".golem-time").each(function(f,g){(f=parseInt($(g).attr("name"))-Date.now())&&f>0?$(g).text(makeTimer(f/1E3)):$(g).removeClass("golem-time").text("now?")})},1E3)};Dashboard.parse=function(){$("#golem-dashboard").css("top",$("#app"+APPID+"_main_bn").offset().top+"px")};
Dashboard.update=function(b){if(!(!this._loaded||b&&typeof b!=="object")){worker=b||WorkerByName(Dashboard.option.active.substr(16));b="golem-dashboard-"+worker.name;if(this.option.active===b&&this.option.display==="block")try{worker._unflush();worker.dashboard()}catch(c){debug(c.name+" in "+worker.name+".dashboard(): "+c.message)}else $("#"+b).empty()}};
Dashboard.dashboard=function(){var b,c=[];for(b=0;b<Workers.length;b++)this.data[Workers[b].name]&&c.push("<tr><th>"+Workers[b].name+':</th><td id="golem-status-'+Workers[b].name+'">'+this.data[Workers[b].name]+"</td></tr>");c.sort();$("#golem-dashboard-Dashboard").html('<table cellspacing="0" cellpadding="0" class="golem-status">'+c.join("")+"</table>")};Dashboard.status=function(b,c){if(c)this.data[b.name]=c;else delete this.data[b.name];this._save()};var Page=new Worker("Page");
Page.settings={system:true,unsortable:true,keep:true};Page.option={timeout:15,retry:5};Page.page="";Page.last=null;Page.lastclick=null;Page.when=null;Page.retry=0;Page.checking=true;Page.node_trigger=null;Page.loading=false;Page.display=[{id:"timeout",label:"Retry after",select:[10,15,30,60],after:"seconds"}];
Page.defaults={castle_age:{pageNames:{index:{url:"index.php",selector:"#app"+APPID+"_indexNewFeaturesBox"},quests_quest:{url:"quests.php",image:"tab_quest_on.gif"},quests_quest1:{url:"quests.php?land=1",image:"land_fire_sel.gif"},quests_quest2:{url:"quests.php?land=2",image:"land_earth_sel.gif"},quests_quest3:{url:"quests.php?land=3",image:"land_mist_sel.gif"},quests_quest4:{url:"quests.php?land=4",image:"land_water_sel.gif"},quests_quest5:{url:"quests.php?land=5",image:"land_demon_realm_sel.gif"},
quests_quest6:{url:"quests.php?land=6",image:"land_undead_realm_sel.gif"},quests_quest7:{url:"quests.php?land=7",image:"tab_underworld_big.gif"},quests_demiquests:{url:"symbolquests.php",image:"demi_quest_on.gif"},quests_atlantis:{url:"monster_quests.php",image:"tab_atlantis_on.gif"},battle_battle:{url:"battle.php",image:"battle_on.gif"},battle_training:{url:"battle_train.php",image:"training_grounds_on_new.gif"},battle_rank:{url:"battlerank.php",image:"tab_battle_rank_on.gif"},battle_raid:{url:"raid.php",
image:"tab_raid_on.gif"},battle_arena:{url:"arena.php",image:"tab_arena_on.gif"},heroes_heroes:{url:"mercenary.php",image:"tab_heroes_on.gif"},heroes_generals:{url:"generals.php",image:"tab_generals_on.gif"},town_soldiers:{url:"soldiers.php",image:"tab_soldiers_on.gif"},town_blacksmith:{url:"item.php",image:"tab_black_smith_on.gif"},town_magic:{url:"magic.php",image:"tab_magic_on.gif"},town_land:{url:"land.php",image:"tab_land_on.gif"},oracle_oracle:{url:"oracle.php",image:"oracle_on.gif"},oracle_demipower:{url:"symbols.php",
image:"demi_on.gif"},oracle_treasurealpha:{url:"treasure_chest.php",image:"tab_treasure_alpha_on.gif"},oracle_treasurevanguard:{url:"treasure_chest.php?treasure_set=alpha",image:"tab_treasure_vanguard_on.gif"},oracle_treasureonslaught:{url:"treasure_chest.php?treasure_set=onslaught",image:"tab_treasure_onslaught_on.gif"},keep_stats:{url:"keep.php?user="+userID,image:"tab_stats_on.gif"},keep_eliteguard:{url:"party.php?user="+userID,image:"tab_elite_guard_on.gif"},keep_achievements:{url:"achievements.php",
image:"tab_achievements_on.gif"},keep_alchemy:{url:"alchemy.php",image:"tab_alchemy_on.gif"},keep_monster:{url:"battle_monster.php",image:"tab_monster_on.jpg"},keep_monster_active2:{url:"battle_monster.php",selector:'div[style*="nm_monster_list_button.gif"]'},keep_monster_active:{url:"raid.php",image:"dragon_view_more.gif"},army_invite:{url:"army.php",image:"invite_on.gif"},army_gifts:{url:"gift.php",selector:"#app"+APPID+"_giftContainer"},army_viewarmy:{url:"army_member.php",image:"view_army_on.gif"},
army_sentinvites:{url:"army_reqs.php",image:"sent_invites_on.gif"},army_newsfeed:{url:"army_news_feed.php",selector:"#app"+APPID+"_army_feed_header"}}}};Page.init=function(){$("body").bind("DOMNodeInserted",function(b){if(!Page.node_trigger&&($(b.target).attr("id")==="app"+APPID+"_app_body_container"||$(b.target).attr("id")==="app"+APPID+"_globalContainer"))Page.node_trigger=window.setTimeout(function(){Page.node_trigger=null;Page.parse_all()},100)})};
Page.parse_all=function(){Page.identify();var b,c=[];for(b=0;b<Workers.length;b++)if(Workers[b].parse&&Workers[b].pages&&(Workers[b].pages.indexOf("*")>=0||Page.page&&Workers[b].pages.indexOf(Page.page)>=0)){Workers[b]._unflush();Workers[b]._parse(false)&&c.push(Workers[b])}for(b in c)c[b]._parse(true);for(b=0;b<Workers.length;b++)Workers[b]._flush()};
Page.work=function(b){if(!this.checking)return false;var c,d,e,f=null;for(c=0;c<Workers.length&&!f;c++)if(Workers[c].pages){e=Workers[c].pages.split(" ");for(d=0;d<e.length;d++)if(e[d]!=="*"&&this.pageNames[e[d]]&&!this.data[e[d]]&&e[d].indexOf("_active")===-1){f=e[d];break}}if(!b){if(f)return true;return this.checking=false}if(f&&!this.to(f)){this.data[f]=Date.now();return true}return false};
Page.identify=function(){this.page="";if(!$("#app_content_"+APPID).length){this.reload();return null}var b=$("#app"+APPID+"_app_body"),c;$("img",b).each(function(d,e){d=$(e).attr("src").filepart();for(c in Page.pageNames)if(Page.pageNames[c].image&&d===Page.pageNames[c].image){Page.page=c;return}});if(!this.page)for(c in Page.pageNames)if(Page.pageNames[c].selector&&$(Page.pageNames[c].selector).length)Page.page=c;if(this.page!=="")this.data[this.page]=Date.now();return this.page};
Page.to=function(b,c,d){if(Queue.option.pause){debug("Trying to load page when paused...");return true}if(b===this.page&&(d||typeof c==="undefined"))return true;c||(c="");if(b&&this.pageNames[b]&&this.pageNames[b].url){this.clear();this.last=this.pageNames[b].url;this.when=Date.now();if(c.indexOf("?")===0&&this.last.indexOf("?")>0)this.last=this.last.substr(0,this.last.indexOf("?"))+c;else this.last+=c;debug("Navigating to "+b+" ("+(d?"FORCE: ":"")+this.last+")");if(d)window.location.href=this.last;
else this.ajaxload()}return false};
Page.ajaxload=function(){$.ajax({cache:false,dataType:"text",timeout:this.option.timeout*1E3,url:"http://apps.facebook.com/castle_age/"+this.last,error:function(){debug("Page not loaded correctly, reloading.");Page.ajaxload()},success:function(b){if(b.indexOf("</html>")!==-1&&b.indexOf("single_popup")!==-1&&b.indexOf("app"+APPID+"_index")!==-1){Page.loading=false;b=b.substring(b.indexOf('<div id="app'+APPID+'_globalContainer"'),b.indexOf('<div class="UIStandardFrame_SidebarAds"'));$("#app"+APPID+
"_AjaxLoadIcon").css("display","none");$("#app"+APPID+"_globalContainer").empty().append(b)}else{debug("Page not loaded correctly, reloading.");Page.ajaxload()}}});this.loading=true;setTimeout(function(){Page.loading&&$("#app"+APPID+"_AjaxLoadIcon").css("display","block")},1500)};Page.reload=function(){debug("Page.reload()");window.location.href=window.location.href};
Page.click=function(b){if(!$(b).length){debug("Page.click: Unable to find element - "+b);return false}var c=document.createEvent("MouseEvents");c.initEvent("click",true,true);$(b).get(0).wrappedJSObject.dispatchEvent(c);this.clear();this.lastclick=b;this.when=Date.now();return true};Page.clear=function(){this.last=this.lastclick=this.when=null;this.retry=0};var Queue=new Worker("Queue","*");Queue.data=null;Queue.settings={system:true,unsortable:true,keep:true};Queue.runtime={reminder:{},current:null};
Queue.option={delay:5,clickdelay:5,queue:["Page","Queue","Settings","Title","Income","LevelUp","Elite","Quest","Monster","Battle","Heal","Land","Town","Bank","Alchemy","Blessing","Gift","Upgrade","Potions","Idle"],start_stamina:0,stamina:0,start_energy:0,energy:0};
Queue.display=[{label:"Drag the unlocked panels into the order you wish them run."},{id:"delay",label:"Delay Between Events",text:true,after:"secs",size:3},{id:"clickdelay",label:"Delay After Mouse Click",text:true,after:"secs",size:3,help:"This should be a multiple of Event Delay"},{id:"start_stamina",before:"Save",select:"stamina",after:"Stamina Before Using"},{id:"stamina",before:"Always Keep",select:"stamina",after:"Stamina"},{id:"start_energy",before:"Save",select:"energy",after:"Energy Before Using"},
{id:"energy",before:"Always Keep",select:"energy",after:"Energy"}];Queue.runfirst=[];Queue.lastclick=Date.now();Queue.lastrun=Date.now();Queue.burn={stamina:false,energy:false};Queue.timer=null;Queue.lasttimer=0;Queue.lastpause=false;
Queue.init=function(){var b,c;this.option.queue=unique(this.option.queue);for(b in Workers)if(Workers[b].work&&Workers[b].display&&!findInArray(this.option.queue,Workers[b].name)){log("Adding "+Workers[b].name+" to Queue");Workers[b].settings.unsortable?this.option.queue.unshift(Workers[b].name):this.option.queue.push(Workers[b].name)}for(b=0;b<this.option.queue.length;b++)if((c=WorkerByName(this.option.queue[b]))&&c.id){if(this.runtime.current&&c.name===this.runtime.current){debug("Queue: Trigger "+
c.name+" (continue after load)");$("#"+c.id+" > h3").css("font-weight","bold")}$("#golem_config").append($("#"+c.id))}$(document).click(function(){Queue.lastclick=Date.now()});Queue.lastpause=this.option.pause;$btn=$('<img class="golem-button'+(this.option.pause?" red":"")+'" id="golem_pause" src="'+(this.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82")+'">').click(function(){Queue.option.pause^=true;debug("State: "+(Queue.option.pause?"paused":"running"));$(this).toggleClass("red").attr("src",Queue.option.pause?"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%0FPLTE%A7%A7%A7%C8%C8%C8YYY%40%40%40%00%00%00%9F0%E7%C0%00%00%00%05tRNS%FF%FF%FF%FF%00%FB%B6%0ES%00%00%00%2BIDATx%DAb%60A%03%0CT%13%60fbD%13%60%86%0B%C1%05%60BH%02%CC%CC%0CxU%A0%99%81n%0BeN%07%080%00%03%EF%03%C6%E9%D4%E3)%00%00%00%00IEND%AEB%60%82":
"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%40%40%40%00%00%00i%D8%B3%D7%00%00%00%02tRNS%FF%00%E5%B70J%00%00%00%1AIDATx%DAb%60D%03%0CT%13%60%60%80%60%3A%0BP%E6t%80%00%03%00%7B%1E%00%E5E%89X%9D%00%00%00%00IEND%AEB%60%82");Page.clear();Config.updateOptions()});$("#golem_buttons").prepend($btn)};
Queue.update=function(){if(!this.option.pause&&this.option.delay!==this.lasttimer){window.clearInterval(this.timer);this.timer=window.setInterval(function(){Queue.run()},this.option.delay*1E3);this.lasttimer=this.option.delay}else if(this.option.pause&&this.option.pause!==this.lastpause){window.clearInterval(this.timer);this.lasttimer=-1}this.lastpause=this.option.pause};
Queue.run=function(){var b,c,d=false,e;b=Date.now();if(!(this.option.pause||b-this.lastclick<this.option.clickdelay*1E3))if(!Page.loading){this.burn.stamina=this.burn.energy=0;if(this.option.burn_stamina||Player.get("stamina")>=this.option.start_stamina){this.burn.stamina=Math.max(0,Player.get("stamina")-this.option.stamina);this.option.burn_stamina=this.burn.stamina>0}if(this.option.burn_energy||Player.get("energy")>=this.option.start_energy){this.burn.energy=Math.max(0,Player.get("energy")-this.option.energy);
this.option.burn_energy=this.burn.energy>0}if(Player.get("energy")>=Player.get("maxenergy")){this.burn.stamina=0;debug("Queue: At max energy, burning energy first.")}else if(Player.get("stamina")>=Player.get("maxstamina")){this.burn.energy=0;debug("Queue: At max stamina, burning stamina first.")}for(b=0;b<Workers.length;b++)if(Workers[b].work&&!Workers[b].display){Workers[b]._unflush();Workers[b]._work(false)}for(b=0;b<this.option.queue.length;b++){c=WorkerByName(this.option.queue[b]);if(!(!c||!c.work||
!c.display)){if(this.runtime.current===c.name){c._unflush();e=c._work(true)}else e=c._work(false);if(!e&&this.runtime.current===c.name){this.runtime.current=null;c.id&&$("#"+c.id+" > h3").css("font-weight","normal");debug("Queue: End "+c.name)}if(!(!e||d)){d=true;if(this.runtime.current!==c.name){if(this.runtime.current){debug("Queue: Interrupt "+this.runtime.current);WorkerByName(this.runtime.current).id&&$("#"+WorkerByName(this.runtime.current).id+" > h3").css("font-weight","normal")}this.runtime.current=
c.name;c.id&&$("#"+c.id+" > h3").css("font-weight","bold");debug("Queue: Trigger "+c.name)}}}}for(b=0;b<Workers.length;b++)Workers[b]._flush()}};var Settings=new Worker("Settings");Settings._rootpath=false;Settings.settings={system:true,unsortable:true,advanced:true};Settings.option={action:"None",which:"- default -",name:"- default -",confirm:false};
Settings.display=[{title:"IMPORTANT!",label:"This will backup and restore your current options.<br>There is no confirmation dialog!"},{id:"action",label:"Action (<b>Immediate!!</b>)",select:["None","Load","Save","Delete"]},{id:"which",label:"Which",select:"settings"},{id:"name",label:"New Name",text:true}];Settings.oldwhich=null;Settings.init=function(){this.data["- default -"]||this.set("- default -");Settings.oldwhich=this.option.which};
Settings.update=function(b){if(b==="option"){var c;b=[];if(this.oldwhich!==this.option.which){$("#"+PREFIX+worker.name.toLowerCase().replace(/[^0-9a-z]/g,"-")+"_name").val(this.option.which);this.oldwhich=this.option.name=this.option.which}switch(this.option.action){default:case "None":break;case "Load":debug("Settings: Loading "+this.option.which);this.get(this.option.which);break;case "Save":debug("Settings: Saving "+this.option.name);this.set(this.option.name);this.option.which=this.option.name;
break;case "Delete":this.option.which!=="- default -"&&delete this.data[this.option.which];this.option.which="- default -";this.option.name="- default -";break}$("#"+PREFIX+worker.name.toLowerCase().replace(/[^0-9a-z]/g,"-")+"_action").val("None");this.option.action="None";for(c in this.data)b.push(c);Config.set("settings",b.sort())}};
Settings.set=function(b,c){var d=typeof b==="string"?b.split("."):typeof b==="object"?b:[];if(d.length&&(d[0]==="option"||d[0]==="runtime"))return this._set(b,c);this._unflush();this.data[b]={};for(var e in Workers)if(Workers[e]!==this&&Workers[e].option)this.data[b][Workers[e].name]=$.extend(true,{},Workers[e].option)};
Settings.get=function(b){var c=typeof b==="string"?b.split("."):typeof b==="object"?b:[];if(c.length&&(c[0]==="option"||c[0]==="runtime"))return this._get(b);this._unflush();if(this.data[b]){for(var d in Workers)if(Workers[d]!==this&&Workers[d].option&&this.data[b][Workers[d].name]){Workers[d].option=$.extend(true,{},this.data[b][Workers[d].name]);Workers[d]._save("option")}Page.reload()}};var Update=new Worker("Update");Update.data=null;Update.option=null;Update.settings={system:true};
Update.runtime={lastcheck:0,force:false,found:false};
Update.init=function(){var b=$('<img class="golem-button" name="Script Update" id="golem_update" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C7%C7%C7UUU%7B%7B%7B%BF%BF%BF%A6%A6%A6%FF%FF%FF%40%40%40%FF%FF%FFk5%D0%FB%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00UIDATx%DAt%8F%5B%12%800%08%03%23%8Fx%FF%1B%5B%C0%96%EA%E8~%95%9D%C0%A48_%E0S%A8p%20%3A%85%F1%C6Jh%3C%DD%FD%205E%E4%3D%18%5B)*%9E%82-%24W6Q%F3Cp%09%E1%A2%8E%A2%13%E8b)lVGU%C7%FF%E7v.%01%06%005%D6%06%07%F9%3B(%D0%00%00%00%00IEND%AEB%60%82">').click(function(){if(Update.get("runtime.found"))window.location.href="http://userscripts.org/scripts/source/67412.user.js";
else{Update.set("runtime.force",true);Update.set("runtime.lastcheck",0)}});$("#golem_buttons").append(b);b=$('<img class="golem-button golem-advanced"'+(Config.get("option.advanced")?"":' style="display:none;"')+' name="Beta Update" src="data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%06PLTE%FF%FF%FFiii%92%95*%C3%00%00%00%01tRNS%00%40%E6%D8f%00%00%00%2FIDATx%DAb%60%C0%00%8CP%8CO%80%91%90%00%08%80H%14%25h%C60%10%2B%80l%0E%98%C3%88%AE%0ES%80%91%91T%8B%C0%00%20%C0%00%17G%00(%A6%C6G%AA%00%00%00%00IEND%AEB%60%82">').click(function(){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>This will update to the latest Work-In-Progress version of Castle Age Golem.<br><br>Are you sure you wish to run a potentially buggy update?<br><br>You must reload the page after installing to use the new version.</div>');
$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close").remove();window.location.href="http://game-golem.googlecode.com/svn/trunk/_normal.user.js"},Skip:function(){$(this).dialog("close").remove()}}})});$("#golem_buttons").append(b)};
Update.work=function(){if(!this.runtime.found&&Date.now()-this.runtime.lastcheck>216E5){this.runtime.lastcheck=Date.now();GM_xmlhttpRequest({method:"GET",url:"http://game-golem.googlecode.com/svn/trunk/_normal.user.js",onload:function(b){if(b.readyState===4&&b.status===200){b=b.responseText.regex(/@version[^0-9.]+([0-9.]+)/i);Update.get("runtime.force")&&$("#golem_request").remove();if(b>VERSION){Update.set("runtime.found",true);$("#golem_update").attr("src","data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%10%00%00%00%10%08%03%00%00%00(-%0FS%00%00%00%18PLTE%C8%C8%C8%C1%C1%C1%BA%BA%BA%F1%F1%F1ggg%FF%FF%FF%40%40%40%FF%FF%FF%7D%5C%EC%14%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00OIDATx%DA%8C%8FA%0A%C0%20%0C%04W%8D%EB%FF%7F%AC1%5BQi%A1s%0A%C3%24%10%B4%0B%7C%89%9COa%A4%ED%22q%906a%2CE%09%14%D4%AA%04%BA0%8AH%5C%80%02%12%3E%FB%0A%19b%06%BE2%13D%F0%F0.~%3E%B7%E8%02%0C%00Z%03%06Q9dE%25%00%00%00%00IEND%AEB%60%82").toggleClass("golem-button golem-button-active");
if(Update.get("runtime.force")){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There is a new version of Castle Age Golem available.</p><p>Current&nbsp;version:&nbsp;'+VERSION+", New&nbsp;version:&nbsp;"+b+"</p></div>");$("#golem_request").dialog({modal:true,buttons:{Install:function(){$(this).dialog("close");window.location.href="http://userscripts.org/scripts/source/67412.user.js"},Skip:function(){$(this).dialog("close")}}})}log("New version available: "+b)}else if(Update.get("runtime.force")){$("#golem_config").after('<div id="golem_request" title="Castle Age Golem"><p>There are no new versions available.</p></div>');
$("#golem_request").dialog({modal:true,buttons:{Ok:function(){$(this).dialog("close")}}})}Update.set("runtime.force",false)}}})}};var Alchemy=new Worker("Alchemy");Alchemy.defaults={castle_age:{pages:"keep_alchemy"}};Alchemy.data={ingredients:{},summons:{},recipe:{}};Alchemy.option={perform:true,hearts:false,summon:false};Alchemy.runtime={best:null};
Alchemy.display=[{id:"perform",label:"Automatically Perform",checkbox:true},{id:"hearts",label:"Use Battle Hearts",checkbox:true},{id:"summon",label:"Use Summon Ingredients",checkbox:true}];
Alchemy.parse=function(){var b=this.data.ingredients={},c=this.data.recipe={};$("div.ingredientUnit").each(function(d,e){d=$("img",e).attr("src").filepart();b[d]=$(e).text().regex(/x([0-9]+)/)});$("div.alchemyQuestBack,div.alchemyRecipeBack,div.alchemyRecipeBackMonster").each(function(d,e){var f={};d=$("div.recipeTitle",e).text().trim().replace("RECIPES: ","");if(d.indexOf(" (")>0)d=d.substr(0,d.indexOf(" ("));if($(e).hasClass("alchemyQuestBack"))f.type="Quest";else if($(e).hasClass("alchemyRecipeBack"))f.type=
"Recipe";else if($(e).hasClass("alchemyRecipeBackMonster"))f.type="Summons";f.ingredients={};$("div.recipeImgContainer",e).parent().each(function(g,h){g=$("img",h).attr("src").filepart();f.ingredients[g]=$(h).text().regex(/x([0-9]+)/)||1});c[d]=f})};
Alchemy.update=function(){var b=null,c=this.data.recipe,d,e;for(d in c)if(c[d].type==="Summons")for(e in c[d].ingredients)this.data.summons[e]=true;for(d in c)if(c[d].type==="Recipe"){b=d;for(e in c[d].ingredients)if(!this.option.hearts&&e==="raid_hearts.gif"||!this.option.summon&&this.data.summons[e]||c[d].ingredients[e]>(this.data.ingredients[e]||0)){b=null;break}if(b)break}this.runtime.best=b};
Alchemy.work=function(b){if(!this.option.perform||!this.runtime.best)return false;if(!b||!Page.to("keep_alchemy"))return true;debug("Alchemy: Perform - "+this.runtime.best);Page.click($('input[type="image"]',$('div.recipeTitle:contains("'+this.runtime.best+'")').next()))||Page.reload();return true};var Bank=new Worker("Bank");Bank.data=null;Bank.settings={after:["Land","Town"]};Bank.defaults={castle_age:{}};Bank.option={general:true,above:1E4,hand:0,keep:1E4};
Bank.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"above",label:"Bank Above",text:true},{id:"hand",label:"Keep in Cash",text:true},{id:"keep",label:"Keep in Bank",text:true}];Bank.work=function(b){if(Player.get("cash")<=10||Player.get("cash")<this.option.above&&(!Queue.get("runtime.current")||!WorkerByName(Queue.get("runtime.current")).settings.bank))return false;if(!b||!this.stash(Player.get("cash")-Math.min(this.option.above,this.option.hand)))return true;return false};
Bank.stash=function(b){if(!b||!Player.get("cash")||Math.min(Player.get("cash"),b)<=10)return true;if(this.option.general&&!Generals.to("bank")||!Page.to("keep_stats"))return false;$('input[name="stash_gold"]').val(Math.min(Player.get("cash"),b));Page.click('input[value="Stash"]');return true};
Bank.retrieve=function(b){WorkerByName(Queue.get("runtime.current")).settings.bank=true;b-=Player.get("cash");if(b<=0||Player.get("bank")-this.option.keep<b)return true;if(!Page.to("keep_stats"))return false;$('input[name="get_gold"]').val(b.toString());Page.click('input[value="Retrieve"]');return false};Bank.worth=function(b){var c=Player.get("cash")+Math.max(0,Player.get("bank")-this.option.keep);if(typeof b==="number")return b<=c;return c};var Battle=new Worker("Battle");Battle.defaults={castle_age:{pages:"battle_rank battle_battle"}};
Battle.data={user:{},rank:{},points:{}};Battle.option={general:true,points:true,monster:true,arena:false,losses:5,type:"Invade",bp:"Always",army:1.1,level:1.1,preferonly:"Sometimes",prefer:[]};Battle.runtime={attacking:null};
Battle.symbol={1:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%17%90%B3%1AIn%99%AD%B0%3F%5Erj%7F%8A4%40J%22*1%FF%FF%FFm%0F%82%CD%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%ABIDATx%DAl%91%0B%0E%04!%08CAh%E7%FE7%DE%02%BA3%FBib%A2O%A8%02vm%91%00xN%B6%A1%10%EB%86O%0C%22r%AD%0Cmn%0C%8A%8Drxa%60-%B3p%AF%8C%05%0C%06%15d%E6-%5D%90%8D%E5%90~%B0x%A20e%117%0E%D9P%18%A1%60w%F3%B0%1D%1E%18%1C%85m'D%B9%08%E7%C6%FE%0F%B7%CF%13%C77%1Eo%F4%93%05%AA%24%3D%D9%3F%E1%DB%25%8E%07%BB%CA%D8%9C%8E%FE6%A6J%B9%1F%FB%DAa%8A%BFNW3%B5%9ANc%D5%FEn%9El%F7%20%F6tt%8C%12%F01%B4%CE%F8%9D%E5%B7%5E%02%0C%00n%97%07%B1AU%81%B7%00%00%00%00IEND%AEB%60%82",2:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%E0%0D%0CZ%5B%5Bv%13%0F%2F%1A%16%7Byx%8941DB%3F%FF%FF%FFOmpc%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B4IDATx%DAT%D1%5B%12%C5%20%08%03P%08%C2%DD%FF%8Eo%12%EB%D8%F2%D1%C7%C1%01%C5%F8%3DQ%05T%9D%BFxP%C6%07%EA%CDF%07p%998%B9%14%C3%C4aj%AE%9CI%A5%B6%875zFL%0F%C8%CD%19vrG%AC%CD%5C%BC%C6nM%D57'%EB%CA%AD%EC%C2%E5b%B5%93%5B%E9%97%99%40D%CC%97sw%DB%FByqwF%83u%FA%F2%C8%A3%93u%A0%FD%8C%B8%BA%96NAn%90%17%C1%C7%E1'%D7%F2%85%01%D4%DC%A7d%16%EDM2%1A%C3%C5%1E%15%7DX%C7%23%19%EB%1El%F5h%B2lV%5B%CF%ED%A0w%89~%AE'%CE%ED%01%F7%CA%5E%FC%8D%BF%00%03%00%AA%CE%08%23%FB4h%C4%00%00%00%00IEND%AEB%60%82",
3:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%B1%98g%DE%BCyqpq%8CnF%12%11%0EME7y8%0B%FF%FF%FF6%A1%E73%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B7IDATx%DA%5C%91Y%16C!%0CB%C9%40%BA%FF%1D%17%7Cz%9Em%BE%F4%8A%19%08%3E%3BX%40%F1%DC%B0%A1%99_xcT%EF(%BC8%D8%CC%9A%A9%D4!%0E%0E%8Bf%863%FE%16%0F%06%5BR%22%02%1C%A0%89%07w%E6T%AC%A8A%F6%C2%251_%9CPG%C2%A1r7N%CB%E1%1CtN%E7%06%86%7F%B85%8B%1A%22%2F%AC%3E%D4%B2_.%9C%C6%EA%B3%E2%C6%BB%24%CA%25uY%98%D5H%0D%EE%922%40b%19%09%CFNs%99%C8Y%E2XS%D2%F3*%0F7%B5%B9%B6%AA%16_%0E%9A%D61V%DCu-%E5%A2g%3BnO%C1%B3%1E%9C%EDiax%94%3F%F87%BE%02%0C%00%98%F2%07%E0%CE%8C%E4%B1%00%00%00%00IEND%AEB%60%82",
4:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%90%CA%3CSTRq%9B5On*%10%13%0Dx%7Ct6B'%FF%FF%FFx%0A%94%CE%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%B2IDATx%DAT%D1A%16%C4%20%08%03P%20%92%B9%FF%8D'%80%B5%96%85%AF~%95*%D8o%07%09%90%CF%CC6%96%F5%CA%CD%E0%DAA%BC%0CM%B3C%CBxX%9A%E9%15Z%18%B7QW%E2%DB%9B%3D%E0%CD%99%11%18V%3AM%02%CD%FA%08.%8A%B5%D95%B1%A0%A7%E9Ci%D0%9Cb3%034D%F8%CB(%EE%F8%F0%F1%FA%C5ae9%BB%FD%B0%A7%CF%F9%1Au%9FfR%DB%A3%A19%179%CFa%B1%8E%EB*%91%BE_%B9*M%A9S%B7%97%AE)%15%B5%3F%BAX%A9%0Aw%C9m%9A%A0%CA%AA%20%5Eu%E5%D5%1DL%23%D4%9Eu7%AD%DBvZv%F17%FE%02%0C%00%D3%0A%07%E1%0961%CF%00%00%00%00IEND%AEB%60%82",
5:"data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%00%16%00%00%00%16%08%03%00%00%00%F3j%9C%09%00%00%00%18PLTE%F2%F2%EF!!%20%A5%A5%A3vvv%5BZZ%3D%3D%3B%00%00%00%FF%FF%FF.%C4%F9%B3%00%00%00%08tRNS%FF%FF%FF%FF%FF%FF%FF%00%DE%83%BDY%00%00%00%BEIDATx%DA%5C%91Q%92%C30%08C%11B%DE%FB%DFx%25%C7n3%E5%23%E3%3Cd%01%A6%FEN%00%12p%FF%EA%40%A3%05%A7%F0%C6%C2%0A%CCW_%AC%B5%C4%1D9%5D%EC39%09'%B0y%A5%D8%E2H%5D%D53%DDH%E1%E05%A6%9A2'%9Bkcw%40%E9%C5e%5Ev%B6g%E4%B1)%DA%DF%EEQ%D3%A0%25Vw%EC%B9%D5)%C8%5Cob%9C%1E%E2%E2%D8%16%F1%94%F8%E0-%AF%B9%F8x%CB%F2%FE%C8g%1Eo%A03w%CA%86%13%DB%C4%1D%CA%7C%B7%E8w%E4d%FAL%E9%CE%9B%F3%F0%D0g%F8%F0%AD%CFSyD%DC%875%87%3B%B0%D1%5D%C4%D9N%5C%13%3A%EB%A9%F7.%F5%BB%CB%DF%F8%17%60%00%EF%2F%081%0F%2BNZ%00%00%00%00IEND%AEB%60%82"};
Battle.demi={1:"Ambrosia",2:"Malekus",3:"Corvintheus",4:"Aurora",5:"Azeron"};
Battle.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"type",label:"Battle Type",select:["Invade","Duel"]},{id:"losses",label:"Attack Until",select:["Ignore",1,2,3,4,5,6,7,8,9,10],after:"Losses"},{id:"points",label:"Always Get Demi-Points",checkbox:true},{advanced:true,id:"monster",label:"Fight Monsters First",checkbox:true},{id:"bp",label:"Get Battle Points<br>(Clears Cache)",select:["Always","Never","Don't Care"]},{advanced:true,id:"cache",label:"Limit Cache Length",select:[100,
200,300,400,500]},{id:"army",label:"Target Army Ratio<br>(Only needed for Invade)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for smaller target army. Reduce this number if you're losing in Invade"},{id:"level",label:"Target Level Ratio<br>(Mainly used for Duel)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for lower target level. Reduce this number if you're losing a lot"},{advanced:true,hr:true,title:"Preferred Targets"},{advanced:true,
id:"preferonly",label:"Fight Preferred",select:["Never","Sometimes","Only","Until Dead"]},{advanced:true,id:"prefer",multiple:"userid"}];Battle.init=function(){this._watch(Monster);this.option.arena=false};
Battle.parse=function(){var b,c;if(Page.page==="battle_rank"){b={0:{name:"Newbie",points:0}};$('tr[height="23"]').each(function(d,e){d=$(e).text().regex(/Rank ([0-9]+) - (.*)\s*([0-9]+)/i);b[d[0]]={name:d[1],points:d[2]}});this.data.rank=b;this.data.bp=$('span:contains("Battle Points.")','div:contains("You are a Rank")').text().replace(/,/g,"").regex(/with ([0-9]+) Battle Points/i)}else if(Page.page==="battle_battle"){b=this.data.user;if(this.runtime.attacking){c=this.runtime.attacking;this.runtime.attacking=
null;if($("div.results").text().match(/You cannot battle someone in your army/i))delete b[c];else if($("div.results").text().match(/This trainee is too weak. Challenge someone closer to your level/i))delete b[c];else if($("div.results").text().match(/Your opponent is dead or too weak/i)){b[c].hide=(b[c].hide||0)+1;b[c].dead=Date.now()}else if($('img[src*="battle_victory"]').length){b[c].win=(b[c].win||0)+1;History.add("battle+win",1)}else if($('img[src*="battle_defeat"]').length){b[c].loss=(b[c].loss||
0)+1;History.add("battle+loss",-1)}else this.runtime.attacking=c}if(c=$("#app"+APPID+'_app_body table.layout table div div:contains("Once a day you can")').text().replace(/[^0-9\/]/g,"").regex(/([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10([0-9]+)\/10/))this.data.points=c;$("#app"+APPID+"_app_body table.layout table table tr:even").each(function(d,e){d=$('img[uid!==""]',e).attr("uid");var f=$("td.bluelink",e).text().trim().regex(/Level ([0-9]+) (.*)/i),g;if(d&&f){g=Battle.rank(f[1]);if(!(Battle.option.bp===
"Always"&&Player.get("rank")-g>5||!Battle.option.bp==="Never"&&Player.get("rank")-g<=5)){b[d]||(b[d]={});b[d].name=$("a",e).text().trim();b[d].level=f[0];b[d].rank=g;b[d].army=$("td.bluelink",e).next().text().regex(/([0-9]+)/);b[d].align=$('img[src*="graphics/symbol_"]',e).attr("src").regex(/symbol_([0-9])/i)}}})}return false};
Battle.update=function(){var b,c,d=this.data.user,e=[],f=false,g=[],h=Player.get("army"),k=Player.get("level"),l=Player.get("rank"),n=0;g.push("Rank "+Player.get("rank")+" "+this.data.rank[Player.get("rank")].name+" with "+addCommas(this.data.bp||0)+" Battle Points, Targets: "+length(d)+" / "+this.option.cache);g.push('Demi Points Earned Today: <img src="'+this.symbol[1]+'" alt=" " title="'+this.demi[1]+'" style="width:11px;height:11px;"> '+(this.data.points[0]||0)+'/10 <img src="'+this.symbol[2]+
'" alt=" " title="'+this.demi[2]+'" style="width:11px;height:11px;"> '+(this.data.points[1]||0)+'/10 <img src="'+this.symbol[3]+'" alt=" " title="'+this.demi[3]+'" style="width:11px;height:11px;"> '+(this.data.points[2]||0)+'/10 <img src="'+this.symbol[4]+'" alt=" " title="'+this.demi[4]+'" style="width:11px;height:11px;"> '+(this.data.points[3]||0)+'/10 <img src="'+this.symbol[5]+'" alt=" " title="'+this.demi[5]+'" style="width:11px;height:11px;"> '+(this.data.points[4]||0)+"/10");for(b in d)if(this.option.bp===
"Always"&&l-(d[b].rank||0)>=4||!this.option.bp==="Never"&&l-(d[b].rank||6)<=5)delete d[b];if(length(this.data.user)>this.option.cache){e=[];for(b in d)e.push(b);for(e.sort(function(o,p){var m=0;if((d[o].win||0)-(d[o].loss||0)<(d[p].win||0)-(d[p].loss||0))m+=10;else if((d[o].win||0)-(d[o].loss||0)>(d[p].win||0)-(d[p].loss||0))m-=10;if(Battle.option.bp==="Always")m+=((d[p].rank||0)-(d[o].rank||0))/2;if(Battle.option.bp==="Never")m+=((d[o].rank||0)-(d[p].rank||0))/2;m+=Math.range(-1,(d[p].hide||0)-(d[o].hide||
0),1);m+=Math.range(-10,((d[o].army||0)-(d[p].army||0))/10,10);m+=Math.range(-10,((d[o].level||0)-(d[p].level||0))/10,10);return m});e.length>this.option.cache;)delete d[e.pop()]}f=this.option.points&&this.data.points&&sum(this.data.points)<50;if(!f&&this.option.monster&&Monster.get("runtime.uid")&&Monster.get("runtime.type")){this.runtime.attacking=null;g.push("Attacking Monsters")}else{if(!this.runtime.attacking||!d[this.runtime.attacking]||this.option.army!=="Any"&&d[this.runtime.attacking].army/
h>this.option.army||this.option.level!=="Any"&&d[this.runtime.attacking].level/k>this.option.level)this.runtime.attacking=null;e=[];for(c=0;c<this.option.prefer.length;c++){b=this.option.prefer[c];if(!/[^0-9]/g.test(b)){d[b]=d[b]||{};if(!(d[b].dead&&d[b].dead+3E5>=Date.now()||typeof this.option.losses==="number"&&(d[b].loss||0)-(d[b].win||0)>=this.option.losses||f&&(!d[b].align||this.data.points[d[b].align-1]>=10))){e.push(b,b,b,b,b,b,b,b,b,b);n++}}}if(this.option.preferonly==="Never"||this.option.preferonly===
"Sometimes"||this.option.preferonly==="Only"&&!this.option.prefer.length||this.option.preferonly==="Until Dead"&&!e.length)for(b in d)if(!(d[b].dead&&d[b].dead+18E5>=Date.now()||typeof this.option.losses==="number"&&(d[b].loss||0)-(d[b].win||0)>=this.option.losses||this.option.army!=="Any"&&(d[b].army||0)/h>this.option.army||this.option.level!=="Any"&&(d[b].level||0)/k>this.option.level||f&&(!d[b].align||this.data.points[d[b].align-1]>=10))){for(c=Math.range(1,(d[b].rank||0)-l+1,5);c>0;c--)e.push(b);
n++}if(!this.runtime.attacking&&e.length)this.runtime.attacking=e[Math.floor(Math.random()*e.length)];if(this.runtime.attacking){b=this.runtime.attacking;g.push("Next Target: "+d[b].name+" (Level "+d[b].level+" "+this.data.rank[d[b].rank].name+" with "+d[b].army+" army)"+(n?", "+n+" valid target"+plural(n):""))}else{this.runtime.attacking=null;g.push("No valid targets found");this._remind(60)}}Dashboard.status(this,g.join("<br>"))};
Battle.work=function(b){if(!this.runtime.attacking||Player.get("health")<13||Queue.burn.stamina<1)return false;if(!b||this.option.general&&!Generals.to(Generals.best(this.option.type))||!Page.to("battle_battle"))return true;b=$('form input[alt="'+this.option.type+'"]').first().parents("form");if(b.length){log("Battle: Attacking "+this.data.user[this.runtime.attacking].name+" ("+this.runtime.attacking+")");$('input[name="target_id"]',b).attr("value",this.runtime.attacking);Page.click($('input[type="image"]',
b))}else{debug("Battle: Unable to find attack buttons, forcing reload");Page.to("index")}return true};Battle.rank=function(b){for(var c in Battle.data.rank)if(Battle.data.rank[c].name===b)return parseInt(c,10);return 0};Battle.order=[];
Battle.dashboard=function(b,c){var d,e;e=[0,0,0,0,0,0];var f=[],g=[],h=["align","name","level","rank","army","win","loss","hide"],k=this.data.user,l=Player.get("army"),n=Player.get("level");for(d in k)e[k[d].align]++;if(typeof b==="undefined"){this.order=[];for(d in k)this.order.push(d)}if(typeof b==="undefined")b=this.runtime.sort||1;if(typeof c==="undefined")c=this.runtime.rev||false;this.runtime.sort=b;this.runtime.rev=c;typeof h[b]==="string"&&this.order.sort(function(o,p){o=k[o][h[b]]||0;p=k[p][h[b]]||
0;if(typeof o==="string"||typeof p==="string")return c?p>o:p<o;return c?o-p:p-o});f.push('<div style="text-align:center;"><strong>Rank:</strong> '+this.data.rank[Player.get("rank")].name+" ("+Player.get("rank")+"), <strong>Targets:</strong> "+length(k)+" / "+this.option.cache+", <strong>By Alignment:</strong>");for(d=1;d<6;d++)f.push(' <img src="'+this.symbol[d]+'" alt="'+this.demi[d]+'" title="'+this.demi[d]+'" style="width:11px;height:11px;"> '+e[d]);f.push("</div><hr>");th(g,"Align");th(g,"Name");
th(g,"Level");th(g,"Rank");th(g,"Army");th(g,"Wins");th(g,"Losses");th(g,"Hides");f.push('<table cellspacing="0" style="width:100%"><thead><tr>'+g.join("")+"</tr></thead><tbody>");for(e=0;e<this.order.length;e++){k=this.data.user[this.order[e]];g=[];td(g,'<img src="'+this.symbol[k.align]+'" alt="'+this.demi[k.align]+'">','title="'+this.demi[k.align]+'"');th(g,k.name,'title="'+d+'"');td(g,this.option.level!=="Any"&&k.level/n>this.option.level?"<i>"+k.level+"</i>":k.level);td(g,this.data.rank[k.rank]?
this.data.rank[k.rank].name:"");td(g,this.option.army!=="Any"&&k.army/l>this.option.army?"<i>"+k.army+"</i>":k.army);td(g,k.win||"");td(g,k.loss||"");td(g,k.hide||"");tr(f,g.join(""))}f.push("</tbody></table>");$("#golem-dashboard-Battle").html(f.join(""));$("#golem-dashboard-Battle tbody tr td:nth-child(2)").css("text-align","left");if(typeof b!=="undefined")$("#golem-dashboard-Battle thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Blessing=new Worker("Blessing");
Blessing.data=null;Blessing.defaults={castle_age:{pages:"oracle_demipower"}};Blessing.option={which:"Stamina"};Blessing.runtime={when:0};Blessing.which=["None","Energy","Attack","Defense","Health","Stamina"];Blessing.display=[{id:"which",label:"Which",select:Blessing.which}];
Blessing.parse=function(){var b=$("div.results"),c;if(b.length)if((c=b.text().regex(/Please come back in: ([0-9]+) hours and ([0-9]+) minutes/i))&&c.length)this.runtime.when=Date.now()+(c[0]*60+c[1]+1)*6E4;else if(b.text().match(/You have paid tribute to/i))this.runtime.when=Date.now()+8646E4;return false};
Blessing.work=function(b){if(!this.option.which||this.option.which==="None"||Date.now()<=this.runtime.when)return false;if(!b||!Page.to("oracle_demipower"))return true;Page.click("#app"+APPID+"_symbols_form_"+this.which.indexOf(this.option.which)+" input.imgButton");return true};var Elite=new Worker("Elite","keep_eliteguard army_viewarmy battle_arena");Elite.data={};Elite.defaults={castle_age:{pages:"keep_eliteguard army_viewarmy battle_arena"}};
Elite.option={elite:true,arena:false,every:24,prefer:[],armyperpage:25};Elite.runtime={armylastpage:1,armyextra:0,waitelite:0,nextelite:0,waitarena:0,nextarena:0};Elite.display=[{id:"elite",label:"Fill Elite Guard",checkbox:true},{id:"every",label:"Every",select:[1,2,3,6,12,24],after:"hours"},{advanced:true,label:"Add UserIDs to prefer them over random army members. These <b>must</b> be in your army to be checked.",id:"prefer",multiple:"userid"}];
Elite.init=function(){for(i in this.data)if(typeof this.data[i]==="number")this.data[i]={elite:this.data[i]};this.option.arena=false};
Elite.parse=function(){$("span.result_body").each(function(c,d){if(Elite.runtime.nextarena)if($(d).text().match(/has not joined in the Arena!/i))Elite.data[Elite.runtime.nextarena].arena=-1;else if($(d).text().match(/Arena Guard, and they have joined/i))Elite.data[Elite.runtime.nextarena].arena=Date.now()+864E5;else if($(d).text().match(/'s Arena Guard is FULL/i))Elite.data[Elite.runtime.nextarena].arena=Date.now()+36E5;else if($(d).text().match(/YOUR Arena Guard is FULL/i)){Elite.runtime.waitarena=
Date.now();debug("Arena guard full, wait "+Elite.option.every+" hours")}if($(d).text().match(/Elite Guard, and they have joined/i))Elite.data[$("img",d).attr("uid")].elite=Date.now()+864E5;else if($(d).text().match(/'s Elite Guard is FULL!/i))Elite.data[$("img",d).attr("uid")].elite=Date.now()+36E5;else if($(d).text().match(/YOUR Elite Guard is FULL!/i)){Elite.runtime.waitelite=Date.now();debug("Elite guard full, wait "+Elite.option.every+" hours")}});if(Page.page==="army_viewarmy"){var b=0;$('img[linked="true"][size="square"]').each(function(c,
d){c=$(d).attr("uid");d=$(d).parent().parent().next();b++;Elite.data[c]=Elite.data[c]||{};Elite.data[c].name=$("a",d).text();Elite.data[c].level=$(d).text().regex(/([0-9]+) Commander/i)});if(b<25)this.runtime.armyextra=Player.get("armymax")-length(this.data)-1}return false};
Elite.update=function(){var b,c,d=[],e=Date.now();for(c=this.runtime.nextelite=this.runtime.nextarena=0;c<this.option.prefer.length;c++){b=this.option.prefer[c];if(!/[^0-9]/g.test(b)&&this.data[b]){if(!this.runtime.nextelite&&(typeof this.data[b].elite!=="number"||this.data[b].elite<Date.now()))this.runtime.nextelite=b;if(!this.runtime.nextarena&&(typeof this.data[b].arena!=="number"||this.data[b].arena!==-1&&this.data[b].arena<Date.now()))this.runtime.nextarena=b}}for(b in this.data){if(!this.runtime.nextelite&&
(typeof this.data[b].elite!=="number"||this.data[b].elite<Date.now()))this.runtime.nextelite=b;if(!this.runtime.nextarena&&(typeof this.data[b].arena!=="number"||this.data[b].arena!==-1&&this.data[b].arena<Date.now()))this.runtime.nextarena=b}if(this.option.elite||this.option.arena){if(this.option.arena){b=this.runtime.waitarena+this.option.every*36E5;d.push("Arena Guard: Check"+(b<e?"ing now":' in <span class="golem-time" name="'+b+'">'+makeTimer((b-e)/1E3)+"</span>"))}if(this.option.elite){b=this.runtime.waitelite+
this.option.every*36E5;d.push("Elite Guard: Check"+(b<e?"ing now":' in <span class="golem-time" name="'+b+'">'+makeTimer((b-e)/1E3)+"</span>"))}Dashboard.status(this,d.join(", "))}else Dashboard.status(this)};
Elite.work=function(b){if(Math.ceil((Player.get("armymax")-this.runtime.armyextra-1)/this.option.armyperpage)>this.runtime.armylastpage){if(b){debug("Elite: Filling army list");this.runtime.armylastpage=Math.max(this.runtime.armylastpage+1,Math.ceil((length(this.data)+1)/this.option.armyperpage));Page.to("army_viewarmy","?page="+this.runtime.armylastpage)}return true}if((!this.option.elite||!this.runtime.nextelite||this.runtime.waitelite+this.option.every*36E5>Date.now())&&(!this.option.arena||!this.runtime.nextarena||
this.runtime.waitarena+this.option.every*36E5>Date.now()))return false;if(!b)return true;if(!this.runtime.nextelite&&!this.runtime.nextarena&&!length(this.data)&&!Page.to("army_viewarmy"))return true;if(this.runtime.waitelite+this.option.every*36E5<=Date.now()){debug("Elite: Add Elite Guard member "+this.runtime.nextelite);if(!Page.to("keep_eliteguard","?twt=jneg&jneg=true&user="+this.runtime.nextelite))return true}if(this.runtime.waitarena+this.option.every*36E5<=Date.now()){debug("Elite: Add Arena Guard member "+
this.runtime.nextarena);if(!Page.to("battle_arena","?user="+this.runtime.nextarena+"&lka="+this.runtime.nextarena+"&agtw=1&ref=nf"))return true}return false};var Generals=new Worker("Generals");Generals.option=null;Generals.data={};Generals.defaults={castle_age:{pages:"* heroes_generals"}};Generals.runtime={disabled:false};Generals.init=function(){for(var b in this.data)b.indexOf("\t")!==-1&&delete this.data[b];this._watch(Town)};
Generals.parse=function(){$("div.results").text().match(/has gained a level!/i)&&this.data[Player.get("general")].level++;if(Page.page==="heroes_generals"){var b=$(".generalSmallContainer2"),c=this.data;if(b.length<length(c)){debug("Generals: Different number of generals, have "+b.length+", want "+length(c));return false}b.each(function(d,e){d=$(".general_name_div3_padding",e).text().trim();var f=parseInt($(e).text().regex(/Level ([0-9]+)/i)),g=parseInt($("div.generals_indv_stats",e).next().children().children().children().next().attr("style").regex(/width: ([0-9]*\.*[0-9]*)%/i));
if(d&&d.indexOf("\t")===-1&&d.length<30)if(!c[d]||c[d].level!==f||c[d].progress!==g){c[d]=c[d]||{};c[d].img=$(".imgButton",e).attr("src").filepart();c[d].att=$(".generals_indv_stats_padding div:eq(0)",e).text().regex(/([0-9]+)/);c[d].def=$(".generals_indv_stats_padding div:eq(1)",e).text().regex(/([0-9]+)/);c[d].progress=g;c[d].level=f;c[d].skills=$("table div",e).html().replace(/\<[^>]*\>|\s+|\n/g," ").trim();f>=4&&c[d].priority&&delete c[d].priority}})}return false};
Generals.update=function(b){var c=this.data,d,e=[],f=[],g=Town.get("runtime.invade"),h=Town.get("runtime.duel"),k,l,n,o,p,m,q,s,r=k=l=0,t=function(u,v){u.push(v)};if(b==="data"){for(d in Generals.data)f.push(d);Config.set("generals",["any"].concat(f.sort()))}for(d in c)c[d].level<4&&e.push([d,c[d].priority]);e.sort(function(u,v){return u[1]-v[1]});for(d in e)c[e[d][0]].priority=parseInt(d)+1;this.runtime.max_priority=e.length;if((b==="data"||b===Town)&&g&&h)for(d in c){k=Math.floor(sum(c[d].skills.regex(/([-+]?[0-9]*\.?[0-9]*) Player Attack|Increase Player Attack by ([0-9]+)/i))+
(c[d].skills.regex(/Increase ([-+]?[0-9]*\.?[0-9]*) Player Attack for every Hero Owned/i)||0)*(length(c)-1));l=Math.floor(sum(c[d].skills.regex(/([-+]?[0-9]*\.?[0-9]*) Player Defense|Increase Player Defense by ([0-9]+)/i))+(c[d].skills.regex(/Increase ([-+]?[0-9]*\.?[0-9]*) Player Defense for every Hero Owned/i)||0)*(length(c)-1));b=Player.get("attack")+k;e=Player.get("defense")+l;f=Player.get("attack")+k*4/c[d].level;m=Player.get("defense")+l*4/c[d].level;n=c[d].skills.regex(/Increases? Army Limit to ([0-9]+)/i)||
501;o=getAttDef(c,t,"att",Math.floor(n/5));p=getAttDef(c,t,"def",Math.floor(n/5));l=c[d].skills.regex(/([-+]?[0-9]+) Attack when attacked/i)||0;k=c[d].skills.regex(/([-+]?[0-9]+) Defense when attacked/i)||0;q=l*4/c[d].level;s=k*4/c[d].level;r=c[d].skills.regex(/([-+]?[0-9]+) Monster attack/i)||0;c[d].invade={att:Math.floor(g.attack+c[d].att+c[d].def*0.7+(b+e*0.7)*n+o),def:Math.floor(g.defend+c[d].def+c[d].att*0.7+(e+k+(b+l)*0.7)*n+p)};c[d].duel={att:Math.floor(h.attack+c[d].att+c[d].def*0.7+b+e*0.7),
def:Math.floor(h.defend+c[d].def+c[d].att*0.7+e+k+(b+l)*0.7)};c[d].monster={att:Math.floor(h.attack+c[d].att+b+r),def:Math.floor(h.defend+c[d].def+e)};c[d].potential={bank:c[d].skills.regex(/Bank Fee/i)?1:0,defense:Math.floor(h.defend+(c[d].def+4-c[d].level)+(c[d].att+4-c[d].level)*0.7+m+s+(f+q)*0.7),income:c[d].skills.regex(/Increase Income by ([0-9]+)/i)*4/c[d].level,invade:Math.floor(g.attack+(c[d].att+4-c[d].level)+(c[d].def+4-c[d].level)*0.7+(f+m*0.7)*n+o),duel:Math.floor(h.attack+(c[d].att+
4-c[d].level)+(c[d].def+4-c[d].level)*0.7+f+m*0.7),monster:Math.floor(h.attack+(c[d].att+4-c[d].level)+f+r*4/c[d].level),raid_invade:0,raid_duel:0,influence:c[d].skills.regex(/Influence ([0-9]+)% Faster/i)||0,drops:c[d].skills.regex(/Chance ([0-9]+)% Drops/i)||0,demi:c[d].skills.regex(/Extra Demi Points/i)?1:0,cash:c[d].skills.regex(/Bonus ([0-9]+) Gold/i)||0};c[d].potential.raid_invade=c[d].potential.defense+c[d].potential.invade;c[d].potential.raid_duel=c[d].potential.defense+c[d].potential.duel}};
Generals.to=function(b){if(this.runtime.disabled)return true;this._unflush();if(b&&!this.data[b])b=this.best(b);if(!b||Player.get("general")===b||b==="any")return true;if(!b||!this.data[b]){log('General "'+b+'" requested but not found!');return true}if(!Page.to("heroes_generals"))return false;debug("Changing to General "+b);Page.click('input[src$="'+this.data[b].img+'"]');this.data[b].used=(this.data[b].used||0)+1;return false};
Generals.best=function(b){this._unflush();var c="",d=null,e=0,f;switch(b.toLowerCase()){case "cost":c=/Decrease Soldier Cost by ([0-9]+)/i;break;case "stamina":c=/Increase Max Stamina by ([0-9]+)|\+([0-9]+) Max Stamina/i;break;case "energy":c=/Increase Max Energy by ([0-9]+)|\+([0-9]+) Max Energy/i;break;case "income":c=/Increase Income by ([0-9]+)/i;break;case "item":c=/([0-9]+)% Drops for Quest/i;break;case "influence":c=/Bonus Influence ([0-9]+)/i;break;case "attack":c=/([-+]?[0-9]+) Player Attack/i;
break;case "defense":c=/([-+]?[0-9]+) Player Defense/i;break;case "cash":c=/Bonus ([0-9]+) Gold/i;break;case "bank":return"Aeris";case "invade":for(f in Generals.data)if(!d||Generals.data[f].invade&&Generals.data[f].invade.att>Generals.data[d].invade.att||Generals.data[f].invade&&Generals.data[f].invade.att===Generals.data[d].invade.att&&d!==Player.get("general"))d=f;return d||"any";case "duel":for(f in Generals.data)if(!d||Generals.data[f].duel&&Generals.data[f].duel.att>Generals.data[d].duel.att||
Generals.data[f].duel&&Generals.data[f].duel.att===Generals.data[d].duel.att&&d!==Player.get("general"))d=f;return d||"any";case "raid-invade":for(f in Generals.data)if(!d||Generals.data[f].invade&&Generals.data[f].invade.att>Generals.data[d].invade.att)d=f;return d||"any";case "raid-duel":for(f in Generals.data)if(!d||Generals.data[f].duel&&Generals.data[f].duel.att>Generals.data[d].duel.att)d=f;return d||"any";case "monster":for(f in Generals.data)if(!d||Generals.data[f].monster&&Generals.data[f].monster.att>
Generals.data[d].monster.att)d=f;return d||"any";case "dispel":case "fortify":for(f in Generals.data)if(!d||Generals.data[f].monster&&Generals.data[f].monster.def>Generals.data[d].monster.def)d=f;return d||"any";case "defend":for(f in Generals.data)if(!d||Generals.data[f].duel&&Generals.data[f].duel.def>Generals.data[d].duel.def||Generals.data[f].duel&&Generals.data[f].duel.def===Generals.data[d].duel.def&&d!==Player.get("general"))d=f;return d||"any";case "under level 4":for(f in Generals.data)if(Generals.data[f].priority==
1)return f;default:return"any"}for(f in Generals.data)if(b=Generals.data[f].skills.regex(c))if(!d||b>e){d=f;e=b}return d||"any"};Generals.order=[];
Generals.dashboard=function(b,c){var d,e,f=[],g=[],h=0,k=0,l=0,n=0,o=0,p=0;if(typeof b==="undefined"){Generals.order=[];for(d in Generals.data)Generals.order.push(d)}if(typeof b==="undefined")b=this.runtime.sort||1;if(typeof c==="undefined")c=this.runtime.rev||false;this.runtime.sort=b;this.runtime.rev=c;typeof b!=="undefined"&&Generals.order.sort(function(m,q){var s,r;if(b==1){m=m;q=q}else if(b==2){m=Generals.data[m].level||0;q=Generals.data[q].level||0}else if(b==3){m=Generals.data[m].priority||
999999;q=Generals.data[q].priority||999999}else{s=b<6?"invade":b<8?"duel":"monster";r=b%2?"def":"att";m=Generals.data[m][s][r]||0;q=Generals.data[q][s][r]||0}if(typeof m==="string"||typeof q==="string")return c?q>m:q<m;return c?m-q:q-m});for(d in Generals.data){h=Math.max(h,Generals.data[d].invade?Generals.data[d].invade.att:1);k=Math.max(k,Generals.data[d].invade?Generals.data[d].invade.def:1);l=Math.max(l,Generals.data[d].duel?Generals.data[d].duel.att:1);n=Math.max(n,Generals.data[d].duel?Generals.data[d].duel.def:
1);o=Math.max(o,Generals.data[d].monster?Generals.data[d].monster.att:1);p=Math.max(p,Generals.data[d].monster?Generals.data[d].monster.def:1)}g.push('<table cellspacing="0" style="width:100%"><thead><tr><th></th><th>General</th><th>Level</th><th>Quest<br>Rank</th><th>Invade<br>Attack</th><th>Invade<br>Defend</th><th>Duel<br>Attack</th><th>Duel<br>Defend</th><th>Monster<br>Attack</th><th>Fortify<br>Dispel</th></tr></thead><tbody>');for(e=0;e<Generals.order.length;e++){d=Generals.order[e];f=[];f.push('<img src="'+
imagepath+Generals.data[d].img+'" style="width:25px;height:25px;" title="'+Generals.data[d].skills+'">');f.push(d);f.push("<div"+(isNumber(Generals.data[d].progress)?' title="'+Generals.data[d].progress+'%"':"")+">"+Generals.data[d].level+'</div><div style="background-color: #9ba5b1; height: 2px; width=100%;"><div style="background-color: #1b3541; float: left; height: 2px; width: '+(Generals.data[d].progress||0)+'%;"></div></div>');f.push(Generals.data[d].priority?(Generals.data[d].priority!=1?'<a class="golem-moveup" name='+
Generals.data[d].priority+">&uarr</a> ":"&nbsp;&nbsp; ")+Generals.data[d].priority+(Generals.data[d].priority!=this.runtime.max_priority?' <a class="golem-movedown" name='+Generals.data[d].priority+">&darr</a>":" &nbsp;&nbsp;"):"");f.push(Generals.data[d].invade?(h==Generals.data[d].invade.att?"<strong>":"")+addCommas(Generals.data[d].invade.att)+(h==Generals.data[d].invade.att?"</strong>":""):"?");f.push(Generals.data[d].invade?(k==Generals.data[d].invade.def?"<strong>":"")+addCommas(Generals.data[d].invade.def)+
(k==Generals.data[d].invade.def?"</strong>":""):"?");f.push(Generals.data[d].duel?(l==Generals.data[d].duel.att?"<strong>":"")+addCommas(Generals.data[d].duel.att)+(l==Generals.data[d].duel.att?"</strong>":""):"?");f.push(Generals.data[d].duel?(n==Generals.data[d].duel.def?"<strong>":"")+addCommas(Generals.data[d].duel.def)+(n==Generals.data[d].duel.def?"</strong>":""):"?");f.push(Generals.data[d].monster?(o==Generals.data[d].monster.att?"<strong>":"")+addCommas(Generals.data[d].monster.att)+(o==
Generals.data[d].monster.att?"</strong>":""):"?");f.push(Generals.data[d].monster?(p==Generals.data[d].monster.def?"<strong>":"")+addCommas(Generals.data[d].monster.def)+(p==Generals.data[d].monster.def?"</strong>":""):"?");g.push("<tr><td>"+f.join("</td><td>")+"</td></tr>")}g.push("</tbody></table>");$("a.golem-moveup").live("click",function(){var m=null,q=null,s=parseInt($(this).attr("name"));Generals._unflush();for(var r in Generals.data){if(Generals.data[r].priority==s)q=r;if(Generals.data[r].priority==
s-1)m=r}if(m&&q){debug("Generals: Priority: Swapping "+q+" with "+m);Generals.data[m].priority++;Generals.data[q].priority--}Generals.dashboard(b,c);return false});$("a.golem-movedown").live("click",function(){var m=null,q=null,s=parseInt($(this).attr("name"));Generals._unflush();for(var r in Generals.data){if(Generals.data[r].priority==s)m=r;if(Generals.data[r].priority==s+1)q=r}if(m&&q){debug("Generals: Priority: Swapping "+q+" with "+m);Generals.data[m].priority++;Generals.data[q].priority--}Generals.dashboard(b,
c);return false});$("#golem-dashboard-Generals").html(g.join(""));$("#golem-dashboard-Generals tbody tr td:nth-child(2)").css("text-align","left");if(typeof b!=="undefined")$("#golem-dashboard-Generals thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Gift=new Worker("Gift");Gift.settings={keep:true};Gift.defaults={castle_age:{pages:"index army_invite army_gifts"}};Gift.data={received:[],todo:{},gifts:{}};Gift.option={type:"None"};
Gift.runtime={work:false,gift_waiting:false,gift_sent:0,sent_id:null,gift:{sender_id:null,sender_ca_name:null,sender_fb_name:null,name:null,id:null}};Gift.display=[{label:"Work in progress..."},{id:"type",label:"Return Gifts",select:["None","Random","Same as Received"]}];
Gift.init=function(){delete this.data.uid;delete this.data.lastgift;if(length(this.data.gifts)){var b=[];for(var c in this.data.gifts)b.push(c);for(var d in this.data.todo)if(!/[^0-9]/g.test(d)){c=Math.floor(Math.random()*b.length);this.data.todo[b[c]]||(this.data.todo[b[c]]=[]);this.data.todo[b[c]].push(d);delete this.data.todo[d]}}};
Gift.parse=function(b){if(b)return false;var c=this.data.gifts;b=this.data.todo;var d=this.data.received;if(Page.page==="index")if($("span.result_body").text().indexOf("has sent you a gift")>=0){this.runtime.gift.sender_ca_name=$("span.result_body").text().regex(/[\t\n]*(.+) has sent you a gift/i);this.runtime.gift.name=$("span.result_body").text().regex(/has sent you a gift:\s+(.+)!/i);this.runtime.gift.id=$("span.result_body img").attr("src").filepart();debug("Gift: "+this.runtime.gift.sender_ca_name+
" has a "+this.runtime.gift.name+" waiting for you. ("+this.runtime.gift.id+")");return this.runtime.gift_waiting=true}else{if($("span.result_body").text().indexOf("warrior wants to join your Army")>=0){this.runtime.gift.sender_ca_name="A Warrior";this.runtime.gift.name="Random Soldier";this.runtime.gift.id="random_soldier";debug("Gift: "+this.runtime.gift.sender_ca_name+" has a "+this.runtime.gift.name+" waiting for you.");return this.runtime.gift_waiting=true}}else if(Page.page==="army_invite"){if(this.runtime.sent_id&&
$("div.result").text().indexOf("request sent")>=0){debug("Gift: "+c[this.runtime.sent_id].name+" sent.");for(j=0;j<Math.min(b[this.runtime.sent_id].length,30);j++)b[this.runtime.sent_id].shift();b[this.runtime.sent_id].length||delete b[this.runtime.sent_id];this.runtime.sent_id=null;if(b.length==0)this.runtime.work=false}if(this.runtime.gift.sender_id)if($("div.result").text().indexOf("accepted the gift")>=0||$("div.result").text().indexOf("have been awarded the gift")>=0){debug("Gift: Accepted "+
this.runtime.gift.name+" from "+this.runtime.gift.sender_ca_name+"(id:"+this.runtime.gift.sender_id+")");d.push(this.runtime.gift);this.runtime.work=true;this.runtime.gift={}}if($("div.messages").text().indexOf("gift")>=0){this.runtime.gift_waiting=true;if(!this.runtime.gift.id)return false;this.runtime.gift.sender_id=$("div.messages img[uid]").first().attr("uid");if(this.runtime.gift.sender_id)this.runtime.gift.sender_fb_name=$("div.messages img[uid]").first().attr("title");else debug("Gift: Can't find the gift sender's ID.")}else this.runtime.gift_waiting=
false}else Page.page==="army_gifts"&&$('div[id*="_giftContainer"] div[id*="_gift"]').each(function(e,f){e=$("img",f).attr("src").filepart();var g=$(f).text().trim().replace("!","");f=$(f).attr("id").regex(/_gift([0-9]+)/);c[e]||(c[e]={});c[e].name=g;c[e].slot=f});return false};
Gift.work=function(b){if(length(e)&&this.runtime.gift_delay<Date.now())return this.runtime.work=true;if(!b){if(this.runtime.gift_waiting||this.runtime.work)return true;return false}if(!this.runtime.gift_waiting&&!this.runtime.work)return false;if(this.runtime.gift_waiting&&!this.runtime.gift.id)if(!Page.to("index"))return true;if(this.runtime.gift.id&&!this.runtime.gift.sender_id)if(!Page.to("army_invite"))return true;if(this.runtime.gift.sender_id){if(!Page.to("army_invite"))return true;if(!Page.to("army_invite",
"?act=acpt&rqtp=gift&uid="+this.runtime.gift.sender_id)||this.runtime.gift.sender_id.length>0)return true}var c,d,e=this.data.todo;b=this.data.received;var f=[],g;if(!b.length&&(!length(e)||this.runtime.gift_delay>Date.now())){this.runtime.work=false;Page.to("keep_alchemy");return false}if(b.length){Page.to("army_gifts");for(c in b){f=this.option.type;if(typeof this.data.gifts[b[c].id]==="undefined"&&this.option.type!="None"){debug("Gift: "+b[c].id+" was not found in our sendable gift list.");f="Random"}switch(f){case "Random":if(length(this.data.gifts)){f=
[];for(d in this.data.gifts)f.push(d);g=Math.floor(Math.random()*f.length);debug("Gift: will randomly send a "+this.data.gifts[f[g]].name+" to "+b[c].sender_ca_name);e[f[g]]||(e[f[g]]=[]);e[f[g]].push(b[c].sender_id)}this.runtime.work=true;break;case "Same as Received":debug("Gift: will return a "+b[c].name+" to "+b[c].sender_ca_name);e[b[c].id]||(e[b[c].id]=[]);e[b[c].id].push(b[c].sender_id);this.runtime.work=true;break;case "None":default:this.runtime.work=false;break}}for(c in b)b.shift()}if(this.runtime.gift_sent>
Date.now()){if($('div.dialog_buttons input[name="sendit"]').length){this.runtime.gift_sent=null;Page.click('div.dialog_buttons input[name="sendit"]')}else if($('span:contains("Out of requests")')){debug("Gift: We have run out of gifts to send.  Waiting one hour to retry.");this.runtime.gift_delay=Date.now()+36E5;Page.click('div.dialog_buttons input[value="Okay"]')}return true}else if(this.runtime.gift_sent)this.runtime.gift_sent=null;if(length(e)&&(!this.runtime.gift_delay||this.runtime.gift_delay<
Date.now()))for(c in e){if(!Page.to("army_gifts"))return true;if($('div[style*="giftpage_select"] div a[href*="giftSelection='+this.data.gifts[c].slot+'"]').length)if($('img[src*="giftpage_ca_friends_on"]').length){if($("div.unselected_list").children().length){debug("Gift: Sending out "+this.data.gifts[c].name);b=0;for(d in e[c])if(b<30)if($("div.unselected_list input[value='"+e[c][d]+"']").length){Page.click('div.unselected_list input[value="'+e[c][d]+'"]');b++}if(b==0){delete e[c];return true}this.runtime.sent_id=
c;this.runtime.gift_sent=Date.now()+6E4;Page.click('input[name="send"]')}}else $('div.tabBtn img.imgButton[src*="giftpage_ca_friends_off"]').length&&Page.click('div.tabBtn img.imgButton[src*="giftpage_ca_friends_off"]');else $('div[style*="giftpage_select"]').length&&Page.click('a[href*="giftSelection='+this.data.gifts[c].slot+'"]:parent');return true}return false};var Heal=new Worker("Heal");Heal.data=null;Heal.defaults={castle_age:{}};Heal.option={stamina:0,health:0};
Heal.display=[{id:"stamina",label:"Heal Above",after:"stamina",select:"stamina"},{id:"health",label:"...And Below",after:"health",select:"health"}];Heal.work=function(b){if(Player.get("health")>=Player.get("maxhealth")||Player.get("stamina")<Heal.option.stamina||Player.get("health")>=Heal.option.health)return false;if(!b)return true;return this.me()};
Heal.me=function(){if(!Page.to("keep_stats"))return true;debug("Heal: Healing...");$('input[value="Heal Wounds"]').length?Page.click('input[value="Heal Wounds"]'):log("Danger Danger Will Robinson... Unable to heal!");return false};var History=new Worker("History");History.option=null;History.defaults={castle_age:{init:function(){if(Player.data.history){this.data=Player.data.history;delete Player.data.history}}}};
History.dashboard=function(){var b=[];b.push('<table cellspacing="0" cellpadding="0" class="golem-graph"><thead><tr><th></th><th colspan="73"><span style="float:left;">&lArr; Older</span>72 Hour History<span style="float:right;">Newer &rArr;</span><th></th></th></tr></thead><tbody>');b.push(this.makeGraph(["land","income"],"Income",true,{"Average Income":this.get("land.mean")+this.get("income.mean")}));b.push(this.makeGraph("bank","Bank",true,Land.runtime.best?{"Next Land":Land.runtime.cost}:null));
b.push(this.makeGraph("exp","Experience",false,{"Next Level":Player.get("maxexp")}));b.push(this.makeGraph("exp.change","Exp Gain",false,{Average:this.get("exp.average.change"),"Standard Deviation":this.get("exp.stddev.change"),"Ignore entries above":this.get("exp.mean.change")+2*this.get("exp.stddev.change")}));b.push("</tbody></table>");$("#golem-dashboard-History").html(b.join(""))};History.update=function(){var b,c=Math.floor(Date.now()/36E5)-168;for(b in this.data)b<c&&delete this.data[b]};
History.set=function(b,c){if(c){this._unflush();var d=Math.floor(Date.now()/36E5);b=typeof b==="string"?b.split("."):typeof b==="object"?b:[];if(b.length&&(typeof b[0]==="number"||!b[0].regex(/[^0-9]/gi)))d=b.shift();this.data[d]=this.data[d]||{};this.data[d][b[0]]=c}};
History.add=function(b,c){if(c){this._unflush();var d=Math.floor(Date.now()/36E5);b=typeof b==="string"?b.split("."):typeof b==="object"?b:[];if(b.length&&(typeof b[0]==="number"||!b[0].regex(/[^0-9]/gi)))d=b.shift();this.data[d]=this.data[d]||{};this.data[d][b[0]]=(this.data[d][b[0]]||0)+c}};
History.math={stddev:function(b){var c,d=0,e=this.mean(b);for(c in b)d+=Math.pow(b[c]-e,2);d/=b.length;return Math.sqrt(d)},average:function(b){var c,d=this.mean(b),e=this.stddev(b);for(c in b)Math.abs(b[c]-d)>e*2&&delete b[c];return sum(b)/b.length},mean:function(b){return sum(b)/b.length},harmonic:function(b){var c,d=[];for(c in b)b[c]&&d.push(1/b[c]);return d.length/sum(d)},geometric:function(b){var c,d=1;for(c in b)d*=b[c]||1;return Math.pow(d,1/b.length)},median:function(b){b.sort(function(c,
d){return c-d});if(b.length%2)return(b[Math.floor(b.length/2)]+b[Math.ceil(b.length/2)])/2;return b[Math.floor(b.length/2)]},mode:function(b){var c,d=0,e=0,f={};for(c in b)f[b[c]]=(f[b[c]]||0)+1;f=sortObject(f,function(g,h){return f[h]-f[g]});for(c in f)if(f[c]===f[0]){d+=parseInt(f[c]);e++}return d/e},max:function(b){b.sort(function(c,d){return d-c});return b[0]},min:function(b){b.sort(function(c,d){return c-d});return b[0]}};
History.get=function(b){this._unflush();var c,d,e,f=null,g=[],h=this.data;b=typeof b==="string"?b.split("."):typeof b==="object"?b:[];var k=Math.floor(Date.now()/36E5),l=false,n=168,o=false;if(b.length&&(typeof b[0]==="number"||!b[0].regex(/[^0-9]/gi)))k=b.shift();if(b.length&&(typeof b[b.length-1]==="number"||!b[b.length-1].regex(/[^0-9]/gi)))n=Math.range(1,parseInt(b.pop()),168);if(!b.length)return h;for(c in h)if(h[c][b[0]]&&typeof h[c][b[0]]==="number"){l=true;break}if(b.length===1){if(l)return h[k][b[0]];
for(d in h[k])if(d.indexOf(b[0]+"+")===0&&typeof h[k][d]==="number")e=(e||0)+h[k][d];return e}if(b.length===2&&b[1]==="change"){if(h[k]&&h[k-1]){c=this.get([k,b[0]]);d=this.get([k-1,b[0]]);if(typeof c==="number"&&typeof d==="number")return c-d;return 0}return 0}if(b.length>2&&b[2]==="change")o=true;for(c=k-n;c<=k;c++)if(h[c]){e=null;if(l){if(h[c][b[0]])e=h[c][b[0]]}else for(d in h[c])if(d.indexOf(b[0]+"+")===0&&typeof h[c][d]==="number")e=(e||0)+h[c][d];if(o){if(e!==null&&f!==null){g.push(e-f);isNaN(g[g.length-
1])&&debug("NaN: "+e+" - "+f)}f=e}else e!==null&&g.push(e)}if(History.math[b[1]])return History.math[b[1]](g);throw"Wanting to get unknown History type "+b[1]+" on "+b[0];};History.getTypes=function(b){var c,d=[],e={},f=this.data;b=b+"+";for(c in f)if(c.indexOf(b)===0)e[c]=true;for(c in e)d.push(c);return d};
History.makeGraph=function(b,c,d,e){var f,g,h=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY,l,n=[],o=[],p=[],m=[],q={},s="";m=1;var r="",t=Math.floor(Date.now()/36E5);if(typeof e==="number")e=[e];else if(typeof e!=="array"&&typeof e!=="object")e=null;if(e&&length(e))for(f in e){h=Math.min(h,e[f]);k=Math.max(k,e[f])}if(typeof b==="string")b=[b];for(f=t-72;f<=t;f++){q[f]=[0];if(this.data[f]){for(g in b)q[f][g]=this.get(f+"."+b[g]);h=Math.min(h,sum(q[f]));k=Math.max(k,sum(q[f]))}}if(k>=1E9){m=
1E9;r="b"}else if(k>=1E6){m=1E6;r="m"}else if(k>=1E3){m=1E3;r="k"}k=Math.ceil(k/m)*m;b=(d?"$":"")+addCommas(k/m)+r;h=Math.floor(h/m)*m;l=(d?"$":"")+addCommas(h/m)+r;if(e&&length(e)){for(f in e){p.push('<div style="bottom:'+Math.max(Math.floor((e[f]-h)/(k-h)*100),0)+'px;"></div>');n.push("<div"+(typeof f!=="number"?' title="'+f+'"':"")+' style="bottom:'+Math.range(2,Math.ceil((e[f]-h)/(k-h)*100)-2,92)+'px;">'+(d?"$":"")+addCommas((e[f]/m).round(1))+r+"</div>")}s='<div class="goal">'+p.reverse().join("")+
"</div>";n.reverse()}th(o,"<div>"+b+"</div><div>"+c+"</div><div>"+l+"</div>");for(f=t-72;f<=t;f++){p=[];m=[];e=[];c=t-f+" hour"+(t-f==1?"":"s")+" ago";r=0;for(g in q[f]){p.push('<div style="height:'+Math.max(Math.ceil(100*(q[f][g]-(!r?h:0))/(k-h)),0)+'px;"></div>');r++;if(q[f][g])e.push(q[f][g]?(d?"$":"")+addCommas(q[f][g]):"")}m.push('<div class="bars">'+p.reverse().join("")+"</div>"+s);e.reverse();c=c+(e.length?", ":"")+e.join(" + ")+(e.length>1?" = "+(d?"$":"")+addCommas(sum(q[f])):"");td(o,m.join(""),
'title="'+c+'"')}th(o,n.join(""));return"<tr>"+o.join("")+"</tr>"};var Idle=new Worker("Idle");Idle.defaults={castle_age:{}};Idle.data=null;Idle.option={general:"any",index:"Daily",alchemy:"Daily",quests:"Never",town:"Never",battle:"Quarterly",monsters:"Hourly"};Idle.when=["Never","Quarterly","Hourly","2 Hours","6 Hours","12 Hours","Daily","Weekly"];
Idle.display=[{label:"<strong>NOTE:</strong> Any workers below this will <strong>not</strong> run!<br>Use this for disabling workers you do not use."},{id:"general",label:"Idle General",select:"generals"},{label:"Check Pages:"},{id:"index",label:"Home Page",select:Idle.when},{id:"alchemy",label:"Alchemy",select:Idle.when},{id:"quests",label:"Quests",select:Idle.when},{id:"town",label:"Town",select:Idle.when},{id:"battle",label:"Battle",select:Idle.when},{id:"monsters",label:"Monsters",select:Idle.when}];
Idle.work=function(b){if(!b)return true;var c,d,e={index:["index"],alchemy:["keep_alchemy"],quests:["quests_quest1","quests_quest2","quests_quest3","quests_quest4","quests_quest5","quests_quest6","quests_demiquests","quests_atlantis"],town:["town_soldiers","town_blacksmith","town_magic","town_land"],battle:["battle_battle"],monsters:["keep_monster","battle_raid"]},f={Never:0,Quarterly:9E5,Hourly:36E5,"2 Hours":72E5,"6 Hours":216E5,"12 Hours":432E5,Daily:864E5,Weekly:6048E5};if(!Generals.to(this.option.general))return true;
for(c in e)if(f[this.option[c]]){d=Date.now()-f[this.option[c]];for(b=0;b<e[c].length;b++)if(!Page.get(e[c][b])||Page.get(e[c][b])<d)if(!Page.to(e[c][b])){Page.set(e[c][b],Date.now());return true}}return true};var Income=new Worker("Income");Income.data=null;Income.defaults={castle_age:{}};Income.option={general:true,bank:true,margin:45};
Income.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true},{advanced:true,id:"margin",label:"Safety Margin",select:[15,30,45,60],suffix:"seconds"}];
Income.work=function(b){if(!Income.option.margin)return false;if(Player.get("cash_timer")>this.option.margin){if(b&&this.option.bank)return Bank.work(true);return false}if(!b)return true;if(this.option.general&&!Generals.to(Generals.best("income")))return true;debug("Income: Waiting for Income... ("+Player.get("cash_timer")+" seconds)");return true};var Land=new Worker("Land");Land.defaults={castle_age:{pages:"town_land"}};Land.option={enabled:true,best:null,onlyten:false};
Land.runtime={lastlevel:0,best:null,buy:0,cost:0};Land.display=[{id:"enabled",label:"Auto-Buy Land",checkbox:true},{advanced:true,id:"onlyten",label:"Only buy 10x<br>NOTE: This is slower!!!",checkbox:true,help:"The standard method is guaranteed to be the most efficient.  Choosing this option will slow down your income."}];
Land.parse=function(b){$("tr.land_buy_row,tr.land_buy_row_unique").each(function(c,d){c=$("img",d).attr("alt");var e;if(b)$(".land_buy_info strong:first",d).after(' - (<strong title="Return On Investment - higher is better">ROI</strong>: '+(Land.data[c].income*100/Land.data[c].cost).round(3)+"%)");else{$(".land_buy_image_int",d).length||$(".land_buy_image",d).prepend('<div class="land_buy_image_int"></div>').children(".land_buy_image_int").append($('.land_buy_image >[class!="land_buy_image_int"]',
d));$(".land_buy_info_int",d).length||$(".land_buy_info",d).prepend('<div class="land_buy_info_int"></div>').children(".land_buy_info_int").append($('.land_buy_info >[class!="land_buy_info_int"]',d));Land.data[c]={};Land.data[c].income=$(".land_buy_info .gold",d).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);Land.data[c].max=$(".land_buy_info",d).text().regex(/Max Allowed For your level: ([0-9]+)/i);Land.data[c].cost=$(".land_buy_costs .gold",d).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/);if(e=
$("option",$(".land_buy_costs .gold",d).parent().next()).last().attr("value"))Land.data[c].buy=e;Land.data[c].own=$(".land_buy_costs span",d).text().replace(/[^0-9]/g,"").regex(/([0-9]+)/)}});return true};
Land.update=function(){var b,c=Bank.worth(),d=Player.get("income")+History.get("income.mean"),e,f=0;for(b in this.data)if(this.data[b].buy)if(!e||this.data[e].cost/d+this.data[b].cost/(d+this.data[e].income)>this.data[b].cost/d+this.data[e].cost/(d+this.data[b].income))e=b;if(e){b=this.data[e].cost/(10+this.data[e].own)/this.data[e].income;b*=1.5;f=this.option.onlyten||this.data[e].cost*10<=c?Math.min(this.data[e].max-this.data[e].own,10):this.data[e].cost/d>b?1:this.data[e].cost*5/d>b?Math.min(this.data[e].max-
this.data[e].own,5):Math.min(this.data[e].max-this.data[e].own,10);this.runtime.buy=f;this.runtime.cost=f*this.data[e].cost;Dashboard.status(this,(this.runtime.buy?"Buying ":"Want to buy ")+f+"x "+e+" for $"+addCommas(f*this.data[e].cost))}else Dashboard.status(this);this.runtime.best=e};
Land.work=function(b){if(!this.option.enabled||!this.runtime.best||!Bank.worth(this.runtime.cost)){if(!this.runtime.best&&this.runtime.lastlevel<Player.get("level")){if(!b||!Page.to("town_land"))return true;this.runtime.lastlevel=Player.get("level")}return false}if(!b||!Bank.retrieve(this.runtime.cost)||!Page.to("town_land"))return true;$("tr.land_buy_row,tr.land_buy_row_unique").each(function(c,d){if($("img",d).attr("alt")===Land.runtime.best){debug("Land: Buying "+Land.runtime.buy+" x "+Land.runtime.best+
" for $"+addCommas(Land.runtime.cost));$("select",$(".land_buy_costs .gold",d).parent().next()).val(Land.runtime.buy>5?10:Land.runtime.buy>1?5:1);Page.click($('.land_buy_costs input[name="Buy"]',d));$("#"+PREFIX+"Land_current").text("None")}});return true};var LevelUp=new Worker("LevelUp");LevelUp.data=null;LevelUp.settings={before:["Battle","Monster","Quest"]};LevelUp.defaults={castle_age:{pages:"*"}};LevelUp.option={enabled:false,income:true,general:"any",algorithm:"Per Action"};
LevelUp.runtime={level:0,heal_me:false,battle_monster:false,old_quest:null,old_quest_energy:0,running:false,energy:0,stamina:0,exp:0,exp_possible:0,energy_samples:0,exp_per_energy:1,stamina_samples:0,exp_per_stamina:1,quests:[]};
LevelUp.display=[{title:"Important!",label:"This will spend Energy and Stamina to force you to level up quicker."},{id:"enabled",label:"Enabled",checkbox:true},{id:"income",label:"Allow Income General",checkbox:true},{id:"general",label:"Best General",select:["any","Energy","Stamina"],help:"Select which type of general to use when leveling up."},{id:"algorithm",label:"Estimation Method",select:["Per Action","Per Hour"],help:"'Per Hour' uses your gain per hour. 'Per Action' uses your gain per action."}];
LevelUp.init=function(){this._watch(Player);this._watch(Quest);this.runtime.exp=this.runtime.exp||Player.get("exp");this.runtime.level=this.runtime.level||Player.get("level")};
LevelUp.parse=function(b){b?$("#app"+APPID+"_st_2_5 strong").attr("title",Player.get("exp")+"/"+Player.get("maxexp")+" at "+addCommas(this.get("exp_average").round(1))+" per hour").html(addCommas(Player.get("exp_needed"))+'<span style="font-weight:normal;"> in <span class="golem-time" style="color:rgb(25,123,48);" name="'+this.get("level_time")+'">'+makeTimer(this.get("level_timer"))+"</span></span>"):$(".result_body").each(function(c,d){if($('img[src$="battle_victory.gif"]',d).length){c=$(d).text().replace(/,|\t/g,
"");(d=c.regex(/([+-][0-9]+) Experience/i))&&History.add("exp+battle",d);(d=(c.regex(/\+\$([0-9]+)/i)||0)-(c.regex(/\-\$([0-9]+)/i)||0))&&History.add("income+battle",d);(d=c.regex(/([+-][0-9]+) Battle Points/i))&&History.add("bp+battle",d);(d=c.regex(/([+-][0-9]+) Stamina/i))&&History.add("stamina+battle",d);(d=c.regex(/([+-][0-9]+) Energy/i))&&History.add("energy+battle",d)}});return true};
LevelUp.update=function(b){var c,d,e,f=Player.get("energy"),g=Player.get("stamina");d=Player.get("exp");var h=this.runtime,k=Quest.get();if(b===Quest){h.quests=e=[[0]];for(c in k)if(!e[k[c].energy]||k[c].exp>e[k[c].energy][0])e[k[c].energy]=[k[c].exp,[c]];b=1;d=[0];for(c=1;c<e.length;c++)if(e[c]&&e[c][0]/c>=d[0]/b){b=c;d=e[c]}else e[c]=[d[0],[d[1][0]]];for(;e.length>1&&e[e.length-1][0]===e[e.length-2][0];)e.pop();for(c=1;c<e.length;c++)if(k[e[c][1][0]].energy<c){e[c][0]+=e[c-k[e[c][1][0]].energy][0];
e[c][1]=e[c][1].concat(e[c-k[e[c][1][0]].energy][1])}}else if(b===Player){if(d!==h.exp)if(h.stamina>g){h.exp_per_stamina=(h.exp_per_stamina*Math.min(h.stamina_samples,49)+(d-h.exp)/(h.stamina-g))/Math.min(h.stamina_samples+1,50);h.stamina_samples=Math.min(h.stamina_samples+1,50)}else if(h.energy>f){h.exp_per_energy=(h.exp_per_energy*Math.min(h.energy_samples,9)+(d-h.exp)/(h.energy-f))/Math.min(h.energy_samples+1,10);h.energy_samples=Math.min(h.energy_samples+1,10)}h.energy=f;h.stamina=g;h.exp=d}h.exp_possible=
this.runtime.quests.length?f<this.runtime.quests.length?this.runtime.quests[Math.min(f,this.runtime.quests.length-1)][0]:this.runtime.quests[this.runtime.quests.length-1][0]*Math.floor(f/(this.runtime.quests.length-1))+this.runtime.quests[f%(this.runtime.quests.length-1)][0]:1;h.exp_possible+=Math.floor(g*h.exp_per_stamina);c=new Date(this.get("level_time"));if(this.option.enabled)h.running?Dashboard.status(this,'<span title="Exp Possible: '+this.runtime.exp_possible+", per Hour: "+addCommas(this.get("exp_average").round(1))+
", per Energy: "+this.runtime.exp_per_energy.round(2)+", per Stamina: "+this.runtime.exp_per_stamina.round(2)+'">LevelUp Running Now!</span>'):Dashboard.status(this,'<span title="Exp Possible: '+this.runtime.exp_possible+", per Energy: "+this.runtime.exp_per_energy.round(2)+", per Stamina: "+this.runtime.exp_per_stamina.round(2)+'">'+c.format("l g:i a")+" (at "+addCommas(this.get("exp_average").round(1))+" exp per hour)</span>");else Dashboard.status(this)};
LevelUp.work=function(b){var c=this.runtime,d=Player.get("energy"),e=Player.get("stamina");c.running&&this.option.income&&Queue.get("runtime.current")===Income&&Generals.set("runtime.disabled",false);if(c.old_quest){Quest.runtime.best=c.old_quest;Quest.runtime.energy=c.old_quest_energy;c.old_quest=null;c.old_quest_energy=0}if(!this.option.enabled||c.exp_possible<Player.get("exp_needed")){if(c.running&&c.level<Player.get("level")){if($("#app"+APPID+"_energy_current_value").next().css("color")==="rgb(25, 123, 48)"&&
d>=Player.get("maxenergy")){Queue.burn.energy=d;Queue.burn.stamina=0;return false}if($("#app"+APPID+"_stamina_current_value").next().css("color")==="rgb(25, 123, 48)"&&e>=Player.get("maxstamina")){Queue.burn.energy=0;Queue.burn.stamina=e;return false}Generals.set("runtime.disabled",false);Queue.burn.stamina=Math.max(0,e-Queue.get("option.stamina"));Queue.burn.energy=Math.max(0,d-Queue.get("option.energy"));Battle.set("option.monster",c.battle_monster);c.running=false}else if(c.running&&c.level==Player.get("level")){Generals.set("runtime.disabled",
false);Queue.burn.stamina=Math.max(0,e-Queue.get("option.stamina"));Queue.burn.energy=Math.max(0,d-Queue.get("option.energy"));Battle.set("option.monster",c.battle_monster);c.running=false}return false}if(b&&c.heal_me){if(Heal.me())return true;c.heal_me=false}if(!c.running||b){c.level=Player.get("level");c.battle_monster=Battle.get("option.monster");c.running=true;Battle.set("option.monster",false)}if((b=Generals.best(this.option.general))&&b!=="any"&&Player.get("exp_needed")<25){Generals.set("runtime.disabled",
false);if(b===Player.get("general")||Generals.to(b))Generals.set("runtime.disabled",true);else return true}if(Player.get("energy")){c.old_quest=Quest.runtime.best;c.old_quest_energy=Quest.runtime.energy;Queue.burn.energy=d;Queue.burn.stamina=0;Quest.runtime.best=c.quests[Math.min(c.energy,c.quests.length-1)][1][0];Quest.runtime.energy=d;return false}Quest._update("data");if(c.level===Player.get("level")&&Player.get("health")<13&&e)return c.heal_me=true;Queue.burn.energy=0;Queue.burn.stamina=e;return false};
LevelUp.get=function(b){var c=Date.now();switch(b){case "timer":return makeTimer(this.get("level_timer"));case "time":return(new Date(this.get("level_time"))).format("l g:i a");case "level_timer":return Math.floor((this.get("level_time")-c)/1E3);case "level_time":return c+Math.floor(36E5*((Player.get("exp_needed")-this.runtime.exp_possible)/(this.get("exp_average")||10)));case "exp_average":return this.option.algorithm=="Per Hour"?History.get("exp.average.change"):12*(this.runtime.exp_per_stamina+
this.runtime.exp_per_energy);default:return this._get(b)}};var Monster=new Worker("Monster");Monster.data={};Monster.defaults={castle_age:{pages:"keep_monster keep_monster_active keep_monster_active2 battle_raid"}};Monster.option={fortify:80,first:false,choice:"Any",ignore_stats:true,stop:"Never",armyratio:1,levelratio:"Any",force1:true,raid:"Invade x5",assist:true};Monster.runtime={check:false,uid:null,type:null,fortify:false,attack:false,stamina:5,health:10};
Monster.display=[{title:"Fortification"},{id:"fortify",label:"Fortify Below",select:[10,20,30,40,50,60,70,80,90,100],after:"%"},{id:"first",label:"Fortify Active",checkbox:true,help:"Must be checked to fortify."},{title:"Who To Fight"},{advanced:true,id:"ignore_stats",label:"Ignore Player Stats",checkbox:true,help:"Do not use the current health or stamina as criteria for choosing monsters."},{id:"choice",label:"Attack",select:["Any","Strongest","Weakest","Shortest","Spread"]},{id:"stop",label:"Stop",
select:["Never","Achievement","Loot"],help:"Select when to stop attacking a target."},{title:"Raids"},{id:"raid",label:"Raid",select:["Invade","Invade x5","Duel","Duel x5"]},{id:"armyratio",label:"Target Army Ratio<br>(Only needed for Invade)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,1.1,1.2,1.3,1.4,1.5],help:"Smaller number for smaller target army. Reduce this number if you're losing in Invade"},{id:"levelratio",label:"Target Level Ratio<br>(Mainly used for Duel)",select:["Any",0.5,0.6,0.7,0.8,0.9,1,
1.1,1.2,1.3,1.4,1.5],help:"Smaller number for lower target level. Reduce this number if you're losing a lot"},{id:"force1",label:"Force +1",checkbox:true,help:"Force the first player in the list to aid."},{title:"Siege Assist Options"},{id:"assist",label:"Assist with Sieges",help:"Spend stamina to assist with sieges.",checkbox:true},{id:"assist_links",label:"Use Assist Links in Dashboard",checkbox:true}];
Monster.types={raid_easy:{name:"The Deathrune Siege",list:"deathrune_list1.jpg",image:"raid_title_raid_a1.jpg",image2:"raid_title_raid_a2.jpg",dead:"raid_1_large_victory.jpg",achievement:100,timer:216E3,timer2:302400,raid:true},raid:{name:"The Deathrune Siege",list:"deathrune_list2.jpg",image:"raid_title_raid_b1.jpg",image2:"raid_title_raid_b2.jpg",dead:"raid_1_large_victory.jpg",achievement:100,timer:319920,timer2:519960,raid:true},colossus:{name:"Colossus of Terra",list:"stone_giant_list.jpg",image:"stone_giant_large.jpg",
dead:"stone_giant_dead.jpg",achievement:4E4,timer:259200,mpool:1},gildamesh:{name:"Gildamesh, the Orc King",list:"orc_boss_list.jpg",image:"orc_boss.jpg",dead:"orc_boss_dead.jpg",achievement:25E3,timer:259200,mpool:1},keira:{name:"Keira the Dread Knight",list:"boss_keira_list.jpg",image:"boss_keira.jpg",dead:"boss_keira_dead.jpg",achievement:3E4,timer:172800,mpool:1},lotus:{name:"Lotus Ravenmoore",list:"boss_lotus_list.jpg",image:"boss_lotus.jpg",dead:"boss_lotus_big_dead.jpg",achievement:125E4,timer:172800,
mpool:1},mephistopheles:{name:"Mephistopheles",list:"boss_mephistopheles_list.jpg",image:"boss_mephistopheles_large.jpg",dead:"boss_mephistopheles_dead.jpg",achievement:282E3,timer:172800,mpool:1},skaar:{name:"Skaar Deathrune",list:"death_list.jpg",image:"death_large.jpg",dead:"death_dead.jpg",achievement:1E6,timer:345E3,mpool:1},sylvanus:{name:"Sylvanas the Sorceress Queen",list:"boss_sylvanus_list.jpg",image:"boss_sylvanus_large.jpg",dead:"boss_sylvanus_dead.jpg",achievement:12E4,timer:172800,mpool:1},
dragon_emerald:{name:"Emerald Dragon",list:"dragon_list_green.jpg",image:"dragon_monster_green.jpg",dead:"dead_dragon_image_green.jpg",achievement:64E3,timer:259200,mpool:2},dragon_frost:{name:"Frost Dragon",list:"dragon_list_blue.jpg",image:"dragon_monster_blue.jpg",dead:"dead_dragon_image_blue.jpg",achievement:85E3,timer:259200,mpool:2},dragon_gold:{name:"Gold Dragon",list:"dragon_list_yellow.jpg",image:"dragon_monster_gold.jpg",dead:"dead_dragon_image_gold.jpg",achievement:18E4,timer:259200,mpool:2},
dragon_red:{name:"Ancient Red Dragon",list:"dragon_list_red.jpg",image:"dragon_monster_red.jpg",dead:"dead_dragon_image_red.jpg",achievement:35E4,timer:259200,mpool:2},serpent_amethyst:{name:"Amethyst Sea Serpent",list:"seamonster_list_purple.jpg",image:"seamonster_purple.jpg",achievement:6E5,timer:259200,mpool:2},serpent_ancient:{name:"Ancient Sea Serpent",list:"seamonster_list_red.jpg",image:"seamonster_red.jpg",achievement:93E4,timer:259200,mpool:2},serpent_emerald:{name:"Emerald Sea Serpent",
list:"seamonster_list_green.jpg",image:"seamonster_green.jpg",achievement:15E4,timer:259200,mpool:2},serpent_sapphire:{name:"Sapphire Sea Serpent",list:"seamonster_list_blue.jpg",image:"seamonster_blue.jpg",achievement:3E5,timer:259200,mpool:2},cronus:{name:"Cronus, The World Hydra",list:"hydra_head.jpg",image:"hydra_large.jpg",dead:"hydra_dead.jpg",achievement:5E5,timer:604800,mpool:3},legion:{name:"Battle of the Dark Legion",list:"castle_siege_list.jpg",image:"castle_siege_large.jpg",dead:"castle_siege_dead.jpg",
achievement:1E3,timer:604800,mpool:3},genesis:{name:"Genesis, The Earth Elemental",list:"earth_element_list.jpg",image:"earth_element_large.jpg",dead:"earth_element_dead.jpg",achievement:1E6,timer:604800,mpool:3},ragnarok:{name:"Ragnarok, The Ice Elemental",list:"water_list.jpg",image:"water_large.jpg",dead:"water_dead.jpg",achievement:1E6,timer:604800,mpool:3},bahamut:{name:"Bahamut, the Volcanic Dragon",list:"nm_volcanic_list.jpg",image:"nm_volcanic_large.jpg",dead:"nm_volcanic_dead.jpg",achievement:1E6,
timer:604800,mpool:3}};Monster.fortify=['input[src$="attack_monster_button3.jpg"]','input[src$="button_dispel.gif"]','input[src$="seamonster_fortify.gif"]','input[src$="nm_secondary_heal.gif"]','input[src$="nm_secondary_strengthen.gif"]','input[src$="nm_secondary_cripple.jpg"]','input[src$="nm_secondary_deflect.jpg"]'];
Monster.attack=['input[src$="attack_monster_button2.jpg"]','input[src$="seamonster_power.gif"]','input[src$="attack_monster_button.jpg"]','input[src$="event_attack2.gif"]','input[src$="event_attack1.gif"]','input[src$="nm_primary_smite.gif"]','input[src$="nm_primary_bash.gif"]','input[src$="nm_primary_bolt.gif"]','input[src$="nm_primary_stab.gif"]'];Monster.secondary=['input[src$="nm_secondary_cripple.jpg"]','input[src$="nm_secondary_deflect.jpg"]'];Monster.health_img=['img[src$="nm_red.jpg"]','img[src$="monster_health_background.jpg"]'];
Monster.shield_img=['img[src$="bar_dispel.gif"]'];Monster.defense_img=['img[src$="nm_green.jpg"]','img[src$="seamonster_ship_health.jpg"]'];Monster.secondary_img=['img[src$="nm_stun_bar.gif"]'];Monster.class_img=['img[src$="nm_class_warrior.jpg"]','img[src$="nm_class_cleric.jpg"]','img[src$="nm_class_rogue.jpg"]','img[src$="nm_class_mage.jpg"]'];Monster.class_name=["Warrior","Cleric","Rogue","Mage"];
Monster.init=function(){var b,c;this.runtime.count=0;for(b in this.data)for(c in this.data[b]){this.data[b][c].state==="engage"&&this.runtime.count++;if(typeof this.data[b][c].ignore==="unknown")this.data[b][c].ignore=false;if(typeof this.data[b][c].dispel!=="undefined"){this.data[b][c].defense=100-this.data[b][c].dispel;delete this.data[b][c].dispel}}this._watch(Player);$("#golem-dashboard-Monster tbody td a").live("click",function(){var d=$(this).attr("href");Page.to(d.indexOf("raid")>0?"battle_raid":
"keep_monster",d.substr(d.indexOf("?")));return false})};
Monster.parse=function(){var b;Battle.get("user");var c,d,e=false,f,g,h=Monster.data,k=Monster.types;if(Page.page==="keep_monster_active"||Page.page==="keep_monster_active2"){c=$('img[linked][size="square"]').attr("uid");for(b in k)if(k[b].dead&&$('img[src$="'+k[b].dead+'"]').length){d=b;g=k[b].timer;e=true}else if(k[b].image&&($('img[src$="'+k[b].image+'"]').length||$('div[style*="'+k[b].image+'"]').length)){d=b;g=k[b].timer}else if(k[b].image2&&($('img[src$="'+k[b].image2+'"]').length||$('div[style*="'+
k[b].image2+'"]').length)){d=b;g=k[b].timer2||k[b].timer}if(!c||!d){debug("Monster: Unknown monster (probably dead)");return false}h[c]=h[c]||{};h[c][d]=h[c][d]||{};f=h[c][d];f.last=Date.now();if($('input[src*="collect_reward_button.jpg"]').length){f.state="reward";return false}if(e&&f.state==="assist")f.state=null;else if(e&&f.state==="engage")f.state="reward";else{if(!f.state&&$("span.result_body").text().match(/for your help in summoning|You have already assisted on this objective|You don't have enough stamina assist in summoning/i)){if($("span.result_body").text().match(/for your help in summoning/i))f.assist=
Date.now();f.state="assist"}if($('img[src$="battle_victory.gif"],img[src$="battle_defeat.gif"],span["result_body"] a:contains("Attack Again")').length)f.battle_count=(f.battle_count||0)+1;$('img[src$="battle_victory"]').length&&History.add("raid+win",1);$('img[src$="battle_defeat"]').length&&History.add("raid+loss",-1);if(!f.name){c=$('img[linked][size="square"]').parent().parent().next().text().trim().replace(/[\s\n\r]{2,}/g," ");f.name=c.regex(/(.+)'s /i)}for(b in Monster.class_img)if($(Monster.class_img[b]).length)f.mclass=
b;if(f.mclass>1)for(b in Monster.secondary_img)if($(Monster.secondary_img[b]).length){c=$(Monster.secondary_img[b]);f.secondary=c.length?100*c.width()/c.parent().width():0}for(b in Monster.health_img)if($(Monster.health_img[b]).length){c=$(Monster.health_img[b]).parent();f.health=c.length?100*c.width()/c.parent().width():0;break}for(b in Monster.shield_img)if($(Monster.shield_img[b]).length){c=$(Monster.shield_img[b]).parent();f.defense=100*(1-c.width()/(c.next().length?c.width()+c.next().width():
c.parent().width()));f.totaldefense=f.defense*(isNumber(f.strength)?f.strength/100:1);break}for(b in Monster.defense_img)if($(Monster.defense_img[b]).length){b=$(Monster.defense_img[b]).parent();f.defense=b.width()/(b.next().length?b.width()+b.next().width():b.parent().width())*100;if(b.parent().width()<b.parent().parent().width())f.strength=100*b.parent().width()/b.parent().parent().width();f.totaldefense=f.defense*(isNumber(f.strength)?f.strength/100:1);break}f.timer=$("#app"+APPID+"_monsterTicker").text().parseTimer();
f.finish=Date.now()+f.timer*1E3;f.damage_total=0;f.damage={};$('td.dragonContainer table table a[href^="http://apps.facebook.com/castle_age/keep.php?user="]').each(function(l,n){l=$(n).attr("href").regex(/user=([0-9]+)/i);var o=$(n).parent().next().text().replace(/[^0-9\/]/g,"");n=o.regex(/([0-9]+)/);o=o.regex(/\/([0-9]+)/);f.damage[l]=o?[n,o]:[n];f.damage_total+=n});f.dps=f.damage_total/(g-f.timer);f.total=k[d].raid?f.damage_total+$('div[style*="monster_health_back.jpg"] div:nth-child(2)').text().regex(/([0-9]+)/):
Math.floor(100*f.damage_total/(100-f.health));f.eta=Date.now()+Math.floor((f.total-f.damage_total)/f.dps)*1E3}}else if(Page.page==="keep_monster"||Page.page==="battle_raid"){if(!$("#app"+APPID+"_app_body div.imgButton").length)return false;if(Page.page==="battle_raid")raid=true;for(c in h)for(d in h[c])if((Page.page==="battle_raid"&&this.types[d].raid||Page.page==="keep_monster"&&!this.types[d].raid)&&(h[c][d].state==="complete"||h[c][d].state==="assist"&&h[c][d].finish<Date.now()))h[c][d].state=
null;$("#app"+APPID+"_app_body div.imgButton").each(function(l,n){var o=$("a",n).attr("href").regex(/user=([0-9]+)/i),p=$(n).parent().parent().children().eq(1).html().regex(/graphics\/([^.]*\....)/i),m="unknown";for(l in k)if(p==k[l].list){m=l;break}if(!(!o||m==="unknown")){h[o]=h[o]||{};h[o][m]=h[o][m]||{};if(o===userID)h[o][m].name="You";else{p=$(n).parent().parent().children().eq(2).text().trim();h[o][m].name=p.regex(/(.+)'s /i)}switch($("img",n).attr("src").regex(/dragon_list_btn_([0-9])/)){case 2:h[o][m].state=
"reward";break;case 3:h[o][m].state="engage";break;case 4:h[o][m].state="complete";break;default:h[o][m].state="unknown";break}}})}return false};
Monster.update=function(){var b,c,d=[],e=this.runtime.uid,f=this.runtime.type,g=null;this.runtime.count=0;for(b in this.data){for(c in this.data[b])if(this.data[b][c].state)this.data[b][c].state==="engage"&&this.runtime.count++;else delete this.data[b][c];length(this.data[b])||delete this.data[b]}if(!e||!f||!this.data[e]||!this.data[e][f]||this.data[e][f].state!=="engage"&&this.data[e][f].state!=="assist"){this.runtime.uid=e=null;this.runtime.type=f=null}f=e=null;this.runtime.check=false;for(b in this.data)for(c in this.data[b]){if((!this.data[b][c].health&&
this.data[b][c].state==="engage"||typeof this.data[b][c].last==="undefined"||this.data[b][c].last<Date.now()-36E5)&&(typeof this.data[b][c].ignore==="undefined"||!this.data[b][c].ignore)){this.runtime.check=true;break}if((typeof this.data[b][c].ignore==="undefined"||!this.data[b][c].ignore)&&this.data[b][c].state==="engage"&&this.data[b][c].finish>Date.now()&&(this.option.ignore_stats||Player.get("health")>=(this.types[c].raid?13:10)&&Queue.burn.stamina>=(this.types[c].raid&&this.option.raid.search("x5")==
-1?1:5)))switch(this.option.stop){default:case "Never":d.push([b,c,this.data[b][c].health,this.data[b][c].eta,this.data[b][c].battle_count]);break;case "Achievement":if(isNumber(this.types[c].achievement)&&(typeof this.data[b][c].damage[userID]==="undefined"||sum(this.data[b][c].damage[userID])<this.types[c].achievement))d.push([b,c,this.data[b][c].health,this.data[b][c].eta,this.data[b][c].battle_count]);break;case "Loot":if(isNumber(this.types[c].achievement)&&(typeof this.data[b][c].damage[userID]===
"undefined"||sum(this.data[b][c].damage[userID])<(b==userID&&c==="keira"?2E5:2*this.types[c].achievement)))d.push([b,c,this.data[b][c].health,this.data[b][c].eta,this.data[b][c].battle_count]);break}}d.sort(function(h,k){switch(Monster.option.choice){case "Any":return Math.random()-0.5;case "Strongest":return k[2]-h[2];case "Weakest":return h[2]-k[2];case "Shortest":return h[3]-k[3];case "Spread":return h[4]-k[4]}});if(d.length)g=d[0];delete d;if(g){e=g[0];f=g[1]}this.runtime.uid=e;this.runtime.type=
f;if(e&&f){this.runtime.fortify=this.option.first&&(typeof this.data[e][f].mclass==="undefined"||this.data[e][f].mclass<2)&&typeof this.data[e][f].totaldefense!=="undefined"&&this.data[e][f].totaldefense<this.option.fortify&&this.data[e][f].defense<100?true:typeof this.data[e][f].mclass!=="undefined"&&this.data[e][f].mclass>1&&typeof this.data[e][f].secondary!=="undefined"&&this.data[e][f].secondary<100?true:false;if(Queue.burn.energy<10)this.runtime.fortify=false;this.runtime.attack=true;this.runtime.stamina=
this.types[f].raid&&this.option.raid.search("x5")==-1?1:5;this.runtime.health=this.types[f].raid?13:10;Dashboard.status(this,(this.runtime.fortify?"Fortify":"Attack")+" "+this.data[e][f].name+"'s "+this.types[f].name)}else{this.runtime.attack=false;this.runtime.fortify=false;Dashboard.status(this,"Nothing to do.")}};
Monster.work=function(b){var c,d,e=[];e=[];var f=this.runtime.uid,g=this.runtime.type,h=null;if(!this.runtime.check&&(!this.runtime.fortify||Queue.burn.energy<10||Player.get("health")<10)&&(!this.runtime.attack||Queue.burn.stamina<this.runtime.stamina||Player.get("health")<this.runtime.health))return false;if(!b)return true;if(this.runtime.check){for(c in this.data)for(d in this.data[c])if((!this.data[c][d].health&&this.data[c][d].state==="engage"||typeof this.data[c][d].last==="undefined"||this.data[c][d].last<
Date.now()-36E5)&&(typeof this.data[c][d].ignore==="undefined"||!this.data[c][d].ignore)){Page.to(this.types[d].raid?"battle_raid":"keep_monster","?user="+c+(this.types[d].mpool?"&mpool="+this.types[d].mpool:""));return true}this.runtime.check=false;return true}if(this.types[g].raid){if(!Generals.to(Generals.best(this.option.raid.search("Invade")==-1?"raid-duel":"raid-invade")))return true;switch(this.option.raid){case "Invade":h=$('input[src$="raid_attack_button.gif"]:first');break;case "Invade x5":h=
$('input[src$="raid_attack_button3.gif"]:first');break;case "Duel":h=$('input[src$="raid_attack_button2.gif"]:first');break;case "Duel x5":h=$('input[src$="raid_attack_button4.gif"]:first');break}}else{d=this.runtime.fortify&&Queue.burn.energy>=10?"fortify":"attack";if(!Generals.to(Generals.best(d)))return true;debug("Monster: Try to "+d+" "+f+"'s "+this.types[g].name);for(c=0;c<this[d].length;c++){h=$(this[d][c]);if(h.length)break}}if(!h||!h.length||Page.page!=="keep_monster_active"&&Page.page!==
"keep_monster_active2"||$('div[style*="dragon_title_owner"] img[linked]').attr("uid")!=f){Page.to(this.types[g].raid?"battle_raid":"keep_monster","?user="+f+(this.types[g].mpool?"&mpool="+this.types[g].mpool:""));return true}if(this.option.assist&&typeof $('input[name="help with dragon"]')!=="undefined"&&(typeof this.data[f][g].phase==="undefined"||$('input[name="help with dragon"]').attr("title").regex(/ (.*)/i)!==this.data[f][g].phase)){this.data[f][g].phase=$('input[name="help with dragon"]').attr("title").regex(/ (.*)/i);
debug("Monster: Found a new siege phase ("+this.data[f][g].phase+"), assisting now.");Page.to(this.types[g].raid?"battle_raid":"keep_monster","?user="+f+"&action=doObjective"+(this.types[g].mpool?"&mpool="+this.types[g].mpool:"")+"&lka="+c+"&ref=nf");return true}if(this.types[g].raid){b=Battle.get("user");if(this.option.force1){for(c in b)e.push(c);$('input[name*="target_id"]').val(e[Math.floor(Math.random()*e.length)]||0)}e=$('div[id*="raid_atk_lst0"] div div').text().regex(/Lvl\s*([0-9]+).*Army: ([0-9]+)/);
if(this.option.armyratio!=="Any"&&e[1]/Player.get("army")>this.option.armyratio||this.option.levelratio!=="Any"&&e[0]/Player.get("level")>this.option.levelratio){debug("Monster: No valid Raid target!");Page.to("battle_raid","");return true}}this.runtime.uid=this.runtime.type=null;Page.click(h);return true};Monster.order=null;
Monster.dashboard=function(b,c){var d,e,f,g,h,k=[],l=[],n=[null,"name","health","defense",null,"timer","eta"],o={engage:0,assist:1,reward:2,complete:3},p;if(typeof b==="undefined"){this.order=[];for(d in this.data)for(e in this.data[d])this.order.push([d,e])}if(typeof b==="undefined")b=this.runtime.sort||1;if(typeof c==="undefined")c=this.runtime.rev||false;this.runtime.sort=b;this.runtime.rev=c;this.order.sort(function(m,q){var s,r;if(o[Monster.data[m[0]][m[1]].state]>o[Monster.data[q[0]][q[1]].state])return 1;
if(o[Monster.data[m[0]][m[1]].state]<o[Monster.data[q[0]][q[1]].state])return-1;if(typeof n[b]==="string"){s=Monster.data[m[0]][m[1]][n[b]];r=Monster.data[q[0]][q[1]][n[b]]}else if(b==4){if(typeof Monster.data[m[0]][m[1]].damage!=="undefined")s=sum(Monster.data[m[0]][m[1]].damage[userID]);if(typeof Monster.data[q[0]][q[1]].damage!=="undefined")r=sum(Monster.data[q[0]][q[1]].damage[userID])}if(typeof s==="undefined")return 1;else if(typeof r==="undefined")return-1;if(typeof s==="string"||typeof r===
"string")return c?(r||"")>(s||""):(r||"")<(s||"");return c?(s||0)-(r||0):(r||0)-(s||0)});th(l,"");th(l,"User");th(l,"Health",'title="(estimated)"');th(l,"Att Bonus",'title="Composite of Fortification or Dispel into an approximate attack bonus (+50%...-50%)."');th(l,"Damage");th(l,"Time Left");th(l,"Kill In",'title="(estimated)"');th(l,"");k.push('<table cellspacing="0" style="width:100%"><thead><tr>'+l.join("")+"</tr></thead><tbody>");for(f=0;f<this.order.length;f++){d=this.order[f][0];e=this.order[f][1];
if(this.types[e]){l=[];g=this.data[d][e];p=!((g.state==="engage"||g.state==="assist")&&g.total);h=Monster.option.assist_link&&(g.state==="engage"||g.state==="assist")?"?user="+d+"&action=doObjective"+(Monster.types[e].mpool?"&mpool="+Monster.types[e].mpool:"")+"&lka="+d+"&ref=nf":"?user="+d+(Monster.types[e].mpool?"&mpool="+Monster.types[e].mpool:"");td(l,'<a href="http://apps.facebook.com/castle_age/'+(Monster.types[e].raid?"raid.php":"battle_monster.php")+h+'"><img src="'+imagepath+Monster.types[e].list+
'" style="width:72px;height:20px; position: relative; left: -8px; opacity:.7;" alt="'+e+'"><strong class="overlay">'+g.state+"</strong></a>",'title="'+Monster.types[e].name+'"');th(l,'<a class="golem-monster-ignore" name="'+d+"+"+e+'" title="Toggle Active/Inactive"'+(Monster.data[d][e].ignore?' style="text-decoration: line-through;"':"")+">"+Monster.data[d][e].name+"</a>");td(l,p?"":g.health===100?"100%":addCommas(g.total-g.damage_total)+" ("+g.health.round(1)+"%)");td(l,p?"":isNumber(g.totaldefense)?
(g.totaldefense-50).round(1)+"%":"",isNumber(g.strength)?'title="Max: '+(g.strength-50).round(1)+'%"':"");td(l,p?"":g.state==="engage"?addCommas(g.damage[userID][0]||0)+" ("+((g.damage[userID][0]||0)/g.total*100).round(1)+"%)":"",p?"":'title="In '+(g.battle_count||"an unknown number of")+' attacks"');td(l,p?"":g.timer?'<span class="golem-timer">'+makeTimer((g.finish-Date.now())/1E3)+"</span>":"?");td(l,p?"":'<span class="golem-timer">'+(g.health===100?makeTimer((g.finish-Date.now())/1E3):makeTimer((g.eta-
Date.now())/1E3))+"</span>");th(l,'<a class="golem-monster-delete" name="'+d+"+"+e+'" title="Delete this Monster from the dashboard">[x]</a>');tr(k,l.join(""))}}k.push("</tbody></table>");$("#golem-dashboard-Monster").html(k.join(""));$("a.golem-monster-delete").live("click",function(){var m=$(this).attr("name").split("+");Monster._unflush();delete Monster.data[m[0]][m[1]];length(Monster.data[m[0]])||delete Monster.data[m[0]];Monster.dashboard();return false});$("a.golem-monster-ignore").live("click",
function(){var m=$(this).attr("name").split("+");Monster._unflush();Monster.data[m[0]][m[1]].ignore=!Monster.data[m[0]][m[1]].ignore;Monster.dashboard();return false});if(typeof b!=="undefined")$("#golem-dashboard-Monster thead th:eq("+b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var News=new Worker("News");News.data=null;News.option=null;News.defaults={castle_age:{pages:"index"}};News.runtime={last:0};
News.parse=function(b){if(b){var c=0,d=0,e=0,f=0,g=0,h=0,k;b=[];var l={},n=this.runtime.last;News.runtime.last=Date.now();$("#app"+APPID+"_battleUpdateBox .alertsContainer .alert_content").each(function(o,p){var m;o=$(p).text().replace(/,/g,"");m=$(p).prev().text();var q=m.regex(/([0-9]+) days/i),s=m.regex(/([0-9]+) hours/i),r=m.regex(/([0-9]+) minutes/i),t=m.regex(/([0-9]+) seconds/i),u=m=0,v=0;q=Date.now()-((((q||0)*24+(s||0))*60+(r||59))*60+(t||59))*1E3;if(o.regex(/You were killed/i))g++;else{m=
$("a:eq(0)",p).attr("href").regex(/user=([0-9]+)/i);l[m]=l[m]||{name:$("a:eq(0)",p).text(),win:0,lose:0};p=null;if(o.regex(/Victory!/i)){e++;l[m].lose++;m=o.regex(/([0-9]+) experience/i);u=o.regex(/([0-9]+) Battle Points!/i);v=o.regex(/\$([0-9]+)/i);p="win"}else{f++;l[m].win++;m=0-o.regex(/([0-9]+) experience/i);u=0-o.regex(/([0-9]+) Battle Points!/i);v=0-o.regex(/\$([0-9]+)/i);p="loss"}if(q>n){q=Math.floor(q/36E5);History.add([q,"exp+battle"],m);History.add([q,"bp+battle"],u);History.add([q,"income+battle"],
v);switch(p){case "win":History.add([q,"battle+win"],1);break;case "loss":History.add([q,"battle+loss"],-1);break}}c+=m;d+=u;h+=v}});if(e||f){b.push("You were challenged <strong>"+(e+f)+"</strong> times, winning <strong>"+e+"</strong> and losing <strong>"+f+"</strong>.");b.push("You "+(c>=0?'gained <span class="positive">':'lost <span class="negative">')+addCommas(Math.abs(c))+"</span> experience points.");b.push("You "+(h>=0?'gained <span class="positive">':'lost <span class="negative">')+'<b class="gold">$'+
addCommas(Math.abs(h))+"</b></span>.");b.push("You "+(d>=0?'gained <span class="positive">':'lost <span class="negative">')+addCommas(Math.abs(d))+"</span> Battle Points.");b.push("");l=sortObject(l,function(o,p){return l[p].win+l[p].lose/100-(l[o].win+l[o].lose/100)});for(k in l)b.push('<strong title="'+k+'">'+l[k].name+"</strong> "+(l[k].win?'beat you <span class="negative">'+l[k].win+"</span> time"+(l[k].win>1?"s":""):"")+(l[k].lose?(l[k].win?" and ":"")+'was beaten <span class="positive">'+l[k].lose+
"</span> time"+(l[k].lose>1?"s":""):"")+".");if(g)b.push("You died "+(g>1?g+" times":"once")+"!");$("#app"+APPID+"_battleUpdateBox  .alertsContainer").prepend('<div style="padding: 0pt 0pt 10px;"><div class="alert_title">Summary:</div><div class="alert_content">'+b.join("<br>")+"</div></div>")}}return true};var Player=new Worker("Player");Player.option=null;Player.settings={keep:true};Player.defaults={castle_age:{pages:"*"}};
Player.runtime={cash_timeout:null,energy_timeout:null,health_timeout:null,stamina_timeout:null};var use_average_level=false;Player.init=function(){var b=new Date(script_started+$("*").html().regex(/gold_increase_ticker\(([0-9]+),/)*1E3);this.data.cash_time=b.getSeconds()+b.getMinutes()*60;this.runtime.cash_timeout=null;this.runtime.energy_timeout=null;this.runtime.health_timeout=null;this.runtime.stamina_timeout=null};
Player.parse=function(){var b=this.data,c;if($("#app"+APPID+"_energy_current_value").length){c=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);b.energy=c[0]||0}if($("#app"+APPID+"_health_current_value").length){c=$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);b.health=c[0]||0}if($("#app"+APPID+"_stamina_current_value").length){c=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);
b.stamina=c[0]||0}if($("#app"+APPID+"_st_2_5 strong:not([title])").length){c=$("#app"+APPID+"_st_2_5").text().regex(/([0-9]+)\s*\/\s*([0-9]+)/);b.exp=c[0]||0;b.maxexp=c[1]||0}b.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);b.level=$("#app"+APPID+"_st_5").text().regex(/Level: ([0-9]+)!/i);b.armymax=$("a[href*=army.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/);b.army=Math.min(b.armymax,501);b.upgrade=$("a[href*=keep.php]","#app"+APPID+"_main_bntp").text().regex(/([0-9]+)/)||
0;b.general=$("div.general_name_div3").first().text().trim();b.imagepath=$("#app"+APPID+"_globalContainer img:eq(0)").attr("src").pathpart();if(Page.page==="keep_stats"){c=$("div.keep_attribute_section").first();if(c.length){b.myname=$("div.keep_stat_title > span",c).text().regex(/"(.*)"/);b.rank=$("td.statsTMainback img[src*=rank_medals]").attr("src").filepart().regex(/([0-9]+)/);c=$("div.attribute_stat_container",c);b.maxenergy=$(c).eq(0).text().regex(/([0-9]+)/);b.maxstamina=$(c).eq(1).text().regex(/([0-9]+)/);
b.attack=$(c).eq(2).text().regex(/([0-9]+)/);b.defense=$(c).eq(3).text().regex(/([0-9]+)/);b.maxhealth=$(c).eq(4).text().regex(/([0-9]+)/);b.bank=parseInt($("td.statsTMainback b.money").text().replace(/[^0-9]/g,""),10);c=$('.statsTB table table:contains("Total Income")').text().replace(/[^0-9$]/g,"").regex(/([0-9]+)\$([0-9]+)\$([0-9]+)/);b.maxincome=c[0];b.upkeep=c[1];b.income=c[2]}}if(Page.page==="town_land"){c=$(".mContTMainback div:last-child");b.income=c.eq(c.length-4).text().replace(/[^0-9]/g,
"").regex(/([0-9]+)/)}$("span.result_body").each(function(d,e){d=$(e).text().replace(/,|\s+|\n/g,"");History.add("income",sum(d.regex(/Gain.*\$([0-9]+).*Cost|stealsGold:\+\$([0-9]+)|Youreceived\$([0-9]+)|Yougained\$([0-9]+)/i)));d.regex(/incomepaymentof\$([0-9]+)gold/i)&&History.set("land",sum(d.regex(/incomepaymentof\$([0-9]+)gold|backinthemine:Extra([0-9]+)Gold/i)))});if($("#app"+APPID+"_energy_time_value").length){window.clearTimeout(this.runtime.energy_timeout);this.runtime.energy_timeout=window.setTimeout(function(){Player.get("energy")},
$("#app"+APPID+"_energy_time_value").text().parseTimer()*1E3)}if($("#app"+APPID+"_health_time_value").length){window.clearTimeout(this.runtime.health_timeout);this.runtime.health_timeout=window.setTimeout(function(){Player.get("health")},$("#app"+APPID+"_health_time_value").text().parseTimer()*1E3)}if($("#app"+APPID+"_stamina_time_value").length){window.clearTimeout(this.runtime.stamina_timeout);this.runtime.stamina_timeout=window.setTimeout(function(){Player.get("stamina")},$("#app"+APPID+"_stamina_time_value").text().parseTimer()*
1E3)}return false};
Player.update=function(b){if(b!=="option"){var c,d=["stamina","energy","health"],e,f;for(c=0;c<d.length;c++){e=[];f=Divisor(Player.data["max"+d[c]]);for(b=0;b<=Player.data["max"+d[c]];b+=f)e.push(b);Config.set(d[c],e)}History.set("bank",this.data.bank);History.set("exp",this.data.exp)}Dashboard.status(this,"Income: $"+addCommas(Math.max(this.data.income,(History.get("land.average.1")+History.get("income.average.24")).round()))+" per hour (currently $"+addCommas(History.get("land.average.1"))+" from land)")};
Player.get=function(b){var c=this.data;Date.now();switch(b){case "cash":return this.data.cash=parseInt($("strong#app"+APPID+"_gold_current_value").text().replace(/[^0-9]/g,""),10);case "cash_timer":b=new Date;return(3600+c.cash_time-(b.getSeconds()+b.getMinutes()*60))%3600;case "energy":return this.data.energy=$("#app"+APPID+"_energy_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "energy_timer":return $("#app"+APPID+"_energy_time_value").text().parseTimer();case "health":return this.data.health=
$("#app"+APPID+"_health_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "health_timer":return $("#app"+APPID+"_health_time_value").text().parseTimer();case "stamina":return this.data.stamina=$("#app"+APPID+"_stamina_current_value").parent().text().regex(/([0-9]+)\s*\/\s*[0-9]+/);case "stamina_timer":return $("#app"+APPID+"_stamina_time_value").text().parseTimer();case "exp_needed":return c.maxexp-c.exp;default:return this._get(b)}};var Potions=new Worker("Potions");
Potions.defaults={castle_age:{pages:"*"}};Potions.option={energy:35,stamina:35};Potions.runtime={drink:false};Potions.display=[{id:"energy",label:"Maximum Energy Potions",select:{0:0,5:5,10:10,15:15,20:20,25:25,30:30,35:35,40:40,infinite:"&infin;"},help:"Will use them when you have to many, if you collect more than 40 they will be lost anyway"},{id:"stamina",label:"Maximum Stamina Potions",select:{0:0,5:5,10:10,15:15,20:20,25:25,30:30,35:35,40:40,infinite:"&infin;"},help:"Will use them when you have to many, if you collect more than 40 they will be lost anyway"}];
Potions.parse=function(){$('.result_body:contains("You have acquired the Energy Potion!")').each(function(){Potions.data.Energy=(Potions.data.Energy||0)+1});if(Page.page==="keep_stats"){this.data={};$(".statsT2:eq(2) .statUnit").each(function(b,c){if((b=$(c).text().replace(/\s+/g," ").trim().regex(/(.*) Potion x ([0-9]+)/i))&&b[0]&&b[1])Potions.data[b[0]]=b[1]})}return false};
Potions.update=function(){var b=[],c=LevelUp.get("runtime.running");this.runtime.drink=false;for(var d in this.data){this.data[d]&&b.push(d+": "+this.data[d]+"/"+this.option[d.toLowerCase()]);if(!c&&typeof this.option[d.toLowerCase()]==="number"&&this.data[d]>this.option[d.toLowerCase()]&&(Player.get(d.toLowerCase())||0)<(Player.get("max"+d.toLowerCase())||0))this.runtime.drink=true}Dashboard.status(this,b.join(", "))};
Potions.work=function(b){if(!this.runtime.drink)return false;if(!b||!Page.to("keep_stats"))return true;for(var c in this.data)if(typeof this.option[c.toLowerCase()]==="number"&&this.data[c]>this.option[c.toLowerCase()]){debug("Potions: Wanting to drink a "+c+" potion");Page.click('.statUnit:contains("'+c+'") form .imgButton input');break}return true};var Quest=new Worker("Quest");Quest.defaults={castle_age:{pages:"quests_quest1 quests_quest2 quests_quest3 quests_quest4 quests_quest5 quests_quest6 quests_quest7 quests_demiquests quests_atlantis"}};
Quest.option={general:true,what:"Influence",unique:true,monster:true,bank:true};Quest.runtime={best:null,energy:0};Quest.land=["Land of Fire","Land of Earth","Land of Mist","Land of Water","Demon Realm","Undead Realm","Underworld"];Quest.area={quest:"Quests",demiquest:"Demi Quests",atlantis:"Atlantis"};Quest.current=null;
Quest.display=[{id:"general",label:"Use Best General",checkbox:true},{id:"what",label:"Quest for",select:"quest_reward",help:"Once you have unlocked all areas (Advancement) it will switch to Influence. Once you have 100% Influence it will switch to Experience"},{id:"unique",label:"Get Unique Items First",checkbox:true},{id:"monster",label:"Fortify Monsters First",checkbox:true},{id:"bank",label:"Automatically Bank",checkbox:true}];
Quest.init=function(){for(var b in this.data)b.indexOf("\t")!==-1&&delete this.data[b]};
Quest.parse=function(){var b=this.data,c=null,d=null,e;if(Page.page==="quests_quest")return false;else if(Page.page==="quests_demiquests")c="demiquest";else if(Page.page==="quests_atlantis")c="atlantis";else{c="quest";d=Page.page.regex(/quests_quest([0-9]+)/i)-1}for(e in b)if(b[e].area===c&&(c!=="quest"||b[e].land===d))delete b[e];if($("div.quests_background,div.quests_background_sub").length!==$("div.quests_background .quest_progress,div.quests_background_sub .quest_sub_progress").length){Page.to(Page.page,"");
return false}$("div.quests_background,div.quests_background_sub,div.quests_background_special").each(function(f,g){var h,k,l,n,o,p=0;if($(g).hasClass("quests_background_sub")){f=$(".quest_sub_title",g).text().trim();l=$(".qd_2_sub",g).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);o=$(".qd_3_sub",g).text().regex(/([0-9]+)/);h=$(".quest_sub_progress",g).text().regex(/LEVEL ([0-9]+)/i);k=$(".quest_sub_progress",g).text().regex(/INFLUENCE: ([0-9]+)%/i);p=2}else{f=$(".qd_1 b",g).text().trim();
l=$(".qd_2",g).text().replace(/[^0-9$]/g,"").regex(/^([0-9]+)\$([0-9]+)\$([0-9]+)$/);o=$(".quest_req b",g).text().regex(/([0-9]+)/);if($(g).hasClass("quests_background")){h=$(".quest_progress",g).text().regex(/LEVEL ([0-9]+)/i);k=$(".quest_progress",g).text().regex(/INFLUENCE: ([0-9]+)%/i);p=1}else p=3}if(!(!f||f.indexOf("\t")!==-1)){b[f]={};b[f].area=c;b[f].type=p;if(typeof d==="number")b[f].land=d;if(typeof k==="number"){b[f].level=h||0;b[f].influence=k}b[f].exp=l[0];b[f].reward=(l[1]+l[2])/2;b[f].energy=
o;if(p!==2){if(p===3)b[f].unique=true;h=$(".qd_1 img",g).last();if(h.length&&h.attr("title")){b[f].item=h.attr("title").trim();b[f].itemimg=h.attr("src").filepart()}n={};$(".quest_req >div >div >div",g).each(function(m,q){m=$("img",q).attr("title");n[m]=$(q).text().regex(/([0-9]+)/)});if(length(n))b[f].units=n;h=$(".quest_act_gen img",g);if(h.length&&h.attr("title"))b[f].general=h.attr("title")}}});this.data=sortObject(b,function(f,g){return f>g});return false};
Quest.update=function(){var b,c=null,d=0,e=[];for(b in this.data)this.data[b].item&&!this.data[b].unique&&e.push(this.data[b].item);Config.set("quest_reward",["Nothing","Influence","Advancement","Experience","Cash"].concat(unique(e).sort()));if(this.option.unique&&Alchemy._changed>this.lastunique){for(b in this.data)if(this.data[b].unique&&!Alchemy.get(["ingredients",this.data[b].itemimg])&&(!c||this.data[b].energy<this.data[c].energy))c=b;this.lastunique=Date.now()}if(!c&&this.option.what!=="Nothing")for(b in this.data)switch(this.option.what){case "Influence":if(typeof this.data[b].influence!==
"undefined"&&this.data[b].influence<100&&(!c||this.data[b].energy<this.data[c].energy))c=b;break;case "Experience":if(!c||this.data[b].energy/this.data[b].exp<this.data[c].energy/this.data[c].exp)c=b;break;case "Cash":if(!c||this.data[b].energy/this.data[b].reward<this.data[c].energy/this.data[c].reward)c=b;break;case "Advancement":if(this.data[b].type!==2&&typeof this.data[b].land==="number"&&this.data[b].land>=d&&(this.data[b].influence<100||this.data[b].unique&&!Alchemy.get(["ingredients",this.data[b].itemimg]))&&
(!c||this.data[b].land>(this.data[c].land||0)||this.data[b].land===this.data[c].land&&this.data[b].unique&&!length(Player.data[this.data[b].item]))){d=Math.max(d,this.data[b].land);c=b}break;default:if(this.data[b].item===this.option.what&&(!c||this.data[b].energy<this.data[c].energy))c=b;break}if(c!==this.runtime.best)if(this.runtime.best=c){this.runtime.energy=this.data[c].energy;debug("Quest: Wanting to perform - "+c+" in "+(typeof this.data[c].land==="number"?this.land[this.data[c].land]:this.area[this.data[c].area])+
" (energy: "+this.data[c].energy+", experience: "+this.data[c].exp+", reward: $"+addCommas(this.data[c].reward)+")")}if(c)Dashboard.status(this,(typeof this.data[c].land==="number"?this.land[this.data[c].land]:this.area[this.data[c].area])+": "+c+" (energy: "+this.data[c].energy+", experience: "+this.data[c].exp+", reward: $"+addCommas(this.data[c].reward)+(typeof this.data[c].influence!=="undefined"?", influence: "+this.data[c].influence+"%)":""));else if(this.option.what==="Influence"){this.option.what=
"Experience";$("select:golem(quest,what)").val("Experience");Dashboard.status(this,"No quests found, switching to Experience")}else if(this.option.what==="Advancement"){this.option.what="Influence";$("select:golem(quest,what)").val("Influence");Dashboard.status(this,"No unfinished lands found, switching to Influence")}else Dashboard.status(this)};
Quest.work=function(b){var c,d,e=null,f=this.runtime.best;if(!f||this.runtime.energy>Queue.burn.energy){if(b&&this.option.bank)return Bank.work(true);return false}if(this.option.monster&&Monster.data)for(c in Monster.data)for(d in Monster.data[c]){if(Monster.data[c][d].state==="engage"&&typeof Monster.data[c][d].defense==="number"&&Monster.data[c][d].defense<Monster.option.fortify)return false;if(Monster.data[c][d].state==="engage"&&typeof Monster.data[c][d].dispel==="number"&&Monster.data[c][d].dispel>
Monster.option.dispel)return false}if(!b)return true;if(this.option.general)if(this.data[f].general&&typeof this.data[f].influence==="number"&&this.data[f].influence<100){if(!Generals.to(this.data[f].general))return true}else{switch(this.option.what){case "Influence":case "Advancement":case "Experience":e=Generals.best("under level 4");if(e==="any"&&this.data[f].influence<100)e=Generals.best("influence");break;case "Cash":e=Generals.best("cash");break;default:e=Generals.best("item");break}if(!Generals.to(e))return true}switch(this.data[f].area){case "quest":if(!Page.to("quests_quest"+
(this.data[f].land+1)))return true;break;case "demiquest":if(!Page.to("quests_demiquests"))return true;break;case "atlantis":if(!Page.to("quests_atlantis"))return true;break;default:debug("Quest: Can't get to quest area!");return false}debug("Quest: Performing - "+f+" (energy: "+this.data[f].energy+")");if(!Page.click('div.action[title*="'+f+':"] input[type="image"]')){debug("Quest: Can't find button for "+f+", so deleting and re-visiting page...");delete this.data[f];Page.reload()}this.option.unique&&
this.data[f].unique&&!Alchemy.get(["ingredients",this.data[c].itemimg])&&Alchemy.set(["ingredients",this.data[c].itemimg],1);this.option.what==="Advancement"&&this.data[f].unique&&this.data[f].land<6&&Page.to("quests_quest"+(this.data[f].land+2));return true};Quest.order=[];
Quest.dashboard=function(b,c){function d(k){switch(b){case 0:return Quest.data[k].general||"zzz";case 1:return k;case 2:return typeof Quest.data[k].land==="number"&&typeof Quest.land[Quest.data[k].land]!=="undefined"?Quest.land[Quest.data[k].land]:Quest.area[Quest.data[k].area];case 3:return(typeof Quest.data[k].level!=="undefined"?Quest.data[k].level:-1)*100+(Quest.data[k].influence||0);case 4:return Quest.data[k].energy;case 5:return Quest.data[k].exp/Quest.data[k].energy;case 6:return Quest.data[k].reward/
Quest.data[k].energy;case 7:return Quest.data[k].item||"zzz"}return 0}var e,f,g=[],h=[];if(typeof b==="undefined"){this.order=[];for(e in this.data)this.order.push(e)}if(typeof b==="undefined")b=this.runtime.sort||1;if(typeof c==="undefined")c=this.runtime.rev||false;this.runtime.sort=b;this.runtime.rev=c;this.order.sort(function(k,l){k=d(k);l=d(l);if(typeof k==="string"||typeof l==="string")return c?(l||"")>(k||""):(l||"")<(k||"");return c?(k||0)-(l||0):(l||0)-(k||0)});th(h,"General");th(h,"Name");
th(h,"Area");th(h,"Level");th(h,"Energy");th(h,"@&nbsp;Exp");th(h,"@&nbsp;Reward");th(h,"Item");g.push('<table cellspacing="0" style="width:100%"><thead><tr>'+h.join("")+"</tr></thead><tbody>");for(f=0;f<this.order.length;f++){e=this.order[f];h=[];td(h,Generals.get([this.data[e].general])?'<img style="width:25px;height:25px;" src="'+imagepath+Generals.get([this.data[e].general,"img"])+'" alt="'+this.data[e].general+'" title="'+this.data[e].general+'">':"");th(h,e);td(h,typeof this.data[e].land===
"number"?this.land[this.data[e].land].replace(" ","&nbsp;"):this.area[this.data[e].area].replace(" ","&nbsp;"));td(h,typeof this.data[e].level!=="undefined"?this.data[e].level+"&nbsp;("+this.data[e].influence+"%)":"");td(h,this.data[e].energy);td(h,(this.data[e].exp/this.data[e].energy).round(2),'title="'+this.data[e].exp+" total, "+(this.data[e].exp/this.data[e].energy*12).round(2)+' per hour"');td(h,"$"+addCommas((this.data[e].reward/this.data[e].energy).round()),'title="$'+addCommas(this.data[e].reward)+
" total, $"+addCommas((this.data[e].reward/this.data[e].energy*12).round())+' per hour"');td(h,this.data[e].itemimg?'<img style="width:25px;height:25px;" src="'+imagepath+this.data[e].itemimg+'" alt="'+this.data[e].item+'" title="'+this.data[e].item+'">':"");tr(g,h.join(""),'style="height:25px;"')}g.push("</tbody></table>");$("#golem-dashboard-Quest").html(g.join(""));$("#golem-dashboard-Quest tbody tr td:nth-child(2)").css("text-align","left");if(typeof b!=="undefined")$("#golem-dashboard-Quest thead th:eq("+
b+")").attr("name",c?"reverse":"sort").append("&nbsp;"+(c?"&uarr;":"&darr;"))};var Title=new Worker("Title");Title.data=null;Title.settings={system:true,unsortable:true,advanced:true};Title.option={enabled:false,title:"CA: {Queue:runtime.current} | {energy}e | {stamina}s | {exp_needed}xp by {LevelUp:time}"};Title.display=[{id:"enabled",label:"Change Window Title",checkbox:true},{id:"title",text:true,size:24},{title:"Useful Values",info:"{energy} / {maxenergy}<br>{health} / {maxhealth}<br>{stamina} / {maxstamina}<br>{level}<br>{LevelUp:time} - Next level time<br>{Queue:runtime.current} - Activity"}];
Title.old=null;Title.init=function(){this._watch(Player)};
Title.update=function(){if(this.option.enabled&&this.option.title){var b,c,d,e,f="",g=this.option.title.match(/([^}]+\}?)/g);for(b in g){c=g[b].regex(/([^{]*)\{?([^}]*)\}?/);f+=c[0];if(c[1]){e=Player;d=c[1].split(":");if(d[1])e=WorkerByName(d.shift());if(e){c=e.get(d[0]);f+=typeof c==="number"?addCommas(c):typeof c==="string"?c:"";this._watch(e)}else debug('Title: Bad worker specified = "'+c[1]+'"')}}if(!this.old)this.old=document.title;document.title=f}else if(this.old){document.title=this.old;this.old=
null}};var Town=new Worker("Town");Town.data={};Town.defaults={castle_age:{pages:"town_soldiers town_blacksmith town_magic"}};Town.option={number:"Minimum",maxcost:"$100k",units:"All",sell:false};Town.runtime={best:null,buy:0,cost:0};
Town.display=[{label:"Work in progress..."},{id:"number",label:"Buy Number",select:["None","Minimum","Match Army","Maximum"],help:"Minimum will buy before any quests (otherwise only bought when needed), Maximum will buy 501 (depending on generals)"},{advanced:true,id:"maxcost",label:"Maximum Buy Cost",select:["$10k","$100k","$1m","$10m","$100m","$1b","$10b","$100b"]},{advanced:true,id:"units",label:"Buy Type",select:["All","Best Offense","Best Defense","Best of Both"]},{advanced:true,id:"sell",label:"Auto-Sell<br>(Not enabled)",
checkbox:true}];
Town.blacksmith={Weapon:/avenger|axe|blade|bow|cleaver|cudgel|dagger|halberd|mace|morningstar|rod|saber|spear|staff|stave|sword|talon|trident|wand|Daedalus|Dragonbane|Dreadnought Greatsword|Excalibur|Incarnation|Ironhart's Might|Judgement|Justice|Lightbringer|Oathkeeper|Onslaught/i,Shield:/buckler|shield|tome|Defender|Dragon Scale|Frost Dagger|Frost Tear Dagger|Harmony|Sword of Redemption|Terra's Guard|The Dreadnought/i,Helmet:/cowl|crown|helm|horns|mask|veil/i,Gloves:/gauntlet|glove|hand|bracer|Slayer's Embrace/i,Armor:/armor|chainmail|cloak|pauldrons|plate|raiments|robe|Blood Vestment|Faerie Wings/i,
Amulet:/amulet|bauble|charm|crystal|eye|heart|insignia|jewel|lantern|memento|orb|shard|soul|talisman|trinket|Paladin's Oath|Poseidons Horn| Ring|Ring of|Ruby Ore|Thawing Star/i};Town.init=function(){if(this.data.soldiers||this.data.blacksmith||this.data.magic){this.data={};delete Page.data.town_soldiers;delete Page.data.town_blacksmith;delete Page.data.town_magic}};
Town.parse=function(b){if(b)Page.page==="town_blacksmith"&&$(".eq_buy_row,.eq_buy_row2").each(function(e,f){e=$("div.eq_buy_txt strong:first-child",f);f=e.text().trim();Town.data[f].type&&e.parent().append("<br>"+Town.data[f].type)});else{$(".eq_buy_row").each(function(e,f){$(".eq_buy_costs_int",f).length||$(".eq_buy_costs",f).prepend('<div class="eq_buy_costs_int"></div>').children(".eq_buy_costs_int").append($('.eq_buy_costs >[class!="eq_buy_costs_int"]',f));$(".eq_buy_stats_int",f).length||$(".eq_buy_stats",
f).prepend('<div class="eq_buy_stats_int"></div>').children(".eq_buy_stats_int").append($('.eq_buy_stats >[class!="eq_buy_stats_int"]',f));$(".eq_buy_txt_int",f).length||$(".eq_buy_txt",f).prepend('<div class="eq_buy_txt_int"></div>').children(".eq_buy_txt_int").append($('.eq_buy_txt >[class!="eq_buy_txt_int"]',f))});var c=Town.data,d=Page.page.substr(5);$(".eq_buy_row,.eq_buy_row2").each(function(e,f){var g;e=$("div.eq_buy_stats",f);var h=$(".eq_buy_txt strong:first",f).text().trim(),k=$("div.eq_buy_costs",
f),l=$("strong:first-child",k).text().replace(/[^0-9]/g,"");c[h]=c[h]||{};c[h].page=d;c[h].img=$("div.eq_buy_image img",f).attr("src").filepart();c[h].own=$("span:first-child",k).text().regex(/Owned: ([0-9]+)/i);c[h].att=$(".eq_buy_stats_int div:eq(0)",e).text().regex(/([0-9]+)\s*Attack/);c[h].def=$(".eq_buy_stats_int div:eq(1)",e).text().regex(/([0-9]+)\s*Defense/);if(l){c[h].cost=parseInt(l,10);c[h].buy=[];$('select[name="amount"]:first option',k).each(function(n,o){c[h].buy.push(parseInt($(o).val(),
10))})}if(d==="blacksmith")for(g in Town.blacksmith)if(h.match(Town.blacksmith[g]))c[h].type=g})}return true};
Town.getInvade=function(b){var c=0,d=0,e=this.data;c+=getAttDef(e,function(f,g,h){h[g].page==="soldiers"&&f.push(g)},"att",b,"invade");d+=getAttDef(e,null,"def",b,"invade");c+=getAttDef(e,function(f,g,h){h[g].type&&h[g].type!=="Weapon"&&f.push(g)},"att",b,"invade");d+=getAttDef(e,null,"def",b,"invade");c+=getAttDef(e,function(f,g,h){h[g].type==="Weapon"&&f.push(g)},"att",b,"invade");d+=getAttDef(e,null,"def",b,"invade");c+=getAttDef(e,function(f,g,h){h[g].page==="magic"&&f.push(g)},"att",b,"invade");
d+=getAttDef(e,null,"def",b,"invade");return{attack:c,defend:d}};
Town.getDuel=function(){var b=0,c=0,d=this.data;b+=getAttDef(d,function(e,f,g){g[f].type==="Weapon"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",1,"duel");b+=getAttDef(d,function(e,f,g){g[f].page==="magic"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",1,"duel");b+=getAttDef(d,function(e,f,g){g[f].type==="Shield"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",1,"duel");b+=getAttDef(d,function(e,f,g){g[f].type==="Helmet"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",
1,"duel");b+=getAttDef(d,function(e,f,g){g[f].type==="Gloves"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",1,"duel");b+=getAttDef(d,function(e,f,g){g[f].type==="Armor"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",1,"duel");b+=getAttDef(d,function(e,f,g){g[f].type==="Amulet"&&e.push(f)},"att",1,"duel");c+=getAttDef(d,null,"def",1,"duel");return{attack:b,defend:c}};
Town.update=function(){var b,c,d=null,e=0,f=this.data,g;this.runtime.invade=this.getInvade(Player.get("army"));this.runtime.duel=this.getDuel();if(this.option.number!=="None"){g=Quest.get();for(b in g)if(g[b].units)for(c in g[b].units)if(f[c]&&f[c].cost&&f[c].own<g[b].units[c]){d=c;e=g[b].units[c]-f[c].own}}if(this.runtime.best=d){this.runtime.buy=e;this.runtime.cost=e*f[d].cost;Dashboard.status(this,"Want to buy "+e+" x "+d+" for $"+addCommas(this.runtime.cost))}else Dashboard.status(this)};
Town.work=function(b){var c;if(!this.runtime.best||!this.runtime.buy||!Bank.worth(this.runtime.cost))return false;if(!b||!Bank.retrieve(this.runtime.cost)||this.data[this.runtime.best].page==="soldiers"&&!Generals.to("cost")||!Page.to("town_"+this.data[this.runtime.best].page))return true;$(".eq_buy_row,.eq_buy_row2").each(function(d,e){if($(".eq_buy_txt strong:first",e).text().trim()===Town.runtime.best){c=0;$('.eq_buy_costs select[name="amount"]:eq(0) option',e).each(function(f,g){if(parseInt($(g).val())>
c&&Town.runtime.buy>=parseInt($(g).val()))c=parseInt($(g).val())});debug("Town: Buying "+c+" x "+Town.runtime.best+" for $"+addCommas(c*Town.runtime.cost/Town.runtime.buy));$('.eq_buy_costs select[name="amount"]:eq(0)',e).val(c);Page.click($('.eq_buy_costs input[name="Buy"]',e))}});return true};
var makeTownDash=function(b,c,d,e,f,g){var h=[],k=[],l=d==="att"?"def":"att",n,o={Weapon:1,Shield:2,Helmet:3,Armor:4,Amulet:5,Gloves:6,Magic:7};f&&k.push('<div class="golem-panel"><h3 class="golem-panel-header">'+f+'</h3><div class="golem-panel-content">');for(n in b)c(h,n,b);if(b[h[0]])if(e==="duel"&&b[h[0]].type)h.sort(function(p,m){return o[b[p].type]-o[b[m].type]});else b[h[0]]&&b[h[0]].skills&&b[h[0]][e]?h.sort(function(p,m){return(b[m][e][d]||0)-(b[p][e][d]||0)}):h.sort(function(p,m){return b[m][d]+
0.7*b[m][l]-(b[p][d]+0.7*b[p][l])});for(n=0;n<(g?g:h.length);n++)if(b[h[0]]&&b[h[0]].skills||b[h[n]].use&&b[h[n]].use[e+"_"+d])k.push('<div style="height:25px;margin:1px;"><img src="'+imagepath+b[h[n]].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+(b[h[n]].use?b[h[n]].use[e+"_"+d]+" x ":"")+h[n]+" ("+b[h[n]].att+" / "+b[h[n]].def+")"+(b[h[n]].cost?"<br>$"+addCommas(b[h[n]].cost):"")+"</div>");f&&k.push("</div></div>");return k.join("")};
Town.dashboard=function(){var b,c;c=Generals.get();var d;d=Generals.best("duel");b='<div style="float:left;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(c,function(e,f){e.push(f)},"att","invade","Heroes")+makeTownDash(this.data,function(e,f,g){g[f].page==="soldiers"&&g[f].use&&e.push(f)},"att","invade","Soldiers")+makeTownDash(this.data,function(e,f,g){g[f].use&&g[f].type==="Weapon"&&e.push(f)},
"att","invade","Weapons")+makeTownDash(this.data,function(e,f,g){g[f].page==="blacksmith"&&g[f].use&&g[f].type!=="Weapon"&&e.push(f)},"att","invade","Equipment")+makeTownDash(this.data,function(e,f,g){g[f].page==="magic"&&g[f].use&&e.push(f)},"att","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Attack</h3><div class="golem-panel-content" style="padding:8px;">'+(d!=="any"?'<div style="height:25px;margin:1px;"><img src="'+imagepath+c[d].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+
d+" ("+c[d].att+" / "+c[d].def+")</div>":"")+makeTownDash(this.data,function(e,f,g){g[f].page==="blacksmith"&&g[f].use&&e.push(f)},"att","duel")+makeTownDash(this.data,function(e,f,g){g[f].page==="magic"&&g[f].use&&e.push(f)},"att","duel")+"</div></div></div>";d=Generals.best("defend");c='<div style="float:right;width:50%;"><div class="golem-panel"><h3 class="golem-panel-header">Invade - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+makeTownDash(c,function(e,f){e.push(f)},"def",
"invade","Heroes")+makeTownDash(this.data,function(e,f,g){g[f].page==="soldiers"&&g[f].use&&e.push(f)},"def","invade","Soldiers")+makeTownDash(this.data,function(e,f,g){g[f].use&&g[f].type==="Weapon"&&e.push(f)},"def","invade","Weapons")+makeTownDash(this.data,function(e,f,g){g[f].page==="blacksmith"&&g[f].use&&g[f].type!=="Weapon"&&e.push(f)},"def","invade","Equipment")+makeTownDash(this.data,function(e,f,g){g[f].page==="magic"&&g[f].use&&e.push(f)},"def","invade","Magic")+'</div></div><div class="golem-panel"><h3 class="golem-panel-header">Duel - Defend</h3><div class="golem-panel-content" style="padding:8px;">'+
(d!=="any"?'<div style="height:25px;margin:1px;"><img src="'+imagepath+c[d].img+'" style="width:25px;height:25px;float:left;margin-right:4px;">'+d+" ("+c[d].att+" / "+c[d].def+")</div>":"")+makeTownDash(this.data,function(e,f,g){g[f].page==="blacksmith"&&g[f].use&&e.push(f)},"def","duel")+makeTownDash(this.data,function(e,f,g){g[f].page==="magic"&&g[f].use&&e.push(f)},"def","duel")+"</div></div></div>";$("#golem-dashboard-Town").html(b+c)};var Upgrade=new Worker("Upgrade");Upgrade.data=null;
Upgrade.defaults={castle_age:{pages:"keep_stats"}};Upgrade.option={order:[]};Upgrade.runtime={working:false,run:0};Upgrade.display=[{label:"Points will be allocated in this order, add multiple entries if wanted (ie, 3x Attack and 1x Defense would put &frac34; on Attack and &frac14; on Defense)"},{id:"order",multiple:["Energy","Stamina","Attack","Defense","Health"]}];
Upgrade.init=function(){if(this.option.run){this.runtime.run=this.option.run;delete this.option.run}if(this.option.working){this.runtime.working=this.option.working;delete this.option.working}};Upgrade.parse=function(){var b=$("div.results");if(this.runtime.working&&b.length&&b.text().match(/You just upgraded your/i)){this.runtime.working=false;this.runtime.run++}return false};
Upgrade.work=function(b){var c=Player.get("upgrade");if(this.runtime.run>=this.option.order.length)this.runtime.run=0;if(!this.option.order.length||!c||this.option.order[this.runtime.run]==="Stamina"&&c<2)return false;if(!b||!Page.to("keep_stats"))return true;switch(this.option.order[this.runtime.run]){case "Energy":b='a[href$="?upgrade=energy_max"]';break;case "Stamina":b='a[href$="?upgrade=stamina_max"]';break;case "Attack":b='a[href$="?upgrade=attack"]';break;case "Defense":b='a[href$="?upgrade=defense"]';
break;case "Health":b='a[href$="?upgrade=health_max"]';break;default:this.runtime.run++;return true}if(Page.click(b))this.runtime.working=true;else Page.reload();return true};
